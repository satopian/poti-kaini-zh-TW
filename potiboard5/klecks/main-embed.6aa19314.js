!function(){function e(e,t,i,n){Object.defineProperty(e,t,{get:i,set:n,enumerable:!0,configurable:!0})}function t(e){return e&&e.__esModule?e.default:e}var i=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire94c2;i.register("6NgYC",(function(t,n){e(t.exports,"Embed",(function(){return u}));var r=i("3kC7t"),a=i("2gUX3");i("15wZT");var s=i("3C7jC"),o=i("5ngYX"),l=i("gWfkn"),h=i("941rU"),c=i("1mH1z");function u(e){var t,n,u=function(i){try{if(p)throw new Error("Already called openProject");p=!0;var n=new(0,o.SaveReminder)(l.klHistory,!1,!1,(function(){}),(function(){return!!t&&t.isDrawing()}),null,null);t=new(0,s.KlApp)(i,{saveReminder:n,bottomBar:e.bottomBar,aboutEl:e.aboutEl,embed:{url:e.embedUrl,onSubmit:e.onSubmit}}),n.init(),g&&g.parentNode&&g.parentNode.removeChild(g),g=null,f=null,document.body.append(t.getEl())}catch(e){f&&(f.textContent="❌ "+e),g&&(g.className+="loading-screen-error"),console.error(e)}},p=!1,d=[],g=document.getElementById("loading-screen"),f=document.getElementById("loading-screen-text");f&&(f.textContent=(0,c.LANG)("embed-init-waiting")),e.project&&u(e.project),this.openProject=u,this.initError=function(e){f&&(f.textContent="❌ "+e),g&&(g.className+="loading-screen-error")},this.getPNG=function(){if(!t)throw new Error("App not initialized");return t.getPNG()},this.getPSD=(0,r.default)((function(){return(0,a.__generator)(this,(function(e){switch(e.label){case 0:if(!t)throw new Error("App not initialized");return[4,t.getPSD()];case 1:return[2,e.sent()]}}))})),this.readPSDs=function(e){if(0!==e.length){var t=function(e){try{var t=n.readPsd(e.blob),i=(0,h.klPsdToKlProject)((0,h.readPsd)(t));e.callback(i)}catch(t){console.error("failed to read psd",t),e.callback(null)}};n?e.forEach(t):(0===d.length&&(0,r.default)((function(){return(0,a.__generator)(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,i("bxnoy")];case 1:return n=e.sent(),[3,3];case 2:return e.sent(),n="error",[3,3];case 3:for(;d.length;)t(d.shift());return[2]}}))}))(),e.forEach((function(e){d.push(e)})))}}}})),i.register("15wZT",(function(e,t){if(i("k3KW8"),"scrollTo"in Element.prototype||Object.defineProperty(Element.prototype,"scrollTo",{value:function(e,t){this.scrollLeft=e,this.scrollTop=t}}),"scrollBy"in Element.prototype||Object.defineProperty(Element.prototype,"scrollBy",{value:function(e,t){this.scrollLeft+=e,this.scrollTop+=t}}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function e(){var t=isNaN(arguments[0])?1:Number(arguments[0]);return t?Array.prototype.reduce.call(this,(function(i,n){return Array.isArray(n)?i.push.apply(i,e.call(n,t-1)):i.push(n),i}),[]):Array.prototype.slice.call(this)},writable:!0}),!("localStorage"in window))try{window.localStorage={getItem:function(){return null},setItem:function(){},removeItem:function(){}}}catch(e){}})),i.register("k3KW8",(function(e,t){i("5dg4B"),i("izcMZ"),i("iD0Yt"),i("fIU0v")})),i.register("5dg4B",(function(e,t){var i;i=function(){var e=Array.prototype.slice.call(arguments),t=document.createDocumentFragment();e.forEach((function(e){var i=e instanceof Node;t.appendChild(i?e:document.createTextNode(String(e)))})),this.appendChild(t)},[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach((function(e){e.hasOwnProperty("append")||Object.defineProperty(e,"append",{configurable:!0,enumerable:!0,writable:!0,value:i})}))})),i.register("izcMZ",(function(e,t){var i;i=function(){var e=Array.prototype.slice.call(arguments),t=document.createDocumentFragment();e.forEach((function(e){var i=e instanceof Node;t.appendChild(i?e:document.createTextNode(String(e)))})),this.insertBefore(t,this.firstChild)},[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach((function(e){e.hasOwnProperty("prepend")||Object.defineProperty(e,"prepend",{configurable:!0,enumerable:!0,writable:!0,value:i})}))})),i.register("iD0Yt",(function(e,t){String.prototype.padStart||(String.prototype.padStart=function(e,t){return e>>=0,t=String(t||" "),this.length>e?String(this):((e-=this.length)>t.length&&(t+=t.repeat(e/t.length)),t.slice(0,e)+String(this))})})),i.register("fIU0v",(function(e,t){Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),i=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var n=arguments[1],r=0;r<i;){var a=t[r];if(e.call(n,a,r,t))return r;r++}return-1}})})),i.register("3C7jC",(function(n,r){e(n.exports,"KlApp",(function(){return N}));var a=i("3kC7t"),s=i("gFgFC"),o=i("kiQ5H"),l=i("7U0Ew"),h=i("4R9ai"),c=i("4Ea8f"),u=i("2gUX3"),p=i("hrnUX"),d=i("gWfkn"),g=i("eWjiX"),f=i("h62LS"),v=i("jmL5A"),m=i("iUR3L"),y=i("2wCWz"),x=i("3WOmu"),B=i("1mH1z"),b=i("6l0gQ"),w=i("iuTWx"),k=i("57YJz"),C=i("aId1u"),S=i("iG6pP"),L=i("8dsYZ"),A=i("4sBxW"),I=i("6iPxE"),E=i("fZtJh"),T=i("eOZOu"),M=i("haxur"),P=i("fX22P"),O=i("i7SrA"),R=i("qur3y"),D=i("fohxs");(0,m.importFilters)();var N=function(){"use strict";function e(i,n){var r,o=this;(0,s.default)(this,e),(0,l.default)(this,"collapseThreshold",820),(0,l.default)(this,"toolWidth",271);var m=this;(0,l.default)(this,"getPSD",(0,a.default)((function(){return(0,u.__generator)(this,(function(e){switch(e.label){case 0:return[4,(0,x.klCanvasToPsdBlob)(m.klCanvas)];case 1:return[2,e.sent()]}}))}))),this.embed=n.embed;var y=Math.min(4096,Math.max(2048,Math.max(window.screen.width,window.screen.height)));this.uiState=this.embed?"left":b.LocalStorage.getItem("uiState")?b.LocalStorage.getItem("uiState"):"right";var N=(null===(r=n.app)||void 0===r?void 0:r.filenameBase)?n.app.filenameBase:"Klecks",z=n.projectStore;this.klRootEl=g.BB.el({className:"g-root",css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"}}),this.uiWidth=Math.max(0,window.innerWidth),this.uiHeight=Math.max(0,window.innerHeight);var j="png";this.klCanvas=new p.KL.KlCanvas(i?{projectObj:i}:{width:Math.max(10,Math.min(y,window.innerWidth<this.collapseThreshold?this.uiWidth:this.uiWidth-this.toolWidth)),height:Math.max(10,Math.min(y,this.uiHeight))},this.embed?-1:0),this.klCanvas.setHistory(d.klHistory);var G,H=null;n.saveReminder||(n.saveReminder={init:function(){},reset:function(){}}),i?(i.layers.forEach((function(e){e.image=null})),i=null):(d.klHistory.pause(!0),this.klCanvas.addLayer(),this.klCanvas.layerFill(0,{r:D.ERASE_COLOR,g:D.ERASE_COLOR,b:D.ERASE_COLOR}),d.klHistory.pause(!1));try{H={canvas:new p.KL.KlCanvas({copy:this.klCanvas},this.embed?-1:0),focus:this.klCanvas.getLayerCount()-1,brushes:{}}}catch(e){throw"kl-create-canvas-error"===e.message&&this.klCanvas.destroy(),e}Object.entries(p.KL.brushes).forEach((function(e){var t=(0,h.default)(e,2),i=t[0],n=t[1];H.brushes[i]=new n,H.canvas&&H.brushes[i].setContext(H.canvas.getLayerContext(H.focus))}));var F,W,V,U=new g.BB.RGB(0,0,0),X=this.klCanvas.getLayerContext(this.klCanvas.getLayerCount()-1),K=function(e){Y.emitSize(e),o.klCanvasWorkspace&&o.klCanvasWorkspace.setCursorSize(2*e)},Y=new p.KL.BrushSettingService((function(e){o.klColorSlider.setColor(e),F.setColor(e),U=g.BB.copyObj(e)}),(function(e){F.setSize(e),o.klCanvasWorkspace.setCursorSize(2*e)}),(function(e){F.setOpacity(e)}),(function(){return o.klColorSlider.getColor()}),(function(){return te[W].getSize()}),(function(){return te[W].getOpacity()}),(function(){return{sizeSlider:p.KL.brushesUI[W].sizeSlider,opacitySlider:p.KL.brushesUI[W].opacitySlider}})),_=new(0,w.LineSmoothing)({smoothing:(0,C.translateSmoothing)(1)});this.lineSanitizer=new(0,k.LineSanitizer);var q=new g.BB.EventChain({chainArr:[this.lineSanitizer,_]});q.setChainOut((function(e){"down"===e.type&&(o.toolspace.style.pointerEvents="none",F.startLine(e.x,e.y,e.pressure),o.klCanvasWorkspace.requestFrame()),"move"===e.type&&(F.goLine(e.x,e.y,e.pressure,!1,e.isCoalesced),o.klCanvasWorkspace.setLastDrawEvent(e.x,e.y,e.pressure),o.klCanvasWorkspace.requestFrame()),"up"===e.type&&(o.toolspace.style.pointerEvents="",F.endLine(),o.klCanvasWorkspace.requestFrame()),"line"===e.type&&(F.getBrush().drawLineSegment(e.x0,e.y0,e.x1,e.y1),o.klCanvasWorkspace.requestFrame())}));var Q={size:20,align:"left",isBold:!1,isItalic:!1,font:"sans-serif",opacity:1};this.klCanvasWorkspace=new p.KL.KlCanvasWorkspace({klCanvas:this.klCanvas,width:Math.max(0,this.uiWidth-this.toolWidth),height:this.uiHeight,onDraw:function(e){return q.chainIn(e)},onPick:function(e,t){Y.setColor(e),t&&(o.klColorSlider.pickingDone(),o.klCanvasWorkspace.setMode(o.toolspaceToolRow.getActive()))},onFill:function(e,t){var i=o.klCanvas.getLayerIndex(X.canvas);o.klCanvas.floodFill(i,e,t,le.getIsEraser()?null:o.klColorSlider.getColor(),le.getOpacity(),le.getTolerance(),le.getSample(),le.getGrow(),le.getContiguous()),o.klCanvasWorkspace.requestFrame()},onGradient:function(e,t,i,n){"down"===e&&pe.onDown(t,i,n),"move"===e&&pe.onMove(t,i),"up"===e&&pe.onUp(t,i)},onText:function(e,t,i){p.KL.dialogCounter.get()>0||p.KL.textToolDialog({klCanvas:o.klCanvas,layerIndex:o.klCanvas.getLayerIndex(X.canvas),x:e,y:t,angleRad:i,color:o.klColorSlider.getColor(),secondaryColor:o.klColorSlider.getSecondaryRGB(),size:Q.size,align:Q.align,isBold:Q.isBold,isItalic:Q.isItalic,font:Q.font,opacity:Q.opacity,onConfirm:function(e){var t=e.color;t.a=e.opacity,Q.size=e.size,Q.align=e.align,Q.isBold=e.isBold,Q.isItalic=e.isItalic,Q.font=e.font,Q.opacity=e.opacity;var n=o.klCanvas.getLayerIndex(X.canvas);o.klCanvas.text(n,{textStr:e.textStr,x:e.x,y:e.y,size:e.size,font:e.font,align:e.align,isBold:e.isBold,isItalic:e.isItalic,angleRad:i,color:g.BB.ColorConverter.toRgbaStr(t)}),o.klCanvasWorkspace.requestFrame()}})},onShape:function(e,t,i,n){"down"===e&&de.onDown(t,i,n),"move"===e&&de.onMove(t,i),"up"===e&&de.onUp(t,i)},onViewChange:function(e){e.changed.includes("scale")&&o.statusOverlay.out({type:"transform",scale:e.scale,angleDeg:180*e.angle/Math.PI}),o.toolspaceToolRow.setEnableZoomIn(e.scale!==o.klCanvasWorkspace.getMaxScale()),o.toolspaceToolRow.setEnableZoomOut(e.scale!==o.klCanvasWorkspace.getMinScale()),oe.update(e.scale,180*e.angle/Math.PI)},onUndo:function(){d.klHistory.canUndo()&&fe.undo()&&o.statusOverlay.out((0,B.LANG)("undo"),!0)},onRedo:function(){d.klHistory.canRedo()&&fe.redo()&&o.statusOverlay.out((0,B.LANG)("redo"),!0)}});var Z,J,$=function(){if(G)for(var e=o.toolspaceToolRow.getActive(),t=G.getOpenedTabId(),i=Object.keys({draw:{},hand:{},fill:{},gradient:{},text:{},shape:{}}),n=0;n<i.length;n++)e===i[n]?G.setIsVisible(i[n],!0):(G.setIsVisible(i[n],!1),t===i[n]&&G.open(e))},ee=new g.BB.KeyListener({onDown:function(e,t,i){if(!(p.KL.dialogCounter.get()>0||g.BB.isInputFocused(!0))&&!(o.lineSanitizer.getIsDrawing()||o.klCanvasWorkspace.getIsDrawing())){if("plus"===i&&o.klCanvasWorkspace.zoomByStep(ee.isPressed("shift")?1/8:.5),"minus"===i&&o.klCanvasWorkspace.zoomByStep(ee.isPressed("shift")?-1/8:-.5),"home"===i&&o.klCanvasWorkspace.fitView(),"end"===i&&o.klCanvasWorkspace.resetView(!0),["ctrl+z","cmd+z"].includes(i)&&(t.preventDefault(),fe.undo()),(["ctrl+y","cmd+y"].includes(i)||(g.BB.sameKeys("ctrl+shift+z",i)||g.BB.sameKeys("cmd+shift+z",i))&&"z"===e)&&(t.preventDefault(),fe.redo()),!o.embed){if(["ctrl+s","cmd+s"].includes(i)&&(t.preventDefault(),o.saveToComputer.save()),["ctrl+shift+s","cmd+shift+s"].includes(i)){t.preventDefault();var r=o;(0,a.default)((function(){var e,t;return(0,u.__generator)(this,(function(i){switch(i.label){case 0:e=!0,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,z.store(r.klCanvas.getProject())];case 2:return i.sent(),[3,4];case 3:return t=i.sent(),e=!1,setTimeout((function(){throw new Error("keyboard-shortcut: failed to store browser storage, "+t)}),0),r.statusOverlay.out("❌ "+(0,B.LANG)("file-storage-failed"),!0),[3,4];case 4:return e&&(n.saveReminder.reset(),r.statusOverlay.out((0,B.LANG)("file-storage-stored"),!0)),[2]}}))}))()}["ctrl+c","cmd+c"].includes(i)&&(t.preventDefault(),ye(!0))}if(["ctrl+a","cmd+a"].includes(i)&&t.preventDefault(),ee.comboOnlyContains(["left","right","up","down"])&&("left"===e&&o.klCanvasWorkspace.translateView(1,0),"right"===e&&o.klCanvasWorkspace.translateView(-1,0),"up"===e&&o.klCanvasWorkspace.translateView(0,1),"down"===e&&o.klCanvasWorkspace.translateView(0,-1)),["r+left","r+right"].includes(i)&&("left"===e&&(o.klCanvasWorkspace.setAngle(-15,!0),oe.update(o.klCanvasWorkspace.getScale(),o.klCanvasWorkspace.getAngleDeg())),"right"===e&&(o.klCanvasWorkspace.setAngle(15,!0),oe.update(o.klCanvasWorkspace.getScale(),o.klCanvasWorkspace.getAngleDeg()))),["r+up"].includes(i)&&(o.klCanvasWorkspace.setAngle(0),oe.update(o.klCanvasWorkspace.getScale(),o.klCanvasWorkspace.getAngleDeg())),"sqbr_open"===i&&F.decreaseSize(.03/o.klCanvasWorkspace.getScale()),"sqbr_close"===i&&F.increaseSize(.03/o.klCanvasWorkspace.getScale()),"enter"===i&&(o.klCanvas.layerFill(o.klCanvas.getLayerIndex(X.canvas),o.klColorSlider.getColor()),o.statusOverlay.out((0,B.LANG)("filled"),!0)),["delete","backspace"].includes(i)){var s=o.klCanvas.getLayerIndex(X.canvas);0!==s||te.eraserBrush.getIsTransparentBg()?o.klCanvas.clearLayer(s):o.klCanvas.layerFill(s,{r:255,g:255,b:255},"source-in"),o.statusOverlay.out((0,B.LANG)("cleared-layer"),!0)}if("e"===i&&(t.preventDefault(),o.klCanvasWorkspace.setMode("draw"),o.toolspaceToolRow.setActive("draw"),G&&G.open("draw"),$(),se.open("eraserBrush")),"b"===i){t.preventDefault();var l=o.klCanvasWorkspace.getMode();o.klCanvasWorkspace.setMode("draw"),o.toolspaceToolRow.setActive("draw"),G&&G.open("draw"),$(),se.open("draw"===l?function(){if("eraserBrush"===W)return V;var e=Object.keys(te).filter((function(e){return"eraserBrush"!==e})),t=e.findIndex((function(e){return e===W}));return e[(t+1)%e.length]}():W)}if("g"===i){t.preventDefault();var h="fill"===o.klCanvasWorkspace.getMode()?"gradient":"fill";o.klCanvasWorkspace.setMode(h),o.toolspaceToolRow.setActive(h),G&&G.open(h),$()}"t"===i&&(t.preventDefault(),o.klCanvasWorkspace.setMode("text"),o.toolspaceToolRow.setActive("text"),G&&G.open("text"),$()),"u"===i&&(t.preventDefault(),o.klCanvasWorkspace.setMode("shape"),o.toolspaceToolRow.setActive("shape"),G&&G.open("shape"),$()),"x"===i&&(t.preventDefault(),o.klColorSlider.swapColors())}},onUp:function(e,t){}}),te={};Object.entries(p.KL.brushesUI).forEach((function(e){var t=(0,h.default)(e,2),i=t[0],n=new t[1].Ui({onSizeChange:K,onOpacityChange:function(e){Y.emitOpacity(e)},onConfigChange:function(){Y.emitSliderConfig({sizeSlider:p.KL.brushesUI[W].sizeSlider,opacitySlider:p.KL.brushesUI[W].opacitySlider})}});te[i]=n,n.getElement().style.padding="10px"})),this.statusOverlay=new p.KL.StatusOverlay,this.toolspace=g.BB.el({className:"kl-toolspace",css:{position:"absolute",right:"0",top:"0",bottom:"0",width:this.toolWidth-1+"px",overflow:"hidden",userSelect:"none",touchAction:"none"}}),this.toolspaceInner=g.BB.el({parent:this.toolspace}),this.toolspace.oncontextmenu=function(){return!1},this.toolspace.onclick=g.BB.handleClick,this.toolspaceCollapser=new p.KL.ToolspaceCollapser({onChange:function(){o.updateCollapse()}}),this.updateCollapse(),setTimeout((function(){Z=new p.KL.OverlayToolspace({enabledTest:function(){return 0===p.KL.dialogCounter.get()&&!o.lineSanitizer.getIsDrawing()},brushSettingService:Y}),o.klRootEl.append(Z.getElement())}),0),g.BB.append(this.klRootEl,[this.klCanvasWorkspace.getElement(),this.toolspace,this.toolspaceCollapser.getElement()]),J=this.embed?new(0,v.EmbedToolspaceTopRow)({onHelp:function(){(0,f.showIframeModal)(o.embed.url+"/help.html",!!o.embed)},onSubmit:function(){var e,t=o;p.KL.popup({target:o.klRootEl,message:(0,B.LANG)("submit-prompt"),buttons:[(0,B.LANG)("submit"),"Cancel"],callback:(e=(0,a.default)((function(e){var i;return(0,u.__generator)(this,(function(r){return e!==(0,B.LANG)("submit")||(i=g.BB.el({parent:t.klRootEl,className:"upload-overlay",content:'<div class="spinner"></div> '+(0,B.LANG)("submit-submitting")}),t.embed.onSubmit((function(){n.saveReminder.reset(),t.klRootEl.removeChild(i)}),(function(){t.klRootEl.removeChild(i)}))),[2]}))})),function(t){return e.apply(this,arguments)})})},onLeftRight:function(){o.uiState="left"===o.uiState?"right":"left",o.updateUi()}}):new p.KL.ToolspaceTopRow({logoImg:n.logoImg,onLogo:function(){(0,f.showIframeModal)("./home/",!!o.embed)},onNew:function(){ve()},onImport:function(){xe.triggerImport()},onSave:function(){o.saveToComputer.save()},onShare:function(){me()},onHelp:function(){(0,f.showIframeModal)("./help/",!!o.embed)}}),J.getElement().style.marginBottom="10px",this.toolspaceInner.append(J.getElement()),this.toolspaceToolRow=new p.KL.ToolspaceToolRow({onActivate:function(e){if("draw"===e)o.klCanvasWorkspace.setMode("draw");else if("hand"===e)o.klCanvasWorkspace.setMode("hand");else if("fill"===e)o.klCanvasWorkspace.setMode("fill");else if("gradient"===e)o.klCanvasWorkspace.setMode("gradient");else if("text"===e)o.klCanvasWorkspace.setMode("text");else{if("shape"!==e)throw new Error("unknown activeStr");o.klCanvasWorkspace.setMode("shape")}G&&G.open(e),$(),o.klColorSlider.pickingDone()},onZoomIn:function(){o.klCanvasWorkspace.zoomByStep(ee.isPressed("shift")?1/8:.5)},onZoomOut:function(){o.klCanvasWorkspace.zoomByStep(ee.isPressed("shift")?-1/8:-.5)},onUndo:function(){fe.undo()},onRedo:function(){fe.redo()}}),this.toolspaceToolRow.setIsSmall(this.uiHeight<540),d.klHistory.addListener((function(){o.toolspaceToolRow.setEnableUndo(d.klHistory.canUndo()),o.toolspaceToolRow.setEnableRedo(d.klHistory.canRedo())})),this.toolspaceInner.append(this.toolspaceToolRow.getElement());this.klColorSlider=new p.KL.KlColorSlider({width:250,height:30,svHeight:100,startValue:new g.BB.RGB(0,0,0),onPick:function(e){U=e,F.setColor(e),Y.emitColor(e),o.klColorSlider.pickingDone()}}),this.klColorSlider.setHeight(Math.max(163,Math.min(400,this.uiHeight-505))),this.klColorSlider.setPickCallback((function(e){e?o.klCanvasWorkspace.setMode("pick"):(o.klCanvasWorkspace.setMode(o.toolspaceToolRow.getActive()),$())}));var ie=function(e){X=e.context,F.setContext(e.context),o.layerPreview.setLayer(e)},ne=g.BB.el(),re=g.BB.el({css:{margin:"10px",display:"flex",flexWrap:"wrap",justifyContent:"space-between",alignItems:"flex-end"}}),ae=new p.KL.ToolspaceStabilizerRow({smoothing:1,onSelect:function(e){_.setSmoothing((0,C.translateSmoothing)(e))}});ne.append(re),g.BB.append(re,[this.klColorSlider.getElement(),this.klColorSlider.getOutputElement(),ae.getElement()]);var se=new p.KL.TabRow({initialId:"penBrush",useAccent:!0,tabArr:function(){for(var e=[],t=function(e){return{id:e,image:p.KL.brushesUI[e].image,title:p.KL.brushesUI[e].tooltip,onOpen:function(){var t;te[e].getElement().style.display="block","eraserBrush"!==(t=e)&&(V=t),o.klColorSlider&&("eraserBrush"===t?o.klColorSlider.enable(!1):o.klColorSlider.enable(!0)),W=t,(F=te[t]).setColor(U),F.setContext(X),o.klCanvasWorkspace.setMode("draw"),o.toolspaceToolRow.setActive("draw"),$(),o.klColorSlider.pickingDone(),Y.emitSliderConfig({sizeSlider:p.KL.brushesUI[e].sizeSlider,opacitySlider:p.KL.brushesUI[e].opacitySlider}),K(te[e].getSize()),Y.emitOpacity(te[e].getOpacity())},onClose:function(){te[e].getElement().style.display="none"}}},i=Object.keys(te),n=0;n<i.length;n++)e.push(t(i[n]));return e}()});g.BB.append(ne,[se.getElement()].concat((0,c.default)(Object.entries(p.KL.brushesUI).map((function(e){var t=(0,h.default)(e,1)[0];return te[t].getElement()})))));var oe=new p.KL.HandUi({scale:1,angleDeg:0,onReset:function(){o.klCanvasWorkspace.resetView(!0),oe.update(o.klCanvasWorkspace.getScale(),o.klCanvasWorkspace.getAngleDeg())},onFit:function(){o.klCanvasWorkspace.fitView(),oe.update(o.klCanvasWorkspace.getScale(),o.klCanvasWorkspace.getAngleDeg())},onAngleChange:function(e,t){o.klCanvasWorkspace.setAngle(e,t),oe.update(o.klCanvasWorkspace.getScale(),o.klCanvasWorkspace.getAngleDeg())}}),le=new p.KL.FillUi({colorSlider:this.klColorSlider}),he=new p.KL.GradientUi({colorSlider:this.klColorSlider}),ce=new p.KL.TextUi({colorSlider:this.klColorSlider}),ue=new p.KL.ShapeUi({colorSlider:this.klColorSlider}),pe=new p.KL.GradientTool({onGradient:function(e,t,i,n,r,a){var s=o.klCanvas.getLayerIndex(X.canvas),l=he.getSettings(),h={type:l.type,color1:o.klColorSlider.getColor(),isReversed:l.isReversed,opacity:l.opacity,doLockAlpha:l.doLockAlpha,isEraser:l.isEraser,doSnap:ee.isPressed("shift")||l.doSnap,x1:t,y1:i,x2:n,y2:r,angleRad:a};e?(o.klCanvas.setComposite(s,null),o.klCanvas.drawGradient(s,h)):o.klCanvas.setComposite(s,{draw:function(e){p.KL.drawGradient(e,h)}}),o.klCanvasWorkspace.requestFrame()}}),de=new p.KL.ShapeTool({onShape:function(e,t,i,n,r,a){var s=o.klCanvas.getLayerIndex(X.canvas),l={type:ue.getShape(),x1:t,y1:i,x2:n,y2:r,angleRad:a,isOutwards:ue.getIsOutwards(),opacity:ue.getOpacity(),isEraser:ue.getIsEraser(),doLockAlpha:ue.getDoLockAlpha()};"line"===ue.getShape()?(l.strokeRgb=o.klColorSlider.getColor(),l.lineWidth=ue.getLineWidth(),l.isAngleSnap=ue.getIsSnap()||ee.isPressed("shift")):(l.isFixedRatio=ue.getIsFixed()||ee.isPressed("shift"),"stroke"===ue.getMode()?(l.strokeRgb=o.klColorSlider.getColor(),l.lineWidth=ue.getLineWidth()):l.fillRgb=o.klColorSlider.getColor()),e?(o.klCanvas.setComposite(s,null),o.klCanvas.drawShape(s,l)):o.klCanvas.setComposite(s,{draw:function(e){p.KL.drawShape(e,l)}}),o.klCanvasWorkspace.requestFrame()}});this.layerManager=new p.KL.LayerManager(this.klCanvas,(function(e){ie(o.klCanvas.getLayer(e)),d.klHistory.push({tool:["misc"],action:"focusLayer",params:[e]})}),this.klRootEl,this.uiState),this.layerPreview=new p.KL.LayerPreview({klRootEl:this.klRootEl,onClick:function(){G&&G.open("layers")},uiState:this.uiState}),this.layerPreview.setIsVisible(this.uiHeight>=579),this.layerPreview.setLayer(this.klCanvas.getLayer(this.klCanvas.getLayerIndex(X.canvas)));var ge=new p.KL.FilterTab(this.klRootEl,this.klColorSlider,this.layerManager,this.klCanvasWorkspace,oe,(function(){return U}),(function(){return y}),(function(){return o.klCanvas}),(function(){return X}),!!this.embed,this.statusOverlay),fe=new p.KL.UndoRedoCatchup(te,this.layerPreview,this.layerManager,oe,this.klCanvasWorkspace,(function(){if(!H)throw new Error("initState not initialized");return H}),(function(){return o.klCanvas}),(function(){return X}),(function(e){X=e}),(function(){return F}));d.klHistory.addListener((function(e){fe.catchup(e)}));var ve=function(){p.KL.newImageDialog({currentColor:U,secondaryColor:o.klColorSlider.getSecondaryRGB(),maxCanvasSize:y,canvasWidth:o.klCanvas.getWidth(),canvasHeight:o.klCanvas.getHeight(),workspaceWidth:window.innerWidth<o.collapseThreshold?o.uiWidth:o.uiWidth-o.toolWidth,workspaceHeight:o.uiHeight,onConfirm:function(e,t,i){o.klCanvas.reset({width:e,height:t,color:1===i.a?i:null}),o.layerManager.update(0),ie(o.klCanvas.getLayer(0)),o.klCanvasWorkspace.resetView(),oe.update(o.klCanvasWorkspace.getScale(),o.klCanvasWorkspace.getAngleDeg())},onCancel:function(){}})},me=function(e){g.BB.shareCanvas({canvas:o.klCanvas.getCompleteCanvas(1),fileName:g.BB.getDate()+N+".png",title:g.BB.getDate()+N+".png",callback:e||function(){}})};this.saveToComputer=new p.KL.SaveToComputer(n.saveReminder,this.klRootEl,(function(){return j}),(function(){return o.klCanvas}),N);var ye=function(e){p.KL.clipboardDialog(o.klRootEl,o.klCanvas.getCompleteCanvas(1),(function(e){0===e.left&&0===e.right&&0===e.top&&0===e.bottom||(p.KL.filterLib.cropExtend.apply({context:X,klCanvas:o.klCanvas,input:e,history:d.klHistory}),o.layerManager.update(),o.klCanvasWorkspace.resetView(),oe.update(o.klCanvasWorkspace.getScale(),o.klCanvasWorkspace.getAngleDeg()))}),o.statusOverlay,e||!1)},xe=this.embed?null:new p.KL.FileTab(this.klRootEl,z,(function(){return o.klCanvas.getProject()}),j,(function(e){j=e}),(function(e,t){return be.handleFileSelect(e,t)}),(function(){return o.saveToComputer.save()}),ve,me,(function(){p.KL.imgurUpload(o.klCanvas,o.klRootEl,n.saveReminder,n.app&&n.app.imgurKey?n.app.imgurKey:null)}),ye,n.saveReminder),Be=new p.KL.SettingsTab((function(){o.uiState="left"===o.uiState?"right":"left",o.updateUi(),o.embed||b.LocalStorage.setItem("uiState",o.uiState)}),n.aboutEl);(G=new p.KL.TabRow({initialId:"draw",tabArr:[{id:"draw",title:(0,B.LANG)("tool-brush"),image:t(L),onOpen:function(){"eraserBrush"===W&&o.klColorSlider.enable(!1),g.BB.append(re,[o.klColorSlider.getElement(),o.klColorSlider.getOutputElement(),ae.getElement()]),ne.style.display="block"},onClose:function(){ne.style.display="none"},css:{minWidth:"45px"}},{id:"hand",title:(0,B.LANG)("tool-hand"),image:t(A),isVisible:!1,onOpen:function(){oe.setIsVisible(!0)},onClose:function(){oe.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"fill",title:(0,B.LANG)("tool-paint-bucket"),image:t(I),isVisible:!1,onOpen:function(){o.klColorSlider.enable(!0),le.setIsVisible(!0)},onClose:function(){le.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"gradient",title:(0,B.LANG)("tool-gradient"),image:t(E),isVisible:!1,onOpen:function(){o.klColorSlider.enable(!0),he.setIsVisible(!0)},onClose:function(){he.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"text",title:(0,B.LANG)("tool-text"),image:t(T),isVisible:!1,onOpen:function(){o.klColorSlider.enable(!0),ce.setIsVisible(!0)},onClose:function(){ce.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"shape",title:(0,B.LANG)("tool-shape"),image:t(M),isVisible:!1,onOpen:function(){o.klColorSlider.enable(!0),ue.setIsVisible(!0)},onClose:function(){ue.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"layers",title:(0,B.LANG)("layers"),image:t(O),onOpen:function(){o.layerManager.update(),o.layerManager.getElement().style.display="block"},onClose:function(){o.layerManager.getElement().style.display="none"},css:{minWidth:"45px"}},{id:"edit",label:(0,B.LANG)("tab-edit"),onOpen:function(){ge.show()},onClose:function(){ge.hide()},css:{padding:"0 7px"}},{id:"file",label:(0,B.LANG)("tab-file"),isVisible:!!xe,onOpen:function(){xe&&(xe.getElement().style.display="block",xe.setIsVisible(!0))},onClose:function(){xe&&(xe.getElement().style.display="none",xe.setIsVisible(!1))},css:{padding:"0 7px"}},{id:"settings",title:(0,B.LANG)("tab-settings"),image:t(P),onOpen:function(){Be.getElement().style.display="block"},onClose:function(){Be.getElement().style.display="none"},css:{minWidth:"45px"}}]}),this.bottomBarWrapper=g.BB.el({css:{width:"270px",position:"absolute",bottom:"0",left:"0"}}),n.bottomBar)&&(this.bottomBar=n.bottomBar,this.bottomBarWrapper.append(this.bottomBar),new MutationObserver((function(){return o.updateBottomBar()})).observe(this.toolspaceInner,{attributes:!0,childList:!0,subtree:!0}));g.BB.append(this.toolspaceInner,[this.layerPreview.getElement(),G.getElement(),ne,oe.getElement(),le.getElement(),he.getElement(),ce.getElement(),ue.getElement(),this.layerManager.getElement(),ge.getElement(),xe?xe.getElement():void 0,Be.getElement(),g.BB.el({css:{height:"10px"}}),this.bottomBarWrapper?this.bottomBarWrapper:void 0]),this.toolspaceScroller=new p.KL.ToolspaceScroller({toolspace:this.toolspace,uiState:this.uiState}),this.embed||Object.defineProperty(window,"KL",{value:(0,R.createConsoleApi)({onDraw:function(e){e&&0!==e.length&&(e.forEach((function(e,t){0===t?F.startLine(e.x,e.y,1):F.goLine(e.x,e.y,1)})),F.endLine(),o.klCanvasWorkspace.requestFrame())}}),writable:!1}),this.resize(this.uiWidth,this.uiHeight),this.updateUi();var be=new(0,S.ImportHandler)({klRootEl:this.klRootEl,klMaxCanvasSize:y,layerManager:this.layerManager,setCurrentLayer:ie,klCanvas:this.klCanvas,klCanvasWorkspace:this.klCanvasWorkspace,handUi:oe},{onColor:function(e){return Y.setColor(e)}});this.embed||(new p.KL.KlImageDropper({target:document.body,onDrop:function(e,t){p.KL.dialogCounter.get()>0||be.handleFileSelect(e,t)},enabledTest:function(){return 0===p.KL.dialogCounter.get()}}),window.addEventListener("paste",(function(e){return be.onPaste(e)}),!1)),window.addEventListener("resize",(function(){o.resize(window.innerWidth,window.innerHeight)})),window.addEventListener("orientationchange",(function(){o.resize(window.innerWidth,window.innerHeight)}));var we=g.BB.el({parent:document.body,css:{position:"fixed",left:"0",top:"0",right:"0",bottom:"0",pointerEvents:"none",zIndex:"-1",userSelect:"none"}});try{new ResizeObserver((function(){return o.resize(window.innerWidth,window.innerHeight)})).observe(we)}catch(e){we.parentNode.removeChild(we)}this.klRootEl.addEventListener("wheel",(function(e){ee.isPressed("ctrl")&&e.preventDefault()}));var ke=function(e){e.preventDefault()};window.addEventListener("gesturestart",ke),window.addEventListener("gesturechange",ke),window.addEventListener("gestureend",ke)}return(0,o.default)(e,[{key:"updateCollapse",value:function(){this.uiWidth<this.collapseThreshold?(this.toolspaceCollapser.getElement().style.display="block",this.toolspaceCollapser.setDirection(this.uiState),this.toolspaceCollapser.isOpen()?("left"===this.uiState?(g.BB.css(this.toolspaceCollapser.getElement(),{left:"271px",right:""}),g.BB.css(this.klCanvasWorkspace.getElement(),{left:"271px"})):(g.BB.css(this.toolspaceCollapser.getElement(),{left:"",right:"271px"}),g.BB.css(this.klCanvasWorkspace.getElement(),{left:"0"})),this.toolspace.style.display="block",this.klCanvasWorkspace.setSize(Math.max(0,this.uiWidth-this.toolWidth),this.uiHeight),this.statusOverlay.setWide(!1)):("left"===this.uiState?(g.BB.css(this.toolspaceCollapser.getElement(),{left:"0",right:""}),g.BB.css(this.klCanvasWorkspace.getElement(),{left:"0"})):(g.BB.css(this.toolspaceCollapser.getElement(),{left:"",right:"0"}),g.BB.css(this.klCanvasWorkspace.getElement(),{left:"0"})),this.toolspace.style.display="none",this.klCanvasWorkspace.setSize(Math.max(0,this.uiWidth),this.uiHeight),this.statusOverlay.setWide(!0))):(this.toolspaceCollapser.getElement().style.display="none","left"===this.uiState?g.BB.css(this.klCanvasWorkspace.getElement(),{left:"271px"}):g.BB.css(this.klCanvasWorkspace.getElement(),{left:"0"}),this.toolspace.style.display="block",this.klCanvasWorkspace.setSize(Math.max(0,this.uiWidth-this.toolWidth),this.uiHeight),this.statusOverlay.setWide(!1))}},{key:"updateBottomBar",value:function(){if(this.bottomBar){var e=this.toolspaceInner.scrollHeight+40<window.innerHeight;this.bottomBarWrapper.style.display=e?"":"none"}}},{key:"updateUi",value:function(){this.toolspace.classList.toggle("kl-toolspace--left","left"===this.uiState),this.toolspace.classList.toggle("kl-toolspace--right","right"===this.uiState),"left"===this.uiState?(g.BB.css(this.toolspace,{left:"0",right:""}),g.BB.css(this.klCanvasWorkspace.getElement(),{left:"271px"})):(g.BB.css(this.toolspace,{left:"",right:"0"}),g.BB.css(this.klCanvasWorkspace.getElement(),{left:"0"})),this.statusOverlay.setUiState(this.uiState),this.layerPreview.setUiState(this.uiState),this.layerManager.setUiState(this.uiState),this.updateCollapse(),this.toolspaceScroller.updateUiState(this.uiState)}},{key:"getEl",value:function(){return this.klRootEl}},{key:"resize",value:function(e,t){window.scrollY>0&&window.scrollTo(0,0),this.uiWidth===Math.max(0,e)&&this.uiHeight===Math.max(0,t)||(this.uiWidth=Math.max(0,e),this.uiHeight=Math.max(0,t),this.updateCollapse(),this.updateBottomBar(),this.layerPreview.setIsVisible(this.uiHeight>=579),this.klColorSlider.setHeight(Math.max(163,Math.min(400,this.uiHeight-505))),this.toolspaceToolRow.setIsSmall(this.uiHeight<540))}},{key:"out",value:function(e){this.statusOverlay.out(e)}},{key:"getPNG",value:function(){return(0,y.base64ToBlob)(this.klCanvas.getCompleteCanvas(1).toDataURL("image/png"))}},{key:"getProject",value:function(){return this.klCanvas.getProject()}},{key:"swapUiLeftRight",value:function(){this.uiState="left"===this.uiState?"right":"left",this.embed||b.LocalStorage.setItem("uiState",this.uiState),this.updateUi()}},{key:"saveAsPsd",value:function(){this.saveToComputer.save("psd")}},{key:"isDrawing",value:function(){return this.lineSanitizer.getIsDrawing()||this.klCanvasWorkspace.getIsDrawing()}}]),e}()})),i.register("4Ea8f",(function(t,n){e(t.exports,"default",(function(){return l}));var r=i("3wEFn"),a=i("8XIsj"),s=i("hhqk6"),o=i("jBmMa");function l(e){return(0,r.default)(e)||(0,a.default)(e)||(0,o.default)(e)||(0,s.default)()}})),i.register("3wEFn",(function(t,n){e(t.exports,"default",(function(){return a}));var r=i("apgdg");function a(e){if(Array.isArray(e))return(0,r.default)(e)}})),i.register("hhqk6",(function(t,i){function n(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}e(t.exports,"default",(function(){return n}))})),i.register("hrnUX",(function(t,n){e(t.exports,"KL",(function(){return we}));var r=i("gWfkn"),a=i("2MaaK"),s=i("dLlkc"),o=i("i8UFO"),l=i("7bWhB"),h=i("dJPtW"),c=i("eEL9N"),u=i("1kyaA"),p=i("4nUqS"),d=i("lCF5N"),g=i("aP0jf"),f=i("11glk"),v=i("lfHl9"),m=i("fg9Sv"),y=i("gmji4"),x=i("j5jvd"),B=i("43qNf"),b=i("iFIyy"),w=i("bmB93"),k=i("hRdOL"),C=i("isYih"),S=i("jMW1P"),L=i("7bo3M"),A=i("lV6Vy"),I=i("i5nyl"),E=i("cNhNm"),T=i("kEeSq"),M=i("32CBv"),P=i("kqmpc"),O=i("8ebuX"),R=i("13r5y"),D=i("9p4Zp"),N=i("8jqzp"),z=i("84zxV"),j=i("9Kxky"),G=i("1Ax5m"),H=i("e4sAN"),F=i("khi8I"),W=i("dJXmR"),V=i("iS9xS"),U=i("9J17G"),X=i("76Qvv"),K=i("1uc3b"),Y=i("h20yl"),_=i("keKW3"),q=i("kDGzx"),Q=i("30Cml"),Z=i("941rU"),J=i("3ujzu"),$=i("705qg"),ee=i("9BlwZ"),te=(ee=i("9BlwZ"),i("kyVjY")),ie=i("dAXbp"),ne=i("3P46L"),re=i("h62LS"),ae=i("fRGIf"),se=i("9pcu9"),oe=i("aSJRf"),le=i("6mTnI"),he=i("eK8ID"),ce=i("2umOB"),ue=i("5ENro"),pe=i("lkluh"),de=i("5ngYX"),ge=i("eyygR"),fe=i("6rdi0"),ve=i("7pyBK"),me=i("cmnov"),ye=i("bIgqE"),xe=i("iVHpg"),Be=i("5Gc7M"),be=i("7EG77"),we={brushes:ie.brushes,brushesUI:ne.brushesUI,BrushSettingService:ve.BrushSettingService,KlCanvas:$.KlCanvas,drawProject:oe.drawProject,WorkspaceSvgOverlay:L.WorkspaceSvgOverlay,KlCanvasWorkspace:A.KlCanvasWorkspace,KlCanvasPreview:I.KlCanvasPreview,filterLibStatus:te.filterLibStatus,filterLib:te.filterLib,UndoRedoCatchup:fe.UndoRedoCatchup,renderText:Y.renderText,floodFillBits:Q.floodFillBits,ShapeTool:J.ShapeTool,drawShape:J.drawShape,GradientTool:be.GradientTool,drawGradient:be.drawGradient,PSD:Z,setDbName:ee.setDbName,indexedDb:ee,ProjectStore:le.ProjectStore,loadAgPsd:pe.loadAgPsd,SaveToComputer:ge.SaveToComputer,calcSliderFalloffFactor:f.calcSliderFalloffFactor,Checkbox:l.Checkbox,input:h.input,Select:c.Select,ImageToggle:u.ImageToggle,ImageRadioList:p.ImageRadioList,RadioList:ae.RadioList,createPenPressureToggle:d.createPenPressureToggle,KlSlider:g.KlSlider,HexColorDialog:v.HexColorDialog,KlColorSlider:m.KlColorSlider,KlColorSliderSmall:y.KlColorSliderSmall,PointSlider:x.PointSlider,ColorOptions:B.ColorOptions,Options:b.Options,BoxToggle:me.BoxToggle,StatusOverlay:w.StatusOverlay,CropCopy:k.CropCopy,FreeTransform:E.FreeTransform,FreeTransformCanvas:T.FreeTransformCanvas,Cropper:M.Cropper,LayerPreview:P.LayerPreview,KlImageDropper:R.KlImageDropper,OverlayToolspace:D.OverlayToolspace,ToolspaceTopRow:N.ToolspaceTopRow,ToolDropdown:z.ToolDropdown,ToolspaceToolRow:j.ToolspaceToolRow,ToolspaceStabilizerRow:G.ToolspaceStabilizerRow,TabRow:H.TabRow,ToolspaceCollapser:K.ToolspaceCollapser,BrowserStorageUi:se.BrowserStorageUi,SaveReminder:de.SaveReminder,ToolspaceScroller:xe.ToolspaceScroller,dialogCounter:o.dialogCounter,popup:a.showModal,Popup:s.DynamicModal,clipboardDialog:C.clipboardDialog,showImportAsLayerDialog:O.showImportAsLayerDialog,newImageDialog:X.newImageDialog,textToolDialog:_.textToolDialog,showImportImageDialog:q.showImportImageDialog,showIframePopup:re.showIframeModal,imgurUpload:ue.imgurUpload,HandUi:F.HandUi,FillUi:W.FillUi,GradientUi:Be.GradientUi,TextUi:V.TextUi,ShapeUi:U.ShapeUi,FileTab:he.FileTab,FilterTab:ce.FilterTab,SettingsTab:ye.SettingsTab,LayerManager:S.LayerManager,klHistory:r.klHistory,DecoyKlHistory:r.DecoyKlHistory}})),i.register("gWfkn",(function(t,n){e(t.exports,"DecoyKlHistory",(function(){return c})),e(t.exports,"klHistory",(function(){return u}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("4Ea8f"),l=i("7jh4K"),h=!1,c=function(){"use strict";function e(){(0,r.default)(this,e)}return(0,a.default)(e,[{key:"pause",value:function(){}},{key:"addListener",value:function(){}},{key:"push",value:function(){}},{key:"undo",value:function(){return[]}},{key:"redo",value:function(){}},{key:"getAll",value:function(){return[]}},{key:"canRedo",value:function(){return!1}},{key:"canUndo",value:function(){return!1}},{key:"getState",value:function(){return 0}},{key:"getActionNumber",value:function(){return 0}}]),e}(),u=new(function(){"use strict";function e(){if((0,r.default)(this,e),(0,s.default)(this,"max",20),h)throw new Error("klHistory already instantiated");h=!0,this.state=0,this.entries=[],this.listeners=[],this.pauseStack=0,this.maxState=-1,this.actionNumber=-1}return(0,a.default)(e,[{key:"broadcast",value:function(e){var t=this;setTimeout((function(){for(var i=0;i<t.listeners.length;i++)t.listeners[i](e);t.state++}),1)}},{key:"pause",value:function(e){e?this.pauseStack++:this.pauseStack=Math.max(0,this.pauseStack-1)}},{key:"addListener",value:function(e){this.listeners.push(e)}},{key:"push",value:function(e){if(!(this.pauseStack>0)){for(;this.actionNumber<this.entries.length-1;)this.entries.pop();var t=this.entries[this.entries.length-1];if(t&&"canvas"===e.tool[0]&&"canvas"===t.tool[0]&&"layerOpacity"===e.action&&"layerOpacity"===t.action&&t.params[0]===e.params[0])return this.entries[this.entries.length-1]=e,void this.state++;if("focusLayer"===e.action&&t&&"focusLayer"===t.action)return this.entries[this.entries.length-1]=e,void this.state++;this.entries[this.entries.length]=e,this.actionNumber=this.entries.length-1;var i=this.maxState;if(this.maxState=Math.max(this.maxState,this.actionNumber-this.max),i<this.maxState){var n=this.entries[this.maxState];if(!n)throw new Error("this.dataArr[this.maxState] null");this.broadcast({bufferUpdate:n})}else this.broadcast(null);this.maxState>=0&&(this.entries[this.maxState]=null)}}},{key:"undo",value:function(){var e=[];if(!this.canUndo())return e;for(var t=this.maxState+1;t<this.actionNumber;t++)e.push((0,l.throwIfNull)(this.entries[t]));return this.actionNumber--,this.broadcast(null),e}},{key:"redo",value:function(){if(this.canRedo())return this.actionNumber++,this.broadcast(null),(0,l.throwIfNull)(this.entries[this.actionNumber])}},{key:"getAll",value:function(){return(0,o.default)(this.entries)}},{key:"canRedo",value:function(){return this.actionNumber<this.entries.length-1}},{key:"canUndo",value:function(){return this.actionNumber>this.maxState}},{key:"getState",value:function(){return this.state}},{key:"getActionNumber",value:function(){return this.actionNumber+1}}]),e}())})),i.register("2MaaK",(function(n,r){e(n.exports,"showModal",(function(){return c}));var a=i("i8UFO"),s=i("eWjiX"),o=i("1mH1z");i("8zjca");var l=i("6ToP3"),h=i("d2FVM");function c(e){var i=function(t){n||(n=!0,s.BB.clearSelection(),s.BB.unfocusAnyInput(),document.body.removeChild(r),a.dialogCounter.decrease(),s.BB.destroyEl(d),s.BB.destroyEl(p),m.destroy(),c.removeEventListener("wheel",y),c.onclick=null,b.forEach((function(e){return s.BB.destroyEl(e)})),b.splice(0,b.length),e.callback&&e.callback(t))};a.dialogCounter.increase();var n=!1,r=s.BB.el({parent:document.body,css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",overflow:"hidden"}}),c=s.BB.el({parent:r,className:"kl-popup"}),u=s.BB.el({parent:c,css:{width:"100%",minHeight:"100%",position:"relative",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}}),p=s.BB.el({parent:u,onClick:function(){e.ignoreBackground||i("Cancel")},css:{position:"absolute",left:"0",top:"0",zIndex:"0",width:"100%",height:"100%"}}),d=s.BB.el({tagName:"button",className:"popup-x",content:'<img alt="'.concat((0,o.LANG)("modal-close"),'" height="20" src="').concat(t(l),'">'),title:(0,o.LANG)("modal-close"),onClick:function(){i("Cancel")},css:{width:"40px",height:"40px",lineHeight:"40px",position:"absolute",right:"0",top:"0",background:"none",boxShadow:"none"}}),g=["kl-popup-box"];g.push("kl-popup-box--sm");var f=s.BB.el({content:[d,s.BB.el({content:e.message,css:{marginBottom:e.div?"10px":void 0,marginRight:"15px"}}),e.div],className:g.join(" "),css:e.style?e.style:void 0});u.append(s.BB.el({css:{flex:"0.5"}}),f,s.BB.el({css:{flex:"1"}})),"error"===e.type&&f.classList.add("poperror"),"ok"===e.type&&f.classList.add("popok"),"warning"===e.type&&f.classList.add("popwarning"),"upload"===e.type&&f.classList.add("popupload");var v,m=new s.BB.KeyListener({onDown:function(e,t,r){n||(x&&"enter"===r&&!s.BB.isInputFocused()&&(t.stopPropagation(),setTimeout((function(){x&&x.click()}),10)),"esc"===r&&(t.stopPropagation(),i("Cancel")))}}),y=function(e){m.isPressed("ctrl")&&e.preventDefault()};c.addEventListener("wheel",y),c.onclick=s.BB.handleClick,v=e.autoFocus?e.autoFocus:!1===e.autoFocus?void 0:"Ok";var x,B=e.buttons&&e.buttons.length>0?s.BB.el({parent:f,css:{display:"flex",flexWrap:"wrap",justifyContent:"flex-end",marginTop:"12px",marginLeft:"-8px"}}):null,b=[];e.buttons&&e.buttons.forEach((function(n){var r,a=["kl-popup__btn"];("Ok"===n||e.primaries&&e.primaries.includes(n))&&a.push("kl-button-primary");var u=n;"Ok"===n&&(u=(0,o.LANG)("modal-ok"),r=t(h)),"Cancel"===n&&(u=(0,o.LANG)("modal-cancel"),r=t(l),a.push("kl-button-cancel"));var p=null;r&&(p=s.BB.el({tagName:"img",custom:{src:r,height:"17"}}));var d=s.BB.el({parent:B||void 0,tagName:"button",className:a.join(" "),content:[p||void 0,s.BB.el({className:"kl-popup__btn__text",content:u})],onClick:function(){i(n)}});b.push(d),v===n&&(setTimeout((function(){d.focus(),c.scrollTo(0,0)}),10),setTimeout((function(){c.scrollTo(0,0)}),20)),n===e.clickOnEnter&&(x=d)})),e.closeFunc&&e.closeFunc((function(){i("Cancel")}))}})),i.register("i8UFO",(function(t,n){e(t.exports,"dialogCounter",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=new(function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"listeners",[]),(0,s.default)(this,"count",0)}return(0,a.default)(e,[{key:"emit",value:function(){var e=this;this.listeners.forEach((function(t){t(e.count)}))}},{key:"increase",value:function(e){void 0!==e?this.count+=e:this.count++,this.emit()}},{key:"decrease",value:function(e){void 0!==e?this.count-=e:this.count--,this.emit()}},{key:"get",value:function(){return this.count}},{key:"subscribe",value:function(e){this.listeners.push(e)}}]),e}())})),i.register("eWjiX",(function(t,n){e(t.exports,"BB",(function(){return C}));var r=i("7jh4K"),a=i("6J2My"),s=i("idV3L"),o=i("04lDo"),l=i("eIcQa"),h=i("kVHNC"),c=i("4toIY"),u=i("af1iA"),p=i("dJ1E2"),d=i("72Jv0"),g=i("eg83P"),f=i("eelgW"),v=i("i0uIf"),m=i("6l0gQ"),y=i("jjWRi"),x=i("2pgVs"),B=i("joplQ"),b=i("c1lmK"),w=i("635F6"),k=i("gCzYB"),C={eventUsesHighResTimeStamp:a.eventUsesHighResTimeStamp,hasPointerEvents:a.hasPointerEvents,hasWebGl:a.hasWebGl,isCssMinMaxSupported:a.isCssMinMaxSupported,canShareFiles:a.canShareFiles,insertAfter:r.insertAfter,loadImage:r.loadImage,css:r.css,setAttributes:r.setAttributes,append:r.append,fitInto:r.fitInto,centerWithin:r.centerWithin,getDate:r.getDate,gcd:r.gcd,reduce:r.reduce,decToFraction:r.decToFraction,imageBlobToUrl:r.imageBlobToUrl,dateDayDifference:r.dateDayDifference,copyObj:r.copyObj,shareCanvas:r.shareCanvas,handleClick:r.handleClick,createSvg:r.createSvg,BbLog:v.BbLog,LocalStorage:m.LocalStorage,throwIfNull:r.throwIfNull,isDark:r.isDark,mix:g.mix,dist:g.dist,distSquared:g.distSquared,lenSquared:g.lenSquared,pointsToAngleRad:g.pointsToAngleRad,pointsToAngleDeg:g.pointsToAngleDeg,isInsideRect:g.isInsideRect,clamp:g.clamp,rotate:g.rotate,rotateAround:g.rotateAround,Matrix:h.Matrix,Vec2:c.Vec2,intDxy:g.intDxy,roundEven:g.roundEven,roundUneven:g.roundUneven,round:g.round,updateBounds:g.updateBounds,boundsInArea:g.boundsInArea,projectPointOnLine:u.projectPointOnLine,PointLine:u.PointLine,BezierLine:u.BezierLine,SplineInterpolator:u.SplineInterpolator,quadraticSplineInput:u.quadraticSplineInput,canvas:f.createCanvas,ctx:l.ctx,copyCanvas:l.copyCanvas,testShouldPixelate:l.testShouldPixelate,drawTransformedImageWithBounds:l.drawTransformedImageWithBounds,drawTransformedImageOnCanvas:l.drawTransformedImageOnCanvas,createCheckerCanvas:l.createCheckerCanvas,createCheckerDataUrl:l.createCheckerDataUrl,resizeCanvas:l.resizeCanvas,convertToAlphaChannelCanvas:l.convertToAlphaChannelCanvas,freeCanvas:l.freeCanvas,canvasBounds:l.canvasBounds,HSV:p.HSV,RGB:p.RGB,CMYK:p.CMYK,ColorConverter:p.ColorConverter,testIsWhiteBestContrast:p.testIsWhiteBestContrast,appendTextDiv:d.appendTextDiv,clearSelection:d.clearSelection,makeUnfocusable:d.makeUnfocusable,el:d.el,destroyEl:d.destroyEl,isInputFocused:d.isInputFocused,unfocusAnyInput:d.unfocusAnyInput,KeyListener:s.KeyListener,PointerListener:o.PointerListener,sameKeys:s.sameKeys,EventChain:k.EventChain,DoubleTapper:b.DoubleTapper,NFingerTapper:x.NFingerTapper,PinchZoomer:B.PinchZoomer,CoalescedExploder:y.CoalescedExploder,OnePointerLimiter:w.OnePointerLimiter}})),i.register("6J2My",(function(t,n){e(t.exports,"isFirefox",(function(){return h})),e(t.exports,"eventUsesHighResTimeStamp",(function(){return c})),e(t.exports,"hasPointerEvents",(function(){return u})),e(t.exports,"hasWebGl",(function(){return p})),e(t.exports,"isCssMinMaxSupported",(function(){return d})),e(t.exports,"canShareFiles",(function(){return g}));var r,a,s,o,l=i("eelgW"),h=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,c=(r=new Event("").timeStamp<36e5,function(){return r}),u=!!window.PointerEvent,p=(a=function(){var e=(0,l.createCanvas)();try{return e.getContext("experimental-webgl",{premultipliedAlpha:!1}),!0}catch(e){return!1}}(),function(){return a}),d=(s=function(){var e=document.createElement("div");e.style.position="absolute",e.style.top="0",e.style.left="max(0px, 25px)",document.body.append(e),setTimeout((function(){o=25===e.offsetLeft,document.body.removeChild(e)}),25)},o=null,document.body?s():window.addEventListener("DOMContentLoaded",(function(){s()})),function(){if(null===o)throw new Error("isCssMinMaxSupported not initialized");return o}),g=function(){return"share"in navigator&&"canShare"in navigator}})),i.register("eelgW",(function(t,i){function n(e,t){var i=document.createElement("canvas");return e&&t&&(i.width=e,i.height=t),i}e(t.exports,"createCanvas",(function(){return n}))})),i.register("idV3L",(function(t,n){e(t.exports,"KeyListener",(function(){return b})),e(t.exports,"sameKeys",(function(){return w}));var r,a,s,o,l,h,c,u,p,d,g,f,v,m=i("gFgFC"),y=i("kiQ5H"),x=i("4R9ai"),B=(r=function(e){var t=e.key,i=e.code;if(t in c){var n=c[t];if(h[n])return void g(n,e,u.join("+"),!0);h[n]=!0,p[i]=n,u.push(n),g(n,e,u.join("+"))}},a=function(e){var t=e.code,i=u.join("+");if(["Meta","MetaLeft","MetaRight","OSLeft","OSRight"].includes(t))s();else{var n=p[t];if(void 0!==n){h[n]=!1,p[t]=void 0;for(var r=0;r<u.length;r++)u[r]==n&&(u.splice(r,1),r--);f(n,e,i)}}},s=function(){var e=u.join("+");u=[],p={};var t=[];l.forEach((function(e){h[e]&&(h[e]=!1,t.push(e))}));for(var i=0;i<t.length;i++)f(t[i],{preventDefault:function(){},stopPropagation:function(){}},e);v()},o={space:[" ","Spacebar"],alt:["Alt","AltGraph"],shift:"Shift",ctrl:"Control",cmd:["Meta","MetaLeft","MetaRight"],enter:"Enter",esc:"Escape",backspace:"Backspace",delete:"Delete",sqbr_open:"[",sqbr_close:"]",a:["a","A"],b:["b","B"],c:["c","C"],e:["e","E"],f:["f","F"],g:["g","G"],r:["r","R"],s:["s","S"],t:["t","T"],u:["u","U"],x:["x","X"],y:["y","Y"],z:["z","Z"],plus:"+",minus:"-",left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown",home:"Home",end:"End"},l=Object.keys(o),h=Object.entries(o).reduce((function(e,t){return e[(0,x.default)(t,1)[0]]=!1,e}),{}),c=Object.entries(o).reduce((function(e,t){var i=(0,x.default)(t,2),n=i[0],r=i[1];return"string"==typeof r?e[r]=n:r.forEach((function(t){e[t]=n})),e}),{}),u=[],p={},d=[],g=function(e,t,i,n){d.forEach((function(r){r[0]&&r[0](e,t,i,n)}))},f=function(e,t,i){d.forEach((function(n){n[1]&&n[1](e,t,i)}))},v=function(){d.forEach((function(e){e[2]&&e[2]()}))},{add:function(e){if(!d.includes(e)){var t=0===d.length;d.push(e),t&&(document.addEventListener("keydown",r),document.addEventListener("keyup",a),window.addEventListener("blur",s))}},remove:function(e){if(d.includes(e)){for(var t=1===d.length,i=0;i<d.length;i++)if(d[i]===e){d.splice(i,1);break}t&&(document.removeEventListener("keydown",r),document.removeEventListener("keyup",a),window.removeEventListener("blur",s))}},getIsDown:function(){return h},getCombo:function(){return u}}),b=function(){"use strict";function e(t){(0,m.default)(this,e),this.onDown=t.onDown,this.onUp=t.onUp,this.onBlur=t.onBlur,this.ref=[this.onDown,this.onUp,this.onBlur],B.add(this.ref)}return(0,y.default)(e,[{key:"isPressed",value:function(e){if(!(e in B.getIsDown()))throw'key "'+e+'" not found';return B.getIsDown()[e]}},{key:"getComboStr",value:function(){return B.getCombo().join("+")}},{key:"comboOnlyContains",value:function(e){for(var t=0;t<B.getCombo().length;t++)if(!e.includes(B.getCombo()[t]))return!1;return!0}},{key:"destroy",value:function(){B.remove(this.ref)}}]),e}();function w(e,t){return e.split("+").sort().join("+")===t.split("+").sort().join("+")}})),i.register("04lDo",(function(t,n){e(t.exports,"PointerListener",(function(){return k}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("3Rl3W"),l=i("a7ch7"),h=i("6J2My"),c=i("93oLo"),u=i("eIAon"),p=[];function d(e){switch(e){case 1:return"left";case 2:return"right";case 4:return"middle";default:return}}var g=new(0,u.PressureNormalizer),f=(0,h.eventUsesHighResTimeStamp)()?0:-performance.timing.navigationStart,v=h.hasPointerEvents?"pointerdown":"mousedown",m=h.hasPointerEvents?"pointermove":"mousemove",y=h.hasPointerEvents?"pointerup":"mouseup",x=h.hasPointerEvents?"pointercancel":"mousecancel",B=h.hasPointerEvents?"pointerleave":"mouseleave",b=h.hasPointerEvents?"pointerenter":"mouseenter";function w(e){if("corrected"in e)return e.corrected;var t={pointerId:e.pointerId,pointerType:e.pointerType,pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY,movementX:e.movementX,movementY:e.movementY,timeStamp:e.timeStamp+f,pressure:g.normalize(e.pressure),buttons:void 0!==e.buttons?e.buttons:void 0!==e.button?[1,4,2,8,16][e.button]:0,button:e.button,coalescedArr:[],eventPreventDefault:function(){return e.preventDefault()},eventStopPropagation:function(){return e.stopPropagation()}};e.corrected=t;var i=null;"pointerId"in e?"pressure"in e&&0!==e.buttons&&(["mouse"].includes(e.pointerType)||"touch"===e.pointerType&&0===e.pressure)&&(t.pressure=1,i=1):(t.pointerId=0,t.pointerType="mouse",t.pressure=0!==e.buttons?1:0,i=t.pressure),h.isFirefox&&"mouse"!=e.pointerType&&"pointermove"===e.type&&0===e.buttons&&(t.buttons=1);var n=[];"getCoalescedEvents"in e&&(n=e.getCoalescedEvents());for(var r=function(e){for(var t=p.length-1;t>=0;t--)if(e.pointerId===p[t].pointerId)return p[t];return null}(t)||function(e){var t={pointerId:e.pointerId,lastPageX:null,lastPageY:null};return p.push(t),p.length>15&&p.shift(),t}(t),a=r.lastPageX,s=r.lastPageY,o=0;o<n.length;o++){var l=n[o];t.coalescedArr.push({pageX:l.pageX,pageY:l.pageY,clientX:l.clientX,clientY:l.clientY,movementX:null===r.lastPageX?0:l.pageX-r.lastPageX,movementY:null===r.lastPageY?0:l.pageY-r.lastPageY,timeStamp:0===l.timeStamp?t.timeStamp:l.timeStamp+f,pressure:null===i?g.normalize(l.pressure):i}),r.lastPageX=l.pageX,r.lastPageY=l.pageY}return r.lastPageX=t.pageX,r.lastPageY=t.pageY,t.movementX=null===a?0:r.lastPageX-a,t.movementY=null===s?0:r.lastPageY-s,t}var k=function(){"use strict";function e(t){var i=this;if((0,r.default)(this,e),(0,s.default)(this,"isDestroyed",!1),(0,s.default)(this,"isOverCounter",0),(0,s.default)(this,"dragObjArr",[]),(0,s.default)(this,"dragPointerIdArr",[]),(0,s.default)(this,"lastPointerType",null),(0,s.default)(this,"didSkip",!1),this.targetElement=t.target,this.onPointerCallback=t.onPointer,this.onWheelCallback=t.onWheel,this.onEnterLeaveCallback=t.onEnterLeave,this.maxPointers=Math.max(1,t.maxPointers||1),this.wheelCleaner=new(0,c.WheelCleaner)((function(e){if(!i.isDestroyed&&i.onWheelCallback){var t=i.targetElement.getBoundingClientRect(),n=(0,l.default)((0,o.default)({},e),{relX:e.clientX-t.left+i.targetElement.scrollLeft,relY:e.clientY-t.top+i.targetElement.scrollTop});i.onWheelCallback(n)}})),this.onPointerCallback&&(this.onPointerMove=function(e){var t=w(e),n=i.lastPointerType;if(i.lastPointerType=t.pointerType,i.dragPointerIdArr.includes(t.pointerId)||i.dragPointerIdArr.length===i.maxPointers||"touch"===t.pointerType)i.didSkip=!1;else if(i.didSkip||"mouse"!==t.pointerType||"pen"!==n){i.didSkip=!1;var r=i.createPointerOutEvent("pointermove",t);i.onPointerCallback&&i.onPointerCallback(r)}else i.didSkip=!0},this.onPointerDown=function(e,t){var n=w(e);if(!i.dragPointerIdArr.includes(n.pointerId)&&i.dragPointerIdArr.length!==i.maxPointers&&[1,2,4].includes(n.buttons)){0!==i.dragObjArr.length||t||i.setupDocumentListeners();var r={pointerId:n.pointerId,pointerType:n.pointerType,downPageX:n.pageX,downPageY:n.pageY,buttons:n.buttons,lastPageX:n.pageX,lastPageY:n.pageY,lastTimeStamp:n.timeStamp};i.dragObjArr.push(r),i.dragPointerIdArr.push(n.pointerId);var a=i.createPointerOutEvent("pointerdown",n,{downPageX:n.pageX,downPageY:n.pageY,button:d(n.buttons),pressure:n.pressure});i.onPointerCallback&&i.onPointerCallback(a)}},this.windowOnPointerMove=function(e){var t=w(e);if(i.dragPointerIdArr.includes(t.pointerId)){var n=i.getDragObj(t.pointerId);if(n)if(t.buttons===n.buttons){if("pen"!==t.pointerType||t.pageX!==n.lastPageX||t.pageY!==n.lastPageY||t.timeStamp!==n.lastTimeStamp){var r=i.createPointerOutEvent("pointermove",t,{downPageX:n.downPageX,downPageY:n.downPageY,button:d(t.buttons),pressure:t.pressure});n.lastPageX=t.pageX,n.lastPageY=t.pageY,n.lastTimeStamp=t.timeStamp,i.onPointerCallback&&i.onPointerCallback(r)}}else{1===i.dragObjArr.length&&i.destroyDocumentListeners(),i.removeDragObj(t.pointerId);var a=i.createPointerOutEvent("pointerup",t,{downPageX:n.downPageX,downPageY:n.downPageY});i.onPointerCallback&&i.onPointerCallback(a)}}},this.windowOnPointerUp=function(e){var t=w(e);if(i.dragPointerIdArr.includes(t.pointerId)){1===i.dragObjArr.length&&i.destroyDocumentListeners();var n=i.removeDragObj(t.pointerId);if(n){var r=i.createPointerOutEvent("pointerup",t,{downPageX:n.downPageX,downPageY:n.downPageY});i.onPointerCallback&&i.onPointerCallback(r)}}},this.windowOnPointerLeave=function(e){var t=w(e);if(i.dragPointerIdArr.includes(t.pointerId)){1===i.dragObjArr.length&&i.destroyDocumentListeners();var n=i.removeDragObj(t.pointerId);if(n){var r=i.createPointerOutEvent("pointerup",t,{downPageX:n.downPageX,downPageY:n.downPageY});i.onPointerCallback&&i.onPointerCallback(r)}}},this.targetElement.addEventListener(m,this.onPointerMove),this.targetElement.addEventListener(v,this.onPointerDown),!h.hasPointerEvents)){var n=function(e,t,i){return{pointerId:e.identifier,pointerType:"touch",pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY,button:i?0:void 0,buttons:i?1:0,timeStamp:t.timeStamp,target:t.target,pressure:i?1:0,preventDefault:function(){return t.preventDefault()},stopPropagation:function(){return t.stopPropagation()}}},a=function(e,t){for(var r=0;r<e.changedTouches.length;r++){var a=e.changedTouches[r],s=n(a,e,["start","move"].includes(t));"start"===t?i.onPointerDown(s,!1):"move"===t?i.windowOnPointerMove(s):"end"===t?i.windowOnPointerUp(s):i.windowOnPointerLeave(s)}};this.onTouchStart=function(e){e.preventDefault(),a(e,"start")},this.onTouchMove=function(e){a(e,"move")},this.onTouchEnd=function(e){a(e,"end")},this.onTouchCancel=function(e){a(e,"cancel")},this.targetElement.addEventListener("touchstart",this.onTouchStart),this.targetElement.addEventListener("touchmove",this.onTouchMove),this.targetElement.addEventListener("touchend",this.onTouchEnd),this.targetElement.addEventListener("touchcancel",this.onTouchCancel)}this.onWheelCallback&&(this.onWheel=function(e){i.wheelCleaner.process(e)},this.targetElement.addEventListener("wheel",this.onWheel)),this.onEnterLeaveCallback&&(this.onPointerEnter=function(){i.isOverCounter++,i.onEnterLeaveCallback&&i.onEnterLeaveCallback(!0)},this.onPointerLeave=function(){i.isOverCounter--,i.onEnterLeaveCallback&&i.onEnterLeaveCallback(!1)},this.targetElement.addEventListener(b,this.onPointerEnter),this.targetElement.addEventListener(B,this.onPointerLeave)),t.fixScribble&&(this.onTouchMoveScribbleFix=function(e){return e.preventDefault()},this.targetElement.addEventListener("touchmove",this.onTouchMoveScribbleFix))}return(0,a.default)(e,[{key:"getDragObj",value:function(e){for(var t=0;t<this.dragObjArr.length;t++)if(e===this.dragObjArr[t].pointerId)return this.dragObjArr[t];return null}},{key:"removeDragObj",value:function(e){for(var t=null,i=0;i<this.dragPointerIdArr.length;i++)this.dragPointerIdArr[i]===e&&(t=this.dragObjArr[i],this.dragObjArr.splice(i,1),this.dragPointerIdArr.splice(i,1),i--);return t}},{key:"createPointerOutEvent",value:function(e,t,i){var n=this.targetElement.getBoundingClientRect(),r=(0,o.default)({type:e,pointerId:t.pointerId,pointerType:t.pointerType,pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,relX:t.clientX-n.left+this.targetElement.scrollLeft,relY:t.clientY-n.top+this.targetElement.scrollTop,dX:t.movementX,dY:t.movementY,time:t.timeStamp,eventPreventDefault:t.eventPreventDefault,eventStopPropagation:t.eventStopPropagation},i);if("pointermove"===e&&(r.coalescedArr=[],t.coalescedArr.length>1))for(var a,s=0;s<t.coalescedArr.length;s++)a=t.coalescedArr[s],r.coalescedArr.push({pageX:a.pageX,pageY:a.pageY,clientX:a.clientX,clientY:a.clientY,relX:a.clientX-n.left+this.targetElement.scrollLeft,relY:a.clientY-n.top+this.targetElement.scrollTop,dX:a.movementX,dY:a.movementY,time:a.timeStamp});return r}},{key:"setupDocumentListeners",value:function(){this.windowOnPointerMove&&document.addEventListener(m,this.windowOnPointerMove),this.windowOnPointerUp&&document.addEventListener(y,this.windowOnPointerUp),this.windowOnPointerLeave&&document.addEventListener(x,this.windowOnPointerLeave),this.windowOnPointerLeave&&document.addEventListener(B,this.windowOnPointerLeave)}},{key:"destroyDocumentListeners",value:function(){this.windowOnPointerMove&&document.removeEventListener(m,this.windowOnPointerMove),this.windowOnPointerUp&&document.removeEventListener(y,this.windowOnPointerUp),this.windowOnPointerLeave&&document.removeEventListener(x,this.windowOnPointerLeave),this.windowOnPointerLeave&&document.removeEventListener(B,this.windowOnPointerLeave)}},{key:"destroy",value:function(){this.isDestroyed||(this.isDestroyed=!0,this.onPointerEnter&&this.targetElement.removeEventListener(b,this.onPointerEnter),this.onPointerLeave&&this.targetElement.removeEventListener(B,this.onPointerLeave),this.onPointerMove&&this.targetElement.removeEventListener(m,this.onPointerMove),this.onPointerDown&&this.targetElement.removeEventListener(v,this.onPointerDown),this.onWheel&&this.targetElement.removeEventListener("wheel",this.onWheel),this.destroyDocumentListeners(),this.onTouchMoveScribbleFix&&document.removeEventListener("touchmove",this.onTouchMoveScribbleFix),this.onTouchStart&&this.targetElement.removeEventListener("touchstart",this.onTouchStart),this.onTouchMove&&this.targetElement.removeEventListener("touchmove",this.onTouchMove),this.onTouchEnd&&this.targetElement.removeEventListener("touchend",this.onTouchEnd),this.onTouchCancel&&this.targetElement.removeEventListener("touchcancel",this.onTouchCancel))}}]),e}()})),i.register("93oLo",(function(t,n){e(t.exports,"WheelCleaner",(function(){return s}));var r=i("gFgFC"),a=i("kiQ5H"),s=function(){"use strict";function e(t){(0,r.default)(this,e),this.callback=t,this.knownUnitArr=[100],this.sequenceLength=0,this.sequenceUnit=null,this.toEmitDelta=null,this.position=null}return(0,a.default)(e,[{key:"emit",value:function(e){null!==this.position&&null!==this.sequenceUnit&&this.callback({deltaY:Math.round(e/this.sequenceUnit),pageX:this.position.pageX,pageY:this.position.pageY,clientX:this.position.clientX,clientY:this.position.clientY})}},{key:"endSequence",value:function(){null!==this.toEmitDelta&&(this.emit(this.toEmitDelta),this.toEmitDelta=null),null===this.sequenceUnit||this.knownUnitArr.includes(this.sequenceUnit)||this.knownUnitArr.push(this.sequenceUnit),this.sequenceLength=0,this.sequenceUnit=null}},{key:"process",value:function(e){var t=this;this.position={pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY},this.endSequenceTimeout&&clearTimeout(this.endSequenceTimeout),this.endSequenceTimeout=setTimeout((function(){return t.endSequence()}),200);var i=e.deltaY;"deltaMode"in e&&1===e.deltaMode&&(i*=100/3);var n=Math.abs(i);if(0===this.sequenceLength){if(this.sequenceLength++,n<50)return;return this.sequenceUnit=n,void(this.knownUnitArr.includes(this.sequenceUnit)?this.emit(i):this.toEmitDelta=i)}if(null!==this.sequenceUnit){if(0!==n){if(n===this.sequenceUnit||n/this.sequenceUnit%1<1e-4);else if(this.sequenceUnit/n%1<1e-4)this.sequenceUnit=n;else if(n!==this.sequenceUnit)return this.sequenceUnit=null,void(this.toEmitDelta=null);null!==this.toEmitDelta&&(this.emit(this.toEmitDelta),this.toEmitDelta=null),this.emit(i)}}else this.toEmitDelta=null}}]),e}()})),i.register("eIAon",(function(t,n){e(t.exports,"PressureNormalizer",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eg83P"),l=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"count",0),(0,s.default)(this,"avgPressure",0),(0,s.default)(this,"normalizeIsComplete",!1),(0,s.default)(this,"normalizeFactor",1)}return(0,a.default)(e,[{key:"normalize",value:function(e){return 0===e||1===e?e:(this.count<60?(0===this.count||null===this.count?this.avgPressure=e:this.avgPressure=(0,o.mix)(e,this.avgPressure,.95),this.count++):this.normalizeIsComplete||(this.normalizeIsComplete=!0,this.avgPressure<.13&&(this.normalizeFactor=2.3)),Math.pow(e,1/this.normalizeFactor))}}]),e}()})),i.register("eg83P",(function(t,i){function n(e,t,i){return e*(1-i)+t*i}function r(e,t,i,n){return Math.sqrt(Math.pow(e-i,2)+Math.pow(t-n,2))}function a(e,t,i,n){return Math.pow(e-i,2)+Math.pow(t-n,2)}function s(e,t){return e*e+t*t}function o(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function l(e,t){return 180*o(e,t)/Math.PI}function h(e,t){return t.x<=e.x&&e.x<=t.x+t.width&&t.y<=e.y&&e.y<=t.y+t.height}function c(e,t,i){return e<t?t:e>i?i:e}function u(e,t,i){var n=i*(Math.PI/180),r=Math.cos(n),a=Math.sin(n);return{x:e*r-t*a,y:e*a+t*r}}function p(e,t,i){var n=u(t.x-e.x,t.y-e.y,i);return n.x+=e.x,n.y+=e.y,n}function d(e,t,i){e.x+=t,e.y+=i;var n=Math.round(e.x),r=Math.round(e.y);return e.x-=n,e.y-=r,{dX:n,dY:r}}function g(e){if(e%1==0)return e%2==0?e:e+1;var t=Math.ceil(e),i=Math.floor(e);return t%2==0?t:i}function f(e){if(e%1==0)return e%2==0?e+1:e;var t=Math.ceil(e),i=Math.floor(e);return t%2==1?t:i}function v(e,t){var i=Math.pow(10,t);return Math.round(e*i)/i}function m(e,t){return t?(e?(e.x1=Math.min(e.x1,t.x1),e.y1=Math.min(e.y1,t.y1),e.x2=Math.max(e.x2,t.x2),e.y2=Math.max(e.y2,t.y2)):e={x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2},e):e}function y(e,t,i){var n=Math.max(0,e.x1),r=Math.max(0,e.y1),a=Math.min(t-1,e.x2),s=Math.min(i-1,e.y2);return n>a||r>s?null:{x1:n,y1:r,x2:a,y2:s}}e(t.exports,"mix",(function(){return n})),e(t.exports,"dist",(function(){return r})),e(t.exports,"distSquared",(function(){return a})),e(t.exports,"lenSquared",(function(){return s})),e(t.exports,"pointsToAngleRad",(function(){return o})),e(t.exports,"pointsToAngleDeg",(function(){return l})),e(t.exports,"isInsideRect",(function(){return h})),e(t.exports,"clamp",(function(){return c})),e(t.exports,"rotate",(function(){return u})),e(t.exports,"rotateAround",(function(){return p})),e(t.exports,"intDxy",(function(){return d})),e(t.exports,"roundEven",(function(){return g})),e(t.exports,"roundUneven",(function(){return f})),e(t.exports,"round",(function(){return v})),e(t.exports,"updateBounds",(function(){return m})),e(t.exports,"boundsInArea",(function(){return y}))})),i.register("eIcQa",(function(t,n){e(t.exports,"copyCanvas",(function(){return s})),e(t.exports,"ctx",(function(){return o})),e(t.exports,"testShouldPixelate",(function(){return l})),e(t.exports,"drawTransformedImageWithBounds",(function(){return h})),e(t.exports,"drawTransformedImageOnCanvas",(function(){return c})),e(t.exports,"createCheckerCanvas",(function(){return p})),e(t.exports,"createCheckerDataUrl",(function(){return d})),e(t.exports,"resizeCanvas",(function(){return g})),e(t.exports,"convertToAlphaChannelCanvas",(function(){return f})),e(t.exports,"freeCanvas",(function(){return v})),e(t.exports,"canvasBounds",(function(){return m}));var r=i("eelgW"),a=i("7jh4K");function s(e){var t=(0,r.createCanvas)(e.width,e.height),i=t.getContext("2d");if(!i)throw new Error("2d context not supported or canvas already initialized");return i.drawImage(e,0,0),t}function o(e){var t=e.getContext("2d");if(!t)throw new Error("couldn't get 2d context");return t}function l(e,t,i){if(![1,-1].includes(t)||![1,-1].includes(i)||e.width%1!=0||e.height%1!=0||Math.abs(e.angleDeg)%90!=0)return!1;var n=Math.abs(e.angleDeg-90)%180==0,r=n?e.height:e.width,a=n?e.width:e.height;return(Math.abs(r)%2==0&&e.x%1==0||Math.abs(r)%2==1&&e.x%1==.5)&&(Math.abs(a)%2==0&&e.y%1==0||Math.abs(a)%2==1&&e.y%1==.5)}function h(e,t,i,n,r){n||(n={x:0,y:0,width:t.width,height:t.height}),e.save(),r?e.imageSmoothingEnabled=!1:(e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high"),e.translate(i.x,i.y),e.rotate(i.angleDeg/180*Math.PI),e.scale(i.width>0?1:-1,i.height>0?1:-1),e.drawImage(t,n.x,n.y,n.width,n.height,-Math.abs(i.width)/2,-Math.abs(i.height)/2,Math.abs(i.width),Math.abs(i.height)),e.restore()}function c(e,t,i){(i=(0,a.copyObj)(i)).center||(i.center={x:t.width/2,y:t.height/2}),i.scale||(i.scale={x:1,y:1}),i.angleDegree||(i.angleDegree=0),i.translate||(i.translate={x:0,y:0});var n=e.getContext("2d");if(!n)throw new Error("2d context not supported or canvas already initialized");n.save(),Math.abs(i.scale.x-1)>1e-6||Math.abs(i.scale.y-1)>1e-6||Math.abs(i.angleDegree%90)>1e-6?(n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high"):n.imageSmoothingEnabled=!1,n.translate(i.translate.x,i.translate.y),n.translate(i.center.x,i.center.y),n.rotate(i.angleDegree/180*Math.PI),n.scale(i.scale.x,i.scale.y),n.translate(-i.center.x,-i.center.y),n.drawImage(t,0,0,t.width,t.height),n.restore()}var u,p=function(e,t){var i,n=(0,r.createCanvas)();if(e<1){if(n.width=1,n.height=1,!(i=n.getContext("2d")))throw new Error("2d context not supported or canvas already initialized");i.fillStyle="rgb(128, 128, 128)",i.fillRect(0,0,1,1)}else if(e>200)n.width=401,n.height=401;else{if(n.width=2*e,n.height=2*e,!(i=n.getContext("2d")))throw new Error("2d context not supported or canvas already initialized");i.fillStyle=t?"rgb(90, 90, 90)":"rgb(255, 255, 255)",i.fillRect(0,0,2*e,2*e),i.fillStyle=t?"rgb(63, 63, 63)":"rgb(200, 200, 200)",i.fillRect(0,0,e,e),i.fillRect(e,e,2*e,2*e)}return n},d=(u={"8l":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMElEQVQ4T2M8ceLEfwY8wNzcHJ80A+OoAcMiDP7//483HZw8eRJ/Ohg1gIFx6IcBAIhJUqnarXQ1AAAAAElFTkSuQmCC","4l":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAJ0lEQVQoU2M8ceLEfwYkYG5ujsxlYKSDgv///6O44eTJk6huoL0CAGsOKVVu8UYvAAAAAElFTkSuQmCC"},function(e,t,i){var n=function(e){if(e=parseInt(""+e),u[""+e+r])return u[""+e+r];var t=p(e,i).toDataURL("image/png");return u[""+e+r]=t,t},r=i?"d":"l";if(!t)return n(e);setTimeout((function(){t(n(e))}),1)});function g(e,t,i,n,a){var s,o,l,h,c;if(t&&i&&(t!==e.width||i!==e.height))if(t=Math.max(t,1),i=Math.max(i,1),t<=e.width&&i<=e.height){n=n||(0,r.createCanvas)(),a=a||(0,r.createCanvas)();var u,p,d=(s=e.width,o=e.height,l=t,h=i,(c={oldWidthEx:Math.round(Math.log2(s)),oldHeightEx:Math.round(Math.log2(o)),newWidthEx:Math.ceil(Math.log2(l)),newHeightEx:Math.ceil(Math.log2(h))}).oldWidthEx=Math.max(c.oldWidthEx,c.newWidthEx),c.oldHeightEx=Math.max(c.oldHeightEx,c.newHeightEx),c);a.width=d.oldWidthEx>d.newWidthEx?Math.pow(2,d.oldWidthEx):t,a.height=d.oldHeightEx>d.newHeightEx?Math.pow(2,d.oldHeightEx):i,n.getContext("2d").save(),a.getContext("2d").save();var f=n,v=a;u=d.oldWidthEx,p=d.oldHeightEx;var m=v.getContext("2d");m.imageSmoothingEnabled=!0,m.imageSmoothingQuality="high",m.globalCompositeOperation="copy",m.drawImage(e,0,0,v.width,v.height);for(var y=v.width,x=v.height;u>d.newWidthEx||p>d.newHeightEx;u--,p--){(m=f.getContext("2d")).imageSmoothingEnabled=!0,m.imageSmoothingQuality="high",m.globalCompositeOperation="copy";var B=u>d.newWidthEx?y/2:y,b=p>d.newHeightEx?x/2:x;f.width=B,f.height=b,m.drawImage(v,0,0,y,x,0,0,B,b),y=B,x=b;var w=f;f=v,v=w}e.width=t,e.height=i;var k=e.getContext("2d");k.save(),k.imageSmoothingEnabled=!0,k.imageSmoothingQuality="high",k.drawImage(v,0,0,y,x,0,0,t,i),k.restore(),n.getContext("2d").restore(),a.getContext("2d").restore()}else if(t>=e.width&&i>=e.height){(n=n||(0,r.createCanvas)()).width=t,n.height=i;var C=n.getContext("2d");C.save(),C.imageSmoothingEnabled=!0,C.imageSmoothingQuality="high",C.drawImage(e,0,0,t,i),C.restore(),e.width=t,e.height=i,e.getContext("2d").drawImage(n,0,0)}else g(e,t,e.height,n,a),g(e,t,i,n,a)}function f(e){for(var t=e.getContext("2d").getImageData(0,0,e.width,e.height),i=0;i<t.data.length;i+=4)0!==t.data[i+3]&&(t.data[i+3]=(t.data[i]+t.data[i+1]+t.data[i+2])/3*(t.data[i+3]/255));e.getContext("2d").putImageData(t,0,0)}function v(e){e.width=1,e.height=1;var t=e.getContext("2d");t&&t.clearRect(0,0,1,1)}function m(e){var t={x:0,y:0,width:0,height:0},i={x1:null,y1:null,x2:null,y2:null},n=e.getImageData(0,0,e.canvas.width,e.canvas.height);if(n.data[3]>0&&n.data[n.data.length-1]>0)i.x1=0,i.y1=0,i.x2=e.canvas.width-1,i.y2=e.canvas.height-1;else for(var r=3;r<n.data.length;r+=4)if(n.data[r]>0){var a=(r-3)/4%e.canvas.width,s=Math.floor((r-3)/4/e.canvas.width);(null===i.x1||i.x1>a)&&(i.x1=a),null===i.y1&&(i.y1=s),(null===i.x2||i.x2<a)&&(i.x2=a),(null===i.y2||i.y2<s)&&(i.y2=s)}return null===i.x1||null===i.y1||null===i.x2||null===i.y2?null:(t.x=i.x1,t.y=i.y1,t.width=i.x2-i.x1+1,t.height=i.y2-i.y1+1,t)}})),i.register("kVHNC",(function(t,i){function n(e,t){return[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15]]}e(t.exports,"Matrix",(function(){return r}));var r=Object.freeze({getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},multiplyMatrixAndPoint:n,multiplyMatrices:function(e,t){var i=[t[0],t[1],t[2],t[3]],r=[t[4],t[5],t[6],t[7]],a=[t[8],t[9],t[10],t[11]],s=[t[12],t[13],t[14],t[15]],o=n(e,i),l=n(e,r),h=n(e,a),c=n(e,s);return[o[0],o[1],o[2],o[3],l[0],l[1],l[2],l[3],h[0],h[1],h[2],h[3],c[0],c[1],c[2],c[3]]},createTranslationMatrix:function(e,t){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,0,1]},createRotationMatrix:function(e){return[Math.cos(-e),-Math.sin(-e),0,0,Math.sin(-e),Math.cos(-e),0,0,0,0,1,0,0,0,0,1]},createScaleMatrix:function(e){return[e,0,0,0,0,e,0,0,0,0,1,0,0,0,0,1]}})})),i.register("4toIY",(function(t,i){e(t.exports,"Vec2",(function(){return n}));var n={add:function(e,t){return{x:e.x+t.x,y:e.y+t.y}},sub:function(e,t){return{x:e.x-t.x,y:e.y-t.y}},nor:function(e){var t=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2));return{x:e.x/t,y:e.y/t}},len:function(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))},dist:function(e,t){return n.len(n.sub(e,t))},mul:function(e,t){return{x:e.x*t,y:e.y*t}},angle:function(e,t){return Math.atan2(t.y-e.y,t.x-e.x)},dot:function(e,t){var i=[e.x,e.y],n=[t.x,t.y];return i.map((function(e,t){return i[t]*n[t]})).reduce((function(e,t){return e+t}))}}})),i.register("af1iA",(function(t,n){e(t.exports,"projectPointOnLine",(function(){return c})),e(t.exports,"PointLine",(function(){return u})),e(t.exports,"BezierLine",(function(){return p})),e(t.exports,"SplineInterpolator",(function(){return d})),e(t.exports,"quadraticSplineInput",(function(){return g}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("4toIY"),l=i("eg83P"),h=i("7jh4K"),c=function(e,t,i){if(e.x===t.x)return{x:e.x,y:i.y};var n=(t.y-e.y)/(t.x-e.x),r=e.y-n*e.x;return{x:(n*i.y+i.x-n*r)/(n*n+1),y:(n*n*i.y+n*i.x+r)/(n*n+1)}},u=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.segmentArr=[];for(var n=0;n<t.points.length;n++)!function(e){var n=0;e<t.points.length-1&&(n=(0,l.dist)(t.points[e].x,t.points[e].y,t.points[e+1].x,t.points[e+1].y)),i.segmentArr[e]={x:t.points[e].x,y:t.points[e].y,length:n}}(n)}return(0,a.default)(e,[{key:"getAtDist",value:function(e){for(var t=Math.min(this.getLength(),e),i=0;t>this.segmentArr[i].length&&i<this.segmentArr.length-2;i++)t-=this.segmentArr[i].length;var n=Math.min(1,Math.max(0,t/this.segmentArr[i].length));return{x:this.segmentArr[i].x*(1-n)+this.segmentArr[i+1].x*n,y:this.segmentArr[i].y*(1-n)+this.segmentArr[i+1].y*n}}},{key:"getLength",value:function(){for(var e=0,t=0;t<this.segmentArr.length-1;t++)e+=this.segmentArr[t].length;return e}}]),e}(),p=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"lastDot",0),(0,s.default)(this,"lastSpacing",null),this.pointArr=[]}return(0,a.default)(e,[{key:"getBezierPoints",value:function(e,t,i,n,r){for(var a,s=[],o=0;o<=r;o++)a=o/r,s[s.length]={x:Math.pow(1-a,3)*e.x+3*Math.pow(1-a,2)*a*t.x+3*(1-a)*Math.pow(a,2)*i.x+Math.pow(a,3)*n.x,y:Math.pow(1-a,3)*e.y+3*Math.pow(1-a,2)*a*t.y+3*(1-a)*Math.pow(a,2)*i.y+Math.pow(a,3)*n.y};return s}},{key:"add",value:function(e,t,i,n,r){if(!this.lastPoint||e!==this.lastPoint.x||t!==this.lastPoint.y)if(this.lastPoint={x:e,y:t},this.pointArr[this.pointArr.length]={x:e,y:t,spacing:i},1!==this.pointArr.length){if(2===this.pointArr.length)return this.pointArr[0].dir=o.Vec2.nor(o.Vec2.sub(this.pointArr[1],this.pointArr[0])),this.lastDot=i,void(this.lastSpacing=i);var a=this.pointArr[this.pointArr.length-1],s=this.pointArr[this.pointArr.length-2],c=this.pointArr[this.pointArr.length-3];s.dir=o.Vec2.nor(o.Vec2.sub(a,c)),(isNaN(s.dir.x)||isNaN(s.dir.y))&&(s.dir=(0,h.copyObj)(c.dir));var p,d=this.pointArr[this.pointArr.length-3],g=this.pointArr[this.pointArr.length-2],f=d,v=o.Vec2.add(d,o.Vec2.mul(d.dir,o.Vec2.dist(d,g)/4)),m=o.Vec2.sub(g,o.Vec2.mul(g.dir,o.Vec2.dist(d,g)/4)),y=g;if(n){var x=this.getBezierPoints(f,v,m,y,20);p=new u({points:x})}else p=new u({points:[f,y]});for(var B=p.getLength(),b=(0,l.mix)(this.lastSpacing,i,(0,l.clamp)(this.lastDot/B,0,1)),w=this.lastDot;w<=B;w+=b){b=(0,l.mix)(this.lastSpacing,i,(0,l.clamp)(w/B,0,1));var k=p.getAtDist(w),C=this.lastCallbackPoint?(0,l.pointsToAngleDeg)(this.lastCallbackPoint,k):void 0;n&&n({x:k.x,y:k.y,t:w/B,angle:C,dAngle:this.lastCallbackPoint?C-this.lastAngle:0}),this.lastCallbackPoint=k,this.lastAngle=C}n?this.lastDot=w-B:(this.lastDot=0,r&&r({p1:f,p2:v,p3:m,p4:y})),this.lastSpacing=i}else this.lastSpacing=i}},{key:"addFinal",value:function(e,t,i){if(!(this.pointArr.length<2)){var n=this.pointArr[this.pointArr.length-2],r=this.pointArr[this.pointArr.length-1],a=o.Vec2.add(r,o.Vec2.sub(r,n));this.add(a.x,a.y,e,t,i)}}}]),e}(),d=function(){"use strict";function e(t){(0,r.default)(this,e);var i,n=t.length;for(this.xa=[],this.ya=[],this.u=[],this.y2=[],this.first=t[0][0],this.last=t[t.length-1][0],t.sort((function(e,t){return e[0]-t[0]})),i=0;i<n;i++)this.xa.push(t[i][0]),this.ya.push(t[i][1]);for(this.u[0]=0,this.y2[0]=0,i=1;i<n-1;++i){var a=this.xa[i+1]-this.xa[i-1],s=(this.xa[i]-this.xa[i-1])/a,o=s*this.y2[i-1]+2;this.y2[i]=(s-1)/o;var l=(this.ya[i+1]-this.ya[i])/(this.xa[i+1]-this.xa[i])-(this.ya[i]-this.ya[i-1])/(this.xa[i]-this.xa[i-1]);this.u[i]=(6*l/a-s*this.u[i-1])/o}for(this.y2[n-1]=0,i=n-2;i>=0;--i)this.y2[i]=this.y2[i]*this.y2[i+1]+this.u[i]}return(0,a.default)(e,[{key:"getFirstX",value:function(){return this.first}},{key:"getLastX",value:function(){return this.last}},{key:"interpolate",value:function(e){for(var t=0,i=this.ya.length-1;i-t>1;){var n=i+t>>1;this.xa[n]>e?i=n:t=n}var r=this.xa[i]-this.xa[t],a=(this.xa[i]-e)/r,s=(e-this.xa[t])/r;return a*this.ya[t]+s*this.ya[i]+((a*a*a-a)*this.y2[t]+(s*s*s-s)*this.y2[i])*(r*r)/6}},{key:"findX",value:function(e,t){for(var i=null,n=null,r=0;r<=t;r++){var a=r/t,s=this.interpolate(a);if(null!==i){var o=Math.abs(s-e);if(!(o<n))break;i=a,n=o}else i=a,n=Math.abs(s-e)}return i}}]),e}();function g(e,t,i){for(var n=function(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)},r=[],a=0;a<=1;a+=i)r.push([n(a,4),n(e+Math.pow(a,2)*(t-e),4)]);return r}})),i.register("dJ1E2",(function(t,n){e(t.exports,"HSV",(function(){return a})),e(t.exports,"RGB",(function(){return s})),e(t.exports,"CMYK",(function(){return o})),e(t.exports,"ColorConverter",(function(){return l})),e(t.exports,"testIsWhiteBestContrast",(function(){return h}));var r=i("gFgFC"),a=function e(t,i,n){"use strict";(0,r.default)(this,e),this.h=Math.max(0,Math.min(360,t)),this.s=Math.max(.001,Math.min(100,i)),this.v=Math.max(0,Math.min(100,n))},s=function e(t,i,n){"use strict";(0,r.default)(this,e),this.r=Math.max(0,Math.min(255,t)),this.g=Math.max(0,Math.min(255,i)),this.b=Math.max(0,Math.min(255,n))},o=function e(t,i,n,a){"use strict";(0,r.default)(this,e),this.c=Math.max(0,Math.min(100,t)),this.m=Math.max(0,Math.min(100,i)),this.y=Math.max(0,Math.min(100,n)),this.k=Math.max(0,Math.min(100,a))},l={_RGBtoHSV:function(e){var t=new a(0,0,0),i=e.r/255,n=e.g/255,r=e.b/255,s=Math.min(i,n,r),o=Math.max(i,n,r),l=o-s;if(t.v=o,0==l)t.h=0,t.s=0;else{t.s=l/o;var h=((o-i)/6+l/2)/l,c=((o-n)/6+l/2)/l,u=((o-r)/6+l/2)/l;i==o?t.h=u-c:n==o?t.h=1/3+h-u:r==o&&(t.h=2/3+c-h),t.h<0&&(t.h+=1),t.h>1&&(t.h-=1)}return t.h=Math.round(360*t.h),t.s=Math.round(100*t.s),t.v=Math.round(100*t.v),t},_HSVtoRGB:function(e){var t,i,n,r,a,o,l,h,c=new s(0,0,0),u=e.h/360%1,p=e.s/100,d=e.v/100;return 0==p?(c.r=255*d,c.g=255*d,c.b=255*d):(n=d*(1-p),r=d*(1-p*((t=6*u)-(i=Math.floor(t)))),a=d*(1-p*(1-(t-i))),0==i?(o=d,l=a,h=n):1==i?(o=r,l=d,h=n):2==i?(o=n,l=d,h=a):3==i?(o=n,l=r,h=d):4==i?(o=a,l=n,h=d):(o=d,l=n,h=r),c.r=255*o,c.g=255*l,c.b=255*h,c.r=Math.round(c.r),c.g=Math.round(c.g),c.b=Math.round(c.b)),c},_CMYKtoRGB:function(e){var t=new s(0,0,0),i=e.c/100,n=e.m/100,r=e.y/100,a=e.k/100;return t.r=1-Math.min(1,i*(1-a)+a),t.g=1-Math.min(1,n*(1-a)+a),t.b=1-Math.min(1,r*(1-a)+a),t.r=Math.round(255*t.r),t.g=Math.round(255*t.g),t.b=Math.round(255*t.b),t},_RGBtoCMYK:function(e){var t=new o(0,0,0,0),i=e.r/255,n=e.g/255,r=e.b/255;return t.k=Math.min(1-i,1-n,1-r),t.c=(1-i-t.k)/(1-t.k),t.m=(1-n-t.k)/(1-t.k),t.y=(1-r-t.k)/(1-t.k),t.c=Math.round(100*t.c),t.m=Math.round(100*t.m),t.y=Math.round(100*t.y),t.k=Math.round(100*t.k),t},toRGB:function(e){return e instanceof s?e:e instanceof a?this._HSVtoRGB(e):e instanceof o?this._CMYKtoRGB(e):void 0},toHSV:function(e){return e instanceof a?e:e instanceof s?this._RGBtoHSV(e):e instanceof o?this._RGBtoHSV(this._CMYKtoRGB(e)):void 0},toCMYK:function(e){return e instanceof o?e:e instanceof s?this._RGBtoCMYK(e):e instanceof a?this._RGBtoCMYK(this._HSVtoRGB(e)):void 0},toHexString:function(e){if(e instanceof s||"r"in e&&"g"in e&&"b"in e){var t=parseInt(""+e.r).toString(16),i=parseInt(""+e.g).toString(16),n=parseInt(""+e.b).toString(16);return 1==t.length&&(t="0"+t),1==i.length&&(i="0"+i),1==n.length&&(n="0"+n),t+i+n}},toRgbStr:function(e){return"rgb("+Math.round(e.r)+", "+Math.round(e.g)+", "+Math.round(e.b)+")"},toRgbaStr:function(e){return"rgba("+Math.round(e.r)+", "+Math.round(e.g)+", "+Math.round(e.b)+", "+e.a+")"},hexToRGB:function(e){e=(e=e.trim()).replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(e,t,i,n){return t+t+i+i+n+n}));var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?new s(parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)):null}};function h(e){return.299*e.r+.587*e.g+.114*e.b<125}})),i.register("72Jv0",(function(t,n){e(t.exports,"appendTextDiv",(function(){return s})),e(t.exports,"isInputFocused",(function(){return o})),e(t.exports,"unfocusAnyInput",(function(){return l})),e(t.exports,"clearSelection",(function(){return h})),e(t.exports,"makeUnfocusable",(function(){return u})),e(t.exports,"el",(function(){return d})),e(t.exports,"destroyEl",(function(){return g}));var r=i("7jh4K"),a=i("eWjiX");function s(e,t){var i=document.createElement("div");return i.innerHTML=t,e.append(i),i}function o(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=!(!document.activeElement||!["INPUT","TEXTAREA"].includes(document.activeElement.tagName));return t?i:i&&!(null===(e=document.activeElement)||void 0===e?void 0:e.getAttribute("data-ignore-focus"))}function l(){if(o(!0)){var e=a.BB.el({parent:document.body,tagName:"input",css:{opacity:"0",width:"0",height:"0"}});setTimeout((function(){e.select(),e.focus(),e.parentNode.removeChild(e)}),10)}}function h(){if(window.getSelection){var e=window.getSelection();e&&(e.empty?e.empty():e.removeAllRanges&&e.removeAllRanges())}else"selection"in document&&document.selection.empty()}var c,u=(c=function(e){e.preventDefault();var t=!1;if(e.relatedTarget)try{e.relatedTarget.focus(),t=!0}catch(e){console.error("failed to focus")}t||e.currentTarget.blur()},function(e){e.setAttribute("tabindex","-1"),e.addEventListener("focus",c)}),p=[];function d(e){if(!e)return document.createElement("div");var t=document.createElement(e.tagName?e.tagName:"div");e.css&&(0,r.css)(t,e.css),e.content&&("string"==typeof e.content?t.innerHTML=e.content:Array.isArray(e.content)?a.BB.append(t,e.content):t.append(e.content)),e.textContent&&(t.textContent=e.textContent),e.className&&(t.className=e.className),e.id&&(t.id=e.id),e.parent&&e.parent.append(t),"title"in e&&void 0!==e.title&&(t.title=e.title);var i=[];if("onClick"in e&&(t.addEventListener("click",e.onClick),i.push(["click",e.onClick])),"onChange"in e&&(t.addEventListener("change",e.onChange),i.push(["change",e.onChange])),i.length>0&&p.push({el:t,listeners:i}),"custom"in e&&e.custom)for(var n=Object.keys(e.custom),s=0;s<n.length;s++)t.setAttribute(n[s],e.custom[n[s]]);return t}function g(e){if(e)for(var t=0;t<p.length;t++){var i=p[t];if(i.el===e)return i.listeners.forEach((function(t){e.removeEventListener(t[0],t[1])})),void p.splice(t,1)}}})),i.register("i0uIf",(function(t,n){e(t.exports,"BbLog",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=function(){"use strict";function e(){(0,r.default)(this,e)}return(0,a.default)(e,null,[{key:"subscribe",value:function(t){e.listeners.includes(t)||e.listeners.push(t)}},{key:"unsubscribe",value:function(t){for(var i=0;i<e.listeners.length;i++)if(t===e.listeners[i])return void e.listeners.splice(i,1)}},{key:"emit",value:function(t){e.listeners.forEach((function(e){e(t)}))}}]),e}();(0,s.default)(o,"listeners",[])})),i.register("6l0gQ",(function(t,n){e(t.exports,"LocalStorage",(function(){return s}));var r=i("gFgFC"),a=i("kiQ5H"),s=function(){"use strict";function e(){(0,r.default)(this,e)}return(0,a.default)(e,null,[{key:"getItem",value:function(e){var t=null;try{t=localStorage.getItem(e)}catch(e){this.error=e}return t}},{key:"setItem",value:function(e,t){try{localStorage.setItem(e,t)}catch(e){this.error=e}}},{key:"removeItem",value:function(e){try{localStorage.removeItem(e)}catch(e){this.error=e}}},{key:"getError",value:function(){return this.error}}]),e}()})),i.register("jjWRi",(function(t,n){e(t.exports,"CoalescedExploder",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7jh4K"),o=function(){"use strict";function e(){(0,r.default)(this,e)}return(0,a.default)(e,[{key:"setChainOut",value:function(e){this.chainOut=e}},{key:"chainIn",value:function(e){if("pointermove"!==e.type)return e;if(!(e.coalescedArr&&e.coalescedArr.length>0))return e;for(var t=0;t<e.coalescedArr.length;t++){var i=(0,s.copyObj)(e);0===t&&(i.coalescedArr=[]);var n=e.coalescedArr[t];i.pageX=n.pageX,i.pageY=n.pageY,i.relX=n.relX,i.relY=n.relY,i.dX=n.dX,i.dY=n.dY,i.time=n.time,t<e.coalescedArr.length-1&&(i.isCoalesced=!0),this.chainOut&&this.chainOut(i)}return null}}]),e}()})),i.register("2pgVs",(function(t,n){e(t.exports,"NFingerTapper",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eg83P"),l=function(){"use strict";function e(t){(0,r.default)(this,e),(0,s.default)(this,"minSilenceBeforeDurationMs",50),(0,s.default)(this,"maxTapMs",500),(0,s.default)(this,"maxFirstLastFingerDownMs",250),(0,s.default)(this,"maxPressedDistancePx",12),(0,s.default)(this,"fingerArr",[]),(0,s.default)(this,"eventQueueArr",[]),(0,s.default)(this,"firstDownTime",0),(0,s.default)(this,"lastEventTime",0),(0,s.default)(this,"nowTime",performance.now()),(0,s.default)(this,"pointersDownIdArr",[]),(0,s.default)(this,"timeoutObj",{firstLastDownTimeout:null,tapTimeout:null}),this.fingers=t.fingers,this.onTap=t.onTap}return(0,a.default)(e,[{key:"failGesture",value:function(){if(0!==this.eventQueueArr.length){this.timeoutObj.firstLastDownTimeout&&clearTimeout(this.timeoutObj.firstLastDownTimeout),this.timeoutObj.tapTimeout&&clearTimeout(this.timeoutObj.tapTimeout);for(var e=0;e<this.eventQueueArr.length;e++)this.chainOut&&this.chainOut(this.eventQueueArr[e]);this.eventQueueArr=[],this.fingerArr=[]}}},{key:"success",value:function(){this.timeoutObj.firstLastDownTimeout&&clearTimeout(this.timeoutObj.firstLastDownTimeout),this.timeoutObj.tapTimeout&&clearTimeout(this.timeoutObj.tapTimeout),this.eventQueueArr=[],this.fingerArr=[],this.onTap()}},{key:"setupTimeout",value:function(e,t){var i=this,n=t-this.nowTime;return!(n<=0)&&(this.timeoutObj[e]=setTimeout((function(){return i.failGesture()}),n),!0)}},{key:"processEvent",value:function(e){var t=this.lastEventTime;if(this.lastEventTime=e.time,"pointerdown"===e.type)this.pointersDownIdArr.push(e.pointerId);else if("pointerup"===e.type)for(var i=0;i<this.pointersDownIdArr.length;i++)if(this.pointersDownIdArr[i]===e.pointerId){this.pointersDownIdArr.splice(i,1);break}if("touch"===e.pointerType){if(this.nowTime=performance.now(),"pointerdown"===e.type)return this.fingerArr.length+1!==this.pointersDownIdArr.length||this.fingerArr.length===this.fingers||this.fingerArr.length>0&&e.time-this.maxFirstLastFingerDownMs>this.fingerArr[0].downTimeMs||0===this.fingerArr.length&&e.time-this.minSilenceBeforeDurationMs<t?void this.failGesture():0!==this.fingerArr.length||(this.firstDownTime=e.time,this.setupTimeout("firstLastDownTimeout",e.time+this.maxFirstLastFingerDownMs)&&this.setupTimeout("tapTimeout",e.time+this.maxTapMs))?void this.fingerArr.push({pointerId:e.pointerId,downTimeMs:e.time,downPageX:e.pageX,downPageY:e.pageY}):void this.failGesture();if("pointermove"===e.type){if(0===this.fingerArr.length)return;for(var n=null,r=0;r<this.fingerArr.length;r++)if(this.fingerArr[r].pointerId===e.pointerId){n=this.fingerArr[r];break}if(null===n)return void this.failGesture();if(e.time-this.maxTapMs>this.firstDownTime)return void this.failGesture();if((0,o.dist)(e.pageX,e.pageY,n.downPageX,n.downPageY)>this.maxPressedDistancePx)return void this.failGesture()}if("pointerup"===e.type){if(0===this.fingerArr.length)return;if(this.fingerArr.length!==this.fingers)return void this.failGesture();for(var a=null,s=0;s<this.fingerArr.length;s++)if(this.fingerArr[s].pointerId===e.pointerId){a=this.fingerArr[s];break}if(null===a)return;if(e.time-this.maxTapMs>this.firstDownTime)return void this.failGesture();if((0,o.dist)(e.pageX,e.pageY,a.downPageX,a.downPageY)>this.maxPressedDistancePx)return void this.failGesture();a.isUp=!0;for(var l=!0,h=0;h<this.fingerArr.length;h++)if(!this.fingerArr[h].isUp){l=!1;break}if(l)return this.success(),!0}}else this.fingerArr.length>0&&this.failGesture()}},{key:"chainIn",value:function(e){return!0===this.processEvent(e)?null:0===this.fingerArr.length?e:(this.eventQueueArr.push(e),null)}},{key:"setChainOut",value:function(e){this.chainOut=e}}]),e}()})),i.register("joplQ",(function(t,n){e(t.exports,"PinchZoomer",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eg83P"),l=function(){"use strict";function e(t){(0,r.default)(this,e),(0,s.default)(this,"firstFingerMaxDistancePx",10),(0,s.default)(this,"untilSecondFingerDurationMs",250),(0,s.default)(this,"pointersDownIdArr",[]),(0,s.default)(this,"gestureObj",null),(0,s.default)(this,"eventQueueArr",[]),(0,s.default)(this,"nowTime",performance.now()),(0,s.default)(this,"timeoutObj",{secondFingerTimeout:null}),(0,s.default)(this,"pincherArr",[]),this.onPinch=t.onPinch}return(0,a.default)(e,[{key:"end",value:function(){this.gestureObj=null,this.eventQueueArr=[]}},{key:"fail",value:function(e){if(this.gestureObj){if(this.timeoutObj.secondFingerTimeout&&clearTimeout(this.timeoutObj.secondFingerTimeout),!e)for(var t=0;t<this.eventQueueArr.length;t++)this.chainOut&&this.chainOut(this.eventQueueArr[t]);this.end()}}},{key:"setupFailTimeout",value:function(e){var t=this,i=e-this.nowTime;return!(i<=0)&&(this.timeoutObj.secondFingerTimeout=setTimeout((function(){return t.fail()}),i),!0)}},{key:"processEvent",value:function(e){if("pointerdown"===e.type)this.pointersDownIdArr.push(e.pointerId);else if("pointerup"===e.type)for(var t=0;t<this.pointersDownIdArr.length;t++)if(this.pointersDownIdArr[t]===e.pointerId){this.pointersDownIdArr.splice(t,1);break}if(this.gestureObj||!("touch"!==e.pointerType||"pointermove"===e.type&&this.pointersDownIdArr.length>0||this.pointersDownIdArr.length>1||"pointerup"===e.type)){if(this.nowTime=performance.now(),"pointerdown"===e.type)return this.gestureObj?"touch"===e.pointerType?(this.gestureObj.touchPointerArr.push({pointerId:e.pointerId,relX:e.relX,relY:e.relY}),void(this.gestureObj.isInProgress?this.continuePinch(this.gestureObj,{type:"down",index:this.gestureObj.touchPointerArr.length-1}):(this.timeoutObj.secondFingerTimeout&&clearTimeout(this.timeoutObj.secondFingerTimeout),this.gestureObj.isInProgress=!0,this.beginPinch(this.gestureObj)))):void(this.gestureObj.isInProgress?this.gestureObj.otherPointerIdArr.push(e.pointerId):this.fail()):(this.gestureObj={touchPointerArr:[{pointerId:e.pointerId,relX:e.relX,relY:e.relY,downRelX:e.relX,downRelY:e.relY}],otherPointerIdArr:[],isInProgress:!1},this.setupFailTimeout(e.time+this.untilSecondFingerDurationMs)?void 0:void this.fail());if(this.gestureObj)if("pointermove"!==e.type||"touch"!==e.pointerType){if("pointerup"===e.type){if("touch"===e.pointerType){for(var i=0;i<this.gestureObj.touchPointerArr.length;i++)if(this.gestureObj.touchPointerArr[i].pointerId===e.pointerId){this.gestureObj.touchPointerArr.splice(i,1);break}this.gestureObj.touchPointerArr.length>0&&this.continuePinch(this.gestureObj,{type:"up",index:i})}else for(var n=0;n<this.gestureObj.otherPointerIdArr.length;n++)if(this.gestureObj.otherPointerIdArr[n]===e.pointerId){this.gestureObj.otherPointerIdArr.splice(n,1);break}if(0===this.gestureObj.touchPointerArr.length&&0===this.gestureObj.otherPointerIdArr.length)return void(this.gestureObj.isInProgress?(this.end(),this.endPinch()):this.fail())}}else{for(var r=null,a=0;a<this.gestureObj.touchPointerArr.length;a++)if(e.pointerId===this.gestureObj.touchPointerArr[a].pointerId){r=this.gestureObj.touchPointerArr[a];break}if(!r)return void this.fail();if(r.relX=e.relX,r.relY=e.relY,this.gestureObj.isInProgress)a<2&&this.continuePinch(this.gestureObj,{type:"move",index:a});else{if(!("downRelX"in r)||void 0===r.downRelX||!("downRelY"in r)||void 0===r.downRelY)return void this.fail();if((0,o.dist)(r.downRelX,r.downRelY,r.relX,r.relY)>this.firstFingerMaxDistancePx)return void this.fail()}}else this.fail()}}},{key:"beginPinch",value:function(e){for(var t=0;t<e.touchPointerArr.length;t++){var i=e.touchPointerArr[t];this.pincherArr.push({pointerId:i.pointerId,relX:i.relX,relY:i.relY,downRelX:i.relX,downRelY:i.relY})}var n={type:"move",downRelX:0,downRelY:0,relX:0,relY:0,angleRad:0,scale:1};1===this.pincherArr.length?(n.relX=this.pincherArr[0].downRelX,n.relY=this.pincherArr[0].downRelY):(n.relX=.5*(this.pincherArr[0].downRelX+this.pincherArr[1].downRelX),n.relY=.5*(this.pincherArr[0].downRelY+this.pincherArr[1].downRelY)),n.downRelX=n.relX,n.downRelY=n.relY,this.onPinch(n)}},{key:"continuePinch",value:function(e,t){if(!(t.index>1))if("move"===t.type){var i;if(this.pincherArr[t.index].relX=e.touchPointerArr[t.index].relX,this.pincherArr[t.index].relY=e.touchPointerArr[t.index].relY,1===this.pincherArr.length)i={type:"move",downRelX:this.pincherArr[0].downRelX,downRelY:this.pincherArr[0].downRelY,relX:this.pincherArr[0].relX,relY:this.pincherArr[0].relY,angleRad:0,scale:1};else{var n=(0,o.dist)(this.pincherArr[0].downRelX,this.pincherArr[0].downRelY,this.pincherArr[1].downRelX,this.pincherArr[1].downRelY),r=(0,o.dist)(this.pincherArr[0].relX,this.pincherArr[0].relY,this.pincherArr[1].relX,this.pincherArr[1].relY),a=(0,o.pointsToAngleRad)({x:this.pincherArr[0].downRelX,y:this.pincherArr[0].downRelY},{x:this.pincherArr[1].downRelX,y:this.pincherArr[1].downRelY}),s=(0,o.pointsToAngleRad)({x:this.pincherArr[0].relX,y:this.pincherArr[0].relY},{x:this.pincherArr[1].relX,y:this.pincherArr[1].relY});i={type:"move",downRelX:.5*(this.pincherArr[0].downRelX+this.pincherArr[1].downRelX),downRelY:.5*(this.pincherArr[0].downRelY+this.pincherArr[1].downRelY),relX:.5*(this.pincherArr[0].relX+this.pincherArr[1].relX),relY:.5*(this.pincherArr[0].relY+this.pincherArr[1].relY),angleRad:s-a,scale:r/n}}this.onPinch(i)}else"down"!==t.type&&"up"!==t.type||(this.endPinch(),this.beginPinch(e))}},{key:"endPinch",value:function(){this.pincherArr=[],this.onPinch({type:"end"})}},{key:"chainIn",value:function(e){return this.processEvent(e),this.gestureObj?(this.gestureObj.isInProgress||this.eventQueueArr.push(e),null):e}},{key:"setChainOut",value:function(e){this.chainOut=e}}]),e}()})),i.register("c1lmK",(function(t,n){e(t.exports,"DoubleTapper",(function(){return h}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("4Ea8f"),l=i("eg83P"),h=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),(0,s.default)(this,"allowedPointerTypeArr",["touch","mouse","pen"]),(0,s.default)(this,"allowedButtonArr",["left"]),(0,s.default)(this,"minSilenceBeforeDurationMs",400),(0,s.default)(this,"maxPressedDurationMs",300),(0,s.default)(this,"maxPressedDistancePx",10),(0,s.default)(this,"maxInbetweenDistancePx",19),(0,s.default)(this,"maxUpToUpDurationMs",500),(0,s.default)(this,"maxUntilSecondDownDurationMs",300),(0,s.default)(this,"minSilenceAfterMs",250),(0,s.default)(this,"sequenceArr",[]),(0,s.default)(this,"pointersDownIdArr",[]),(0,s.default)(this,"lastUpTime",0),(0,s.default)(this,"nowTime",0),(0,s.default)(this,"eventQueueArr",[]),(0,s.default)(this,"timeoutObj",{fail:null,maxUntilSecondDown:null,success:null}),this.onDoubleTap=t.onDoubleTap,this.gestureFailed=function(){if(0!==i.sequenceArr.length){if(i.timeoutObj.fail&&clearTimeout(i.timeoutObj.fail),i.timeoutObj.maxUntilSecondDown&&clearTimeout(i.timeoutObj.maxUntilSecondDown),i.timeoutObj.success&&clearTimeout(i.timeoutObj.success),i.timeoutObj.fail=null,i.timeoutObj.maxUntilSecondDown=null,i.timeoutObj.success=null,i.chainOut)for(var e=0;e<i.eventQueueArr.length;e++)i.chainOut(i.eventQueueArr[e]);i.eventQueueArr=[],i.sequenceArr=[]}}}return(0,a.default)(e,[{key:"success",value:function(){this.timeoutObj.fail=null,this.timeoutObj.success=null,this.eventQueueArr=[];var e=this.sequenceArr[this.sequenceArr.length-1];this.sequenceArr=[],"pageX"in e&&this.onDoubleTap({pageX:e.pageX,pageY:e.pageY,relX:e.relX,relY:e.relY})}},{key:"setupTimeout",value:function(e,t,i){var n=i-this.nowTime;return!(n<=0)&&(this.timeoutObj[e]=setTimeout(t,n),!0)}},{key:"processEvent",value:function(e){var t=this;if("pointerdown"===e.type)this.pointersDownIdArr.push(e.pointerId);else if("pointerup"===e.type)for(var i=0;i<this.pointersDownIdArr.length;i++)if(this.pointersDownIdArr[i]===e.pointerId){this.pointersDownIdArr.splice(i,1);break}if(this.allowedPointerTypeArr.includes(e.pointerType)){this.nowTime=performance.now();var n=this.sequenceArr.length>0?this.sequenceArr[this.sequenceArr.length-1]:null;if("pointerup"===e.type&&(this.lastUpTime=e.time),"pointerdown"===e.type){if(this.pointersDownIdArr.length>1)return void this.gestureFailed();if(null!==this.timeoutObj.success)return void this.gestureFailed();if(0===this.sequenceArr.length&&this.nowTime-this.lastUpTime<this.minSilenceBeforeDurationMs)return void this.gestureFailed();if(e.button&&!this.allowedButtonArr.includes(e.button))return void this.gestureFailed();if(n&&"isDown"in n&&n.isDown||this.sequenceArr.length>2)return void this.gestureFailed();if(n&&"position"in n)if((0,l.dist)(n.position[0],n.position[1],e.pageX,e.pageY)>this.maxInbetweenDistancePx&&(this.gestureFailed(),"time"in n&&this.nowTime-n.time<this.minSilenceBeforeDurationMs))return;if(this.sequenceArr.push({isDown:!0,time:this.nowTime,position:[e.pageX,e.pageY],pointerId:e.pointerId}),this.sequenceArr.length>1)this.timeoutObj.maxUntilSecondDown&&clearTimeout(this.timeoutObj.maxUntilSecondDown);else if(!this.setupTimeout("maxUntilSecondDown",(function(){return t.gestureFailed()}),e.time+this.maxUntilSecondDownDurationMs))return void this.gestureFailed();if(this.timeoutObj.fail&&clearTimeout(this.timeoutObj.fail),!this.setupTimeout("fail",(function(){return t.gestureFailed()}),e.time+this.maxPressedDurationMs))return void this.gestureFailed()}if(n&&"pointermove"===e.type&&"pointerId"in n&&n.pointerId===e.pointerId)if((0,l.dist)(n.position[0],n.position[1],e.pageX,e.pageY)>this.maxPressedDistancePx)return void this.gestureFailed();if(n&&"pointerup"===e.type){if("pointerId"in n&&n.pointerId!==e.pointerId)return void this.gestureFailed();if("time"in n&&this.nowTime>=n.time+this.maxPressedDurationMs)return void this.gestureFailed();if(this.timeoutObj.fail&&clearTimeout(this.timeoutObj.fail),this.sequenceArr.length<3)return this.setupTimeout("fail",(function(){return t.gestureFailed()}),e.time+this.maxUpToUpDurationMs)?void(this.sequenceArr=[n,{isUp:!0,time:this.nowTime,position:[e.pageX,e.pageY]}]):void this.gestureFailed();"time"in this.sequenceArr[1]&&this.nowTime<this.sequenceArr[1].time+this.maxUpToUpDurationMs?(this.sequenceArr.push({pageX:e.pageX,pageY:e.pageY,relX:e.relX,relY:e.relY}),this.setupTimeout("success",(function(){return t.success()}),e.time+this.minSilenceAfterMs)||this.gestureFailed()):this.gestureFailed()}}else this.gestureFailed()}},{key:"chainIn",value:function(e){return this.processEvent(e),0===this.sequenceArr.length?(this.gestureFailed(),e):(this.eventQueueArr.push(e),null)}},{key:"setChainOut",value:function(e){this.chainOut=e}},{key:"setAllowedPointerTypeArr",value:function(e){this.allowedPointerTypeArr=(0,o.default)(e)}},{key:"setAllowedButtonArr",value:function(e){this.allowedButtonArr=(0,o.default)(e)}}]),e}()})),i.register("635F6",(function(t,n){e(t.exports,"OnePointerLimiter",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"downPointerId",null),(0,s.default)(this,"ignorePointerIdArr",[])}return(0,a.default)(e,[{key:"chainIn",value:function(e){if(this.ignorePointerIdArr.includes(e.pointerId)){if("pointerup"===e.type)for(var t=0;t<this.ignorePointerIdArr.length;t++)if(this.ignorePointerIdArr[t]===e.pointerId){this.ignorePointerIdArr.splice(t,1);break}return null}return null===this.downPointerId?("pointerdown"===e.type&&(this.downPointerId=e.pointerId),e):e.pointerId!==this.downPointerId?("pointerdown"===e.type&&this.ignorePointerIdArr.push(e.pointerId),null):("pointerup"===e.type&&(this.downPointerId=null),e)}},{key:"setChainOut",value:function(e){this.chainOut=e}}]),e}()})),i.register("gCzYB",(function(t,n){e(t.exports,"EventChain",(function(){return s}));var r=i("gFgFC"),a=i("kiQ5H"),s=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.chainArr=t.chainArr;for(var n=0;n<this.chainArr.length;n++)!function(e){i.chainArr[e].setChainOut((function(t){i.continueChain(e+1,t)}))}(n)}return(0,a.default)(e,[{key:"continueChain",value:function(e,t){for(;e<this.chainArr.length;e++)if(null===(t=this.chainArr[e].chainIn(t)))return null;return this.chainOut&&this.chainOut(t),null}},{key:"chainIn",value:function(e){return this.continueChain(0,e)}},{key:"setChainOut",value:function(e){this.chainOut=e}}]),e}()})),i.register("8zjca",(function(e,t){window.onscroll=function(e){e.preventDefault()}})),i.register("6ToP3",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("hWwEP")})),i.register("d2FVM",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("83Fnk")})),i.register("dLlkc",(function(n,r){e(n.exports,"DynamicModal",(function(){return u}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("i8UFO"),l=i("eWjiX"),h=i("1mH1z");i("8zjca");var c=i("6ToP3"),u=function(){"use strict";function e(i){var n=this;(0,a.default)(this,e),o.dialogCounter.increase(),this.onClose=i.onClose,this.parent=document.body,this.rootEl=l.BB.el({parent:this.parent,className:"g-root kl-d-modal-root",css:{position:"fixed",left:"0",top:"0",bottom:"0",right:"0",overflow:"auto",animationName:"consoleIn",animationDuration:"0.3s",animationTimingFunction:"ease-out"},onClick:l.BB.handleClick}),this.bgEl=l.BB.el({parent:this.rootEl,css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"},onClick:function(){return n.close()}});var r=l.BB.el({parent:this.rootEl,className:"kl-d-modal",css:{position:"absolute",width:l.BB.isCssMinMaxSupported()?"min(calc(100% - 40px), "+(i.width?i.width:400)+"px)":(i.width?i.width:400)+"px",height:"calc(100% - 40px)",borderRadius:"10px",overflow:"hidden"}});this.updatePos=function(){var e=r.offsetWidth,t=r.offsetHeight;l.BB.css(r,{left:Math.max(0,(window.innerWidth-e)/2)+"px",top:Math.max(20,(window.innerHeight-t)/2-.2*t)+"px"})},this.updatePos(),window.addEventListener("resize",this.updatePos);var s=l.BB.el({parent:r,css:{height:"40px",display:"flex",justifyContent:"space-between",alignItems:"center",paddingLeft:"20px"}});i.title&&s.append(i.title),this.xButton=l.BB.el({parent:s,tagName:"button",className:"popup-x",content:'<img alt="'.concat((0,h.LANG)("modal-close"),'" height="20" src="').concat(t(c),'">'),title:(0,h.LANG)("modal-close"),onClick:function(){return n.close()},css:{width:"40px",height:"40px",lineHeight:"40px",background:"none",boxShadow:"none"},custom:{tabindex:"0"}});var u=l.BB.el({parent:r,css:{height:"calc(100% - 40px)"}});i.content&&u.append(i.content),this.keyListener=new l.BB.KeyListener({onDown:function(e,t){"esc"===e&&(t.stopPropagation(),n.close())}})}return(0,s.default)(e,[{key:"close",value:function(){o.dialogCounter.decrease(),l.BB.destroyEl(this.rootEl),this.parent.removeChild(this.rootEl),window.removeEventListener("resize",this.updatePos),this.keyListener.destroy(),l.BB.destroyEl(this.xButton),l.BB.destroyEl(this.bgEl),this.onClose&&this.onClose()}}]),e}()})),i.register("7bWhB",(function(t,n){e(t.exports,"Checkbox",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.doHighlight=!!t.doHighlight,this.element=s.BB.el({className:"kl-checkbox"});var n=s.BB.el({parent:this.element,tagName:"label",className:"kl-checkbox__inner",css:{display:"flex"}});this.check=s.BB.el({parent:n,tagName:"input",css:{margin:"0 5px 0 0"},custom:{type:"checkbox"}}),this.check.checked=!!t.init,this.doHighlight&&this.check.checked&&this.element.classList.add("kl-checkbox--highlight"),t.allowTab||(this.check.tabIndex=-1),t.title&&(n.title=t.title),s.BB.el({parent:n,content:t.label,css:{}}).allowClick=!0,this.check.onchange=function(){i.doHighlight&&i.element.classList.toggle("kl-checkbox--highlight",i.check.checked),t.callback&&t.callback(i.check.checked),setTimeout((function(){i.check.blur()}),0)},t.css&&s.BB.css(this.element,t.css)}return(0,a.default)(e,[{key:"getValue",value:function(){return this.check.checked}},{key:"setValue",value:function(e){this.check.checked=!!e,this.doHighlight&&this.element.classList.toggle("kl-checkbox--highlight",this.check.checked)}},{key:"getElement",value:function(){return this.element}},{key:"destroy",value:function(){this.check.onchange=null}}]),e}()})),i.register("dJPtW",(function(t,n){e(t.exports,"input",(function(){return a}));var r=i("eWjiX"),a=function(e){var t=document.createElement("input");if(e.type)try{t.type=e.type}catch(e){}else t.type="text";return void 0!==e.min&&(t.min=""+e.min),void 0!==e.max&&(t.max=""+e.max),t.value=""+e.init,e.callback&&(t.onchange=function(){e.callback(t.value)}),e.css&&r.BB.css(t,e.css),t}})),i.register("eEL9N",(function(t,n){e(t.exports,"Select",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.selectEl=s.BB.el({tagName:"select",title:t.title,className:"kl-select",css:{cursor:"pointer",fontSize:"15px",padding:"3px"}}),t.css&&s.BB.css(this.selectEl,t.css);var n=t.isFocusable;n||(this.selectEl.tabIndex=-1),this.optionArr=[];for(var a=0;a<t.optionArr.length;a++){var o=t.optionArr[a];if(null!==o){var l=document.createElement("option");l.value=o[0],l.textContent=o[1],this.optionArr.push({item:o,el:l}),this.selectEl.append(l)}else this.optionArr.push({item:o})}t.onChange&&(this.onChange=t.onChange),this.changeListener=function(){n||i.selectEl.blur(),i.onChange&&i.onChange(i.getValue())},this.selectEl.addEventListener("change",this.changeListener),this.selectEl.value="initValue"in t&&void 0!==t.initValue?t.initValue:""}return(0,a.default)(e,[{key:"setValue",value:function(e){this.selectEl.value=e}},{key:"getValue",value:function(){return this.selectEl.value}},{key:"setDeltaValue",value:function(e){for(var t=0,i=0;i<this.optionArr.length;i++){var n=this.optionArr[i];if(n.item&&""+n.item[0]===this.selectEl.value){t=i;break}}t=Math.max(0,Math.min(this.optionArr.length-1,t+e));var r=this.optionArr[t];this.selectEl.value=r.item?r.item[0]:"",this.onChange&&this.onChange(this.getValue())}},{key:"getElement",value:function(){return this.selectEl}},{key:"updateLabel",value:function(e,t){this.optionArr.forEach((function(i){i.item&&i.item[0]===e&&i.el&&(i.item[1]=t,i.el.textContent=i.item[1])}))}},{key:"destroy",value:function(){this.selectEl.removeEventListener("change",this.changeListener)}}]),e}()})),i.register("1kyaA",(function(t,n){e(t.exports,"ImageToggle",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.isActive=!!t.initValue,this.rootEl=s.BB.el({className:"image-toggle",title:t.title,content:s.BB.el({className:"image-toggle__im"+(t.darkInvert?" dark-invert":""),css:{backgroundImage:"url('"+t.image+"')"}}),onClick:function(e){e.preventDefault(),t.isRadio&&i.isActive||(i.isActive=!i.isActive,i.update(),t.onChange(i.isActive))}}),this.update()}return(0,a.default)(e,[{key:"update",value:function(){this.rootEl.classList.toggle("image-toggle-active",this.isActive)}},{key:"setValue",value:function(e){this.isActive=!!e,this.update()}},{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.isActive}},{key:"destroy",value:function(){s.BB.destroyEl(this.rootEl)}}]),e}()})),i.register("4nUqS",(function(t,n){e(t.exports,"ImageRadioList",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("1kyaA"),l=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.rootEl=s.BB.el({className:"image-radio-wrapper",css:{display:"flex"}}),this.optionArr=[];for(var n,a=function(e,r){r.id===t.initId&&(n=e);var a=new(0,o.ImageToggle)({image:r.image,title:r.title,initValue:r.id===t.initId,isRadio:!0,onChange:function(){!function(e,n){i.activeIndex=e;for(var r=0;r<i.optionArr.length;r++)i.optionArr[r].radioEl.setValue(r===i.activeIndex);t.onChange(n)}(e,r.id)},darkInvert:r.darkInvert});return i.rootEl.append(a.getElement()),{id:r.id,radioEl:a}},l=0;l<t.optionArr.length;l++)this.optionArr.push(a(l,t.optionArr[l]));if(void 0===n)throw new Error("initId not in optionArr");this.activeIndex=n}return(0,a.default)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.optionArr[this.activeIndex].id}},{key:"destroy",value:function(){this.optionArr.forEach((function(e){e.radioEl.destroy()}))}}]),e}()})),i.register("lCF5N",(function(n,r){e(n.exports,"createPenPressureToggle",(function(){return h}));var a=i("eWjiX"),s=i("1mH1z"),o=i("8IsQq"),l=i("cmnov"),h=function(e,i){return new(0,l.BoxToggle)({label:a.BB.el({className:"dark-invert",css:{width:"17px",height:"17px",backgroundImage:'url("'+t(o)+'")',backgroundSize:"contain",backgroundRepeat:"no-repeat",margin:"1px",borderRadius:"3px"}}),title:(0,s.LANG)("brush-toggle-pressure"),init:e,onChange:function(e){i(e)}}).getElement()}})),i.register("8IsQq",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("h8ubb")})),i.register("cmnov",(function(t,n){e(t.exports,"BoxToggle",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.value=!!t.init,this.el=s.BB.el({content:t.label,title:t.title,className:"string"==typeof t.label?"kl-box-toggle":"kl-box-toggle kl-box-toggle--custom-el",onClick:function(){i.value=!i.value,i.update(),t.onChange(i.value)},css:{cursor:"pointer"}}),"string"!=typeof t.label&&s.BB.css(t.label,{display:"block",pointerEvents:"none"}),this.update()}return(0,a.default)(e,[{key:"update",value:function(){this.el.classList.toggle("kl-box-toggle--active",this.value)}},{key:"getValue",value:function(){return this.value}},{key:"setValue",value:function(e){this.value=!!e,this.update()}},{key:"getElement",value:function(){return this.el}},{key:"destroy",value:function(){s.BB.destroyEl(this.el)}}]),e}()})),i.register("aP0jf",(function(t,n){e(t.exports,"KlSlider",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("11glk"),l=i("1mH1z"),h=i("869o9"),c=function(){"use strict";function e(t){var i=this;if((0,r.default)(this,e),this.isEnabled=!1!==t.isEnabled,this.manualInputRoundDigits=t.manualInputRoundDigits,this.useSpline=!!t.curve,!t.label)throw new Error("KlSlider missing params");if(!(0==t.min||0==t.max||0==t.value||t.min&&t.max&&t.value))throw new Error("KlSlider broken params");if(t.min>=t.max)throw new Error("KlSlider broken params");if(this.min=t.min,this.max=t.max,this.value=s.BB.clamp(t.value,this.min,this.max),this.elementWidth=t.width,this.elementHeight=t.height,this.resolution=t.resolution?t.resolution:2*this.elementWidth,this.onChange=t.onChange?t.onChange:function(){},!t.toValue!=!t.toDisplayValue)throw new Error("both or neither have to be set, toValue and toDisplayValue");if(this.displayValueToValue=t.toValue?t.toValue:function(e){return e},this.valueToDisplayValue=t.toDisplayValue?t.toDisplayValue:function(e){return e},this.isChangeOnFinal=!!t.isChangeOnFinal,this.formatFunc=t.formatFunc,this.eventResMs=t.eventResMs,this.useSpline){if(!t.curve)throw new Error("curve needs to be set if useSpline true");var n="quadratic"===t.curve?s.BB.quadraticSplineInput(this.min,this.max,.1):t.curve;this.splineInterpolator=new s.BB.SplineInterpolator(n)}this.rootEl=s.BB.el({css:{display:"flex"}}),this.sliderWrapperEl=s.BB.el({parent:this.rootEl,className:"slider-wrapper",css:{overflow:"hidden",position:"relative",width:this.elementWidth+"px",height:this.elementHeight+"px",userSelect:"none"}}),this.rootEl.oncontextmenu=function(){return!1},this.label=t.label;var a=this.elementHeight-14;this.textEl=s.BB.el({content:this.label,css:{position:"absolute",display:"flex",alignItems:"center",marginLeft:"7px",height:"100%",fontSize:a+"px",pointerEvents:"none"}}),this.control=s.BB.el({className:"slider-inner",css:{position:"absolute",left:"0",top:"0",width:this.valueToSliderValue(this.value)*this.elementWidth+"px",height:this.elementHeight+"px"}});var l=document.createElement("div");this.sliderWrapperEl.append(this.control,this.textEl),this.control.append(l),this.updateEnable();var h=new s.BB.DoubleTapper({onDoubleTap:function(){i.showManualInput()}});h.setAllowedButtonArr(["left","right"]);var c,u=new s.BB.EventChain({chainArr:[h]});this.pointerListenerTimeout=setTimeout((function(){i.pointerListener=new s.BB.PointerListener({target:i.sliderWrapperEl,fixScribble:!0,onPointer:function(e){!function(e){if(e.eventPreventDefault(),i.isEnabled){if("pointerdown"===e.type){if(s.BB.unfocusAnyInput(),i.sliderWrapperEl.className="slider-wrapper slider-wrapper--active","left"===e.button){var t=e.relX/i.elementWidth;t=Math.max(0,Math.min(1,t)),i.value=i.sliderValueToValue(t),i.updateLabel(),i.emit(!1)}c=i.valueToSliderValue(i.value)}if("pointermove"===e.type&&["left","right"].includes(e.button||"")){var n=e.dX,r=Math.abs(e.pageY-(e.downPageY||0));n*=(0,o.calcSliderFalloffFactor)(r,"right"===e.button),n/=i.elementWidth,c+=n;var a=Math.max(0,Math.min(1,c));i.value=i.sliderValueToValue(a),i.updateLabel(),i.emit(!1)}"pointerup"===e.type&&(i.sliderWrapperEl.className="slider-wrapper",i.emit(!0))}}(e),u.chainIn(e)},onWheel:function(e){var t=i.valueToSliderValue(i.value);t=s.BB.clamp(t-e.deltaY/40,0,1),i.value=i.sliderValueToValue(t),i.updateLabel(),i.onChange(i.value)}}),i.updateLabel()}),1)}return(0,a.default)(e,[{key:"valueToSliderValue",value:function(e){return this.useSpline&&this.splineInterpolator?this.splineInterpolator.findX(e,Math.floor(this.resolution))||0:(e-this.min)/(this.max-this.min)}},{key:"sliderValueToValue",value:function(e){var t=this.min+e*(this.max-this.min);return this.useSpline&&this.splineInterpolator&&(t=this.splineInterpolator.interpolate(e)||0),t}},{key:"updateLabel",value:function(){var e=this.valueToDisplayValue(this.value);e=(e=this.formatFunc?this.formatFunc(e):Math.round(e)).toLocaleString(l.languageStrings.getCode()),this.textEl.innerHTML=this.label+'&nbsp;&nbsp;<span style="font-weight:bold">'+e+"</span>";var t=this.valueToSliderValue(this.value);this.control.style.width=t*this.elementWidth+"px"}},{key:"emit",value:function(e){var t=this;if(e||!this.isChangeOnFinal)return e||!this.eventResMs?(this.onChange(this.value),void(this.emitInterval&&(clearInterval(this.emitInterval),this.emitInterval=void 0))):void(this.emitInterval?this.emitValue=this.value:(this.onChange(this.value),this.emitInterval=setInterval((function(){void 0===t.emitValue?(clearInterval(t.emitInterval),t.emitInterval=void 0):(t.onChange(t.emitValue),t.emitValue=void 0)}),this.eventResMs)))}},{key:"updateEnable",value:function(){this.sliderWrapperEl.classList.toggle("slider-wrapper--disabled",!this.isEnabled),s.BB.css(this.sliderWrapperEl,{opacity:this.isEnabled?"":"0.5",pointerEvents:this.isEnabled?"":"none"}),this.manualInput&&this.manualInput.setIsEnabled(this.isEnabled)}},{key:"showManualInput",value:function(){var e=this;this.manualInput=new(0,h.KlSliderManualInput)(this.valueToDisplayValue(this.value),this.valueToDisplayValue(this.min),this.valueToDisplayValue(this.max),this.sliderWrapperEl.getBoundingClientRect(),(function(t){t=e.displayValueToValue(t),e.setValue(s.BB.clamp(t,e.min,e.max)),e.onChange(e.value)}),(function(){s.BB.css(e.sliderWrapperEl,{display:""}),e.manualInput&&(e.rootEl.removeChild(e.manualInput.getElement()),e.manualInput.destroy()),e.manualInput=void 0}),this.manualInputRoundDigits&&this.manualInputRoundDigits>0?this.manualInputRoundDigits:0),this.rootEl.append(this.manualInput.getElement()),setTimeout((function(){e.manualInput&&e.manualInput.focus()})),s.BB.css(this.sliderWrapperEl,{display:"none"})}},{key:"changeSliderValue",value:function(e){if(this.isEnabled){var t=this.valueToSliderValue(this.value);t=s.BB.clamp(t+e,0,1),this.value=this.sliderValueToValue(t),this.updateLabel(),this.onChange(this.value)}}},{key:"setValue",value:function(e){this.value=s.BB.clamp(e,this.min,this.max),this.updateLabel()}},{key:"getValue",value:function(){return this.value}},{key:"update",value:function(e){if(this.min=e.min,this.max=e.max,this.useSpline=!!e.curve,this.useSpline){if(!e.curve)throw new Error("curve needs to be set if useSpline true");var t="quadratic"===e.curve?s.BB.quadraticSplineInput(this.min,this.max,.1):e.curve;this.splineInterpolator=new s.BB.SplineInterpolator(t)}else this.splineInterpolator=void 0;this.setIsEnabled(!e.isDisabled)}},{key:"setIsEnabled",value:function(e){this.isEnabled=!!e,this.updateEnable()}},{key:"destroy",value:function(){clearTimeout(this.pointerListenerTimeout),this.pointerListener&&this.pointerListener.destroy(),this.manualInput&&this.manualInput.destroy(),this.emitInterval&&clearInterval(this.emitInterval)}},{key:"getElement",value:function(){return this.rootEl}}]),e}()})),i.register("11glk",(function(t,i){function n(e,t){var i=Math.min(10,1+Math.pow(Math.floor(e/50),2));return t&&(i*=2),1/i}e(t.exports,"calcSliderFalloffFactor",(function(){return n}))})),i.register("869o9",(function(t,n){e(t.exports,"KlSliderManualInput",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("dJPtW"),l=function(){"use strict";function e(t,i,n,a,l,h,c){var u,p=this;(0,r.default)(this,e),this.onChange=l,this.onClose=h,this.isClosed=!1,this.input=(0,o.input)({type:"number",init:t,min:i,max:n,callback:function(e){p.emit()}}),0!==c&&this.input.setAttribute("step","any"),this.input.onblur=function(){p.privateOnClose()},this.input.addEventListener("keyup",(function(e){["Enter","Escape"].includes(e.key)?p.privateOnClose():p.emit()})),this.input.addEventListener("wheel",(function(){return p.emit()})),this.scrollBefore={x:window.scrollX,y:window.scrollY},u=c||0===c?s.BB.round(t,c):t,this.lastValue=u,this.input.value=""+u,s.BB.css(this.input,{width:a.width+"px",height:a.height+"px"})}return(0,a.default)(e,[{key:"emit",value:function(){this.lastValue!==Number(this.input.value)&&(this.onChange(Number(this.input.value)),this.lastValue=Number(this.input.value))}},{key:"privateOnClose",value:function(){var e=this;this.isClosed||(this.isClosed=!0,this.emit(),this.onClose(),setTimeout((function(){window.scrollTo(e.scrollBefore.x,e.scrollBefore.y),e.scrollBefore=null})))}},{key:"getElement",value:function(){return this.input}},{key:"setIsEnabled",value:function(e){this.isEnabled=!!e}},{key:"focus",value:function(){this.input.focus(),this.input.select()}},{key:"destroy",value:function(){s.BB.destroyEl(this.input)}}]),e}()})),i.register("lfHl9",(function(n,r){e(n.exports,"HexColorDialog",(function(){return u}));var a=i("gFgFC"),s=i("eWjiX"),o=i("dJPtW"),l=i("2MaaK"),h=i("1mH1z"),c=i("bJupx"),u=function e(i){"use strict";(0,a.default)(this,e);var n=function(e,t){var i=s.BB.el({css:{display:"flex",alignItems:"center",marginTop:"5px"}}),n=s.BB.el({content:e,css:{width:"60px"}}),a=(0,o.input)({init:r[t],min:0,max:255,type:"number",css:{width:"80px"},callback:function(){""===a.value||parseFloat(a.value)<0||parseFloat(a.value)>255?l.update():(a.value=""+Math.round(parseFloat(a.value)),r[t]=Number(a.value),p.style.background="#"+s.BB.ColorConverter.toHexString(r),f.value="#"+s.BB.ColorConverter.toHexString(r))}});i.append(n,a),u.append(i);var l={update:function(){a.value=""+r[t]},destroy:function(){a.onchange=null}};return l},r=new s.BB.RGB(i.color.r,i.color.g,i.color.b),u=s.BB.el(),p=s.BB.el({css:{width:"20px",height:"20px",marginBottom:"10px",boxShadow:"inset 0 0 0 1px #fff, 0 0 0 1px #000",background:"#"+s.BB.ColorConverter.toHexString(r)}});u.append(p);var d=s.BB.el({css:{display:"flex",alignItems:"center",marginBottom:"15px"}}),g=s.BB.el({content:(0,h.LANG)("mci-hex"),css:{width:"60px"}}),f=(0,o.input)({init:"#"+s.BB.ColorConverter.toHexString(r),css:{width:"80px"},callback:function(){var e=s.BB.ColorConverter.hexToRGB(f.value);null===e?(e=r,f.value="#"+s.BB.ColorConverter.toHexString(r)):r=e,p.style.background="#"+s.BB.ColorConverter.toHexString(e);for(var t=0;t<m.length;t++)m[t].update()}}),v=s.BB.el({tagName:"button",content:'<img src="'+t(c)+'" height="20"/>',title:(0,h.LANG)("mci-copy"),css:{marginLeft:"10px"},onClick:function(){f.select(),document.execCommand("copy")}});d.append(g,f,v),u.append(d),setTimeout((function(){f.focus(),f.select()}),0);var m=[];m.push(n((0,h.LANG)("red"),"r")),m.push(n((0,h.LANG)("green"),"g")),m.push(n((0,h.LANG)("blue"),"b")),(0,l.showModal)({target:document.body,message:"<b>".concat((0,h.LANG)("manual-color-input"),"</b>"),div:u,autoFocus:!1,clickOnEnter:"Ok",buttons:["Ok","Cancel"],callback:function(e){s.BB.destroyEl(v),m.forEach((function(e){return e.destroy()})),m.splice(0,m.length),i.onClose("Ok"===e?s.BB.ColorConverter.hexToRGB(f.value):null)}})}})),i.register("bJupx",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("htADd")})),i.register("fg9Sv",(function(n,r){e(n.exports,"KlColorSlider",(function(){return d}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("eWjiX"),l=i("lfHl9"),h=i("11glk"),c=i("6fV2b"),u=i("1mH1z"),p=i("fohxs"),d=function(){"use strict";function e(i){var n=this;(0,a.default)(this,e),this.rootEl=o.BB.el({className:"kl-color-picker",css:{position:"relative"}}),this.outputDiv=o.BB.el({css:{display:"flex",alignItems:"center"}}),this.width=i.width,this.svHeight=i.svHeight,this.height=i.height,this.emitColor=i.onPick,this.primaryColorRGB={r:parseInt(""+i.startValue.r),g:parseInt(""+i.startValue.g),b:parseInt(""+i.startValue.b)},this.primaryColorHSV=o.BB.ColorConverter.toHSV(i.startValue),this.secondaryColorRGB={r:p.ERASE_COLOR,g:p.ERASE_COLOR,b:p.ERASE_COLOR},this.secondaryColorHSV=o.BB.ColorConverter._RGBtoHSV(this.secondaryColorRGB);var r=o.BB.el();this.svSvg=(new DOMParser).parseFromString('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><defs><linearGradient id="value" gradientTransform="rotate(90)"><stop offset="0" stop-color="#fff"/><stop offset="100%" stop-color="#000"/></linearGradient><linearGradient id="hue" gradientTransform="rotate(0)"><stop offset="0" stop-color="#fff"/><stop id="hue-stop" offset="100%" stop-color="#f00"/></linearGradient></defs><rect x="0" y="0" width="100" height="100" fill="url(\'#hue\')"/><rect x="0" y="0" width="100" height="100" fill="url(\'#value\')" style="mix-blend-mode: multiply"/></svg>',"image/svg+xml").documentElement;var s=this.svSvg.querySelector("#hue-stop");if(!s)throw Error("#hue-stop not found in svSvg");this.hueStop=s,o.BB.setAttributes(this.hueStop,{"stop-color":"#f0f"}),o.BB.css(this.svSvg,{width:this.width+"px",height:this.svHeight+"px"}),r.append(this.svSvg);var d=o.BB.el({className:"kl-color-picker__h",css:{overflow:"hidden",position:"relative",width:this.width+"px",height:this.height+"px",cursor:"ew-resize",marginTop:"1px",marginBottom:"1px"}});this.divPreview=o.BB.el({className:"kl-color-picker__preview",css:{display:"flex",justifyContent:"space-between",width:2.5*this.height+"px",height:this.height+"px"}}),this.controlH=o.BB.el();this.updateSVCanvas(),this.rootEl.style.width=this.width+"px",this.rootEl.oncontextmenu=function(){return!1},this.SVContainer=o.BB.el({className:"kl-color-picker__sv",css:{width:this.width+"px",height:this.svHeight+"px",overflow:"hidden",display:"block",position:"relative",cursor:"crosshair"}}),this.pointerSV=o.BB.el({css:{width:"12px",height:"12px",borderRadius:"6px",position:"absolute",pointerEvents:"none",boxShadow:"0px 0px 0 1px #000, inset 0px 0px 0 1px #fff"}}),this.SVContainer.append(r,this.pointerSV),this.updateSVPointer(),this.rootEl.append(this.SVContainer,d),this.outputDiv.append(this.divPreview),o.BB.css(this.controlH,{width:"1px",height:this.height+"px",background:"#000",borderLeft:"1px solid #fff",position:"absolute",top:"0",left:parseInt(""+(this.primaryColorHSV.h/360*this.width-1))+"px"});var g={h:0,s:0,v:0};this.pickerButton=o.BB.el({title:(0,u.LANG)("eyedropper")+" [Alt]",className:"color-picker-preview-button",css:{width:"30px",height:"30px",backgroundImage:"url("+t(c)+")",backgroundRepeat:"no-repeat",backgroundSize:"70%",backgroundPosition:"center"},onClick:function(){n.isPicking?(n.pickCallback&&n.pickCallback(!1),n.pickingDone()):(n.pickerButton.classList.remove("color-picker-preview-button-hover"),n.pickerButton.classList.add("color-picker-preview-button-active"),n.isPicking=!0,n.pickCallback&&n.pickCallback(!0))}}),this.isPicking=!1;new o.BB.PointerListener({target:this.pickerButton,onEnterLeave:function(e){n.isPicking||n.pickerButton.classList.toggle("color-picker-preview-button-hover",e)}});this.divPreview.append(this.pickerButton),this.hexButton=o.BB.el({content:"#",className:"color-picker-preview-button",title:(0,u.LANG)("manual-color-input"),css:{height:"100%",width:this.height+"px",lineHeight:this.height+"px",fontSize:.65*this.height+"px"},onClick:function(){new(0,l.HexColorDialog)({color:new o.BB.RGB(n.primaryColorRGB.r,n.primaryColorRGB.g,n.primaryColorRGB.b),onClose:function(e){e&&(n.setColor(e),n.emitColor(new o.BB.RGB(n.primaryColorRGB.r,n.primaryColorRGB.g,n.primaryColorRGB.b)))}})}});new o.BB.PointerListener({target:this.hexButton,onEnterLeave:function(e){n.hexButton.classList.toggle("color-picker-preview-button-hover",e)}});this.divPreview.append(this.hexButton),this.setColPreview(),setTimeout((function(){!function(e){var t=new Image;o.BB.css(t,{position:"absolute",left:"0",top:"0",display:"none",pointerEvents:"none"});for(var i=o.BB.canvas(n.width,n.height),r=o.BB.ctx(i),a=r.createLinearGradient(0,0,n.width,0),s=0;s<1;s+=.01){var l=o.BB.ColorConverter.toRGB(new o.BB.HSV(360*s,100,100)),h=parseInt(""+l.r).toString(16),c=parseInt(""+l.g).toString(16),u=parseInt(""+l.b).toString(16);1===h.length&&(h="0"+h),1===c.length&&(c="0"+c),1===u.length&&(u="0"+u),a.addColorStop(s,"#"+h+c+u)}r.fillStyle=a,r.fillRect(0,0,n.width,n.height),e.append(t),t.alt="hue",t.src=i.toDataURL("image/png"),t.style.display="block"}(d),d.append(n.controlH);new o.BB.PointerListener({target:r,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(o.BB.unfocusAnyInput(),n.SVContainer.classList.toggle("kl-color-picker--active",!0),"left"===e.button?(g.s=e.relX/n.width*100,g.v=100-e.relY/n.svHeight*100,n.primaryColorHSV=new o.BB.HSV(n.primaryColorHSV.h,g.s,g.v),n.primaryColorRGB=o.BB.ColorConverter.toRGB(n.primaryColorHSV),n.updateSVPointer(),n.setColPreview(),n.emitColor(o.BB.ColorConverter.toRGB(n.primaryColorHSV))):(g.s=n.primaryColorHSV.s,g.v=n.primaryColorHSV.v)),"pointermove"===e.type&&["left","right"].includes(e.button)){var t=1;"right"===e.button&&(t=.5),g.s+=e.dX/n.width*100*t,g.v-=e.dY/n.svHeight*100*t,n.primaryColorHSV=new o.BB.HSV(n.primaryColorHSV.h,g.s,g.v),n.primaryColorRGB=o.BB.ColorConverter.toRGB(n.primaryColorHSV),n.updateSVPointer(),n.setColPreview(),n.emitColor(o.BB.ColorConverter.toRGB(n.primaryColorHSV))}"pointerup"===e.type&&n.SVContainer.classList.toggle("kl-color-picker--active",!1)}}),new o.BB.PointerListener({target:d,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(o.BB.unfocusAnyInput(),d.classList.toggle("kl-color-picker--active",!0),"left"===e.button?(g.h=e.relX/n.width*359.99,n.primaryColorHSV=new o.BB.HSV(g.h,n.primaryColorHSV.s,n.primaryColorHSV.v),n.primaryColorRGB=o.BB.ColorConverter.toRGB(n.primaryColorHSV),n.controlH.style.left=Math.round(n.primaryColorHSV.h/359.99*n.width)-1+"px",n.updateSVCanvas(),n.setColPreview(),n.emitColor(o.BB.ColorConverter.toRGB(n.primaryColorHSV))):g.h=n.primaryColorHSV.h),"pointermove"===e.type&&["left","right"].includes(e.button)){var t=Math.abs(e.pageY-e.downPageY),i=(0,h.calcSliderFalloffFactor)(t,"right"===e.button);g.h+=e.dX/n.width*359.99*i,"right"===e.button&&(g.h=g.h%359.99,g.h<0&&(g.h+=359.99)),g.h=Math.min(359.99,g.h),n.primaryColorHSV=new o.BB.HSV(g.h,n.primaryColorHSV.s,n.primaryColorHSV.v),n.primaryColorRGB=o.BB.ColorConverter.toRGB(n.primaryColorHSV),n.controlH.style.left=Math.round(n.primaryColorHSV.h/359.99*n.width)-1+"px",n.updateSVCanvas(),n.setColPreview(),n.emitColor(o.BB.ColorConverter.toRGB(n.primaryColorHSV))}"pointerup"===e.type&&d.classList.toggle("kl-color-picker--active",!1)}})}),1),this.secondaryColorBtn=o.BB.el({parent:this.outputDiv,title:(0,u.LANG)("secondary-color")+" [X]",className:"kl-color-picker__secondary",css:{cursor:"pointer",marginLeft:"5px",width:"22px",height:"22px"},onClick:function(e){e.preventDefault(),n.swapColors()}}),this.updateSecondaryColor()}return(0,s.default)(e,[{key:"updatePrimaryHSV",value:function(e){0===e.s?this.primaryColorHSV=new o.BB.HSV(this.primaryColorHSV.h,e.s,e.v):this.primaryColorHSV=new o.BB.HSV(e.h,e.s,e.v)}},{key:"updateSVCanvas",value:function(){var e=o.BB.ColorConverter.toRGB(new o.BB.HSV(this.primaryColorHSV.h,100,100));o.BB.setAttributes(this.hueStop,{"stop-color":"#"+o.BB.ColorConverter.toHexString(e)})}},{key:"updateSVPointer",value:function(){var e=this.primaryColorHSV.s/100*this.width-7,t=(1-this.primaryColorHSV.v/100)*this.svHeight-6;o.BB.css(this.pointerSV,{left:e+"px",top:t+"px"})}},{key:"setColPreview",value:function(){this.divPreview.style.backgroundColor="rgb("+this.primaryColorRGB.r+","+this.primaryColorRGB.g+","+this.primaryColorRGB.b+")",o.BB.testIsWhiteBestContrast(this.primaryColorRGB)?(o.BB.css(this.pickerButton,{filter:"invert(1)"}),o.BB.css(this.hexButton,{filter:"invert(1)"})):(o.BB.css(this.pickerButton,{filter:""}),o.BB.css(this.hexButton,{filter:""}))}},{key:"updateSecondaryColor",value:function(){this.secondaryColorBtn.style.backgroundColor=o.BB.ColorConverter.toRgbStr(this.secondaryColorRGB)}},{key:"setColor",value:function(e){this.primaryColorRGB={r:parseInt(""+e.r),g:parseInt(""+e.g),b:parseInt(""+e.b)},this.updatePrimaryHSV(o.BB.ColorConverter.toHSV(e)),this.controlH.style.left=parseInt(""+(this.primaryColorHSV.h/359*this.width-1))+"px",this.updateSVCanvas(),this.updateSVPointer(),this.setColPreview()}},{key:"getColor",value:function(){return new o.BB.RGB(this.primaryColorRGB.r,this.primaryColorRGB.g,this.primaryColorRGB.b)}},{key:"getSecondaryRGB",value:function(){return new o.BB.RGB(this.secondaryColorRGB.r,this.secondaryColorRGB.g,this.secondaryColorRGB.b)}},{key:"setPickCallback",value:function(e){this.pickCallback=e}},{key:"pickingDone",value:function(){this.isPicking&&(this.isPicking=!1,this.pickerButton.classList.remove("color-picker-preview-button-active"))}},{key:"enable",value:function(e){e?(this.rootEl.style.pointerEvents="",this.rootEl.style.opacity="1",this.outputDiv.style.pointerEvents="",this.outputDiv.style.opacity="1"):(this.rootEl.style.pointerEvents="none",this.rootEl.style.opacity="0.5",this.outputDiv.style.pointerEvents="none",this.outputDiv.style.opacity="0.5")}},{key:"setHeight",value:function(e){(e=parseInt(""+(e-2*this.height-3),10))!==this.svHeight&&(this.svHeight=e,o.BB.css(this.svSvg,{width:this.width+"px",height:this.svHeight+"px"}),this.SVContainer.style.height=this.svHeight+"px",this.updateSVPointer())}},{key:"swapColors",value:function(){var e=this.secondaryColorHSV;this.secondaryColorHSV=this.primaryColorHSV,this.updatePrimaryHSV(e),e=this.secondaryColorRGB,this.secondaryColorRGB=this.primaryColorRGB,this.primaryColorRGB=e,this.controlH.style.left=parseInt(""+(this.primaryColorHSV.h/359*this.width-1))+"px",this.updateSVCanvas(),this.updateSVPointer(),this.setColPreview(),this.updateSecondaryColor(),this.emitColor(new o.BB.RGB(this.primaryColorRGB.r,this.primaryColorRGB.g,this.primaryColorRGB.b))}},{key:"getElement",value:function(){return this.rootEl}},{key:"getOutputElement",value:function(){return this.outputDiv}}]),e}()})),i.register("6fV2b",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("ffKNP")})),i.register("fohxs",(function(t,n){e(t.exports,"ERASE_COLOR",(function(){return r}));var r=i("1C8RU").theme.isDark()?180:255})),i.register("gmji4",(function(t,n){e(t.exports,"KlColorSliderSmall",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("11glk"),l=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.rootEl=s.BB.el({css:{width:t.width+"px",position:"relative",overflow:"hidden",userSelect:"none"}}),this.rootEl.oncontextmenu=function(e){e.preventDefault()},this.color=s.BB.ColorConverter.toHSV(new s.BB.RGB(t.color.r,t.color.g,t.color.b)),this.width=t.width,this.heightSV=t.heightSV,this.canvasSV=s.BB.canvas(10,10),s.BB.css(this.canvasSV,{width:this.width+"px",height:this.heightSV+"px",cursor:"crosshair"}),this.updateSV();var n=s.BB.canvas(t.width,t.heightH);n.style.cursor="ew-resize",function(){for(var e=s.BB.ctx(n),i=e.createLinearGradient(0,0,t.width,0),r=0;r<1;r+=.01){var a=s.BB.ColorConverter.toRGB(new s.BB.HSV(360*r,100,100));i.addColorStop(r,"rgba("+parseInt(""+a.r)+", "+parseInt(""+a.g)+", "+parseInt(""+a.b)+", 1)")}e.fillStyle=i,e.fillRect(0,0,t.width,t.heightH)}(),s.BB.css(this.canvasSV,{width:t.width+"px",height:t.heightSV+"px",overflow:"hidden",position:"relative"}),this.canvasSV.style.cssFloat="left",n.style.cssFloat="left",this.rootEl.append(this.canvasSV,n),this.pointerSV=s.BB.el({parent:this.rootEl,css:{width:"8px",height:"8px",borderRadius:"8px",position:"absolute",pointerEvents:"none",boxShadow:"0 0 0 1px #000, inset 0 0 0 1px #fff"}}),this.pointerH=s.BB.el({parent:this.rootEl,css:{width:"0",height:t.heightH+"px",borderLeft:"1px solid #fff",borderRight:"1px solid #000",position:"absolute",top:t.heightSV+"px",pointerEvents:"none"}}),this.updateSVPointer(),this.updateHPointer();var a={h:0,s:0,v:0};this.svPointerId=null,this.svPointerListener=new s.BB.PointerListener({target:this.canvasSV,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(s.BB.unfocusAnyInput(),i.svPointerId=e.pointerId,"left"===e.button?(a.s=e.relX/t.width*100,a.v=100-e.relY/t.heightSV*100,i.color=new s.BB.HSV(i.color.h,a.s,a.v),i.updateSVPointer(),t.callback(s.BB.ColorConverter.toRGB(i.color))):(a.s=i.color.s,a.v=i.color.v)),"pointermove"===e.type&&["left","right"].includes(""+e.button)&&i.svPointerId===e.pointerId){var n=1;"right"===e.button&&(n=.5),a.s+=e.dX/t.width*100*n,a.v-=e.dY/t.heightSV*100*n,i.color=new s.BB.HSV(i.color.h,a.s,a.v),i.updateSVPointer(),t.callback(s.BB.ColorConverter.toRGB(i.color))}"pointerup"===e.type&&(i.svPointerId=null)}}),this.hPointerId=null,this.hPointerListener=new s.BB.PointerListener({target:n,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(i.hPointerId=e.pointerId,"left"===e.button?(a.h=e.relX/t.width*359.99,i.color=new s.BB.HSV(a.h,i.color.s,i.color.v),i.updateSV(),i.updateHPointer(),t.callback(s.BB.ColorConverter.toRGB(i.color))):a.h=i.color.h),"pointermove"===e.type&&["left","right"].includes(""+e.button)&&i.hPointerId===e.pointerId){var n=Math.abs(e.pageY-e.downPageY),r=(0,o.calcSliderFalloffFactor)(n,"right"===e.button);a.h+=e.dX/t.width*359.99*r,"right"===e.button&&(a.h=a.h%359.99,a.h<0&&(a.h+=359.99)),a.h=Math.min(359.99,a.h),i.color=new s.BB.HSV(a.h,i.color.s,i.color.v),i.updateSV(),i.updateHPointer(),t.callback(s.BB.ColorConverter.toRGB(i.color))}"pointerup"===e.type&&(i.hPointerId=null)}});s.BB.el({parent:this.rootEl,css:{clear:"both"}})}return(0,a.default)(e,[{key:"updateSV",value:function(){var e=s.BB.ctx(this.canvasSV);if(!e)throw new Error("couldnt create canvas");for(var t=0;t<this.canvasSV.height;t+=1){var i=e.createLinearGradient(0,0,this.canvasSV.width,0),n=s.BB.ColorConverter.toRGB(new s.BB.HSV(this.color.h,1,100-t/this.canvasSV.height*100)),r=s.BB.ColorConverter.toRGB(new s.BB.HSV(this.color.h,100,100-t/this.canvasSV.height*100));i.addColorStop(0,"#"+s.BB.ColorConverter.toHexString(n)),i.addColorStop(1,"#"+s.BB.ColorConverter.toHexString(r)),e.fillStyle="#ff0000",e.fillStyle=i,e.fillRect(0,t,this.canvasSV.width,1)}}},{key:"updateSVPointer",value:function(){var e=this.color.s/100*this.width-4,t=(1-this.color.v/100)*this.heightSV-4;s.BB.css(this.pointerSV,{left:e+"px",top:t+"px"})}},{key:"updateHPointer",value:function(){this.pointerH.style.left=this.color.h/359.999*this.width-1+"px"}},{key:"setColor",value:function(e){this.color=s.BB.ColorConverter.toHSV(new s.BB.RGB(e.r,e.g,e.b)),this.updateSV(),this.updateSVPointer(),this.updateHPointer()}},{key:"getColor",value:function(){return s.BB.ColorConverter.toRGB(this.color)}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.svPointerListener.destroy(),this.hPointerListener.destroy()}},{key:"end",value:function(){this.svPointerId=null,this.hPointerId=null}}]),e}()})),i.register("j5jvd",(function(t,n){e(t.exports,"PointSlider",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.rootEl=s.BB.el({css:{position:"relative"}});var n;s.BB.el({parent:this.rootEl,className:"kl-point-slider__line",css:{marginTop:parseInt(""+(t.pointSize/2-1))+"px",width:t.width+"px"}});this.sliderPoint=s.BB.el({parent:this.rootEl,className:"kl-point-slider__point"});s.BB.el({parent:this.sliderPoint,css:{margin:"-7px 0 0 -7px",width:"calc(100% + 14px)",height:"calc(100% + 7px)"}});var a,o,l=function(){s.BB.css(i.sliderPoint,{left:n+"px"})},h=function(){return n/(t.width-t.pointSize)};n=s.BB.clamp(t.init*(t.width-t.pointSize),0,t.width-t.pointSize),s.BB.css(this.sliderPoint,{width:t.pointSize+"px",height:t.pointSize+"px",borderRadius:t.pointSize+"px"}),l(),this.pointerListener=new s.BB.PointerListener({target:this.sliderPoint,fixScribble:!0,onPointer:function(e){"pointerdown"===e.type&&"left"===e.button?(a=!0,!0,o=n,l(),e.eventStopPropagation()):"pointermove"===e.type&&"left"===e.button&&(e.eventStopPropagation(),o+=e.dX,n=parseInt(""+s.BB.clamp(o,0,t.width-t.pointSize)),l(),t.callback(h(),a,!1),a=!1),"pointerup"===e.type&&(e.eventStopPropagation(),!1,l(),t.callback(h(),!1,!0))}})}return(0,a.default)(e,[{key:"getEl",value:function(){return this.rootEl}},{key:"setActive",value:function(e){this.sliderPoint.style.backgroundColor=e?"#fff":"#eaeaea"}},{key:"destroy",value:function(){this.pointerListener.destroy()}}]),e}()})),i.register("43qNf",(function(t,n){e(t.exports,"ColorOptions",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("1C8RU"),l=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.rootEl=s.BB.el({content:t.label?t.label:"",css:{display:"flex",alignItems:"center"}});var n=0,a=[];this.buttonArr=[];for(var l=s.BB.createCheckerDataUrl(5,void 0,o.theme.isDark()),h=0;h<t.colorArr.length;h++){for(var c=t.colorArr[h],u=!1,p=0;p<a.length;p++){var d=a[p];if(null!==d&&null!==c&&(d.r===c.r&&d.g===c.g&&d.b===c.b&&d.a===c.a)){u=!0;break}}u||(a.push(c),"initialIndex"in t&&t.initialIndex===h&&(n=a.length-1))}for(var g=0;g<a.length;g++)!function(e){var r=s.BB.el({parent:i.rootEl,content:a[e]?"":"X",className:"kl-color-option",css:{width:"22px",height:"22px",backgroundColor:a[e]?s.BB.ColorConverter.toRgbaStr(a[e]):"transparent",lineHeight:"23px"},onClick:function(i){i.preventDefault(),n=e,f(),t.onChange(a[e])}});a[e]&&0===a[e].a&&(r.style.backgroundImage="url("+l+")");i.buttonArr.push({el:r,setIsSelected:function(e){r.classList.toggle("kl-color-option--active",e)}})}(g);var f=function(){for(var e=0;e<i.buttonArr.length;e++)i.buttonArr[e].setIsSelected(e===n)};f(),this.updateCheckerboard=function(){var e=s.BB.createCheckerDataUrl(5,void 0,o.theme.isDark());i.buttonArr.forEach((function(t,i){a[i]&&0===a[i].a&&(t.el.style.backgroundImage="url("+e+")")}))},o.theme.addIsDarkListener(this.updateCheckerboard)}return(0,a.default)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.buttonArr.forEach((function(e){s.BB.destroyEl(e.el)})),this.buttonArr.splice(0,this.buttonArr.length),o.theme.removeIsDarkListener(this.updateCheckerboard)}}]),e}()})),i.register("iFIyy",(function(t,n){e(t.exports,"Options",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.rootEl=s.BB.el();var n=s.BB.el({parent:this.rootEl,className:"kl-option-wrapper",css:{display:"flex"}});t.onChange&&(this.onChange=t.onChange),this.optionArr=[],this.selectedId="initialId"in t&&void 0!==t.initId?t.initId:t.optionArr[0].id;for(var a=function(e){var r=["kl-option"];t.isSmall&&r.push("kl-option--small"),"string"!=typeof e.label&&(r.push("kl-option--custom-el"),s.BB.css(e.label,{display:"block",pointerEvents:"none"}));var a={id:e.id,el:s.BB.el({parent:n,content:e.label,className:r.join(" "),onClick:function(){i.selectedId!==a.id&&(i.selectedId=a.id,i.update(),i.onChange&&i.onChange(i.selectedId))}})};e.title&&(a.el.title=e.title),i.optionArr.push(a)},o=0;o<t.optionArr.length;o++)a(t.optionArr[o]);this.update(),t.changeOnInit&&setTimeout((function(){i.onChange&&i.onChange(i.selectedId)}),0)}return(0,a.default)(e,[{key:"getIndex",value:function(){for(var e=0;e<this.optionArr.length;e++)if(this.optionArr[e].id===this.selectedId)return e;return-1}},{key:"update",value:function(){for(var e=0;e<this.optionArr.length;e++)this.optionArr[e].el.classList.toggle("kl-option-selected",this.optionArr[e].id===this.selectedId)}},{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.selectedId}},{key:"next",value:function(){this.selectedId=this.optionArr[(this.getIndex()+1)%this.optionArr.length].id,this.update(),this.onChange&&this.onChange(this.selectedId)}},{key:"previous",value:function(){this.selectedId=this.optionArr[(this.optionArr.length+this.getIndex()-1)%this.optionArr.length].id,this.update(),this.onChange&&this.onChange(this.selectedId)}},{key:"destroy",value:function(){this.optionArr.forEach((function(e){s.BB.destroyEl(e.el)})),this.optionArr.splice(0,this.optionArr.length)}}]),e}()})),i.register("bmB93",(function(n,r){e(n.exports,"StatusOverlay",(function(){return h}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("eWjiX"),l=i("gGQwz"),h=function(){"use strict";function e(){(0,a.default)(this,e),this.init()}return(0,s.default)(e,[{key:"updateUiState",value:function(){this.el&&(setTimeout((function(){}),100),"left"===this.uiState?this.el.style.left="271px":this.el.style.removeProperty("left"))}},{key:"init",value:function(){this.el=o.BB.el({className:"top-overlay g-root",onClick:o.BB.handleClick}),this.isWide&&(this.el.style.width="100%"),this.updateUiState(),this.innerEl=o.BB.el({className:"top-overlay--inner"}),this.angleIm=new Image,this.angleIm.src=t(l),o.BB.css(this.angleIm,{verticalAlign:"bottom",width:"20px",height:"20px",marginLeft:"5px",borderRadius:"10px"}),this.innerInnerEl=document.createElement("div"),this.innerInnerEl.style.display="inline-block",this.innerEl.append(this.innerInnerEl,this.angleIm),this.el.append(this.innerEl),document.body.append(this.el),this.el.style.display="none"}},{key:"setWide",value:function(e){this.isWide=!!e,this.el&&(this.isWide?(this.el.style.width="100%",this.el.style.left=""):(this.el.style.removeProperty("width"),this.el.style.left="left"===this.uiState?"271px":""))}},{key:"setUiState",value:function(e){this.uiState=e,this.updateUiState()}},{key:"out",value:function(e,t){var i=this;e&&"object"==typeof e?"transform"===e.type?(this.angleIm.style.display="inline-block",this.angleIm.style.transform="rotate("+e.angleDeg+"deg)",e.angleDeg%90==0?this.angleIm.style.boxShadow="inset 0 0 0 1px rgba(255, 255, 255, 0.7)":this.angleIm.style.boxShadow="",this.innerInnerEl.innerHTML=Math.round(100*e.scale)+"%"):this.angleIm.style.display="none":"string"==typeof e&&(this.angleIm.style.display="none",this.innerInnerEl.innerHTML=e),t&&(this.innerEl.style.animation="",setTimeout((function(){return i.innerEl.style.animation="topOverlayPulse 0.5s ease-out"}),20),this.timeout3&&clearTimeout(this.timeout3),this.timeout3=window.setTimeout((function(){return i.innerEl.style.animation=""}),520)),this.timeout&&clearTimeout(this.timeout),this.timeout2&&clearTimeout(this.timeout2),this.el.style.animationName=t?"consoleInFast":"consoleIn",this.el.style.opacity="1",this.timeout=window.setTimeout((function(){i.el.style.opacity="0",i.el.style.animationName="consoleOut",i.timeout2=window.setTimeout((function(){i.el.style.display="none",i.timeout2=0}),450),i.timeout=0}),1200),this.el.style.display="flex"}}]),e}()})),i.register("gGQwz",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("iqIgb")})),i.register("hRdOL",(function(t,n){e(t.exports,"CropCopy",(function(){return h}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=i("1C8RU"),h=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),(0,s.default)(this,"crop",{x:0,y:0,width:0,height:0}),this.rootEl=o.BB.el({className:"kl-edit-crop-preview",css:{position:"relative",height:t.height+"px",width:t.width+"px",overflow:"hidden"}}),t.onChange&&(this.onChange=t.onChange),this.canvas=t.canvas,this.resetCrop();this.croppedCanvas=o.BB.canvas(),this.eventTarget=this.croppedCanvas,t.isNotCopy||(this.croppedImage=new Image,this.eventTarget=this.croppedImage),o.BB.css(this.eventTarget,{height:t.height+"px",width:t.width+"px"}),this.rootEl.append(this.eventTarget),this.updateCroppedCanvas();var n=o.BB.el({css:{width:t.width+"px",height:t.height+"px",position:"absolute",left:"0",top:"0",pointerEvents:"none"}});this.rootEl.append(n),o.BB.createCheckerDataUrl(4,(function(e){n.style.backgroundImage="url("+e+")"}),l.theme.isDark());var a=o.BB.fitInto(this.canvas.width,this.canvas.height,t.width-40,t.height-40,1),h=o.BB.canvas(Math.round(a.width),Math.round(a.height));h.style.imageRendering="pixelated",this.scaleW=h.width/this.canvas.width,this.scaleH=h.height/this.canvas.height;var c=o.BB.ctx(h);c.imageSmoothingEnabled=!1,c.drawImage(this.canvas,0,0,h.width,h.height),n.append(h),this.thumbX=parseInt(""+(t.width-h.width)/2),this.thumbY=parseInt(""+(t.height-h.height)/2),o.BB.css(h,{position:"absolute",left:this.thumbX+"px",top:this.thumbY+"px"}),this.selectionRect=o.BB.el({parent:n,className:"kl-edit-crop-preview__sel"}),this.updateSelectionRect();var u,p,d=function(e){return{x:o.BB.clamp((e.x-i.thumbX)/i.scaleW,0,i.canvas.width),y:o.BB.clamp((e.y-i.thumbY)/i.scaleH,0,i.canvas.height)}},g=function(e,t){var i={x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)},n={x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)},r=d(i),a=d(n);return r.x=Math.floor(r.x),r.y=Math.floor(r.y),a.x=Math.ceil(a.x),a.y=Math.ceil(a.y),{x:r.x,y:r.y,width:a.x-r.x,height:a.y-r.y}},f=null,v=!1,m=!1;this.pointerListener=new o.BB.PointerListener({target:this.eventTarget,fixScribble:!0,onPointer:function(e){var t,n;"pointerdown"===e.type&&"left"===e.button?(e.eventPreventDefault(),v=!0,u={x:e.relX,y:e.relY},!i.isReset()&&(t=u,n={x:Math.round(i.thumbX+i.crop.x*i.scaleW),y:Math.round(i.thumbY+i.crop.y*i.scaleH),width:Math.round(i.crop.width*i.scaleW),height:Math.round(i.crop.height*i.scaleH)},o.BB.isInsideRect(t,n))?f={x:i.crop.x,y:i.crop.y,width:i.crop.width,height:i.crop.height}:i.crop=g(u,u)):"pointermove"===e.type&&"left"===e.button?(e.eventPreventDefault(),m=!0,f?(i.crop.x=f.x+Math.round((e.relX-u.x)/i.scaleW),i.crop.y=f.y+Math.round((e.relY-u.y)/i.scaleH),i.crop.x=o.BB.clamp(i.crop.x,0,i.canvas.width-i.crop.width),i.crop.y=o.BB.clamp(i.crop.y,0,i.canvas.height-i.crop.height)):i.crop=g(u,{x:e.relX,y:e.relY}),i.updateSelectionRect()):"pointerup"===e.type&&u&&(e.eventPreventDefault(),v=!1,f=null,u=null,0!==i.crop.width&&0!==i.crop.height&&m||(i.resetCrop(),i.updateSelectionRect()),m=!1,p=setTimeout((function(){return i.updateCroppedCanvas()}),1))}}),this.keyListener=new o.BB.KeyListener({onDown:function(e,t,n){if(!v){var r=!1,a=Math.max(1,1/i.scaleW),s=i.keyListener.isPressed("shift");"left"===e&&(s?i.crop.width=o.BB.clamp(i.crop.width-a,1,i.canvas.width-i.crop.x):i.crop.x=o.BB.clamp(i.crop.x-a,0,i.canvas.width-i.crop.width),r=!0),"right"===e&&(s?i.crop.width=o.BB.clamp(i.crop.width+a,1,i.canvas.width-i.crop.x):i.crop.x=o.BB.clamp(i.crop.x+a,0,i.canvas.width-i.crop.width),r=!0),"up"===e&&(s?i.crop.height=o.BB.clamp(i.crop.height-a,1,i.canvas.height-i.crop.y):i.crop.y=o.BB.clamp(i.crop.y-a,0,i.canvas.height-i.crop.height),r=!0),"down"===e&&(s?i.crop.height=o.BB.clamp(i.crop.height+a,1,i.canvas.height-i.crop.y):i.crop.y=o.BB.clamp(i.crop.y+a,0,i.canvas.height-i.crop.height),r=!0),r&&(t.preventDefault(),i.updateSelectionRect(),clearTimeout(p),p=setTimeout((function(){return i.updateCroppedCanvas()}),100))}}})}return(0,a.default)(e,[{key:"resetCrop",value:function(){this.crop={x:0,y:0,width:this.canvas.width,height:this.canvas.height}}},{key:"updateCroppedCanvas",value:function(){this.croppedCanvas.width=Math.round(this.crop.width),this.croppedCanvas.height=Math.round(this.crop.height),o.BB.ctx(this.croppedCanvas).drawImage(this.canvas,Math.round(-this.crop.x),Math.round(-this.crop.y)),this.croppedImage&&(this.croppedImage.src=this.croppedCanvas.toDataURL("image/png")),this.onChange&&this.onChange(this.croppedCanvas.width,this.croppedCanvas.height)}},{key:"updateSelectionRect",value:function(){o.BB.css(this.selectionRect,{left:this.thumbX+this.crop.x*this.scaleW+"px",top:this.thumbY+this.crop.y*this.scaleH+"px",width:this.crop.width*this.scaleW+"px",height:this.crop.height*this.scaleH+"px"}),this.onChange&&this.onChange(Math.round(this.crop.width),Math.round(this.crop.height))}},{key:"getEl",value:function(){return this.rootEl}},{key:"reset",value:function(){this.resetCrop(),this.updateCroppedCanvas(),this.updateSelectionRect()}},{key:"destroy",value:function(){this.eventTarget.style.removeProperty("width"),this.eventTarget.style.removeProperty("height"),this.keyListener.destroy(),this.pointerListener.destroy()}},{key:"isReset",value:function(){return 0===this.crop.x&&0===this.crop.y&&this.crop.width===this.canvas.width&&this.crop.height===this.canvas.height}},{key:"getRect",value:function(){return o.BB.copyObj(this.crop)}},{key:"getCroppedImage",value:function(){return this.croppedCanvas}}]),e}()})),i.register("isYih",(function(t,n){e(t.exports,"clipboardDialog",(function(){return u}));var r=i("3kC7t"),a=i("7U0Ew"),s=i("2gUX3"),o=i("eWjiX"),l=i("2MaaK"),h=i("hRdOL"),c=i("1mH1z");function u(e,t,i,n,u){var p=function(){var e=y.getCroppedImage().toDataURL("image/png");setTimeout((0,r.default)((function(){var t,i;return(0,s.__generator)(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),[4,fetch(e)];case 1:return[4,r.sent().blob()];case 2:return t=r.sent(),[4,navigator.clipboard.write([new ClipboardItem((0,a.default)({},t.type,t))])];case 3:return r.sent(),setTimeout((function(){n.out((0,c.LANG)("cropcopy-copied"),!0)}),200),[3,5];case 4:return i=r.sent(),console.error(i.name,i.message),[3,5];case 5:return[2]}}))})),0)},d=function(){x&&x()},g=!1;try{g=!!ClipboardItem}catch(e){}var f=document.createElement("div"),v=window.innerWidth<550||window.innerHeight<550,m=o.BB.el({content:(0,c.LANG)("crop-drag-to-crop")+(g?"":"<br>"+(0,c.LANG)("cropcopy-click-hold")),css:{textAlign:"center"}});f.append(m);var y=new(0,h.CropCopy)({width:v?340:540,height:v?300:350,canvas:t,isNotCopy:!1});o.BB.css(y.getEl(),{marginTop:"10px",marginLeft:"-20px"}),f.append(y.getEl());var x,B=new o.BB.KeyListener({onDown:function(e,t,i){"ctrl+c"===i&&(p(),x&&x())}});window.addEventListener("blur",d);var b=[];g&&b.push((0,c.LANG)("cropcopy-btn-copy")),u&&b.push((0,c.LANG)("cropcopy-btn-crop")),b.push("Cancel"),(0,l.showModal)({target:e,message:"<b>"+(u?"".concat((0,c.LANG)("cropcopy-title-copy")," / ").concat((0,c.LANG)("cropcopy-title-crop")):"".concat((0,c.LANG)("cropcopy-title-copy")))+"</b>",div:f,style:v?{}:{width:"500px"},buttons:b,primaries:[(0,c.LANG)("cropcopy-btn-copy")],callback:function(e){if(e===(0,c.LANG)("cropcopy-btn-copy"))p();else if(e===(0,c.LANG)("cropcopy-btn-crop")){var n=y.getRect();i({left:Math.round(-n.x),right:Math.round(n.x+n.width-t.width),top:Math.round(-n.y),bottom:Math.round(n.y+n.height-t.height)})}window.removeEventListener("blur",d),y.destroy(),B.destroy()},clickOnEnter:(0,c.LANG)("cropcopy-btn-copy"),closeFunc:function(e){x=e}})}})),i.register("jMW1P",(function(n,r){e(n.exports,"LayerManager",(function(){return k}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("7U0Ew"),l=i("eWjiX"),h=i("gWfkn"),c=i("eEL9N"),u=i("j5jvd"),p=i("705qg"),d=i("1mH1z"),g=i("bBcC4"),f=i("jneUH"),v=i("6NMo1"),m=i("hWVsV"),y=i("5Ycub"),x=i("jKBKm"),B=i("auzYC"),b=i("1Qqvs"),w=i("1C8RU"),k=function(){"use strict";function e(i,n,r,s){var u=this;(0,a.default)(this,e),(0,o.default)(this,"lastpos",0),(0,o.default)(this,"layerHeight",35),(0,o.default)(this,"layerSpacing",0),this.parentEl=r,this.klCanvas=i,this.layerElArr=[],this.layerHeight=35,this.layerSpacing=0;this.onSelect=n,this.uiState=s,this.largeThumbDiv=l.BB.el({onClick:l.BB.handleClick,css:{position:"absolute",top:"500px",background:"#aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",pointerEvents:"none",padding:"0",border:"1px solid #aaa",transition:"opacity 0.3s ease-out",userSelect:"none"}}),this.setUiState(s),l.BB.createCheckerDataUrl(4,(function(e){u.largeThumbDiv.style.backgroundImage="url("+e+")"}),w.theme.isDark()),this.largeThumbCanvas=l.BB.canvas(200,200),this.largeThumbCanvas.style.display="block",this.largeThumbDiv.append(this.largeThumbCanvas),this.largeThumbInDocument=!1,this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex=this.klCanvasLayerArr.length-1,this.rootEl=l.BB.el({css:{marginRight:"10px",marginBottom:"10px",marginLeft:"10px",marginTop:"10px",cursor:"default"}});var f=l.BB.el({css:{width:"250px",position:"relative"}});this.layerListEl=l.BB.el(),this.addBtn=l.BB.el({tagName:"button"}),this.duplicateBtn=l.BB.el({tagName:"button"}),this.mergeBtn=l.BB.el({tagName:"button"}),this.removeBtn=l.BB.el({tagName:"button"});var k,C,S=l.BB.el({tagName:"button"});this.rootEl.append((k=l.BB.el(),setTimeout((function(){l.BB.makeUnfocusable(u.addBtn),l.BB.makeUnfocusable(u.duplicateBtn),l.BB.makeUnfocusable(u.mergeBtn),l.BB.makeUnfocusable(u.removeBtn),l.BB.makeUnfocusable(S),u.addBtn.style.cssFloat="left",u.duplicateBtn.style.cssFloat="left",u.mergeBtn.style.cssFloat="left",u.removeBtn.style.cssFloat="left",S.style.cssFloat="left",u.addBtn.title=(0,d.LANG)("layers-new"),u.duplicateBtn.title=(0,d.LANG)("layers-duplicate"),u.removeBtn.title=(0,d.LANG)("layers-remove"),u.mergeBtn.title=(0,d.LANG)("layers-merge"),S.title=(0,d.LANG)("layers-rename-title"),u.addBtn.style.paddingLeft="5px",u.addBtn.style.paddingRight="3px",u.removeBtn.style.paddingLeft="5px",u.removeBtn.style.paddingRight="3px",u.duplicateBtn.style.paddingLeft="5px",u.duplicateBtn.style.paddingRight="3px",u.mergeBtn.style.paddingLeft="5px",u.mergeBtn.style.paddingRight="3px",S.style.height="30px",S.style.lineHeight="20px",u.addBtn.innerHTML="<img src='"+t(m)+"' height='20'/>",u.duplicateBtn.innerHTML="<img src='"+t(y)+"' height='20'/>",u.mergeBtn.innerHTML="<img src='"+t(x)+"' height='20'/>",u.removeBtn.innerHTML="<img src='"+t(B)+"' height='20'/>",S.innerHTML="<img src='"+t(b)+"' height='20'/>",u.addBtn.style.marginRight="5px",u.removeBtn.style.marginRight="5px",u.duplicateBtn.style.marginRight="5px",u.mergeBtn.style.marginRight="5px",k.append(u.addBtn,u.removeBtn,u.duplicateBtn,u.mergeBtn,S,l.BB.el({css:{clear:"both",height:"10px"}})),u.addBtn.onclick=function(){!1!==u.klCanvas.addLayer(u.selectedSpotIndex)&&(u.klCanvasLayerArr=u.klCanvas.getLayers(),u.klCanvasLayerArr.length===p.MAX_LAYERS&&(u.addBtn.disabled=!0,u.duplicateBtn.disabled=!0),u.removeBtn.disabled=!1,u.selectedSpotIndex=u.selectedSpotIndex+1,u.createLayerList(),h.klHistory.pause(!0),u.onSelect(u.selectedSpotIndex),h.klHistory.pause(!1))},u.duplicateBtn.onclick=function(){!1!==u.klCanvas.duplicateLayer(u.selectedSpotIndex)&&(u.klCanvasLayerArr=u.klCanvas.getLayers(),u.klCanvasLayerArr.length===p.MAX_LAYERS&&(u.addBtn.disabled=!0,u.duplicateBtn.disabled=!0),u.removeBtn.disabled=!1,u.selectedSpotIndex++,u.createLayerList(),h.klHistory.pause(!0),u.onSelect(u.selectedSpotIndex),h.klHistory.pause(!1))},u.removeBtn.onclick=function(){u.layerElArr.length<=1||(u.klCanvas.removeLayer(u.selectedSpotIndex),u.selectedSpotIndex>0&&u.selectedSpotIndex--,u.klCanvasLayerArr=u.klCanvas.getLayers(),u.createLayerList(),h.klHistory.pause(!0),u.onSelect(u.selectedSpotIndex),h.klHistory.pause(!1),1===u.klCanvasLayerArr.length&&(u.removeBtn.disabled=!0),u.klCanvasLayerArr.length<p.MAX_LAYERS&&(u.addBtn.disabled=!1,u.duplicateBtn.disabled=!1))},u.mergeBtn.onclick=function(){u.selectedSpotIndex<=0||(0,v.mergeLayerDialog)(u.parentEl,{topCanvas:u.klCanvasLayerArr[u.selectedSpotIndex].context.canvas,bottomCanvas:u.klCanvasLayerArr[u.selectedSpotIndex-1].context.canvas,topOpacity:u.klCanvas.getLayer(u.selectedSpotIndex).opacity,mixModeStr:u.klCanvasLayerArr[u.selectedSpotIndex].mixModeStr,callback:function(e){u.klCanvas.mergeLayers(u.selectedSpotIndex,u.selectedSpotIndex-1,e),u.klCanvasLayerArr=u.klCanvas.getLayers(),u.selectedSpotIndex--,1===u.klCanvasLayerArr.length&&(u.removeBtn.disabled=!0),u.klCanvasLayerArr.length<p.MAX_LAYERS&&(u.addBtn.disabled=!1,u.duplicateBtn.disabled=!1),u.createLayerList(),h.klHistory.pause(!0),u.onSelect(u.selectedSpotIndex),h.klHistory.pause(!1)}})},S.onclick=function(){u.renameLayer(u.selectedSpotIndex)}}),1),k)),C=l.BB.el({content:(0,d.LANG)("layers-blending")+"&nbsp;",css:{fontSize:"15px"}}),this.modeSelect=new(0,c.Select)({optionArr:["source-over",null,"darken","multiply","color-burn",null,"lighten","screen","color-dodge",null,"overlay","soft-light","hard-light",null,"difference","exclusion",null,"hue","saturation","color","luminosity"].map((function(e){return e?[e,(0,g.translateBlending)(e)]:null})),onChange:function(e){u.klCanvas.setMixMode(u.selectedSpotIndex,e),u.update(u.selectedSpotIndex)},css:{marginBottom:"10px"}}),C.append(this.modeSelect.getElement()),this.rootEl.append(C),f.append(this.layerListEl),this.rootEl.append(f),setInterval((function(){if("block"===u.rootEl.style.display){var e=h.klHistory.getState();if(e!==u.oldHistoryState){u.oldHistoryState=e;for(var t=0;t<u.layerElArr.length;t++)if(u.selectedSpotIndex===u.layerElArr[t].spot&&u.klCanvasLayerArr[u.layerElArr[t].spot]){var i=l.BB.ctx(u.layerElArr[t].thumb);i.save(),i.clearRect(0,0,i.canvas.width,i.canvas.height),u.klCanvasLayerArr[u.layerElArr[t].spot].context.canvas.width<u.layerElArr[t].thumb.width&&(i.imageSmoothingEnabled=!1),i.drawImage(u.klCanvasLayerArr[u.layerElArr[t].spot].context.canvas,0,0,u.layerElArr[t].thumb.width,u.layerElArr[t].thumb.height),i.restore()}}}}),1),w.theme.addIsDarkListener((function(){u.createLayerList()})),this.createLayerList()}return(0,s.default)(e,[{key:"move",value:function(e,t){var i=this;if(isNaN(e)||isNaN(t))throw"layermanager - invalid move";for(var n=0;n<this.klCanvasLayerArr.length;n++)!function(n){var r=i.layerElArr[n].spot;i.layerElArr[n].spot===e?r=t:(i.layerElArr[n].spot>e&&r--,r>=t&&r++),i.layerElArr[n].spot=r,i.layerElArr[n].posY=(i.layerHeight+i.layerSpacing)*(i.klCanvasLayerArr.length-r-1),i.layerElArr[n].style.top=i.layerElArr[n].posY+"px"}(n);e!==t&&(this.klCanvas.moveLayer(this.selectedSpotIndex,t-e),this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex=t,this.mergeBtn.disabled=0===this.selectedSpotIndex)}},{key:"posToSpot",value:function(e){var t=parseInt(""+(e/(this.layerHeight+this.layerSpacing)+.5));return t=Math.min(this.klCanvasLayerArr.length-1,Math.max(0,t)),t=this.klCanvasLayerArr.length-t-1}},{key:"updateLayersVerticalPosition",value:function(e,t){if((t=Math.min(this.klCanvasLayerArr.length-1,Math.max(0,t)))!==this.lastpos){for(var i=0;i<this.klCanvasLayerArr.length;i++)if(this.layerElArr[i].spot!==e){var n=this.layerElArr[i].spot;this.layerElArr[i].spot>e&&n--,n>=t&&n++,this.layerElArr[i].posY=(this.layerHeight+this.layerSpacing)*(this.klCanvasLayerArr.length-n-1),this.layerElArr[i].style.top=this.layerElArr[i].posY+"px"}this.lastpos=t}}},{key:"renameLayer",value:function(e){var t=this;(0,f.renameLayerDialog)(this.parentEl,this.klCanvas.getLayer(e).name,(function(i){void 0!==i&&i!==t.klCanvas.getLayer(e).name&&(t.klCanvas.renameLayer(e,i),t.createLayerList(),h.klHistory.pause(!0),t.onSelect(e),h.klHistory.pause(!1))}))}},{key:"updateHeight",value:function(){this.layerListEl.style.height=35*this.layerElArr.length+"px"}},{key:"createLayerList",value:function(){var e=this;this.oldHistoryState=h.klHistory.getState();var t=function(t){var i=e.klCanvas.getLayer(t).name,n=e.klCanvasLayerArr[t].opacity,r=e.klCanvasLayerArr[t].context.canvas,a=l.BB.el();a.className="kl-layer",e.layerElArr[t]=a,a.posY=35*(e.klCanvasLayerArr.length-1)-35*t,l.BB.css(a,{top:a.posY+"px"});var s=l.BB.el();l.BB.css(s,{position:"relative"});var o=l.BB.el();l.BB.css(o,{width:"250px",height:"34px"});var c=l.BB.el();a.append(s),s.append(o,c),a.spot=t;var p,d=l.BB.fitInto(r.width,r.height,30,30,1),g=a.thumb=l.BB.canvas(d.width,d.height),f=l.BB.ctx(g);f.save(),g.width>r.width&&(f.imageSmoothingEnabled=!1),f.drawImage(r,0,0,g.width,g.height),f.restore(),l.BB.css(a.thumb,{position:"absolute",left:(32-a.thumb.width)/2+"px",top:(32-a.thumb.height)/2+"px"}),l.BB.createCheckerDataUrl(4,(function(e){g.style.backgroundImage="url("+e+")"}),w.theme.isDark()),a.label=l.BB.el({className:"kl-layer__label"}),a.layerName=i,a.label.append(a.layerName),l.BB.css(a.label,{position:"absolute",left:"38px",top:"1px",fontSize:"13px",width:"170px",height:"20px",overflow:"hidden",whiteSpace:"nowrap"}),a.label.ondblclick=function(){e.renameLayer(a.spot)},a.opacityLabel=l.BB.el({className:"kl-layer__opacity-label"}),a.opacity=n,a.opacityLabel.append(parseInt(""+100*a.opacity)+"%"),l.BB.css(a.opacityLabel,{position:"absolute",left:"194px",top:"1px",fontSize:"13px",textAlign:"right",width:"50px",transition:"color 0.2s ease-in-out"});var v=new(0,u.PointSlider)({init:a.opacity,width:204,pointSize:14,callback:function(t,i,n){return i?(p=e.klCanvas.getLayer(a.spot).opacity,void h.klHistory.pause(!0)):n?(h.klHistory.pause(!1),void(p!==t&&e.klCanvas.layerOpacity(a.spot,t))):(a.opacityLabel.innerHTML=Math.round(100*t)+"%",void e.klCanvas.layerOpacity(a.spot,t))}});l.BB.css(v.getEl(),{position:"absolute",left:"39px",top:"17px"}),a.opacitySlider=v,a.thumb.onpointerover=function(t){if(0===t.buttons||t.pointerType&&"touch"===t.pointerType){var i=l.BB.fitInto(r.width,r.height,250,250,1);e.largeThumbCanvas.width===i.width&&e.largeThumbCanvas.height===i.height||(e.largeThumbCanvas.width=i.width,e.largeThumbCanvas.height=i.height);var n=l.BB.ctx(e.largeThumbCanvas);n.save(),e.largeThumbCanvas.width>r.width&&(n.imageSmoothingEnabled=!1),n.imageSmoothingQuality="high",n.clearRect(0,0,e.largeThumbCanvas.width,e.largeThumbCanvas.height),n.drawImage(r,0,0,e.largeThumbCanvas.width,e.largeThumbCanvas.height),n.restore(),l.BB.css(e.largeThumbDiv,{top:t.clientY-e.largeThumbCanvas.height/2+"px",opacity:"0"}),e.largeThumbInDocument||(document.body.append(e.largeThumbDiv),e.largeThumbInDocument=!0),clearTimeout(e.largeThumbInTimeout),e.largeThumbInTimeout=setTimeout((function(){l.BB.css(e.largeThumbDiv,{opacity:"1"})}),20),clearTimeout(e.largeThumbTimeout)}},a.thumb.onpointerout=function(){clearTimeout(e.largeThumbInTimeout),l.BB.css(e.largeThumbDiv,{opacity:"0"}),clearTimeout(e.largeThumbTimeout),e.largeThumbTimeout=setTimeout((function(){e.largeThumbInDocument&&(document.body.removeChild(e.largeThumbDiv),e.largeThumbInDocument=!1)}),300)},o.append(a.thumb,a.label,a.opacityLabel,v.getEl());var m=!1,y=!1;a.pointerListener=new l.BB.PointerListener({target:o,onPointer:function(t){if("pointerdown"===t.type&&"left"===t.button)l.BB.css(a,{transition:"box-shadow 0.3s ease-in-out"}),a.style.zIndex="1",e.lastpos=a.spot,y=!1,a.isSelected||(y=!0,e.activateLayer(a.spot)),m=!0;else if("pointermove"===t.type&&"left"===t.button){m&&(m=!1,l.BB.css(a,{boxShadow:"1px 3px 5px rgba(0,0,0,0.4)"})),a.posY+=t.dY;var i=Math.max(0,Math.min(35*(e.klCanvasLayerArr.length-1),a.posY));a.style.top=i+"px",e.updateLayersVerticalPosition(a.spot,e.posToSpot(a.posY))}if("pointerup"===t.type){l.BB.css(a,{transition:"all 0.1s linear"}),setTimeout((function(){l.BB.css(a,{boxShadow:""})}),20),a.posY=Math.max(0,Math.min(35*(e.klCanvasLayerArr.length-1),a.posY)),a.style.zIndex="";var n=e.posToSpot(a.posY),r=a.spot;e.move(a.spot,n),r!=n&&(h.klHistory.pause(!0),e.onSelect(e.selectedSpotIndex),h.klHistory.pause(!1)),r===n&&y&&e.onSelect(e.selectedSpotIndex),y=!1}}}),e.layerListEl.append(a)};for(this.layerElArr=[];this.layerListEl.firstChild;){var i=this.layerListEl.firstChild;i.pointerListener.destroy(),i.opacitySlider.destroy(),this.layerListEl.removeChild(i)}for(var n=0;n<this.klCanvasLayerArr.length;n++)t(n);this.activateLayer(this.selectedSpotIndex),this.updateHeight()}},{key:"update",value:function(e){var t=this;this.klCanvasLayerArr=this.klCanvas.getLayers(),(e||0===e)&&(this.selectedSpotIndex=e),this.removeBtn.disabled=1===this.klCanvasLayerArr.length,this.klCanvasLayerArr.length===p.MAX_LAYERS?(this.addBtn.disabled=!0,this.duplicateBtn.disabled=!0):(this.addBtn.disabled=!1,this.duplicateBtn.disabled=!1),setTimeout((function(){return t.createLayerList()}),1)}},{key:"getSelected",value:function(){return this.selectedSpotIndex}},{key:"activateLayer",value:function(e){if(e<0||e>this.layerElArr.length-1)throw"invalid spotIndex "+e+", layerElArr.length "+this.layerElArr.length;this.selectedSpotIndex=e,this.modeSelect.setValue(this.klCanvasLayerArr[this.selectedSpotIndex].mixModeStr);for(var t=0;t<this.layerElArr.length;t++){var i=this.layerElArr[t],n=this.selectedSpotIndex===i.spot;l.BB.css(i,{boxShadow:""}),i.classList.toggle("kl-layer--selected",n),i.opacitySlider.setActive(n),i.isSelected=n}this.mergeBtn.disabled=0===this.selectedSpotIndex}},{key:"setUiState",value:function(e){this.uiState=e,"left"===this.uiState?l.BB.css(this.largeThumbDiv,{left:"280px",right:""}):l.BB.css(this.largeThumbDiv,{left:"",right:"280px"})}},{key:"getElement",value:function(){return this.rootEl}}]),e}()})),i.register("705qg",(function(t,n){e(t.exports,"MAX_LAYERS",(function(){return v})),e(t.exports,"KlCanvas",(function(){return m}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("4Ea8f"),o=i("eWjiX"),l=i("30Cml"),h=i("3ujzu"),c=i("h20yl"),u=i("gWfkn"),p=i("aSJRf"),d=i("1mH1z"),g=i("7EG77"),f=["source-over","darken","multiply","color-burn","lighten","screen","color-dodge","overlay","soft-light","hard-light","difference","exclusion","hue","saturation","color","luminosity"],v=16,m=function(){"use strict";function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if((0,r.default)(this,e),this.layerNrOffset=i,this.layerCanvasArr=[],this.pickCanvas=o.BB.canvas(1,1),this.history=new(0,u.DecoyKlHistory),"copy"in t?(this.width=1,this.height=1):"width"in t&&"height"in t?(this.width=t.width,this.height=t.height):(this.width=1,this.height=1),this.init(this.width,this.height),this.changeListenerArr=[],"copy"in t)try{this.copy(t.copy)}catch(e){throw this.destroy(),e}else if("projectObj"in t){var n=(0,s.default)(t.projectObj.layers);if(this.init(t.projectObj.width,t.projectObj.height),!n.length)throw new Error("project.layers needs at least 1 layer");for(var a=0;a<n.length;a++){if(n[a].mixModeStr&&!f.includes(n[a].mixModeStr))throw new Error("unknown mixModeStr "+n[a].mixModeStr);this.addLayer(),this.layerOpacity(a,n[a].opacity),this.layerCanvasArr[a].name=n[a].name,this.layerCanvasArr[a].mixModeStr=n[a].mixModeStr?n[a].mixModeStr:"source-over",o.BB.ctx(this.layerCanvasArr[a]).drawImage(n[a].image,0,0)}}this.updateIndices()}return(0,a.default)(e,[{key:"init",value:function(e,t){if(!e||!t||isNaN(e)||isNaN(t)||e<1||t<1)throw new Error("init - invalid canvas size: "+e+", "+t);this.width=e,this.height=t}},{key:"emitChange",value:function(){this.changeListenerArr.forEach((function(e){return e()}))}},{key:"updateIndices",value:function(){this.layerCanvasArr.forEach((function(e,t){e.index=t}))}},{key:"setHistory",value:function(e){this.history=e}},{key:"reset",value:function(e){if(!e.width||!e.height||e.width<1||e.height<1||isNaN(e.width)||isNaN(e.height))throw new Error("invalid canvas size");if(this.history.pause(!0),this.width=e.width,this.height=e.height,this.layerCanvasArr.splice(1,Math.max(0,this.layerCanvasArr.length-1)),e.layers)for(var t=0;t<e.layers.length;t++){var i=e.layers[t];this.layerCanvasArr[t]||this.addLayer(),this.layerCanvasArr[t].name=i.name,this.layerCanvasArr[t].width=this.width,this.layerCanvasArr[t].height=this.height,this.layerCanvasArr[t].mixModeStr=i.mixModeStr?i.mixModeStr:"source-over",o.BB.ctx(this.layerCanvasArr[t]).drawImage(i.image,0,0),this.layerOpacity(t,i.opacity)}else this.layerCanvasArr[0].name=e.layerName?e.layerName:(0,d.LANG)("layers-layer")+" 1",this.layerCanvasArr[0].width=this.width,this.layerCanvasArr[0].height=this.height,this.layerCanvasArr[0].mixModeStr="source-over",this.layerOpacity(0,1),e.color?this.layerFill(0,e.color):e.image&&o.BB.ctx(this.layerCanvasArr[0]).drawImage(e.image,0,0);return this.updateIndices(),this.history.pause(!1),this.history.push({tool:["canvas"],action:"reset",params:[e]}),this.layerCanvasArr.length-1}},{key:"isLayerLimitReached",value:function(){return this.layerCanvasArr.length>=v}},{key:"getWidth",value:function(){return this.width}},{key:"getHeight",value:function(){return this.height}},{key:"copy",value:function(e){if(e.getWidth()<1||e.getHeight()<1||isNaN(e.getWidth())||isNaN(e.getHeight()))throw new Error("invalid canvas size");for(var t=e.getLayers();this.layerCanvasArr.length>t.length;)this.removeLayer(this.layerCanvasArr.length-1);e.getWidth()==this.width&&e.getHeight()==this.height||this.init(e.getWidth(),e.getHeight());for(var i=0;i<t.length;i++)i>=this.layerCanvasArr.length?this.addLayer():(this.layerCanvasArr[i].width=this.width,this.layerCanvasArr[i].height=this.height),this.layerOpacity(i,t[i].opacity),this.layerCanvasArr[i].name=t[i].name,this.layerCanvasArr[i].mixModeStr=t[i].mixModeStr,o.BB.ctx(this.layerCanvasArr[i]).drawImage(t[i].context.canvas,0,0);this.updateIndices()}},{key:"getLayerCount",value:function(){return this.layerCanvasArr.length}},{key:"resize",value:function(e,t){var i,n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"smooth";if(!e||!t||e===this.width&&t===this.height||isNaN(e)||isNaN(t)||e<1||t<1)return!1;if(e=Math.max(e,1),t=Math.max(t,1),"pixelated"===r){i=o.BB.canvas(e,t);var a=o.BB.ctx(i);a.imageSmoothingEnabled=!1;for(var s=0;s<this.layerCanvasArr.length;s++){s>0&&a.clearRect(0,0,e,t);var l=this.layerCanvasArr[s];a.drawImage(l,0,0,e,t),l.width=e,l.height=t,o.BB.ctx(l).drawImage(i,0,0)}}else{if("smooth"!==r)throw new Error("unknown resize algorithm");i=o.BB.canvas(),n=o.BB.canvas();for(var h=0;h<this.layerCanvasArr.length;h++)o.BB.resizeCanvas(this.layerCanvasArr[h],e,t,i,n)}return this.width=e,this.height=t,!0}},{key:"resizeCanvas",value:function(e){var t=Math.round(e.left)+this.width+Math.round(e.right),i=Math.round(e.top)+this.height+Math.round(e.bottom),n=Math.round(e.left),r=Math.round(e.top);if(isNaN(t)||isNaN(i)||t<1||i<1)throw new Error("KlCanvas.resizeCanvas - invalid canvas size");for(var a=0;a<this.layerCanvasArr.length;a++){var s=o.BB.canvas(this.width,this.height),l=this.layerCanvasArr[a],h=o.BB.ctx(this.layerCanvasArr[a]);o.BB.ctx(s).drawImage(l,0,0),this.layerCanvasArr[a].width=t,this.layerCanvasArr[a].height=i,h.save(),0===a&&e.fillColor&&(h.fillStyle=o.BB.ColorConverter.toRgbStr(e.fillColor),h.fillRect(0,0,t,i),h.clearRect(n,r,this.width,this.height)),h.drawImage(s,n,r),h.restore()}this.width=t,this.height=i}},{key:"addLayer",value:function(e){if(this.isLayerLimitReached())return!1;var t=o.BB.canvas(this.width,this.height);if(!t.getContext("2d"))throw new Error("kl-create-canvas-error");return t.mixModeStr="source-over",void 0===e?(this.layerCanvasArr[this.layerCanvasArr.length]=t,e=Math.max(0,this.layerCanvasArr.length-1)):(this.layerCanvasArr.splice(e+1,0,t),e++),t.name=(0,d.LANG)("layers-layer")+" "+(this.layerCanvasArr.length+this.layerNrOffset),this.history.pause(!0),this.layerOpacity(e,1),this.history.pause(!1),this.updateIndices(),this.history.push({tool:["canvas"],action:"addLayer",params:[e-1]}),e}},{key:"duplicateLayer",value:function(e){if(!this.layerCanvasArr[e]||this.isLayerLimitReached())return!1;var t=o.BB.canvas(this.width,this.height);return this.layerCanvasArr.splice(e+1,0,t),t.name=this.layerCanvasArr[e].name+" "+(0,d.LANG)("layers-copy"),t.mixModeStr=this.layerCanvasArr[e].mixModeStr,o.BB.ctx(t).drawImage(this.layerCanvasArr[e],0,0),this.history.pause(!0),this.layerOpacity(e+1,this.layerCanvasArr[e].opacity),this.history.pause(!1),this.updateIndices(),this.history.push({tool:["canvas"],action:"duplicateLayer",params:[e]}),e+1}},{key:"getLayerContext",value:function(e,t){if(this.layerCanvasArr[e])return o.BB.ctx(this.layerCanvasArr[e]);if(t)return null;throw new Error("layer of index "+e+" not found (in "+this.layerCanvasArr.length+" layers)")}},{key:"removeLayer",value:function(e){return!!this.layerCanvasArr[e]&&(this.layerCanvasArr.splice(e,1),this.updateIndices(),this.history.push({tool:["canvas"],action:"removeLayer",params:[e]}),Math.max(0,e-1))}},{key:"renameLayer",value:function(e,t){return!!this.layerCanvasArr[e]&&(this.layerCanvasArr[e].name=t,this.history.push({tool:["canvas"],action:"renameLayer",params:[e,t]}),!0)}},{key:"layerOpacity",value:function(e,t){this.layerCanvasArr[e]&&(t=Math.max(0,Math.min(1,t)),this.layerCanvasArr[e].opacity=t,this.history.push({tool:["canvas"],action:"layerOpacity",params:[e,t]}),this.emitChange())}},{key:"moveLayer",value:function(e,t){if(0!==t&&this.layerCanvasArr[e]){var i=this.layerCanvasArr[e];this.layerCanvasArr.splice(e,1);var n=Math.max(0,Math.min(e+t,this.layerCanvasArr.length));return this.layerCanvasArr.splice(n,0,i),this.updateIndices(),this.history.push({tool:["canvas"],action:"moveLayer",params:[e,t]}),n}}},{key:"mergeLayers",value:function(e,t,i){if(this.layerCanvasArr[e]&&this.layerCanvasArr[t]&&e!==t){if(e>t){var n=e;e=t,t=n}var r=this.layerCanvasArr[t].opacity;if(0!==r&&r){var a=o.BB.ctx(this.layerCanvasArr[e]);a.save(),"as-alpha"===i?(o.BB.convertToAlphaChannelCanvas(this.layerCanvasArr[t]),a.globalCompositeOperation="destination-in",a.globalAlpha=r,o.BB.ctx(this.layerCanvasArr[e]).drawImage(this.layerCanvasArr[t],0,0)):(i&&(a.globalCompositeOperation=i),a.globalAlpha=r,o.BB.ctx(this.layerCanvasArr[e]).drawImage(this.layerCanvasArr[t],0,0)),a.restore(),i&&(a.save(),a.fillStyle="rgba(0,0,0,0.01)",a.fillRect(-.9999999,-.9999999,1,1),a.restore())}return this.updateIndices(),this.history.pause(!0),this.removeLayer(t),this.history.pause(!1),this.history.push({tool:["canvas"],action:"mergeLayers",params:[e,t,i]}),e}}},{key:"rotate",value:function(e){for(;e<0;)e+=360;if((e%=360)%90==0&&0!==e){var t=o.BB.canvas();0===e||180===e?(t.width=this.width,t.height=this.height):90!==e&&270!==e||(t.width=this.height,t.height=this.width);for(var i=o.BB.ctx(t),n=0;n<this.layerCanvasArr.length;n++)i.clearRect(0,0,t.width,t.height),i.save(),i.translate(t.width/2,t.height/2),i.rotate(e*Math.PI/180),180===e?i.drawImage(this.layerCanvasArr[n],-t.width/2,-t.height/2):90!==e&&270!==e||i.drawImage(this.layerCanvasArr[n],-t.height/2,-t.width/2),this.layerCanvasArr[n].width=t.width,this.layerCanvasArr[n].height=t.height,o.BB.ctx(this.layerCanvasArr[n]).clearRect(0,0,this.layerCanvasArr[n].width,this.layerCanvasArr[n].height),o.BB.ctx(this.layerCanvasArr[n]).drawImage(t,0,0),i.restore();this.width=t.width,this.height=t.height}}},{key:"flip",value:function(e,t,i){if(e||t){var n=o.BB.canvas(this.width,this.height);n.width=this.width,n.height=this.height;for(var r=o.BB.ctx(n),a=0;a<this.layerCanvasArr.length;a++)(!i&&0!==i||a===i)&&(r.save(),r.clearRect(0,0,n.width,n.height),r.translate(n.width/2,n.height/2),r.scale(e?-1:1,t?-1:1),r.drawImage(this.layerCanvasArr[a],-n.width/2,-n.height/2),r.restore(),o.BB.ctx(this.layerCanvasArr[a]).clearRect(0,0,this.layerCanvasArr[a].width,this.layerCanvasArr[a].height),o.BB.ctx(this.layerCanvasArr[a]).drawImage(n,0,0))}}},{key:"layerFill",value:function(e,t,i){var n=o.BB.ctx(this.layerCanvasArr[e]);n.save(),i&&(n.globalCompositeOperation=i),n.fillStyle="rgba("+t.r+","+t.g+","+t.b+",1)",n.fillRect(0,0,this.layerCanvasArr[e].width,this.layerCanvasArr[e].height),n.restore(),n.save(),n.fillStyle="rgba(0,0,0,0.01)",n.fillRect(-.9999999,-.9999999,1,1),n.restore(),this.history.push({tool:["canvas"],action:"layerFill",params:[e,t,i]})}},{key:"floodFill",value:function(e,t,i,n,r,a,s,h,c){if(!(t<0||i<0||t>=this.width||i>=this.height||0===r)){if(a=Math.round(a),!["above","current","all"].includes(s))throw new Error("invalid sampleStr");var u,p,d,g,f,v,m;if("all"===s){var y=1===this.layerCanvasArr.length?this.layerCanvasArr[0]:this.getCompleteCanvas(1);g=(d=(p=o.BB.ctx(y)).getImageData(0,0,this.width,this.height)).data,u=(0,l.floodFillBits)(g,this.width,this.height,t,i,a,Math.round(h),c),y=null,p=null,d=null,g=null,v=(f=o.BB.ctx(this.layerCanvasArr[e])).getImageData(0,0,this.width,this.height)}else{var x="above"===s?e+1:e;if(x>=this.layerCanvasArr.length)return;g=(d=(p=o.BB.ctx(this.layerCanvasArr[x])).getImageData(0,0,this.width,this.height)).data,u=(0,l.floodFillBits)(g,this.width,this.height,t,i,a,Math.round(h),c),e!==x&&(p=null,d=null,g=null),f=e===x?p:o.BB.ctx(this.layerCanvasArr[e]),v=e===x?d:f.getImageData(0,0,this.width,this.height)}if(m=v.data,n)if(1===r)for(var B=0;B<this.width*this.height;B++)255===u.data[B]&&(m[4*B]=n.r,m[4*B+1]=n.g,m[4*B+2]=n.b,m[4*B+3]=255);else for(var b=0;b<this.width*this.height;b++)255===u.data[b]&&(m[4*b]=o.BB.mix(m[4*b],n.r,r),m[4*b+1]=o.BB.mix(m[4*b+1],n.g,r),m[4*b+2]=o.BB.mix(m[4*b+2],n.b,r),m[4*b+3]=o.BB.mix(m[4*b+3],255,r));else if(1===r)for(var w=0;w<this.width*this.height;w++)255===u.data[w]&&(m[4*w+3]=0);else for(var k=0;k<this.width*this.height;k++)255===u.data[k]&&(m[4*k+3]=o.BB.mix(m[4*k+3],0,r));f.putImageData(v,0,0),this.history.push({tool:["canvas"],action:"replaceLayer",params:[e,v]})}}},{key:"drawShape",value:function(e,t){t.x1===t.x2&&t.y1===t.y2||((0,h.drawShape)(o.BB.ctx(this.layerCanvasArr[e]),t),this.history.push({tool:["canvas"],action:"drawShape",params:[e,o.BB.copyObj(t)]}))}},{key:"drawGradient",value:function(e,t){(0,g.drawGradient)(o.BB.ctx(this.layerCanvasArr[e]),t),this.history.push({tool:["canvas"],action:"drawGradient",params:[e,o.BB.copyObj(t)]})}},{key:"text",value:function(e,t){(0,c.renderText)(this.layerCanvasArr[e],o.BB.copyObj(t)),this.history.push({tool:["canvas"],action:"text",params:[e,o.BB.copyObj(t)]})}},{key:"replaceLayer",value:function(e,t){o.BB.ctx(this.layerCanvasArr[e]).putImageData(t,0,0),this.history.push({tool:["canvas"],action:"replaceLayer",params:[e,t]})}},{key:"clearLayer",value:function(e){var t=o.BB.ctx(this.layerCanvasArr[e]);t.save(),t.clearRect(0,0,this.layerCanvasArr[e].width,this.layerCanvasArr[e].height),t.restore(),this.history.push({tool:["canvas"],action:"clearLayer",params:[e]})}},{key:"getLayers",value:function(){return this.layerCanvasArr.map((function(e){return{context:o.BB.ctx(e),opacity:e.opacity,name:e.name,mixModeStr:e.mixModeStr}}))}},{key:"getLayersFast",value:function(){return this.layerCanvasArr.map((function(e){return{canvas:e,opacity:e.opacity,name:e.name,mixModeStr:e.mixModeStr}}))}},{key:"getLayerIndex",value:function(e,t){for(var i=0;i<this.layerCanvasArr.length;i++)if(this.layerCanvasArr[i]===e)return i;if(!t)throw new Error("layer not found (in "+this.layerCanvasArr.length+" layers)");return null}},{key:"getLayer",value:function(e,t){if(this.layerCanvasArr[e])return{context:o.BB.ctx(this.layerCanvasArr[e]),opacity:this.layerCanvasArr[e].opacity,name:this.layerCanvasArr[e].name,id:e};if(!t)throw new Error("layer of index "+e+" not found (in "+this.layerCanvasArr.length+" layers)");return null}},{key:"getColorAt",value:function(e,t){e=Math.floor(e),t=Math.floor(t);var i=o.BB.ctx(this.pickCanvas);i.save(),i.imageSmoothingEnabled=!1,i.clearRect(0,0,1,1);for(var n=0;n<this.layerCanvasArr.length;n++)i.globalAlpha=this.layerCanvasArr[n].opacity,i.globalCompositeOperation=this.layerCanvasArr[n].mixModeStr,i.drawImage(this.layerCanvasArr[n],-e,-t);i.restore();var r=i.getImageData(0,0,1,1);return new o.BB.RGB(r.data[0],r.data[1],r.data[2])}},{key:"getCompleteCanvas",value:function(e){return(0,p.drawProject)(this.getProject(),e)}},{key:"getProject",value:function(){return{width:this.width,height:this.height,layers:this.layerCanvasArr.map((function(e){return{name:e.name,opacity:e.opacity,mixModeStr:e.mixModeStr,image:e}}))}}},{key:"addChangeListener",value:function(e){this.changeListenerArr.includes(e)||this.changeListenerArr.push(e)}},{key:"removeChangeListener",value:function(e){for(var t=0;t<this.changeListenerArr.length;t++)if(this.changeListenerArr[t]===e)return void this.changeListenerArr.splice(t,1)}},{key:"setMixMode",value:function(e,t){if(!this.layerCanvasArr[e])throw new Error("invalid layer");this.layerCanvasArr[e].mixModeStr=t,this.history.push({tool:["canvas"],action:"setMixMode",params:[e,""+t]})}},{key:"setComposite",value:function(e,t){if(!this.layerCanvasArr[e])throw new Error("invalid layer");this.layerCanvasArr[e].compositeObj=t}},{key:"destroy",value:function(){null!==this.layerCanvasArr&&(this.layerCanvasArr.forEach((function(e){o.BB.freeCanvas(e)})),this.layerCanvasArr=null)}}]),e}()})),i.register("30Cml",(function(t,i){function n(e,t,i,n,r,a){for(var s=i;s<=r;s++)for(var o=n;o<=a;o++)255!==e[o*t+s]&&(e[o*t+s]=254)}var r,a;function s(e,t,i,n,s){if(r=i%e+n,a=Math.floor(i/e)+s,!(r<0||a<0||r>=e||a>=t))return a*e+r}function o(e,t,i,n,r,a,s){return void 0!==s&&255!==t[s]&&((e[4*s]===r[0]&&e[4*s+1]===r[1]&&e[4*s+2]===r[2]&&e[4*s+3]===r[3]||a>0&&Math.abs(e[4*s]-r[0])<=a&&Math.abs(e[4*s+1]-r[1])<=a&&Math.abs(e[4*s+2]-r[2])<=a&&Math.abs(e[4*s+3]-r[3])<=a)&&(t[s]=255,!0))}function l(e,t,i,r,a,l,h,c){r=Math.round(r),a=Math.round(a);var u=new Uint8Array(new ArrayBuffer(t*i));return function(e,t,i,r,a,l,h,c,u){var p=[e[4*(l*i+a)],e[4*(l*i+a)+1],e[4*(l*i+a)+2],e[4*(l*i+a)+3]];if(u){var d,g,f=[];for(f.push(l*i+a),t[l*i+a]=255;f.length;)o(e,t,0,0,p,h,g=s(i,r,d=f.pop(),-1,0))&&f.push(g),o(e,t,0,0,p,h,g=s(i,r,d,1,0))&&f.push(g),o(e,t,0,0,p,h,g=s(i,r,d,0,-1))&&f.push(g),o(e,t,0,0,p,h,g=s(i,r,d,0,1))&&f.push(g)}else for(var v=0;v<i*r;v++)o(e,t,0,0,p,h,v);if(0!==c){for(var m,y,x,B,b,w,k,C,S,L,A,I,E=0;E<i;E++)for(var T=0;T<r;T++)255===t[T*i+E]&&(m=E,y=E,x=T,B=T,b=255!==t[T*i+E-1],w=255!==t[(T-1)*i+E-1],k=255!==t[(T-1)*i+E],C=255!==t[(T-1)*i+E+1],S=255!==t[T*i+E+1],L=255!==t[(T+1)*i+E+1],A=255!==t[(T+1)*i+E],I=255!==t[(T+1)*i+E-1],b&&(m=E-c),b&&w&&k&&(m=E-c,x=T-c),k&&(x=Math.min(x,T-c)),k&&C&&S&&(x=Math.min(x,T-c),y=E+c),S&&(y=Math.max(y,E+c)),S&&L&&A&&(y=Math.max(y,E+c),B=Math.max(B,T+c)),A&&(B=Math.max(B,T+c)),A&&I&&b&&(m=Math.min(m,E-c),B=Math.max(B,T+c)),(b||w||k||C||S||L||A||I)&&n(t,i,Math.max(0,m),Math.max(0,x),Math.min(i-1,y),Math.min(r-1,B)));for(var M=0;M<i*r;M++)254===t[M]&&(t[M]=255)}}(e,u,t,i,r,a,l,h,c),{data:u}}e(t.exports,"floodFillBits",(function(){return l}))})),i.register("3ujzu",(function(t,n){e(t.exports,"ShapeTool",(function(){return h})),e(t.exports,"drawShape",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("3Rl3W"),l=i("eWjiX"),h=function(){"use strict";function e(t){(0,r.default)(this,e),(0,s.default)(this,"downX",0),(0,s.default)(this,"downY",0),(0,s.default)(this,"downAngleRad",0),this.onShape=t.onShape}return(0,a.default)(e,[{key:"onDown",value:function(e,t,i){this.downX=e,this.downY=t,this.downAngleRad=i}},{key:"onMove",value:function(e,t){this.onShape(!1,this.downX,this.downY,e,t,this.downAngleRad)}},{key:"onUp",value:function(e,t){this.onShape(!0,this.downX,this.downY,e,t,this.downAngleRad)}}]),e}();function c(e,t){if(t=(0,o.default)({angleRad:0,isOutwards:!1,opacity:1,isEraser:!1,doLockAlpha:!1},l.BB.copyObj(t)),!["rect","ellipse","line"].includes(t.type))throw new Error("unknown shape");if(void 0===t.angleRad)throw new Error("angleRad undefined");var i=void 0===t.lineWidth?-1:Math.round(t.lineWidth),n=180*t.angleRad/Math.PI;if(!t.isEraser&&void 0===t.fillRgb&&void 0===t.strokeRgb)throw new Error("fillRgb and strokeRgb undefined");var r=t.isEraser?{r:255,g:255,b:255}:t.fillRgb?t.fillRgb:t.strokeRgb;e.save(),t.opacity&&(e.globalAlpha=t.opacity),t.isEraser&&(e.globalCompositeOperation="destination-out"),t.doLockAlpha&&(e.globalCompositeOperation="source-atop"),e.rotate(-t.angleRad),t.fillRgb?e.fillStyle=l.BB.ColorConverter.toRgbStr(r):t.strokeRgb&&(e.strokeStyle=l.BB.ColorConverter.toRgbStr(r),e.lineWidth=i);var a=t.x1,s=t.y1,h=t.x2,c=t.y2;if(t.isAngleSnap){var u=l.BB.rotate(a,s,t.angleRad/Math.PI*180),p=l.BB.rotate(h,c,t.angleRad/Math.PI*180),d=l.BB.pointsToAngleDeg(u,p)+90,g=45*Math.round(d/45),f=l.BB.rotateAround({x:a,y:s},{x:h,y:c},g-d);h=f.x,c=f.y,(n+g)%90==0&&(Math.round((n-g)/90)%2==0?h=a:c=s)}var v,m,y=a,x=s,B=h-a,b=c-s;if("line"!==t.type&&t.isFixedRatio){var w=l.BB.rotate(t.x1,t.y1,t.angleRad/Math.PI*180),k=l.BB.rotate(t.x2,t.y2,t.angleRad/Math.PI*180),C=w.x,S=w.y,L=k.x-w.x,A=k.y-w.y;Math.abs(L)<Math.abs(A)?A=Math.abs(L)*(A<0?-1:1):L=Math.abs(A)*(L<0?-1:1),k.x=C+L,k.y=S+A,w=l.BB.rotate(w.x,w.y,-t.angleRad/Math.PI*180),k=l.BB.rotate(k.x,k.y,-t.angleRad/Math.PI*180),y=a=w.x,x=s=w.y,B=(h=k.x)-a,b=(c=k.y)-s}if(t.isOutwards&&(a=y-=B,s=x-=b,h=y+(B*=2),c=x+(b*=2)),"line"===t.type){var I=Math.round(a),E=Math.round(s),T=Math.round(h),M=Math.round(c),P=Math.floor(a),O=Math.floor(s),R=Math.floor(h),D=Math.floor(c);i%2==0?E===M?(v={x:P,y:E},m={x:R,y:M},P<R?m.x+=1:v.x+=1):I===T?(v={x:I,y:O},m={x:T,y:D},O<D?m.y+=1:v.y+=1):(v={x:a,y:s},m={x:h,y:c}):(v={x:P,y:O},m={x:R,y:D},O===D?(P<R?m.x+=1:v.x+=1,v.y+=.5,m.y+=.5):P===R?(O<D?m.y+=1:v.y+=1,v.x+=.5,m.x+=.5):(v.x=a,v.y=s,m.x=h,m.y=c)),v=l.BB.rotate(v.x,v.y,t.angleRad/Math.PI*180),m=l.BB.rotate(m.x,m.y,t.angleRad/Math.PI*180),e.beginPath(),e.moveTo(v.x,v.y),e.lineTo(m.x,m.y),e.stroke()}else if("rect"===t.type){var N=Math.floor(a),z=Math.floor(s),j=Math.floor(h),G=Math.floor(c);n%90==0?t.fillRgb?(a%1==0&&(a+=1),s%1==0&&(s+=1),h%1==0&&(h+=1),c%1==0&&(c+=1),v={x:a<h?N:j,y:s<c?z:G},(m={x:Math.ceil((a<h?h:a)-v.x),y:Math.ceil((s<c?c:s)-v.y)}).x=v.x+m.x,m.y=v.y+m.y):i%2==0?(v={x:N,y:z},m={x:j,y:G}):(v={x:N+.5,y:z+.5},m={x:j+.5,y:G+.5}):(v={x:a,y:s},m={x:h,y:c}),v=l.BB.rotate(v.x,v.y,t.angleRad/Math.PI*180),(m=l.BB.rotate(m.x,m.y,t.angleRad/Math.PI*180)).x=m.x-v.x,m.y=m.y-v.y,t.fillRgb?e.fillRect(v.x,v.y,m.x,m.y):e.strokeRect(v.x,v.y,m.x,m.y)}else v=l.BB.rotate(a,s,t.angleRad/Math.PI*180),m=l.BB.rotate(h,c,t.angleRad/Math.PI*180),y=v.x,x=v.y,B=m.x-v.x,b=m.y-v.y,e.beginPath(),e.ellipse(y+B/2,x+b/2,Math.abs(B/2),Math.abs(b/2),0,0,2*Math.PI),t.fillRgb?e.fill():e.stroke();e.restore()}})),i.register("h20yl",(function(t,n){e(t.exports,"renderText",(function(){return a}));var r=i("eWjiX");function a(e,t){for(var i=""===t.textStr?" ":t.textStr,n=r.BB.el({css:{position:"fixed",left:"0",top:"0",width:"100000px",fontSize:t.size+"px",lineHeight:t.lineHeight?t.lineHeight+"px":"default"}}),a=r.BB.el({parent:n,css:{display:"inline-block",textAlign:t.align?t.align:"left",fontFamily:t.font?t.font:"sans-serif",fontSize:t.size+"px",fontWeight:t.isBold?"bold":"normal",fontStyle:t.isItalic?"italic":"normal",lineHeight:t.lineHeight?t.lineHeight+"px":"default",opacity:"0",pointerEvents:"none"}}),s="",o=0;o<i.length;o++)"\n"!==i[o]?s+=i[o].replace("\t","    "):(r.BB.el({parent:a,tagName:"span",textContent:s,css:{whiteSpace:"pre"}}),s="",a.append(r.BB.el({tagName:"br"})));r.BB.el({parent:a,tagName:"span",textContent:s,css:{whiteSpace:"pre"}}),document.body.append(n);for(var l={x0:99999999,y0:99999999,x1:0,y1:0},h=0;h<a.children.length;h++){var c=a.children[h];l.x0=Math.min(l.x0,c.offsetLeft),l.y0=Math.min(l.y0,c.offsetTop),l.x1=Math.max(l.x1,c.offsetLeft+c.offsetWidth),l.y1=Math.max(l.y1,c.offsetTop+c.offsetHeight)}var u=r.BB.ctx(e);u.save();var p=[];t.isItalic&&p.push("italic"),t.isBold&&p.push("bold"),p.push(t.size+"px "+(t.font?t.font:"sans-serif")),u.font=p.join(" "),u.fillStyle=t.color?t.color:"#000";var d=t.x,g=t.y;"right"===t.align&&(d+=-l.x1+l.x0),"center"===t.align&&(d+=(-l.x1+l.x0)/2),u.translate(t.x,t.y),u.rotate(t.angleRad?-t.angleRad:0),u.translate(-t.x,-t.y),u.translate(d,g);for(var f=0;f<a.children.length;f++){var v=a.children[f];u.fillText(v.innerText,v.offsetLeft,v.offsetTop)}return t.isDebug?(u.lineWidth=1,u.strokeRect(0,.85*-t.size,l.x1,l.y1),u.restore(),u.fillRect(t.x-1,t.y-1,2,2)):u.restore(),document.body.removeChild(n),{x:d-t.x,y:g-t.y-.85*t.size,width:l.x1-l.x0,height:l.y1-l.y0}}})),i.register("aSJRf",(function(t,n){e(t.exports,"drawProject",(function(){return a}));var r=i("eWjiX");function a(e,t){var i=r.BB.canvas(Math.max(1,Math.round(e.width*t)),Math.max(1,Math.round(e.height*t))),n=r.BB.ctx(i);n.save(),t>1&&(n.imageSmoothingEnabled=!1);for(var a=0;a<e.layers.length;a++)if(0!==e.layers[a].opacity){n.globalAlpha=e.layers[a].opacity;var s=e.layers[a].mixModeStr;n.globalCompositeOperation=void 0!==s?s:"source-over",n.drawImage(e.layers[a].image,0,0,i.width,i.height)}return n.restore(),i}})),i.register("7EG77",(function(t,n){e(t.exports,"GradientTool",(function(){return o})),e(t.exports,"drawGradient",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){(0,r.default)(this,e),this.onGradient=t.onGradient}return(0,a.default)(e,[{key:"onDown",value:function(e,t,i){this.downX=e,this.downY=t,this.downAngleRad=i}},{key:"onMove",value:function(e,t){this.onGradient(!1,this.downX,this.downY,e,t,this.downAngleRad)}},{key:"onUp",value:function(e,t){this.onGradient(!0,this.downX,this.downY,e,t,this.downAngleRad)}}]),e}();function l(e,t){e.save();var i=t.x1,n=t.y1,r=t.x2,a=t.y2;if(t.doSnap){var o=180*t.angleRad/Math.PI,l=s.BB.rotate(i,n,t.angleRad/Math.PI*180),h=s.BB.rotate(r,a,t.angleRad/Math.PI*180),c=s.BB.pointsToAngleDeg(l,h)+90,u=45*Math.round(c/45),p=s.BB.rotateAround({x:i,y:n},{x:r,y:a},u-c);r=p.x,a=p.y,(o+u)%90==0&&(Math.round((o-u)/90)%2==0?r=i:a=n)}var d=t.color1;t.isEraser&&t.doLockAlpha&&(d={r:255,g:255,b:255});var g=s.BB.copyObj(d);g.a=t.opacity;var f,v=s.BB.copyObj(d);if(v.a=0,t.isReversed){var m=g;g=v,v=m}if("linear"===t.type)(f=e.createLinearGradient(i,n,r,a)).addColorStop(0,s.BB.ColorConverter.toRgbaStr(g)),f.addColorStop(1,s.BB.ColorConverter.toRgbaStr(v));else if("linear-mirror"===t.type){var y={x:r-i,y:a-n};(f=e.createLinearGradient(i-y.x,n-y.y,r,a)).addColorStop(0,s.BB.ColorConverter.toRgbaStr(v)),f.addColorStop(.5,s.BB.ColorConverter.toRgbaStr(g)),f.addColorStop(1,s.BB.ColorConverter.toRgbaStr(v))}else if("radial"===t.type){var x=s.BB.Vec2.dist({x:i,y:n},{x:r,y:a});(f=e.createRadialGradient(i,n,0,i,n,x)).addColorStop(0,s.BB.ColorConverter.toRgbaStr(g)),f.addColorStop(1,s.BB.ColorConverter.toRgbaStr(v))}e.fillStyle=f,t.isEraser&&(e.globalCompositeOperation="destination-out"),t.doLockAlpha&&(e.globalCompositeOperation="source-atop"),e.fillRect(0,0,e.canvas.width,e.canvas.height),e.restore()}})),i.register("bBcC4",(function(t,n){e(t.exports,"translateBlending",(function(){return a}));var r=i("1mH1z");function a(e){if(!e)return(0,r.LANG)("layers-blend-normal");var t={"source-over":"layers-blend-normal",darken:"layers-blend-darken",multiply:"layers-blend-multiply","color-burn":"layers-blend-color-burn",lighten:"layers-blend-lighten",screen:"layers-blend-screen","color-dodge":"layers-blend-color-dodge",overlay:"layers-blend-overlay","soft-light":"layers-blend-soft-light","hard-light":"layers-blend-hard-light",difference:"layers-blend-difference",exclusion:"layers-blend-exclusion",hue:"layers-blend-hue",saturation:"layers-blend-saturation",color:"layers-blend-color",luminosity:"layers-blend-luminosity"};if(!(e in t))throw new Error("unknown blend mode");return(0,r.LANG)(t[e])}})),i.register("jneUH",(function(n,r){e(n.exports,"renameLayerDialog",(function(){return h}));var a=i("eWjiX"),s=i("1mH1z"),o=i("2MaaK"),l=i("auzYC");function h(e,i,n){var r=a.BB.el(),h=a.BB.el({content:(0,s.LANG)("layers-rename-name")+":",css:{marginRight:"5px"}}),c=a.BB.el({css:{display:"flex"}}),u=a.BB.el({tagName:"input"});u.value=i,u.setAttribute("data-ignore-focus","true");var p=a.BB.el({tagName:"Button",content:'<img src="'+t(l)+'" height="20"/>',title:(0,s.LANG)("layers-rename-clear"),css:{marginLeft:"10px"},onClick:function(){u.value="",u.focus()}}),d=[(0,s.LANG)("layers-rename-sketch"),(0,s.LANG)("layers-rename-colors"),(0,s.LANG)("layers-rename-shading"),(0,s.LANG)("layers-rename-lines"),(0,s.LANG)("layers-rename-effects"),(0,s.LANG)("background"),(0,s.LANG)("layers-rename-foreground")],g=[],f=a.BB.el({css:{display:"flex",flexWrap:"wrap",marginTop:"5px",marginLeft:"-5px"}});d.forEach((function(e){var t=a.BB.el({parent:f,tagName:"Button",content:e,onClick:function(){u.value=""+t.textContent},css:{margin:"5px 0 0 5px"}});g.push(t)})),r.append(h),h.append(c,f),c.append(u,p),setTimeout((function(){u.focus(),u.select()}),10),(0,o.showModal)({target:e,message:"<b>".concat((0,s.LANG)("layers-rename-title"),"</b>"),div:r,buttons:[(0,s.LANG)("layers-rename"),"Cancel"],primaries:[(0,s.LANG)("layers-rename")],callback:function(e){a.BB.destroyEl(p),g.forEach((function(e){a.BB.destroyEl(e)})),g.splice(0,g.length),e===(0,s.LANG)("layers-rename")?n(u.value):n(void 0)},clickOnEnter:(0,s.LANG)("layers-rename")})}})),i.register("auzYC",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("1twgF")})),i.register("6NMo1",(function(t,n){e(t.exports,"mergeLayerDialog",(function(){return c}));var r=i("eWjiX"),a=i("1mH1z"),s=i("iFIyy"),o=i("bBcC4"),l=i("2MaaK"),h=i("1C8RU");function c(e,t){var i=function(){r.BB.createCheckerDataUrl(4,(function(e){p.style.backgroundImage="url("+e+")"}),h.theme.isDark())},n=r.BB.el();n.innerHTML=(0,a.LANG)("layers-merge-description");var c=new(0,s.Options)({optionArr:[{id:t.mixModeStr,label:(0,o.translateBlending)(t.mixModeStr)},{id:"source-in",label:"source-in"},{id:"source-out",label:"source-out"},{id:"source-atop",label:"source-atop"},{id:"destination-in",label:"destination-in"},{id:"destination-out",label:"destination-out"},{id:"destination-atop",label:"destination-atop"},{id:"xor",label:"xor"}],initId:t.mixModeStr,onChange:function(){f()},isSmall:!0});c.getElement().style.marginTop="5px",n.append(c.getElement());var u=r.BB.fitInto(t.topCanvas.width,t.topCanvas.height,200,200,1),p=r.BB.canvas(u.width,u.height);p.title=(0,a.LANG)("preview"),p.className="kl-merge-preview";var d=r.BB.el({content:"<br/>",css:{clear:"both"}});n.append(d,p),i(),h.theme.addIsDarkListener(i);var g=r.BB.copyCanvas(p);r.BB.ctx(g).drawImage(t.topCanvas,0,0,g.width,g.height),r.BB.convertToAlphaChannelCanvas(g);var f=function(){var e=r.BB.ctx(p);e.save(),e.clearRect(0,0,p.width,p.height),p.width>t.topCanvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(t.bottomCanvas,0,0,p.width,p.height),"as-alpha"===c.getValue()?(e.globalCompositeOperation="destination-in",e.globalAlpha=t.topOpacity,e.drawImage(g,0,0,p.width,p.height)):(e.globalCompositeOperation=c.getValue(),e.globalAlpha=t.topOpacity,e.drawImage(t.topCanvas,0,0,p.width,p.height)),e.restore()};f();var v=new r.BB.KeyListener({onDown:function(e){"right"===e&&c.next(),"left"===e&&c.previous()}});(0,l.showModal)({target:e,message:"<b>".concat((0,a.LANG)("layers-merge-modal-title"),"</b>"),div:n,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(e){v.destroy(),c.destroy(),h.theme.removeIsDarkListener(i),"Ok"===e&&t.callback(c.getValue())}})}})),i.register("hWVsV",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("70WHw")})),i.register("5Ycub",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("3huo1")})),i.register("jKBKm",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("1AvFX")})),i.register("1Qqvs",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("ftA1L")})),i.register("7bo3M",(function(t,n){e(t.exports,"WorkspaceSvgOverlay",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){(0,r.default)(this,e),this.rootElement=s.BB.createSvg({elementType:"svg",width:""+t.width,height:""+t.height}),s.BB.css(this.rootElement,{position:"absolute",left:"0",top:"0",pointerEvents:"none",userSelect:"none"}),this.brushCircleOuter=s.BB.createSvg({elementType:"circle",r:"10",stroke:"rgba(0,0,0,0.7)","stroke-width":"1",fill:"none"}),this.brushCircleInner=s.BB.createSvg({elementType:"circle",r:"9",stroke:"rgba(255,255,255,0.7)","stroke-width":"1",fill:"none"}),this.rootElement.append(this.brushCircleOuter,this.brushCircleInner),this.pickerPreviewBorder=s.BB.createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"22",fill:"none"}),this.pickerPreviewBorder.style.opacity="0",this.pickerPreviewCol=s.BB.createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"20",fill:"none"}),this.pickerPreviewCol.style.opacity="0",this.rootElement.append(this.pickerPreviewBorder,this.pickerPreviewCol),this.compassSize=30,this.compass=s.BB.createSvg({elementType:"g",transform:"translate("+t.width/2+", "+t.height/2+")"}),s.BB.css(this.compass,{transition:"opacity 0.25s ease-in-out",opacity:"0"}),this.compassInner=s.BB.createSvg({elementType:"g",transform:"rotate(45)"}),this.compassBaseCircle=s.BB.createSvg({elementType:"circle",fill:"rgba(0,0,0,0.9)",stroke:"none",cx:"0",cy:"0",r:""+this.compassSize}),this.compassLineCircle=s.BB.createSvg({elementType:"circle",fill:"none",stroke:"rgba(255,255,255,0.75)","stroke-width":"1",cx:"0",cy:"0",r:""+.9*this.compassSize}),this.compassUpperTriangle=s.BB.createSvg({elementType:"path",fill:"#f00",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,-"+.9*this.compassSize+" z"}),this.compassLowerTriangle=s.BB.createSvg({elementType:"path",fill:"#fff",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,"+.9*this.compassSize+" z"}),this.compassInner.append(this.compassBaseCircle,this.compassLineCircle,this.compassUpperTriangle,this.compassLowerTriangle),this.compass.append(this.compassInner),this.rootElement.append(this.compass)}return(0,a.default)(e,[{key:"getElement",value:function(){return this.rootElement}},{key:"setSize",value:function(e,t){this.rootElement.setAttribute("width",""+e),this.rootElement.setAttribute("height",""+t),this.compass.setAttribute("transform","translate("+e/2+", "+t/2+")")}},{key:"updateCursor",value:function(e){void 0!==e.x&&(this.brushCircleOuter.setAttribute("cx",""+e.x),this.brushCircleInner.setAttribute("cx",""+e.x)),void 0!==e.y&&(this.brushCircleOuter.setAttribute("cy",""+e.y),this.brushCircleInner.setAttribute("cy",""+e.y)),void 0!==e.radius&&(this.brushCircleOuter.setAttribute("r",""+Math.max(0,e.radius)),this.brushCircleInner.setAttribute("r",""+Math.max(0,e.radius-1))),void 0!==e.isVisible&&(this.brushCircleOuter.style.opacity=e.isVisible?"1":"0",this.brushCircleInner.style.opacity=e.isVisible?"1":"0")}},{key:"updateColorPreview",value:function(e){if(void 0!==e.x&&(this.pickerPreviewCol.setAttribute("cx",""+e.x),this.pickerPreviewBorder.setAttribute("cx",""+e.x)),void 0!==e.y&&(this.pickerPreviewCol.setAttribute("cy",""+e.y),this.pickerPreviewBorder.setAttribute("cy",""+e.y)),e.color){this.pickerPreviewCol.setAttribute("stroke",s.BB.ColorConverter.toRgbStr(e.color));var t=s.BB.testIsWhiteBestContrast(e.color)?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.5)";this.pickerPreviewBorder.setAttribute("stroke",t)}void 0!==e.isVisible&&(this.pickerPreviewCol.style.opacity=e.isVisible?"1":"0",this.pickerPreviewBorder.style.opacity=e.isVisible?"1":"0")}},{key:"updateCompass",value:function(e){void 0!==e.angleDeg&&(this.compassInner.setAttribute("transform","rotate("+e.angleDeg+")"),this.compassLineCircle.style.opacity=e.angleDeg%90==0?"1":"0"),void 0!==e.isVisible&&(this.compass.style.opacity=e.isVisible?"1":"0")}}]),e}()})),i.register("lV6Vy",(function(n,r){e(n.exports,"KlCanvasWorkspace",(function(){return b}));var a,s,o=i("gFgFC"),l=i("kiQ5H"),h=i("eWjiX"),c=i("7bo3M"),u=i("gWfkn"),p=i("eZ2aJ"),d=i("7QZIi"),g=i("bz6iQ"),f=i("kE5UF"),v=i("hrnUX"),m=i("dpBaO"),y=i("1C8RU"),x=1/16,B=64;(s=a||(a={}))[s.Draw=0]="Draw",s[s.Hand=1]="Hand",s[s.HandGrabbing=2]="HandGrabbing",s[s.Pick=3]="Pick",s[s.Zoom=4]="Zoom",s[s.Rotate=5]="Rotate",s[s.Rotating=6]="Rotating",s[s.Fill=7]="Fill",s[s.Gradient=8]="Gradient",s[s.Text=9]="Text",s[s.Shape=10]="Shape";var b=function(){"use strict";function e(t){var i=this;(0,o.default)(this,e);var n=this;this.rootEl=h.BB.el({css:{position:"absolute",left:"0",right:"0",top:"0",bottom:"0",cursor:"crosshair",userSelect:"none"}}),this.klCanvas=t.klCanvas,this.onViewChange=t.onViewChange,this.renderTargetCanvas=h.BB.canvas(t.width,t.height),this.renderTargetCtx=h.BB.ctx(this.renderTargetCanvas),this.renderWidth=t.width,this.renderHeight=t.height,this.compositeCanvas=h.BB.canvas(1,1),this.compositeCtx=h.BB.ctx(this.compositeCanvas),this.doResizeCanvas=!1,this.oldTransformObj=null,this.targetTransformObj={x:0,y:0,scale:1,angle:0},this.highResTransformObj={x:0,y:0,scale:1,angle:0},this.renderedTransformObj={x:null,y:null,scale:null,angle:null},this.cursorPos={x:0,y:0},this.usesCssCursor=!1,this.bgVisible=!0,this.transformIsDirty=!0,this.doAnimateTranslate=!0,this.svgOverlay=new(0,c.WorkspaceSvgOverlay)({width:t.width,height:t.height}),h.BB.css(this.renderTargetCanvas,{userSelect:"none",pointerEvents:"none"}),h.BB.createCheckerDataUrl(8,(function(e){i.renderTargetCanvas.style.background="url("+e+")"}),y.theme.isDark()),y.theme.addIsDarkListener((function(){i.renderTargetCanvas.style.background="url("+h.BB.createCheckerDataUrl(8,void 0,y.theme.isDark())+")",i.lastRenderedState=-1,i.reqFrame()})),this.rootEl.append(this.renderTargetCanvas,this.svgOverlay.getElement()),this.rootEl.addEventListener("touchend",(function(e){return e.preventDefault(),!1})),this.rootEl.addEventListener("contextmenu",(function(e){return e.preventDefault(),!1})),this.rootEl.addEventListener("dragstart",(function(e){return e.preventDefault(),!1})),this.emptyCanvas=h.BB.canvas(1,1),this.emptyLightCanvas=h.BB.canvas(1,1);var r=h.BB.ctx(this.emptyCanvas);r.fillRect(0,0,1,1),(r=h.BB.ctx(this.emptyLightCanvas)).fillStyle="#fff",r.fillRect(0,0,1,1),this.keyListener=new h.BB.KeyListener({onDown:function(e,t,n,r){if(!(v.KL.dialogCounter.get()>0||h.BB.isInputFocused(!0)||("alt"===e&&t.preventDefault(),r)))if(i.currentInputProcessor)i.currentInputProcessor.onKeyDown(e,t,n,r);else{if([a.Draw,a.Pick,a.Fill,a.Gradient,a.Text,a.Shape].includes(i.globalMode)&&"space"===n)return i.currentInputProcessor=i.inputProcessorObj.spaceHand,void i.currentInputProcessor.onKeyDown(e,t,n,r);if([a.Draw,a.Hand,a.Fill,a.Gradient,a.Text,a.Shape].includes(i.globalMode)&&"alt"===n)return i.currentInputProcessor=i.inputProcessorObj.altPicker,void i.currentInputProcessor.onKeyDown(e,t,n,r);if(["r","shift+r"].includes(n))return i.currentInputProcessor=i.inputProcessorObj.rotate,void i.currentInputProcessor.onKeyDown(e,t,n,r);if("z"===n)return i.currentInputProcessor=i.inputProcessorObj.zoom,void i.currentInputProcessor.onKeyDown(e,t,n,r)}},onUp:function(e,t,n){"alt"===e&&t.preventDefault(),i.currentInputProcessor&&i.currentInputProcessor.onKeyUp(e,t,n)}}),this.updateChangeListener(),this.currentMode=a.Draw,this.globalMode=a.Draw,this.renderTime=0,this.lastDrawEvent=null,this.linetoolProcessor=new(0,m.LinetoolProcessor)({onDraw:function(e){var n=function(){var e=i.getRenderedTransform(),t=h.BB.Matrix.getIdentity();return t=h.BB.Matrix.multiplyMatrices(t,h.BB.Matrix.createScaleMatrix(1/e.scale)),t=h.BB.Matrix.multiplyMatrices(t,h.BB.Matrix.createRotationMatrix(-e.angle)),t=h.BB.Matrix.multiplyMatrices(t,h.BB.Matrix.createTranslationMatrix(-e.x,-e.y))};if("line"===e.type&&!i.lastDrawEvent){var r=n(),a=[e.x1,e.y1,0,1];return a=h.BB.Matrix.multiplyMatrixAndPoint(r,a),void(i.lastDrawEvent={x:a[0],y:a[1],pressure:e.pressure1})}if("x"in e||"x0"in e){var s=n();if("x"in e){var o=[e.x,e.y,0,1];o=h.BB.Matrix.multiplyMatrixAndPoint(s,o),e.x=o[0],e.y=o[1]}if("x0"in e){e.x0=i.lastDrawEvent.x,e.y0=i.lastDrawEvent.y,e.pressure0=i.lastDrawEvent.pressure;var l=[e.x1,e.y1,0,1];l=h.BB.Matrix.multiplyMatrixAndPoint(s,l),e.x1=l[0],e.y1=l[1],i.lastDrawEvent={x:e.x1,y:e.y1,pressure:e.pressure1}}}"down"!==e.type&&"move"!==e.type||(i.lastDrawEvent={x:e.x,y:e.y,pressure:e.pressure}),t.onDraw(e)}}),this.pointer=null,this.isDrawing=!1,this.inputProcessorObj={draw:{onPointer:function(e){i.reqFrame(),i.updateCursor(a.Draw);var t=i.keyListener.getComboStr(),n={scale:i.highResTransformObj.scale};if(n.shiftIsPressed="shift"===t,n.pressure=e.pressure,n.isCoalesced=!!e.isCoalesced,"pointerdown"===e.type)i.isDrawing=!0,n.type="down";else{if(!e.button)return"pointerup"===e.type?(i.isDrawing=!1,n.type="up",i.linetoolProcessor.process(n),void i.resetInputProcessor()):void 0;n.type="move"}n.x=e.relX,n.y=e.relY,i.linetoolProcessor.process(n)},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},fill:{onPointer:function(e){if(i.reqFrame(),i.updateCursor(a.Fill),"pointerdown"===e.type){var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY});t.onFill(Math.floor(n.x),Math.floor(n.y))}else if("pointerup"===e.type)return void i.resetInputProcessor()},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},gradient:{onPointer:function(e){i.reqFrame(),i.updateCursor(a.Gradient);var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY});"pointerdown"===e.type?(i.isDrawing=!0,t.onGradient("down",n.x,n.y,i.renderedTransformObj.angle)):"pointermove"===e.type?t.onGradient("move",n.x,n.y,i.renderedTransformObj.angle):"pointerup"===e.type&&(i.isDrawing=!1,t.onGradient("up",n.x,n.y,i.renderedTransformObj.angle),i.resetInputProcessor())},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},text:{onPointer:function(e){if(i.reqFrame(),i.updateCursor(a.Text),"pointerdown"===e.type){var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY});t.onText(Math.floor(n.x),Math.floor(n.y),i.renderedTransformObj.angle)}else if("pointerup"===e.type)return void i.resetInputProcessor()},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},shape:{onPointer:function(e){i.reqFrame(),i.updateCursor(a.Shape);var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY});"pointerdown"===e.type?(i.isDrawing=!0,t.onShape("down",n.x,n.y,i.renderedTransformObj.angle)):"pointermove"===e.type?t.onShape("move",n.x,n.y,i.renderedTransformObj.angle):"pointerup"===e.type&&(i.isDrawing=!1,t.onShape("up",n.x,n.y,i.renderedTransformObj.angle),i.resetInputProcessor())},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},hand:{onPointer:function(e){i.updateCursor(a.Hand),["left","middle"].includes(e.button)?(i.updateCursor(a.HandGrabbing),i.targetTransformObj.x+=e.dX,i.targetTransformObj.y+=e.dY,i.highResTransformObj=h.BB.copyObj(i.targetTransformObj),i.doAnimateTranslate=!1,i.transformIsDirty=!0,i.reqFrame(!0)):"pointerup"===e.type&&i.resetInputProcessor()},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},spaceHand:{onPointer:function(e){i.updateCursor(a.Hand),["left","middle"].includes(e.button)&&(i.updateCursor(a.HandGrabbing),i.targetTransformObj.x+=e.dX,i.targetTransformObj.y+=e.dY,i.highResTransformObj=h.BB.copyObj(i.targetTransformObj),i.doAnimateTranslate=!1,i.transformIsDirty=!0,i.reqFrame(!0))},onKeyDown:function(e,t,n,r){"space"!==n?i.resetInputProcessor():i.updateCursor(a.Hand)},onKeyUp:function(e,t,n){i.resetInputProcessor()}},zoom:{onPointer:function(e){if(i.updateCursor(a.Zoom),"left"===e.button&&!e.isCoalesced&&0!=e.dX){var t=e.pageX-e.relX,n=e.pageY-e.relY;i.internalZoomByStep(e.dX/175,e.downPageX-t,e.downPageY-n),i.highResTransformObj=h.BB.copyObj(i.targetTransformObj),i.lastRenderedState=-1,i.reqFrame(),i.onViewChange({changed:["scale"],angle:i.targetTransformObj.angle,scale:i.targetTransformObj.scale})}},onKeyDown:function(e,t,n,r){"z"!==n?i.resetInputProcessor():i.updateCursor(a.Zoom)},onKeyUp:function(e,t,n){i.resetInputProcessor()}},picker:{onPointer:function(e){if(i.updateCursor(a.Pick),["left","right"].includes(e.button)&&!e.isCoalesced||"pointerup"===e.type){var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY}),r=i.klCanvas.getColorAt(n.x,n.y);t.onPick(r,"pointerup"===e.type),i.svgOverlay.updateColorPreview({x:e.relX,y:e.relY,color:r,isVisible:"pointerup"!==e.type}),"pointerup"===e.type&&i.resetInputProcessor()}},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},altPicker:{onPointer:function(e){if(i.updateCursor(a.Pick),["left","right"].includes(e.button)&&!e.isCoalesced||"pointerup"===e.type){var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY}),r=i.klCanvas.getColorAt(n.x,n.y);t.onPick(r,"pointerup"===e.type),i.svgOverlay.updateColorPreview({x:e.relX,y:e.relY,color:r,isVisible:"pointerup"!==e.type})}},onKeyDown:function(e,t,n,r){"alt"!==n?i.resetInputProcessor():i.updateCursor(a.Pick)},onKeyUp:function(e,t,n){i.resetInputProcessor()}},rotate:{onPointer:function(e){if(i.updateCursor("left"===e.button?a.Rotating:a.Rotate),"pointerdown"===e.type&&"left"===e.button)i.oldTransformObj=h.BB.copyObj(i.targetTransformObj);else if("left"===e.button&&!e.isCoalesced&&i.oldTransformObj){var t=e.pageX-e.relX,n=e.pageY-e.relY,r={x:i.renderWidth/2,y:i.renderHeight/2},s=h.BB.Vec2.angle(r,{x:e.downPageX-t,y:e.downPageY-n}),o=h.BB.Vec2.angle(r,{x:e.pageX-t,y:e.pageY-n})-s;i.targetTransformObj=h.BB.copyObj(i.oldTransformObj),i.targetTransformObj.angle+=o,i.keyListener.isPressed("shift")&&(i.targetTransformObj.angle=Math.round(i.targetTransformObj.angle/Math.PI*8)*Math.PI/8,o=i.targetTransformObj.angle-i.oldTransformObj.angle),i.targetTransformObj.angle=i.minimizeAngleRad(i.targetTransformObj.angle);var l=h.BB.Matrix.getIdentity();l=h.BB.Matrix.multiplyMatrices(l,h.BB.Matrix.createTranslationMatrix(r.x,r.y)),l=h.BB.Matrix.multiplyMatrices(l,h.BB.Matrix.createRotationMatrix(o)),l=h.BB.Matrix.multiplyMatrices(l,h.BB.Matrix.createTranslationMatrix(-r.x,-r.y));var c=[i.targetTransformObj.x,i.targetTransformObj.y,0,1];c=h.BB.Matrix.multiplyMatrixAndPoint(l,c),i.targetTransformObj.x=c[0],i.targetTransformObj.y=c[1],i.highResTransformObj=h.BB.copyObj(i.targetTransformObj),i.transformIsDirty=!0,i.lastRenderedState=-1,i.reqFrame(),i.onViewChange({changed:["angle"],scale:i.targetTransformObj.scale,angle:i.targetTransformObj.angle})}},onKeyDown:function(e,t,n,r){["r","r+shift","shift+r","r+left","r+right","r+left+right","r+right+left","r+up"].includes(n)?i.updateCursor(a.Rotate):i.resetInputProcessor()},onKeyUp:function(e,t,n){var r=i.keyListener.getComboStr();["r","r+shift","shift+r","r+left","r+right","r+left+right","r+right+left","r+up"].includes(r)?i.updateCursor(a.Rotate):i.resetInputProcessor()}}},this.currentInputProcessor=null,this.angleIsExtraSticky=!1,this.pinchZoomer=new h.BB.PinchZoomer({onPinch:function(e){if("move"===e.type){i.oldTransformObj||(i.oldTransformObj=h.BB.copyObj(i.targetTransformObj),i.angleIsExtraSticky=i.targetTransformObj.angle%(Math.PI/2)==0),i.targetTransformObj=h.BB.copyObj(i.oldTransformObj),e.scale=Math.max(x,Math.min(B,i.targetTransformObj.scale*e.scale))/i.targetTransformObj.scale,i.targetTransformObj.scale*=e.scale,i.targetTransformObj.angle+=e.angleRad,i.targetTransformObj.angle=i.minimizeAngleRad(i.snapAngleRad(i.targetTransformObj.angle,90,i.angleIsExtraSticky?12:4)),i.targetTransformObj.angle%(Math.PI/2)!=0&&(i.angleIsExtraSticky=!1),e.angleRad=i.targetTransformObj.angle-i.oldTransformObj.angle;var t=h.BB.Matrix.getIdentity();t=h.BB.Matrix.multiplyMatrices(t,h.BB.Matrix.createTranslationMatrix(e.relX,e.relY)),t=h.BB.Matrix.multiplyMatrices(t,h.BB.Matrix.createScaleMatrix(e.scale)),t=h.BB.Matrix.multiplyMatrices(t,h.BB.Matrix.createRotationMatrix(e.angleRad)),t=h.BB.Matrix.multiplyMatrices(t,h.BB.Matrix.createTranslationMatrix(-e.relX,-e.relY)),t=h.BB.Matrix.multiplyMatrices(t,h.BB.Matrix.createTranslationMatrix(e.relX-e.downRelX,e.relY-e.downRelY));var n=[i.targetTransformObj.x,i.targetTransformObj.y,0,1];n=h.BB.Matrix.multiplyMatrixAndPoint(t,n),i.targetTransformObj.x=n[0],i.targetTransformObj.y=n[1],i.highResTransformObj=h.BB.copyObj(i.targetTransformObj),i.onViewChange({changed:["scale","angle"],scale:i.targetTransformObj.scale,angle:i.targetTransformObj.angle}),i.reqFrame(),i.transformIsDirty=!0,i.lastRenderedState=-1}else"end"===e.type&&(i.oldTransformObj=null)}});var s=function(e){n.fitView()?(i.lastRenderedState=-1,i.reqFrame()):(i.internalZoomByStep(2,e.relX,e.relY)&&i.onViewChange({changed:["scale"],angle:i.targetTransformObj.angle,scale:i.targetTransformObj.scale}),i.lastRenderedState=-1)};this.mainDoubleTapper=new h.BB.DoubleTapper({onDoubleTap:s}),this.middleDoubleTapper=new h.BB.DoubleTapper({onDoubleTap:s}),this.middleDoubleTapper.setAllowedButtonArr(["middle"]),this.twoFingerTap=new h.BB.NFingerTapper({fingers:2,onTap:function(){t.onUndo()}}),this.threeFingerTap=new h.BB.NFingerTapper({fingers:3,onTap:function(){t.onRedo()}}),this.pointerEventChain=new h.BB.EventChain({chainArr:[this.twoFingerTap,this.threeFingerTap,this.mainDoubleTapper,this.middleDoubleTapper,this.pinchZoomer,new h.BB.OnePointerLimiter,new h.BB.CoalescedExploder]}),this.pointerEventChain.setChainOut((function(e){if(i.cursorPos.x=e.relX,i.cursorPos.y=e.relY,"pointerup"===e.type&&"touch"===e.pointerType?(i.pointer=null,i.lastRenderedState=-1,i.reqFrame()):(i.pointer||(i.pointer={x:0,y:0}),i.pointer.x=e.relX,i.pointer.y=e.relY),i.currentInputProcessor)i.currentInputProcessor.onPointer(e);else{var t=i.keyListener.getComboStr();i.globalMode===a.Draw?["","shift","ctrl"].includes(t)&&"pointerdown"===e.type&&"left"===e.button?(i.currentInputProcessor=i.inputProcessorObj.draw,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):(i.updateCursor(a.Draw),i.reqFrame()):i.globalMode===a.Hand?"pointerdown"===e.type&&["left","middle"].includes(e.button)?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):i.updateCursor(a.Hand):i.globalMode===a.Pick?"pointerdown"===e.type&&["left","right"].includes(e.button)?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):i.updateCursor(a.Pick):i.globalMode===a.Fill?"pointerdown"===e.type&&"left"===e.button?(i.currentInputProcessor=i.inputProcessorObj.fill,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):(i.updateCursor(a.Fill),i.reqFrame()):i.globalMode===a.Gradient?["","shift","ctrl"].includes(t)&&"pointerdown"===e.type&&"left"===e.button?(i.currentInputProcessor=i.inputProcessorObj.gradient,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):(i.updateCursor(a.Gradient),i.reqFrame()):i.globalMode===a.Text?"pointerdown"===e.type&&"left"===e.button?(i.currentInputProcessor=i.inputProcessorObj.text,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):(i.updateCursor(a.Text),i.reqFrame()):i.globalMode===a.Shape&&(["","shift","ctrl"].includes(t)&&"pointerdown"===e.type&&"left"===e.button?(i.currentInputProcessor=i.inputProcessorObj.shape,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):(i.updateCursor(a.Shape),i.reqFrame()))}})),this.rootEl.addEventListener("wheel",(function(e){e.preventDefault()})),setTimeout((function(){i.pointerListener=new h.BB.PointerListener({target:i.rootEl,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&"middle"===e.button)try{e.eventPreventDefault()}catch(e){}"pointerdown"===e.type&&h.BB.unfocusAnyInput(),i.pointerEventChain.chainIn(e)},onWheel:function(e){i.isDrawing||(i.reqFrame(),i.internalZoomByStep(-e.deltaY/(i.keyListener.isPressed("shift")?8:2),e.relX,e.relY)&&i.onViewChange({changed:["scale"],angle:i.targetTransformObj.angle,scale:i.targetTransformObj.scale}),i.lastRenderedState=-1)},onEnterLeave:function(e){e||i.isDrawing||(i.pointer=null,i.lastRenderedState=-1)},maxPointers:4})}),1),this.brushRadius=1,this.animationFrameRequested=!1,this.lastRenderedState=-2,this.lastRenderTime=performance.now(),window.requestAnimationFrame((function(){return i.updateLoop()})),this.resetView()}return(0,l.default)(e,[{key:"getRenderedTransform",value:function(){var e=this.renderedTransformObj;return e.x=this.highResTransformObj.x,e.y=this.highResTransformObj.y,e.scale=this.highResTransformObj.scale,e.angle=this.highResTransformObj.angle,e.angle%(Math.PI/2)==0&&e.scale%1==0&&(e.x=Math.round(e.x),e.y=Math.round(e.y)),e}},{key:"updateChangeListener",value:function(){var e=this;this.klCanvas.addChangeListener((function(){e.lastRenderedState=-1,e.reqFrame()}))}},{key:"updateCursor",value:function(e,i){if(e!==this.currentMode||i){var n=this.currentMode;if(this.currentMode=e,this.lastRenderedState=-1,this.currentMode===a.Draw?this.rootEl.style.cursor="crosshair":this.currentMode===a.Hand?this.rootEl.style.cursor="grab":this.currentMode===a.HandGrabbing?this.rootEl.style.cursor="grabbing":this.currentMode===a.Pick?this.rootEl.style.cursor="url('"+t(p)+"') 0 15, crosshair":this.currentMode===a.Zoom?this.rootEl.style.cursor="url('"+t(d)+"') 7 7, zoom-in":this.currentMode===a.Rotate?this.rootEl.style.cursor="grab":this.currentMode===a.Rotating?this.rootEl.style.cursor="grabbing":this.currentMode===a.Fill?this.rootEl.style.cursor="url('"+t(g)+"') 1 12, crosshair":this.currentMode===a.Gradient?this.rootEl.style.cursor="crosshair":this.currentMode===a.Text?this.rootEl.style.cursor="url('"+t(f)+"') 1 12, crosshair":this.currentMode===a.Shape&&(this.rootEl.style.cursor="crosshair"),[a.Draw,a.Pick,a.Fill,a.Text,a.Shape].includes(this.globalMode)){var r=[a.Hand,a.HandGrabbing].includes(n),s=[a.Hand,a.HandGrabbing].includes(this.currentMode);!r&&s&&this.mainDoubleTapper.setAllowedPointerTypeArr(["mouse","pen","touch"]),r&&!s&&this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])}this.currentMode!==a.Pick&&this.svgOverlay.updateColorPreview({isVisible:!1})}}},{key:"internalZoomByStep",value:function(e,t,i){var n=Math.log2(this.targetTransformObj.scale)/Math.abs(e);n+=e>0?1:-1,n=Math.round(n),n*=Math.abs(e);var r=Math.max(x,Math.min(B,Math.pow(2,n)));if(r===this.targetTransformObj.scale)return!1;var a=r/this.targetTransformObj.scale;this.targetTransformObj.scale=r;var s=h.BB.Matrix.getIdentity();s=h.BB.Matrix.multiplyMatrices(s,h.BB.Matrix.createTranslationMatrix(t,i)),s=h.BB.Matrix.multiplyMatrices(s,h.BB.Matrix.createScaleMatrix(a)),s=h.BB.Matrix.multiplyMatrices(s,h.BB.Matrix.createTranslationMatrix(-t,-i));var o=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];return o=h.BB.Matrix.multiplyMatrixAndPoint(s,o),this.targetTransformObj.x=o[0],this.targetTransformObj.y=o[1],this.transformIsDirty=!0,!0}},{key:"mixTransformObj",value:function(e,t,i){if(e.angle===t.angle)return e.scale=h.BB.mix(e.scale,t.scale,i),e.x=h.BB.mix(e.x,t.x,i),e.y=h.BB.mix(e.y,t.y,i),void(e.angle=h.BB.mix(e.angle,t.angle,i));var n=this.klCanvas.getWidth(),r=this.klCanvas.getHeight(),a=this.canvasToWorkspaceCoord({x:n/2,y:r/2},e),s=this.canvasToWorkspaceCoord({x:n/2,y:r/2},t);e.x=h.BB.mix(a.x,s.x,i),e.y=h.BB.mix(a.y,s.y,i),e.scale=h.BB.mix(e.scale,t.scale,i),e.angle=h.BB.mix(e.angle,t.angle,i);var o=this.canvasToWorkspaceCoord({x:-n/2,y:-r/2},e);e.x=o.x,e.y=o.y}},{key:"render",value:function(){this.doResizeCanvas&&(this.doResizeCanvas=!1,this.renderTargetCanvas.width=this.renderWidth,this.renderTargetCanvas.height=this.renderHeight),this.renderContext(this.renderTargetCtx)}},{key:"testBgVisible",value:function(){var e=[[0,0],[this.renderWidth,0],[this.renderWidth,this.renderHeight],[0,this.renderHeight]],t=this.getRenderedTransform(),i=h.BB.Matrix.getIdentity();i=h.BB.Matrix.multiplyMatrices(i,h.BB.Matrix.createScaleMatrix(1/t.scale)),i=h.BB.Matrix.multiplyMatrices(i,h.BB.Matrix.createRotationMatrix(-t.angle)),i=h.BB.Matrix.multiplyMatrices(i,h.BB.Matrix.createTranslationMatrix(-t.x,-t.y));for(var n=0;n<e.length;n++){var r=[e[n][0],e[n][1],0,1];if(!(0<=(r=h.BB.Matrix.multiplyMatrixAndPoint(i,r))[0]&&r[0]<=this.klCanvas.getWidth()&&0<=r[1]&&r[1]<=this.klCanvas.getHeight()))return!0}return!1}},{key:"renderContext",value:function(e){var t=this.klCanvas.getWidth(),i=this.klCanvas.getHeight(),n=this.getRenderedTransform(),r=y.theme.isDark();if(n.scale>=4||1===n.scale&&0===n.angle?e.imageSmoothingEnabled=!1:(e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="low"),e.save(),this.bgVisible?(e.fillStyle=r?"rgb(33, 33, 33)":"rgb(158,158,158)",e.fillRect(0,0,this.renderWidth,this.renderHeight)):e.clearRect(0,0,this.renderWidth,this.renderHeight),this.bgVisible){e.save(),e.translate(n.x,n.y),e.scale(n.scale,n.scale),e.rotate(n.angle),e.imageSmoothingEnabled=!1;e.globalAlpha=r?.25:.2,e.drawImage(r?this.emptyLightCanvas:this.emptyCanvas,-1/n.scale,-1/n.scale,t+2/n.scale,i+2/n.scale),e.globalAlpha=1,e.globalCompositeOperation="destination-out",e.drawImage(this.emptyCanvas,0,0,t,i),e.restore()}e.translate(n.x,n.y),e.scale(n.scale,n.scale),e.rotate(n.angle);for(var s=this.klCanvas.getLayersFast(),o=0;o<s.length;o++)s[o].opacity>0&&(e.globalAlpha=s[o].opacity,e.globalCompositeOperation=s[o].mixModeStr,s[o].canvas.compositeObj?(this.compositeCanvas.width!==s[o].canvas.width||this.compositeCanvas.height!==s[o].canvas.height?(this.compositeCanvas.width=s[o].canvas.width,this.compositeCanvas.height=s[o].canvas.height):this.compositeCtx.clearRect(0,0,this.compositeCanvas.width,this.compositeCanvas.height),this.compositeCtx.drawImage(s[o].canvas,0,0),s[o].canvas.compositeObj.draw(this.compositeCtx),e.drawImage(this.compositeCanvas,0,0,t,i)):e.drawImage(s[o].canvas,0,0,t,i));e.globalAlpha=1,e.restore(),a.Rotate===this.currentMode||a.Rotating===this.currentMode?this.svgOverlay.updateCompass({isVisible:!0,angleDeg:n.angle/Math.PI*180}):this.svgOverlay.updateCompass({isVisible:!1})}},{key:"workspaceToCanvasCoord",value:function(e){var t=this.getRenderedTransform(),i=h.BB.Matrix.getIdentity();i=h.BB.Matrix.multiplyMatrices(i,h.BB.Matrix.createScaleMatrix(1/t.scale)),i=h.BB.Matrix.multiplyMatrices(i,h.BB.Matrix.createRotationMatrix(-t.angle)),i=h.BB.Matrix.multiplyMatrices(i,h.BB.Matrix.createTranslationMatrix(-t.x,-t.y));var n=[e.x,e.y,0,1];return{x:(n=h.BB.Matrix.multiplyMatrixAndPoint(i,n))[0],y:n[1]}}},{key:"canvasToWorkspaceCoord",value:function(e,t){var i=h.BB.Matrix.getIdentity();i=h.BB.Matrix.multiplyMatrices(i,h.BB.Matrix.createTranslationMatrix(t.x,t.y)),i=h.BB.Matrix.multiplyMatrices(i,h.BB.Matrix.createRotationMatrix(t.angle)),i=h.BB.Matrix.multiplyMatrices(i,h.BB.Matrix.createScaleMatrix(t.scale));var n=[e.x,e.y,0,1];return{x:(n=h.BB.Matrix.multiplyMatrixAndPoint(i,n))[0],y:n[1]}}},{key:"snapAngleRad",value:function(e,t,i){var n=180*e/Math.PI,r=Math.abs(n%t);return Math.min(r,t-r)<=i&&(n=Math.round(n/t)*t),n/180*Math.PI}},{key:"minimizeAngleRad",value:function(e){return(e%=2*Math.PI)>Math.PI?e-=2*Math.PI:e<-Math.PI&&(e+=2*Math.PI),e}},{key:"resetInputProcessor",value:function(){this.currentInputProcessor=null,this.updateCursor(this.globalMode),this.reqFrame(!0)}},{key:"reqFrame",value:function(e){this.animationFrameRequested=!0,e&&(this.lastRenderedState=-1)}},{key:"updateLoop",value:function(){var e=this;window.requestAnimationFrame((function(){return e.updateLoop()}));var t=u.klHistory.getState(),i=this.lastRenderedState<t,n=performance.now(),r=60*(n-this.lastRenderTime)/1e3;this.lastRenderTime=n,(this.animationFrameRequested||i)&&(this.animationFrameRequested=!1,this.checkChange(r))}},{key:"checkChange",value:function(e){var t=u.klHistory.getState(),i=this.lastRenderedState<t||this.highResTransformObj.scale!==this.targetTransformObj.scale||this.highResTransformObj.x!==this.targetTransformObj.x||this.highResTransformObj.y!==this.targetTransformObj.y;if(!this.doAnimateTranslate&&(this.highResTransformObj.scale===this.targetTransformObj.scale||Math.abs(this.highResTransformObj.scale-this.targetTransformObj.scale)<.008*this.targetTransformObj.scale))this.highResTransformObj.scale=this.targetTransformObj.scale,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.highResTransformObj.angle=this.targetTransformObj.angle,this.transformIsDirty&&(this.transformIsDirty=!1,this.bgVisible=this.testBgVisible()),this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale});else if((this.highResTransformObj.x===this.targetTransformObj.x||Math.abs(this.highResTransformObj.x-this.targetTransformObj.x)<.5)&&(this.highResTransformObj.y===this.targetTransformObj.y||Math.abs(this.highResTransformObj.y-this.targetTransformObj.y)<.5)&&(this.highResTransformObj.scale===this.targetTransformObj.scale||Math.abs(this.highResTransformObj.scale-this.targetTransformObj.scale)<.008*this.targetTransformObj.scale))this.highResTransformObj.scale=this.targetTransformObj.scale,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.highResTransformObj.angle=this.targetTransformObj.angle,this.doAnimateTranslate=!1,this.transformIsDirty&&(this.transformIsDirty=!1,this.bgVisible=this.testBgVisible()),this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale});else{this.reqFrame();var n=Math.min(1,.3*e);this.mixTransformObj(this.highResTransformObj,this.targetTransformObj,n),this.bgVisible=!0,this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale})}if(this.pointer&&this.currentMode==a.Draw&&!this.usesCssCursor?this.svgOverlay.updateCursor({x:this.pointer.x,y:this.pointer.y,isVisible:!0}):this.svgOverlay.updateCursor({isVisible:!1}),i){this.lastRenderedState=t;var r=performance.now();this.render(),this.renderTime=h.BB.mix(this.renderTime,performance.now()-r,.05)}}},{key:"getElement",value:function(){return this.rootEl}},{key:"setCanvas",value:function(e){this.klCanvas=e,this.lastDrawEvent=null,this.resetView(),this.updateChangeListener(),this.lastRenderedState=-1,this.reqFrame()}},{key:"setSize",value:function(e,t){var i=this.renderWidth,n=this.renderHeight;e===i&&t===n||(this.doResizeCanvas=!0,this.renderWidth=e,this.renderHeight=t,this.svgOverlay.setSize(e,t),this.targetTransformObj.x+=(e-i)/2,this.targetTransformObj.y+=(t-n)/2,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.bgVisible=this.testBgVisible(),this.lastRenderedState=-1,this.reqFrame())}},{key:"setMode",value:function(e){"draw"===e&&(this.globalMode=a.Draw,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"fill"===e&&(this.globalMode=a.Fill,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"gradient"===e&&(this.globalMode=a.Gradient,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"text"===e&&(this.globalMode=a.Text,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"shape"===e&&(this.globalMode=a.Shape,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"hand"===e&&(this.globalMode=a.Hand,this.mainDoubleTapper.setAllowedPointerTypeArr(["mouse","pen","touch"])),"pick"===e&&(this.globalMode=a.Pick,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"]))}},{key:"getMode",value:function(){return this.globalMode===a.Draw?"draw":this.globalMode===a.Fill?"fill":this.globalMode===a.Gradient?"gradient":this.globalMode===a.Text?"text":this.globalMode===a.Shape?"shape":this.globalMode===a.Hand?"hand":this.globalMode===a.Pick?"pick":void 0}},{key:"setEnabled",value:function(e){}},{key:"setCursorSize",value:function(e){var t=this;this.brushRadius=e/2,this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale}),null===this.pointer&&(this.hideBrushCursorTimeout&&clearTimeout(this.hideBrushCursorTimeout),this.svgOverlay.updateCursor({x:this.renderWidth/2,y:this.renderHeight/2,isVisible:!0}),this.hideBrushCursorTimeout=setTimeout((function(){null===t.pointer&&t.svgOverlay.updateCursor({isVisible:!1})}),500))}},{key:"zoomByStep",value:function(e){this.internalZoomByStep(e,this.renderWidth/2,this.renderHeight/2)&&(this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale}))}},{key:"resetView",value:function(e){this.targetTransformObj.scale=1,this.targetTransformObj.angle=0,this.targetTransformObj.x=(this.renderWidth-this.klCanvas.getWidth())/2,this.targetTransformObj.y=(this.renderHeight-this.klCanvas.getHeight())/2,e?(this.doAnimateTranslate=!0,this.transformIsDirty=!0):this.highResTransformObj=h.BB.copyObj(this.targetTransformObj),this.bgVisible=this.testBgVisible(),this.reqFrame(),e&&this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle})}},{key:"fitView",value:function(){var e=this.snapAngleRad(this.targetTransformObj.angle,90,90),t=[[0,0],[this.klCanvas.getWidth(),0],[this.klCanvas.getWidth(),this.klCanvas.getHeight()],[0,this.klCanvas.getHeight()],[this.klCanvas.getWidth()/2,this.klCanvas.getHeight()/2]],i=h.BB.Matrix.getIdentity();i=h.BB.Matrix.multiplyMatrices(i,h.BB.Matrix.createRotationMatrix(e));for(var n=0;n<t.length;n++){var r=[t[n][0],t[n][1],0,1];r=h.BB.Matrix.multiplyMatrixAndPoint(i,r),t[n][0]=r[0],t[n][1]=r[1]}for(var a={x0:null,y0:null,x1:null,y1:null},s=0;s<t.length;s++)(null===a.x0||t[s][0]<a.x0)&&(a.x0=t[s][0]),(null===a.y0||t[s][1]<a.y0)&&(a.y0=t[s][1]),(null===a.x1||t[s][0]>a.x1)&&(a.x1=t[s][0]),(null===a.y1||t[s][1]>a.y1)&&(a.y1=t[s][1]);var o=a.x1-a.x0,l=a.y1-a.y0,c=h.BB.fitInto(o,l,this.renderWidth-0,this.renderHeight-0,1).width/o,u={angle:e,x:this.renderWidth/2-(t[4][0]-t[0][0])*c,y:this.renderHeight/2-(t[4][1]-t[0][1])*c,scale:c};return!(u.angle===this.targetTransformObj.angle&&Math.abs(u.x-this.targetTransformObj.x)<1e-10&&Math.abs(u.y-this.targetTransformObj.y)<1e-10&&u.scale===this.targetTransformObj.scale)&&(this.targetTransformObj=u,this.doAnimateTranslate=!0,this.transformIsDirty=!0,this.reqFrame(),this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle}),!0)}},{key:"setAngle",value:function(e,t){var i={x:this.renderWidth/2,y:this.renderHeight/2},n=this.targetTransformObj.angle,r=e/180*Math.PI;t?this.targetTransformObj.angle+=r:this.targetTransformObj.angle=r,this.targetTransformObj.angle=this.minimizeAngleRad(this.snapAngleRad(this.targetTransformObj.angle,90,4));var a=h.BB.Matrix.getIdentity();a=h.BB.Matrix.multiplyMatrices(a,h.BB.Matrix.createTranslationMatrix(i.x,i.y)),a=h.BB.Matrix.multiplyMatrices(a,h.BB.Matrix.createRotationMatrix(this.targetTransformObj.angle-n)),a=h.BB.Matrix.multiplyMatrices(a,h.BB.Matrix.createTranslationMatrix(-i.x,-i.y));var s=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];s=h.BB.Matrix.multiplyMatrixAndPoint(a,s),this.targetTransformObj.x=s[0],this.targetTransformObj.y=s[1],this.highResTransformObj=h.BB.copyObj(this.targetTransformObj),this.transformIsDirty=!0,this.reqFrame(!0)}},{key:"translateView",value:function(e,t){this.targetTransformObj.x+=40*e,this.targetTransformObj.y+=40*t,this.transformIsDirty=!0,this.doAnimateTranslate=!0,this.reqFrame(!0)}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"getScale",value:function(){return this.targetTransformObj.scale}},{key:"getAngleDeg",value:function(){return 180*this.targetTransformObj.angle/Math.PI}},{key:"getMaxScale",value:function(){return B}},{key:"getMinScale",value:function(){return x}},{key:"requestFrame",value:function(){this.lastRenderedState=-1,this.reqFrame()}},{key:"setLastDrawEvent",value:function(e,t,i){null!==e?(this.lastDrawEvent||(this.lastDrawEvent={x:0,y:0,pressure:0}),this.lastDrawEvent.x=e,this.lastDrawEvent.y=t,this.lastDrawEvent.pressure=i):this.lastDrawEvent=null}}]),e}()})),i.register("eZ2aJ",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("ayl5b")})),i.register("7QZIi",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("8Sx0P")})),i.register("bz6iQ",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("ixtEz")})),i.register("kE5UF",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("3iHbP")})),i.register("dpBaO",(function(t,n){e(t.exports,"LinetoolProcessor",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=function(){"use strict";function e(t){(0,r.default)(this,e),(0,s.default)(this,"downEvent",null),(0,s.default)(this,"eventQueue",[]),(0,s.default)(this,"direction",null),this.onDraw=t.onDraw}return(0,a.default)(e,[{key:"process",value:function(e){if("down"===e.type&&(this.downEvent=e,this.direction=null,e.shiftIsPressed))return this.onDraw({type:"line",x0:null,y0:null,pressure0:null,x1:e.x,y1:e.y,pressure1:e.pressure}),void this.eventQueue.push(e);if("move"===e.type&&this.downEvent)if(e.shiftIsPressed){if(null===this.direction){var t=Math.abs(e.x-this.downEvent.x),i=Math.abs(e.y-this.downEvent.y);if(t>5||i>5){this.direction=t>i?0:1;for(var n=0;n<this.eventQueue.length;n++){var r=this.eventQueue[n];"up"!==r.type&&(0===this.direction?r.y=this.downEvent.y:r.x=this.downEvent.x),this.onDraw(o.BB.copyObj(r))}this.eventQueue=[]}}if(null===this.direction)return void this.eventQueue.push(e);0===this.direction?e.y=this.downEvent.y:e.x=this.downEvent.x}else if(this.eventQueue.length>0){for(var a=0;a<this.eventQueue.length;a++)this.onDraw(o.BB.copyObj(this.eventQueue[a]));this.eventQueue=[]}"up"===e.type&&(this.eventQueue=[],this.downEvent=null),this.onDraw(o.BB.copyObj(e))}}]),e}()})),i.register("i5nyl",(function(t,n){e(t.exports,"KlCanvasPreview",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("1C8RU"),l=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.layers=t.layers;var n=t.width/t.layers[0].image.width,a=n>1?t.layers[0].image.width:t.width,l=n>1?t.layers[0].image.height:t.height;this.canvas=s.BB.canvas(a,l),this.updateCheckerboard=function(){i.canvas.style.backgroundImage="url("+s.BB.createCheckerDataUrl(8,void 0,o.theme.isDark())+")"},this.updateCheckerboard(),this.ctx=s.BB.ctx(this.canvas),s.BB.css(this.canvas,{width:"100%",height:"100%",imageRendering:n>1?"pixelated":void 0}),setTimeout((function(){return i.render()}),0),o.theme.addIsDarkListener(this.updateCheckerboard)}return(0,a.default)(e,[{key:"getElement",value:function(){return this.canvas}},{key:"render",value:function(){if(this.ctx){this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var e=0;e<this.layers.length;e++)this.ctx.globalAlpha=this.layers[e].opacity,this.ctx.globalCompositeOperation=this.layers[e].mixModeStr,this.canvas.width>this.layers[e].image.width&&(this.ctx.imageSmoothingEnabled=!1),this.ctx.drawImage(this.layers[e].image,0,0,this.canvas.width,this.canvas.height);this.ctx.restore()}}},{key:"destroy",value:function(){o.theme.removeIsDarkListener(this.updateCheckerboard)}}]),e}()})),i.register("cNhNm",(function(n,r){e(n.exports,"FreeTransform",(function(){return u}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("7U0Ew"),l=i("eWjiX"),h=i("5cYet"),c=i("lt7cS"),u=function(){"use strict";function e(i){var n=this;(0,a.default)(this,e);(0,o.default)(this,"scaled",{x:0,y:0,width:0,height:0,corners:[{x:0,y:0}]}),(0,o.default)(this,"minSnapDist",7),(0,o.default)(this,"cornerCursors",["nw","n","ne","e","se","s","sw","w"]),(0,o.default)(this,"gripSize",14),(0,o.default)(this,"edgeSize",10),(0,o.default)(this,"corners",[]),(0,o.default)(this,"edges",[]),this.transform={x:i.x,y:i.y,width:i.width,height:i.height,angleDeg:i.angleDeg},this.isConstrained=i.isConstrained,this.snapX=i.snapX,this.snapY=i.snapY,this.callback=i.callback,this.scale=i.scale,this.snappingEnabled=!0,this.ratio=this.transform.width/this.transform.height,this.rootEl=l.BB.el({className:"kl-free-transform",css:{userSelect:"none"}}),this.transEl=l.BB.el({parent:this.rootEl,css:{position:"absolute"}}),this.boundsEl=l.BB.el({css:{position:"absolute",cursor:"move",boxShadow:"rgba(255, 255, 255, 0.5) 0 0 0 1px inset, rgba(0, 0, 0, 0.5) 0 0 0 1px"}});var r={x:0,y:0};this.keyListener=new l.BB.KeyListener({});var s,u={x:0,y:0};this.boundsPointerListener=new l.BB.PointerListener({target:this.boundsEl,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointerdown"===e.type&&(u={x:n.transform.x,y:n.transform.y}),"pointermove"===e.type&&"left"===e.button){var t;n.transform.x=u.x+(e.pageX-e.downPageX)/n.scale,n.transform.y=u.y+(e.pageY-e.downPageY)/n.scale;var i={};if(n.snappingEnabled){var r,a;for(r=0;r<n.snapX.length;r++)(t=Math.abs(n.transform.x-n.snapX[r]))<n.minSnapDist/n.scale&&(!i.x||t<i.distX)&&(i.x=n.snapX[r],i.distX=t);for(r=0;r<n.snapY.length;r++)(t=Math.abs(n.transform.y-n.snapY[r]))<n.minSnapDist/n.scale&&(!i.y||t<i.distY)&&(i.y=n.snapY[r],i.distY=t);for(r=0;r<4;r++){a=(0,c.toImageSpace)(n.corners[r].x,n.corners[r].y,n.transform);var s=void 0;for(s=0;s<n.snapX.length;s++)(t=Math.abs(a.x-n.snapX[s]))<n.minSnapDist/n.scale&&(!i.x||t<i.distX)&&(i.x=n.snapX[s]-(a.x-n.transform.x),i.distX=t);for(s=0;s<n.snapY.length;s++)(t=Math.abs(a.y-n.snapY[s]))<n.minSnapDist/n.scale&&(!i.y||t<i.distY)&&(i.y=n.snapY[s]-(a.y-n.transform.y),i.distY=t)}}if("shift"===n.keyListener.getComboStr()){var o=l.BB.projectPointOnLine({x:0,y:u.y},{x:10,y:u.y},{x:n.transform.x,y:n.transform.y}),h=l.BB.dist(o.x,o.y,n.transform.x,n.transform.y);i={x:o.x,y:o.y,distX:h,distY:h},o=l.BB.projectPointOnLine({x:u.x,y:0},{x:u.x,y:10},{x:n.transform.x,y:n.transform.y}),(h=l.BB.dist(o.x,o.y,n.transform.x,n.transform.y))<i.distX&&(i={x:o.x,y:o.y,distX:h,distY:h}),o=l.BB.projectPointOnLine({x:u.x,y:u.y},{x:u.x+1,y:u.y+1},{x:n.transform.x,y:n.transform.y}),(h=l.BB.dist(o.x,o.y,n.transform.x,n.transform.y))<i.distX&&(i={x:o.x,y:o.y,distX:h,distY:h}),o=l.BB.projectPointOnLine({x:u.x,y:u.y},{x:u.x+1,y:u.y-1},{x:n.transform.x,y:n.transform.y}),(h=l.BB.dist(o.x,o.y,n.transform.x,n.transform.y))<i.distX&&(i={x:o.x,y:o.y,distX:h,distY:h})}null!=i.x&&(n.transform.x=i.x),null!=i.y&&(n.transform.y=i.y),Math.abs(n.transform.angleDeg)%90==0&&((0,c.snapToPixel)(n.transform),n.updateCornerPositions()),n.updateDOM()}}});for(var p=0;p<4;p++)!function(e){var t=n.corners[e]={i:e,el:l.BB.el({css:{width:n.gripSize+"px",height:n.gripSize+"px",background:"#fff",borderRadius:n.gripSize+"px",position:"absolute",boxShadow:"inset 0 0 0 2px #000"}}),x:0,y:0,virtualPos:{x:0,y:0}};t.updateDOM=function(){var i=[[-1,-1],[1,-1],[1,1],[-1,1]].map((function(e){return e[0]*=n.transform.width>0?1:-1,e[1]*=n.transform.height>0?1:-1,e})),r=Math.abs(n.scaled.width)<20||Math.abs(n.scaled.height)<20?10:0;l.BB.css(t.el,{left:n.scaled.corners[t.i].x-n.gripSize/2+i[e][0]*r+"px",top:n.scaled.corners[t.i].y-n.gripSize/2+i[e][1]*r+"px"});for(var a=l.BB.pointsToAngleDeg({x:n.transform.x,y:n.transform.y},(0,c.toImageSpace)(t.x,t.y,n.transform))+135;a<0;)a+=360;var s=Math.round(a/45)%n.cornerCursors.length;l.BB.css(t.el,{cursor:n.cornerCursors[s]+"-resize"})},t.pointerListener=new l.BB.PointerListener({target:n.corners[e].el,fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointerdown"===t.type&&"left"===t.button)n.corners[e].virtualPos=(0,c.toImageSpace)(n.corners[e].x,n.corners[e].y,n.transform);else if("pointermove"===t.type&&"left"===t.button){n.corners[e].virtualPos.x+=t.dX/n.scale,n.corners[e].virtualPos.y+=t.dY/n.scale;var i={x:n.corners[e].virtualPos.x,y:n.corners[e].virtualPos.y};i=n.constrainCorner(e,i.x,i.y),n.isConstrained||(i=n.snapCorner(i.x,i.y)),Math.abs(n.transform.angleDeg)%90==0&&(i.x=Math.round(i.x),i.y=Math.round(i.y));var r=(0,c.toTransformSpace)(i.x,i.y,n.transform),a=r.x-n.corners[e].x,s=r.y-n.corners[e].y;n.corners[e].x=r.x,n.corners[e].y=r.y;var o=[];0===e?o=[3,1,2]:1===e?o=[2,0,3]:2===e?o=[1,3,0]:3===e&&(o=[0,2,1]),n.corners[o[0]].x=n.corners[e].x,n.corners[o[1]].y=n.corners[e].y,n.keyListener.isPressed("shift")&&(n.corners[o[2]].x-=a,n.corners[o[2]].y-=s,n.corners[o[1]].x=n.corners[o[2]].x,n.corners[o[0]].y=n.corners[o[2]].y),n.updateTransformViaCorners()}}})}(p);this.updateCornerPositions(),this.updateScaled();for(var d=0;d<4;d++)!function(e){n.edges[e]={el:l.BB.el({css:{width:n.edgeSize+"px",height:n.edgeSize+"px",position:"absolute"}})};var t=n.edges[e];t.updateDOM=function(){0===e?l.BB.css(t.el,{left:Math.min(n.scaled.corners[0].x,n.scaled.corners[1].x)+"px",top:Math.min(n.scaled.corners[0].y,n.scaled.corners[3].y)-n.edgeSize+"px",width:Math.abs(n.scaled.width)+"px",height:n.edgeSize+"px"}):1===e?l.BB.css(t.el,{left:Math.max(n.scaled.corners[0].x,n.scaled.corners[1].x)+"px",top:Math.min(n.scaled.corners[1].y,n.scaled.corners[2].y)+"px",width:n.edgeSize+"px",height:Math.abs(n.scaled.height)+"px"}):2===e?l.BB.css(t.el,{left:Math.min(n.scaled.corners[3].x,n.scaled.corners[2].x)+"px",top:Math.max(n.scaled.corners[0].y,n.scaled.corners[3].y)+"px",width:Math.abs(n.scaled.width)+"px",height:n.edgeSize+"px"}):3===e&&l.BB.css(t.el,{left:Math.min(n.scaled.corners[0].x,n.scaled.corners[1].x)-n.edgeSize+"px",top:Math.min(n.scaled.corners[0].y,n.scaled.corners[3].y)+"px",width:n.edgeSize+"px",height:Math.abs(n.scaled.height)+"px"});for(var i=Math.round(n.transform.angleDeg/45);i<0;)i+=8;i=(2*e+1+i)%n.cornerCursors.length,t.el.style.cursor=n.cornerCursors[i]+"-resize"};var i=[0,2].includes(e);t.pointerListener=new l.BB.PointerListener({target:n.edges[e].el,fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointerdown"===t.type&&"left"===t.button&&(s=i?n.corners[0].y>=n.corners[3].y:n.corners[0].x>=n.corners[1].x,r.x=0,r.y=0),"pointermove"===t.type&&"left"===t.button){var a=l.BB.rotateAround({x:0,y:0},{x:t.dX/n.scale,y:t.dY/n.scale},-n.transform.angleDeg),o={dX:a.x,dY:a.y};Math.abs(n.transform.angleDeg)%90==0&&(o=l.BB.intDxy(r,a.x,a.y));var h=[];0===e?h=[2,3,0,1]:1===e?h=[0,3,1,2]:2===e?h=[0,1,2,3]:3===e&&(h=[1,2,0,3]);var c=i?"y":"x",u=i?o.dY:o.dX;s?(n.corners[h[0]][c]+=u,n.corners[h[1]][c]+=u):(n.corners[h[2]][c]+=u,n.corners[h[3]][c]+=u),n.keyListener.isPressed("shift")&&(s?(n.corners[h[2]][c]-=u,n.corners[h[3]][c]-=u):(n.corners[h[0]][c]-=u,n.corners[h[1]][c]-=u)),i?n.restoreRatio(!1,!0):n.restoreRatio(!0,!1),n.updateTransformViaCorners()}}})}(d);this.angleGrip={el:l.BB.el({css:{cursor:"url("+t(h)+") 10 10, move",width:this.gripSize+"px",height:this.gripSize+"px",background:"#0ff",borderRadius:this.gripSize+"px",position:"absolute",boxShadow:"inset 0 0 0 2px #000"}}),x:0,y:0,snap:!1,updateDOM:function(){l.BB.css(n.angleGrip.el,{left:n.angleGrip.x-n.gripSize/2+"px",top:n.angleGrip.y-n.gripSize/2+"px"})}},l.BB.el({parent:this.angleGrip.el,css:{width:"2px",height:"13px",left:this.gripSize/2-1+"px",top:this.gripSize+"px",background:"#0ff",position:"absolute"}}),this.anglePointerListener=new l.BB.PointerListener({target:this.angleGrip.el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=n.rootEl.getBoundingClientRect(),i={x:t.left-n.rootEl.scrollLeft,y:t.top-n.rootEl.scrollTop},r={x:(e.clientX-i.x)/n.scale,y:(e.clientY-i.y)/n.scale},a=l.BB.pointsToAngleDeg({x:n.transform.x,y:n.transform.y},r)+90;n.transform.angleDeg=a;var s=45*Math.round(a/360*8);("shift"===n.keyListener.getComboStr()||n.snappingEnabled&&Math.abs(s-a)<8)&&(n.transform.angleDeg=s),n.updateDOM()}"pointerup"===e.type&&Math.abs(n.transform.angleDeg)%90==0&&((0,c.snapToPixel)(n.transform),n.updateCornerPositions(),n.updateDOM())}}),(0,c.snapToPixel)(this.transform),this.updateDOM(!0),l.BB.append(this.transEl,[this.boundsEl,this.edges[0].el,this.edges[1].el,this.edges[2].el,this.edges[3].el,this.corners[0].el,this.corners[1].el,this.corners[2].el,this.corners[3].el,this.angleGrip.el])}return(0,s.default)(e,[{key:"updateScaled",value:function(){var e=this;this.scaled.x=this.transform.x*this.scale,this.scaled.y=this.transform.y*this.scale,this.scaled.width=this.transform.width*this.scale,this.scaled.height=this.transform.height*this.scale,this.scaled.corners=this.corners.map((function(t){return{x:t.x*e.scale,y:t.y*e.scale}}))}},{key:"snapCorner",value:function(e,t){if(!this.snappingEnabled)return{x:e,y:t};for(var i,n,r,a={x:void 0,y:void 0,dist:{x:void 0,y:void 0}},s=0;s<this.snapX.length;s++)(i=Math.abs(e-this.snapX[s]))<this.minSnapDist/this.scale&&(void 0===a.x||i<a.dist.x)&&(a.x=this.snapX[s],a.dist.x=i);for(var o=0;o<this.snapY.length;o++)(i=Math.abs(t-this.snapY[o]))<this.minSnapDist/this.scale&&(void 0===a.y||i<a.dist.y)&&(a.y=this.snapY[o],a.dist.y=i);return void 0===a.x&&void 0===a.y?{x:e,y:t}:{x:null!==(n=a.x)&&void 0!==n?n:e,y:null!==(r=a.y)&&void 0!==r?r:t}}},{key:"constrainCorner",value:function(e,t,i){if(!this.isConstrained)return{x:t,y:i};var n=this.transform.width*this.transform.height<0?-1:1;return l.BB.projectPointOnLine({x:this.transform.x,y:this.transform.y},(0,c.toImageSpace)(this.ratio,n*([0,2].includes(e)?1:-1),this.transform),{x:t,y:i})}},{key:"updateCornerPositions",value:function(){this.corners[0].x=-this.transform.width/2,this.corners[0].y=-this.transform.height/2,this.corners[1].x=this.transform.width/2,this.corners[1].y=-this.transform.height/2,this.corners[2].x=this.transform.width/2,this.corners[2].y=this.transform.height/2,this.corners[3].x=-this.transform.width/2,this.corners[3].y=this.transform.height/2}},{key:"restoreRatio",value:function(e,t){if(this.isConstrained){var i=Math.abs(this.transform.angleDeg)%90==0,n=Math.abs(this.transform.angleDeg-90)%180==0;if(t&&!e){var r=Math.abs(this.corners[3].y-this.corners[0].y),a=this.ratio*r;i&&(a=0==(n?this.transform.y%1:this.transform.x%1)?l.BB.roundEven(a):l.BB.roundUneven(a)),this.corners[1].x-this.corners[0].x<0&&(a*=-1),this.corners[0].x=-a/2,this.corners[3].x=-a/2,this.corners[1].x=a/2,this.corners[2].x=a/2}if(!t&&e){var s=Math.abs(this.corners[0].x-this.corners[1].x)/this.ratio;i&&(s=0==(n?this.transform.x%1:this.transform.y%1)?l.BB.roundEven(s):l.BB.roundUneven(s)),this.corners[3].y-this.corners[0].y<0&&(s*=-1),this.corners[0].y=-s/2,this.corners[1].y=-s/2,this.corners[2].y=s/2,this.corners[3].y=s/2}}}},{key:"updateTransformViaCorners",value:function(){var e=l.BB.rotateAround({x:0,y:0},{x:(this.corners[0].x+this.corners[1].x)/2,y:(this.corners[0].y+this.corners[3].y)/2},this.transform.angleDeg);this.transform.x=e.x+this.transform.x,this.transform.y=e.y+this.transform.y,this.transform.width=this.corners[1].x-this.corners[0].x,this.transform.height=this.corners[3].y-this.corners[0].y,this.updateCornerPositions(),this.updateDOM()}},{key:"updateDOM",value:function(e){this.updateScaled(),l.BB.css(this.transEl,{left:this.scaled.x+"px",top:this.scaled.y+"px",transformOrigin:"0 0",transform:"rotate("+this.transform.angleDeg+"deg)"}),l.BB.css(this.boundsEl,{width:Math.abs(this.scaled.width)+"px",height:Math.abs(this.scaled.height)+"px",left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px"}),this.corners[0].updateDOM(),this.corners[1].updateDOM(),this.corners[2].updateDOM(),this.corners[3].updateDOM(),this.edges[0].updateDOM(),this.edges[1].updateDOM(),this.edges[2].updateDOM(),this.edges[3].updateDOM(),this.angleGrip.x=0,this.angleGrip.y=-Math.abs(this.transform.height*this.scale)/2-20,this.angleGrip.updateDOM(),e||this.callback&&this.callback((0,c.copyTransform)(this.transform))}},{key:"getTransform",value:function(){return(0,c.copyTransform)(this.transform)}},{key:"setConstrained",value:function(e){this.isConstrained=e,e&&0!==this.transform.width&&0!==this.transform.height&&(this.ratio=Math.abs(this.transform.width/this.transform.height))}},{key:"setSnapping",value:function(e){this.snappingEnabled=e}},{key:"setPos",value:function(e){this.transform.x=e.x,this.transform.y=e.y,this.updateDOM(!0)}},{key:"move",value:function(e,t){this.transform.x+=e,this.transform.y+=t,this.updateDOM(!1)}},{key:"setSize",value:function(e,t){this.transform.width=e,this.transform.height=t,Math.abs(this.transform.angleDeg)%90==0&&(0,c.snapToPixel)(this.transform),this.updateCornerPositions(),this.updateDOM(!1)}},{key:"setAngleDeg",value:function(e){this.transform.angleDeg=e,Math.abs(this.transform.angleDeg)%90==0&&((0,c.snapToPixel)(this.transform),this.updateCornerPositions()),this.updateDOM(!0)}},{key:"getElement",value:function(){return this.rootEl}},{key:"getRatio",value:function(){return this.ratio}},{key:"destroy",value:function(){this.keyListener.destroy(),this.boundsPointerListener.destroy(),this.corners[0].pointerListener.destroy(),this.corners[1].pointerListener.destroy(),this.corners[2].pointerListener.destroy(),this.corners[3].pointerListener.destroy(),this.edges[0].pointerListener.destroy(),this.edges[1].pointerListener.destroy(),this.edges[2].pointerListener.destroy(),this.edges[3].pointerListener.destroy(),this.anglePointerListener.destroy()}}]),e}()})),i.register("5cYet",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("fcdZI")})),i.register("lt7cS",(function(t,n){e(t.exports,"snapToPixel",(function(){return a})),e(t.exports,"copyTransform",(function(){return s})),e(t.exports,"toTransformSpace",(function(){return o})),e(t.exports,"toImageSpace",(function(){return l}));var r=i("eWjiX");function a(e){if(Math.abs(e.angleDeg)%90==0){e.width=Math.round(e.width),e.height=Math.round(e.height);var t=Math.abs(e.angleDeg-90)%180==0;e.x=(t?e.height:e.width)%2==0?Math.round(e.x):Math.round(e.x-.5)+.5,e.y=(t?e.width:e.height)%2==0?Math.round(e.y):Math.round(e.y-.5)+.5}}function s(e){return{x:e.x,y:e.y,width:e.width,height:e.height,angleDeg:e.angleDeg}}function o(e,t,i){var n,a;n=e-i.x,a=t-i.y;var s=r.BB.rotateAround({x:0,y:0},{x:n,y:a},-i.angleDeg);return{x:n=s.x,y:a=s.y}}function l(e,t,i){var n=r.BB.rotateAround({x:0,y:0},{x:e,y:t},i.angleDeg);return{x:n.x+i.x,y:n.y+i.y}}})),i.register("kEeSq",(function(t,n){e(t.exports,"FreeTransformCanvas",(function(){return h}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("i5nyl"),l=i("cNhNm"),h=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.imageWidth=t.imageWidth,this.imageHeight=t.imageHeight;var n=s.BB.fitInto(t.imageWidth,this.imageHeight,t.elementWidth-20,t.elementHeight-60,1);this.scale=n.width/t.imageWidth,this.rootEl=s.BB.el({className:"kl-preview-wrapper",css:{width:t.elementWidth+"px",height:t.elementHeight+"px"}}),this.rootEl.oncontextmenu=function(){return!1},this.layers=t.layers,this.transformIndex=t.transformIndex;var a=s.BB.el({className:"kl-preview-wrapper__canvas",css:{width:n.width+"px",height:n.height+"px"}});this.rootEl.append(a),this.previewLayerArr=this.layers.map((function(e){return{image:e.image,mixModeStr:e.mixModeStr,opacity:e.opacity}})),this.previewLayerArr[this.previewLayerArr.length-1].image=s.BB.canvas(this.scale>1?this.imageWidth:n.width,this.scale>1?this.imageHeight:n.height),this.klCanvasPreview=new(0,o.KlCanvasPreview)({width:n.width,height:n.height,layers:this.previewLayerArr}),a.append(this.klCanvasPreview.getElement());var h={width:this.layers[this.transformIndex].image.width*this.scale,height:this.layers[this.transformIndex].image.height*this.scale};(h.width>n.width||h.height>n.height)&&(h=s.BB.fitInto(this.layers[this.transformIndex].image.width,this.layers[this.transformIndex].image.height,n.width,n.height,1)),this.initTransform={x:this.imageWidth/2,y:this.imageHeight/2,width:this.layers[this.transformIndex].image.width,height:this.layers[this.transformIndex].image.height},this.freeTransform=new(0,l.FreeTransform)({x:this.initTransform.x,y:this.initTransform.y,width:this.initTransform.width,height:this.initTransform.height,angleDeg:0,isConstrained:!0,snapX:[0,this.imageWidth],snapY:[0,this.imageHeight],scale:this.scale,callback:function(e){i.updatePreview()}}),s.BB.css(this.freeTransform.getElement(),{position:"absolute",left:"0",top:"0"}),a.append(this.freeTransform.getElement()),setTimeout((function(){return i.updatePreview()}),0)}return(0,a.default)(e,[{key:"updatePreview",value:function(){if(this.freeTransform){var e=this.freeTransform.getTransform();this.scale<1&&(e.x*=this.scale,e.y*=this.scale,e.width*=this.scale,e.height*=this.scale);var t=this.previewLayerArr[this.transformIndex].image,i=s.BB.ctx(t);i.save(),i.clearRect(0,0,t.width,t.height),s.BB.drawTransformedImageWithBounds(i,this.layers[this.transformIndex].image,e,void 0,s.BB.testShouldPixelate(e,e.width/this.initTransform.width,e.height/this.initTransform.height)),i.restore(),this.klCanvasPreview.render()}}},{key:"move",value:function(e,t){this.freeTransform.move(e,t)}},{key:"reset",value:function(){var e=this.layers[this.transformIndex].image.width,t=this.layers[this.transformIndex].image.height;this.freeTransform.setSize(e,t),this.freeTransform.setPos({x:e/2,y:t/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}},{key:"setTransformFit",value:function(){var e=s.BB.fitInto(this.layers[this.transformIndex].image.width,this.layers[this.transformIndex].image.height,this.imageWidth,this.imageHeight,1);this.freeTransform.setSize(e.width,e.height),this.freeTransform.setPos({x:e.width/2,y:e.height/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}},{key:"setTransformCenter",value:function(){this.freeTransform.setPos({x:this.imageWidth/2,y:this.imageHeight/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}},{key:"getTransformation",value:function(){return!!this.freeTransform&&this.freeTransform.getTransform()}},{key:"getIsPixelated",value:function(){var e=this.freeTransform.getTransform();return s.BB.testShouldPixelate(e,e.width/this.initTransform.width,e.height/this.initTransform.height)}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.freeTransform.destroy(),this.klCanvasPreview.destroy()}}]),e}()})),i.register("32CBv",(function(t,n){e(t.exports,"Cropper",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.scale=t.scale,this.callback=t.callback;var n=t.maxW,a=t.maxW;this.rootEl=s.BB.el();var o=["nw","n","ne","e","se","s","sw","w"];this.keyListener=new s.BB.KeyListener({}),s.BB.css(this.rootEl,{position:"absolute",left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.outline={el:s.BB.el({css:{position:"absolute",border:"1px dashed #fff",cursor:"move"}}),update:function(){s.BB.css(i.outline.el,{left:i.grips[0].x*i.scale-1+"px",top:i.grips[0].y*i.scale-1+"px",width:(i.grips[2].x-i.grips[0].x)*i.scale+"px",height:(i.grips[2].y-i.grips[0].y)*i.scale+"px"})}},this.pointerRemainder={x:0,y:0},this.outlinePointerListener=new s.BB.PointerListener({target:this.outline.el,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;i.grips[0].x+=n,i.grips[0].y+=r,i.grips[1].x+=n,i.grips[1].y+=r,i.grips[2].x+=n,i.grips[2].y+=r,i.grips[3].x+=n,i.grips[3].y+=r,i.update()}"pointerup"===e.type&&i.commit()}}),this.thirdsHorizontal={el:s.BB.el({css:{position:"absolute",borderTop:"1px solid #0ff",borderBottom:"1px solid #0ff"}}),update:function(){s.BB.css(i.thirdsHorizontal.el,{left:i.grips[0].x*i.scale+"px",top:(i.grips[0].y+(i.grips[2].y-i.grips[0].y)/3)*i.scale+"px",width:(i.grips[2].x-i.grips[0].x)*i.scale+"px",height:(i.grips[2].y-i.grips[0].y)/3*i.scale+"px"})}},this.thirdsVertical={el:s.BB.el({css:{position:"absolute",borderLeft:"1px solid #0ff",borderRight:"1px solid #0ff"}}),update:function(){s.BB.css(i.thirdsVertical.el,{left:(i.grips[0].x+(i.grips[2].x-i.grips[0].x)/3)*i.scale+"px",top:i.grips[0].y*i.scale+"px",width:(i.grips[2].x-i.grips[0].x)/3*i.scale+"px",height:(i.grips[2].y-i.grips[0].y)*i.scale+"px"})}};var l=10;this.grips=[{x:0,y:0},{x:this.width,y:0},{x:this.width,y:this.height},{x:0,y:this.height}];var h=function(e){i.grips[0].y+=e,i.grips[0].y=s.BB.clamp(i.grips[0].y,i.grips[3].y-a,i.grips[3].y-1),i.grips[1].y=i.grips[0].y},c=function(e){i.grips[1].x+=e,i.grips[1].x=s.BB.clamp(i.grips[1].x,i.grips[0].x+1,i.grips[0].x+n),i.grips[2].x=i.grips[1].x},u=function(e){i.grips[2].y+=e,i.grips[2].y=s.BB.clamp(i.grips[2].y,i.grips[1].y+1,i.grips[1].y+a),i.grips[3].y=i.grips[2].y},p=function(e){i.grips[0].x+=e,i.grips[0].x=s.BB.clamp(i.grips[0].x,i.grips[1].x-n,i.grips[1].x-1),i.grips[3].x=i.grips[0].x};this.edges=[];for(var d=0;d<4;d++)!function(e){var t=s.BB.el({css:{width:"40px",height:"40px",position:"absolute"}});i.edges[e]={el:t,update:function(){0===e?s.BB.css(t,{left:i.grips[0].x*i.scale+l+"px",top:i.grips[0].y*i.scale-80+l+"px",width:(i.grips[1].x-i.grips[0].x)*i.scale-20+"px",height:"80px"}):1===e?s.BB.css(t,{left:i.grips[1].x*i.scale-l+"px",top:i.grips[1].y*i.scale+l+"px",width:"80px",height:(i.grips[2].y-i.grips[1].y)*i.scale-20+"px"}):2===e?s.BB.css(t,{left:i.grips[3].x*i.scale+l+"px",top:i.grips[3].y*i.scale-l+"px",width:(i.grips[2].x-i.grips[3].x)*i.scale-20+"px",height:"80px"}):3===e&&s.BB.css(t,{left:i.grips[0].x*i.scale-80+l+"px",top:i.grips[0].y*i.scale+l+"px",width:"80px",height:(i.grips[3].y-i.grips[0].y)*i.scale-20+"px"});var n=2*e+1;t.style.cursor=o[n]+"-resize"}}}(d);this.darken=[];for(var g=0;g<4;g++)!function(e){var t=s.BB.el({css:{position:"absolute",background:"#000",opacity:"0.5"}});i.darken[e]={el:t,update:function(){0===e?s.BB.css(t,{left:i.grips[0].x*i.scale+"px",top:i.grips[0].y*i.scale-8e3+"px",width:(i.grips[1].x-i.grips[0].x)*i.scale+"px",height:"8000px"}):1===e?s.BB.css(t,{left:i.grips[1].x*i.scale+"px",top:i.grips[1].y*i.scale-8e3+"px",width:"8000px",height:"16000px"}):2===e?s.BB.css(t,{left:i.grips[3].x*i.scale+"px",top:i.grips[3].y*i.scale+"px",width:(i.grips[2].x-i.grips[3].x)*i.scale+"px",height:"8000px"}):3===e&&s.BB.css(t,{left:i.grips[0].x*i.scale-8e3+"px",top:i.grips[0].y*i.scale-8e3+"px",width:"8000px",height:"16000px"})}}}(g);this.edge0PointerListener=new s.BB.PointerListener({target:this.edges[0].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale).dY;h(t),i.keyListener.isPressed("shift")&&u(-t),i.update()}"pointerup"===e.type&&i.commit()}}),this.edge1PointerListener=new s.BB.PointerListener({target:this.edges[1].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX;t.dY;c(n),i.keyListener.isPressed("shift")&&p(-n),i.update()}"pointerup"===e.type&&i.commit()}}),this.edge2PointerListener=new s.BB.PointerListener({target:this.edges[2].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=(t.dX,t.dY);u(n),i.keyListener.isPressed("shift")&&h(-n),i.update()}"pointerup"===e.type&&i.commit()}}),this.edge3PointerListener=new s.BB.PointerListener({target:this.edges[3].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX;t.dY;p(n),i.keyListener.isPressed("shift")&&c(-n),i.update()}"pointerup"===e.type&&i.commit()}}),this.cornerElArr=[],function(){for(var e=0;e<4;e++)!function(e){var t=s.BB.el({css:{width:"80px",height:"80px",position:"absolute",cursor:["nwse-resize","nesw-resize"][e%2]}});i.cornerElArr[e]={el:t,update:function(){0===e?s.BB.css(t,{left:i.grips[0].x*i.scale-80+l+"px",top:i.grips[0].y*i.scale-80+l+"px"}):1===e?s.BB.css(t,{left:i.grips[1].x*i.scale-l+"px",top:i.grips[1].y*i.scale-80+l+"px"}):2===e?s.BB.css(t,{left:i.grips[1].x*i.scale-l+"px",top:i.grips[2].y*i.scale-l+"px"}):3===e&&s.BB.css(t,{left:i.grips[0].x*i.scale-80+l+"px",top:i.grips[2].y*i.scale-l+"px"})}}}(e)}(),this.corner0PointerListener=new s.BB.PointerListener({target:this.cornerElArr[0].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;p(n),h(r),i.keyListener.isPressed("shift")&&(c(-n),u(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.corner1PointerListener=new s.BB.PointerListener({target:this.cornerElArr[1].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;c(n),h(r),i.keyListener.isPressed("shift")&&(p(-n),u(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.corner2PointerListener=new s.BB.PointerListener({target:this.cornerElArr[2].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;c(n),u(r),i.keyListener.isPressed("shift")&&(p(-n),h(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.corner3PointerListener=new s.BB.PointerListener({target:this.cornerElArr[3].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=s.BB.intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;p(n),u(r),i.keyListener.isPressed("shift")&&(c(-n),h(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.rootEl.append(this.darken[1].el,this.darken[0].el,this.darken[2].el,this.darken[3].el,this.thirdsHorizontal.el,this.thirdsVertical.el,this.outline.el,this.edges[1].el,this.edges[0].el,this.edges[2].el,this.edges[3].el,this.cornerElArr[0].el,this.cornerElArr[1].el,this.cornerElArr[2].el,this.cornerElArr[3].el),this.update()}return(0,a.default)(e,[{key:"update",value:function(){this.edges[0].update(),this.edges[1].update(),this.edges[2].update(),this.edges[3].update(),this.cornerElArr[0].update(),this.cornerElArr[1].update(),this.cornerElArr[2].update(),this.cornerElArr[3].update(),this.darken[0].update(),this.darken[1].update(),this.darken[2].update(),this.darken[3].update(),this.outline.update(),this.thirdsHorizontal.update(),this.thirdsVertical.update()}},{key:"commit",value:function(){this.pointerRemainder.x=0,this.pointerRemainder.y=0,this.callback(this.getTransform())}},{key:"getTransform",value:function(){return this.grips[1].x-=this.grips[0].x,this.grips[1].y-=this.grips[0].y,this.grips[2].x-=this.grips[0].x,this.grips[2].y-=this.grips[0].y,this.grips[3].x-=this.grips[0].x,this.grips[3].y-=this.grips[0].y,this.x+=this.grips[0].x,this.y+=this.grips[0].y,this.grips[0].x=0,this.grips[0].y=0,{x:this.x,y:this.y,width:this.grips[1].x,height:this.grips[2].y}}},{key:"setTransform",value:function(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,s.BB.css(this.rootEl,{left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.grips[0].x=0,this.grips[0].y=0,this.grips[1].x=this.width,this.grips[1].y=0,this.grips[2].x=this.width,this.grips[2].y=this.height,this.grips[3].x=0,this.grips[3].y=this.height,this.update(),this.commit()}},{key:"setScale",value:function(e){this.scale=e,s.BB.css(this.rootEl,{left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.update()}},{key:"showThirds",value:function(e){this.thirdsHorizontal.el.style.display=e?"block":"none",this.thirdsVertical.el.style.display=e?"block":"none"}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.keyListener.destroy(),this.outlinePointerListener.destroy(),this.corner0PointerListener.destroy(),this.corner1PointerListener.destroy(),this.corner2PointerListener.destroy(),this.corner3PointerListener.destroy(),this.edge0PointerListener.destroy(),this.edge1PointerListener.destroy(),this.edge2PointerListener.destroy(),this.edge3PointerListener.destroy()}}]),e}()})),i.register("kqmpc",(function(t,n){e(t.exports,"LayerPreview",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("gWfkn"),l=i("1mH1z"),h=i("1C8RU"),c=function(){"use strict";function e(t){var i,n=this;(0,r.default)(this,e),this.rootEl=s.BB.el({className:"kl-layer-preview"}),this.isVisible=!0,this.height=40,this.canvasSize=this.height-10,this.largeCanvasSize=300,this.lastDrawnState=-2,this.lastDrawnSize={width:0,height:0},this.animationCanvas=s.BB.canvas(),this.animationCanvasCtx=s.BB.ctx(this.animationCanvas),this.animationLength=30,this.animationCount=0,this.largeCanvasIsVisible=!1;this.uiState=t.uiState,this.contentWrapperEl=s.BB.el({css:{display:"flex",alignItems:"center",height:this.height+"px"}});var a=s.BB.el({css:{minWidth:this.height+"px",height:this.height+"px",display:"flex",justifyContent:"center",alignItems:"center"}});this.canvas=s.BB.canvas(this.canvasSize,this.canvasSize),this.canvasCtx=s.BB.ctx(this.canvas),this.canvas.title=(0,l.LANG)("layers-active-layer");var c=s.BB.el({css:{flexGrow:"1",paddingLeft:"10px",fontSize:"13px",overflow:"hidden",position:"relative"}});this.nameLabelEl=s.BB.el({content:"",css:{cssFloat:"left",whiteSpace:"nowrap"}});var u=s.BB.el({css:{position:"absolute",left:"10px",top:"0",width:"90px",height:"100%"}});t.onClick&&(u.addEventListener("click",(function(){t.onClick()})),this.canvas.addEventListener("click",(function(){t.onClick()}))),this.opacityEl=s.BB.el({content:(0,l.LANG)("opacity")+"<br>100%",css:{minWidth:"60px",fontSize:"12px",textAlign:"center"}}),this.largeCanvasWrapper=s.BB.el({onClick:s.BB.handleClick,css:{pointerEvents:"none",background:"#fff",position:"absolute",right:"280px",top:"10px",border:"1px solid #aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",transition:"opacity 300ms ease-in-out",userSelect:"none",display:"block",webkitTouchCallout:"none"}}),this.largeCanvas=s.BB.canvas(this.largeCanvasSize,this.largeCanvasSize),this.largeCanvasWrapper.append(this.largeCanvas),this.largeCanvasCtx=s.BB.ctx(this.largeCanvas),s.BB.css(this.largeCanvas,{display:"block"}),a.append(this.canvas),c.append(this.nameLabelEl,u),this.contentWrapperEl.append(a,c,this.opacityEl),this.rootEl.append(this.contentWrapperEl),this.updateCheckerPatterns(),h.theme.addIsDarkListener((function(){n.updateCheckerPatterns(),n.draw(!0)})),setInterval((function(){n.layerObj&&(o.klHistory.getState()!==n.lastDrawnState&&(n.layerObj.opacity=n.layerObj.context.canvas.opacity,n.draw(!1)))}),2e3);var p=function(){try{t.klRootEl.removeChild(n.largeCanvasWrapper)}catch(e){}};new s.BB.PointerListener({target:this.canvas,onEnterLeave:function(e){!function(e){n.largeCanvasIsVisible!==e&&(clearTimeout(i),n.largeCanvasIsVisible=e,e?i=setTimeout((function(){n.drawLargeCanvas(),n.largeCanvasWrapper.style.opacity="0",t.klRootEl.append(n.largeCanvasWrapper),setTimeout((function(){n.largeCanvasWrapper.style.opacity="1"}),20)}),250):(n.largeCanvasWrapper.style.opacity="0",i=setTimeout(p,320)))}(e)}})}return(0,a.default)(e,[{key:"updateCheckerPatterns",value:function(){var e=s.BB.createCheckerCanvas(4,h.theme.isDark());this.animationCanvasCheckerPattern=this.animationCanvasCtx.createPattern(e,"repeat"),this.largeCanvasCheckerPattern=this.canvasCtx.createPattern(e,"repeat")}},{key:"animate",value:function(){var e=this;0!==this.animationCount&&(this.animationCount--,this.canvasCtx.save(),this.canvasCtx.globalAlpha=Math.pow((this.animationLength-this.animationCount)/this.animationLength,2),this.canvasCtx.drawImage(this.animationCanvas,0,0),this.canvasCtx.restore(),this.animationCount>0&&requestAnimationFrame((function(){return e.animate()})))}},{key:"drawLargeCanvas",value:function(){if(this.largeCanvasIsVisible&&this.layerObj){var e=this.layerObj.context.canvas,t=s.BB.fitInto(e.width,e.height,this.largeCanvasSize,this.largeCanvasSize,1);this.largeCanvas.width=Math.round(t.width),this.largeCanvas.height=Math.round(t.height),this.largeCanvasCtx.save(),this.largeCanvas.width>e.width?this.largeCanvasCtx.imageSmoothingEnabled=!1:(this.largeCanvasCtx.imageSmoothingEnabled=!0,this.largeCanvasCtx.imageSmoothingQuality="high"),this.largeCanvasCtx.fillStyle=this.largeCanvasCheckerPattern,this.largeCanvasCtx.fillRect(0,0,this.largeCanvas.width,this.largeCanvas.height),this.largeCanvasCtx.drawImage(e,0,0,this.largeCanvas.width,this.largeCanvas.height),this.largeCanvasCtx.restore();var i=this.rootEl.getBoundingClientRect();s.BB.css(this.largeCanvasWrapper,{top:Math.max(10,i.top+this.height/2-this.largeCanvas.height/2)+"px"})}}},{key:"draw",value:function(e){if(this.isVisible){this.nameLabelEl.textContent=this.layerObj.name,this.opacityEl.innerHTML=(0,l.LANG)("opacity")+"<br>"+Math.round(100*this.layerObj.opacity)+"%";var t=this.layerObj.context.canvas;if(t.width!==this.lastDrawnSize.width||t.height!==this.lastDrawnSize.height){var i=s.BB.fitInto(t.width,t.height,this.canvasSize,this.canvasSize,1);this.canvas.width=Math.round(i.width),this.canvas.height=Math.round(i.height),e=!0}this.animationCanvas.width=this.canvas.width,this.animationCanvas.height=this.canvas.height,this.animationCanvasCtx.save(),this.animationCanvasCtx.imageSmoothingEnabled=!1,this.animationCanvasCtx.fillStyle=this.animationCanvasCheckerPattern,this.animationCanvasCtx.fillRect(0,0,this.animationCanvas.width,this.animationCanvas.height),this.animationCanvasCtx.drawImage(t,0,0,this.animationCanvas.width,this.animationCanvas.height),this.animationCanvasCtx.restore(),e?(this.animationCount=0,this.canvasCtx.save(),this.canvasCtx.drawImage(this.animationCanvas,0,0),this.canvasCtx.restore()):(this.animationCount=this.animationLength,this.animate()),this.drawLargeCanvas(),this.lastDrawnState=o.klHistory.getState(),this.lastDrawnSize.width=t.width,this.lastDrawnSize.height=t.height}}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){if(this.isVisible!==e){this.isVisible=e,this.contentWrapperEl.style.display=this.isVisible?"flex":"none",this.rootEl.style.marginBottom=this.isVisible?"":"10px";var t=o.klHistory.getState();e&&this.lastDrawnState!==t&&this.draw(!0)}}},{key:"setLayer",value:function(e){this.layerObj=e,this.draw(!0)}},{key:"setUiState",value:function(e){this.uiState=e,"left"===this.uiState?s.BB.css(this.largeCanvasWrapper,{left:"280px",right:""}):s.BB.css(this.largeCanvasWrapper,{left:"",right:"280px"})}}]),e}()})),i.register("8ebuX",(function(t,n){e(t.exports,"showImportAsLayerDialog",(function(){return l}));var r=i("eWjiX"),a=i("kEeSq"),s=i("2MaaK"),o=i("1mH1z");function l(e){var t=function(e,t){v.move(e,t)},i=document.createElement("div");if(r.BB.appendTextDiv(i,(0,o.LANG)("import-as-layer-description")),e.klCanvas.isLayerLimitReached()){var n=r.BB.el({content:(0,o.LANG)("import-as-layer-limit-reached"),css:{background:"#ff0",padding:"10px",marginTop:"5px",marginBottom:"5px",border:"1px solid #e7d321",borderRadius:"5px"}});i.append(n)}var l=window.innerWidth<550,h=r.BB.el({css:{display:"flex"}}),c=r.BB.el({tagName:"button",content:"1:1",css:{marginRight:"10px"},onClick:function(){v.reset()}}),u=r.BB.el({tagName:"button",content:(0,o.LANG)("import-as-layer-fit"),css:{marginRight:"10px"},onClick:function(){v.setTransformFit()}}),p=r.BB.el({tagName:"button",content:(0,o.LANG)("center"),css:{marginRight:"10px"},onClick:function(){v.setTransformCenter()}});h.append(c,u,p),i.append(h);for(var d=[],g=e.klCanvas.getLayers(),f=0;f<g.length;f++)d.push({image:g[f].context.canvas,opacity:g[f].opacity,mixModeStr:g[f].mixModeStr});d.push({image:e.importImage,opacity:1,mixModeStr:"source-over"});var v=new(0,a.FreeTransformCanvas)({elementWidth:l?340:540,elementHeight:l?280:350,imageWidth:e.klCanvas.getLayerContext(0).canvas.width,imageHeight:e.klCanvas.getLayerContext(0).canvas.height,layers:d,transformIndex:d.length-1});r.BB.css(v.getElement(),{marginTop:"10px",marginLeft:"-20px"}),i.append(v.getElement());var m=new r.BB.KeyListener({onDown:function(e){"left"===e&&t(-1,0),"right"===e&&t(1,0),"up"===e&&t(0,-1),"down"===e&&t(0,1)}});(0,s.showModal)({target:e.target,message:"<b>".concat((0,o.LANG)("import-as-layer-title"),"</b>"),div:i,style:l?void 0:{width:"500px"},buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(t){m.destroy(),v.destroy(),r.BB.destroyEl(c),r.BB.destroyEl(u),r.BB.destroyEl(p),"Ok"===t?e.callback(v.getTransformation(),v.getIsPixelated()):e.callback()}})}})),i.register("13r5y",(function(t,n){e(t.exports,"KlImageDropper",(function(){return s}));var r=i("gFgFC"),a=i("eWjiX"),s=function e(t){"use strict";var i=this;(0,r.default)(this,e),this.rootEl=a.BB.el({content:"Drop to import",css:{paddingTop:"100px",position:"fixed",left:"0",top:"0",width:"100%",height:"100%",background:"rgba(50, 50, 50, 0.7)",color:"#fff",textShadow:"2px 2px #000",textAlign:"center",fontSize:"25px"}});var n=a.BB.el({css:{marginTop:"50px",display:"flex",justifyContent:"center"}}),s={width:"200px",padding:"50px",margin:"10px",borderRadius:"20px",border:"1px dashed #fff",background:"#00aefe",fontWeight:"bold"},o=a.BB.el({content:"As Layer",css:s}),l=a.BB.el({content:"As New Image",css:s});this.rootEl.append(n),n.append(o,l);var h=0,c=0,u=0,p=function(){h=0,c=0,u=0;try{t.target.removeChild(i.rootEl)}catch(e){}},d=function(e){return!!e.dataTransfer&&!e.dataTransfer.types.includes("text/plain")},g=function(){var e="0 0 20px 4px #fff";c>0?(o.style.boxShadow=e,l.style.boxShadow=""):u>0?(o.style.boxShadow="",l.style.boxShadow=e):(o.style.boxShadow="",l.style.boxShadow="")};o.addEventListener("dragenter",(function(){c++,g()})),o.addEventListener("dragleave",(function(){c--,g()})),l.addEventListener("dragenter",(function(){u++,g()})),l.addEventListener("dragleave",(function(){u--,g()}));window.addEventListener("dragover",(function(e){d(e)&&(e.stopPropagation(),e.preventDefault())}),!1),window.addEventListener("dragenter",(function(e){t.enabledTest()&&d(e)&&(0===h&&t.target.append(i.rootEl),h++)}),!1),window.addEventListener("dragleave",(function(e){d(e)&&0!==h&&0===(h=Math.max(0,h-1))&&t.target.removeChild(i.rootEl)}),!1),window.addEventListener("drop",(function(e){if(d(e)&&e.dataTransfer&&0!==e.dataTransfer.files.length){e.stopPropagation(),e.preventDefault();var n="default";c>0?n="layer":u>0&&(n="image"),t.onDrop(e.dataTransfer.files,n),h>0&&t.target.removeChild(i.rootEl),h=0,c=0,u=0,g()}else p()}),!1),this.rootEl.addEventListener("pointerdown",(function(){p()}));new a.BB.KeyListener({onDown:function(e){h>0&&"esc"===e&&p()}})}})),i.register("9p4Zp",(function(t,n){e(t.exports,"OverlayToolspace",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("gmji4"),l=i("aP0jf"),h=i("1mH1z"),c=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e);var n=150,a=90,c=20,u=25,p=!1;this.rootEl=s.BB.el({className:"kl-overlay-toolspace"});var d={color:null,size:null,opacity:null},g=s.BB.el({parent:this.rootEl,className:"kl-overlay-toolspace__color"}),f=new(0,o.KlColorSliderSmall)({width:n,heightSV:a,heightH:c,color:t.brushSettingService.getColor(),callback:function(e){v.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")",t.brushSettingService.setColor(e,b)}}),v=s.BB.el({css:{width:n+"px",height:c+"px",pointerEvents:"none"}}),m=t.brushSettingService.getColor();v.style.backgroundColor="rgb("+m.r+","+m.g+","+m.b+")",g.append(v,f.getElement());var y=function(e){f.setColor(e),v.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")"},x=new(0,l.KlSlider)({label:(0,h.LANG)("brush-size"),width:n,height:u,min:0,max:500,value:50,resolution:225,eventResMs:1e3/30,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(e){t.brushSettingService.setSize(e)},formatFunc:function(e){return e<10?s.BB.round(e,1):Math.round(e)}});s.BB.css(x.getElement(),{marginTop:"2px"});var B=new(0,l.KlSlider)({label:(0,h.LANG)("opacity"),width:n,height:u,min:0,max:1,value:1,resolution:225,eventResMs:1e3/30,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(e){t.brushSettingService.setOpacity(e)}});s.BB.css(B.getElement(),{margin:"2px 0"}),this.rootEl.append(x.getElement(),B.getElement());var b=function(e){"color"===e.type&&(p?y(e.value):d.color=e.value),"size"===e.type&&(p?x.setValue(e.value):d.size=e.value),"opacity"===e.type&&(p?B.setValue(e.value):d.opacity=e.value),"sliderConfig"===e.type&&(x.update(e.value.sizeSlider),B.update(e.value.opacitySlider))};t.brushSettingService.subscribe(b);var w=t.brushSettingService.getSliderConfig();x.update(w.sizeSlider),B.update(w.opacitySlider),x.setValue(t.brushSettingService.getSize()),B.setValue(t.brushSettingService.getOpacity());var k=function(){s.BB.unfocusAnyInput(),i.rootEl.style.display=p?"block":"none",p&&C&&s.BB.css(i.rootEl,{left:C.x-Math.round(n/2)+"px",top:C.y-Math.round(a+3*c/2)+"px"})},C=null;document.addEventListener("pointermove",(function(e){C={x:e.pageX,y:e.pageY}}));new s.BB.KeyListener({onDown:function(e,i,n,r){if(!r)return p?(p=!1,void k()):void(t.enabledTest()&&C&&["ctrl+alt","cmd+alt","alt+ctrl","alt+cmd"].includes(n)&&(i.preventDefault(),p=!0,null!==d.color&&(y(d.color),d.color=null),null!==d.size&&(x.setValue(d.size),d.size=null),null!==d.opacity&&(B.setValue(d.opacity),d.opacity=null),k()))},onUp:function(e,t,i){["ctrl+alt","cmd+alt","alt+ctrl","alt+cmd"].includes(i)&&p&&(p=!1,f.end(),k())},onBlur:function(){p&&(p=!1,f.end(),k())}})}return(0,a.default)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}()})),i.register("8jqzp",(function(n,r){e(n.exports,"ToolspaceTopRow",(function(){return f}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("eWjiX"),l=i("kX3t5"),h=i("frUlg"),c=i("7qUeg"),u=i("g2tQ8"),p=i("cmBTx"),d=i("8pc1M"),g=i("1mH1z"),f=function(){"use strict";function e(i){(0,a.default)(this,e);var n=function(e){var t=6+(e.extraPadding?e.extraPadding:0),i=o.BB.el({className:"toolspace-row-button nohighlight",title:e.title,onClick:e.onClick,css:{padding:e.contain?t+"px 0":""}}),n=o.BB.el({className:e.darkInvert?"dark-invert":void 0,css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%"}});n.style.pointerEvents="none",i.append(n);var r=new o.BB.PointerListener({target:i,onEnterLeave:function(e){i.classList.toggle("toolspace-row-button-hover",e)}});return{el:i,pointerListener:r}};this.rootEl=o.BB.el({className:"kl-toolspace-row",css:{height:"36px",display:"flex"}});var r=n({onClick:i.onLogo,title:(0,g.LANG)("home"),image:i.logoImg?i.logoImg:t(l),contain:!0,darkInvert:!0});r.el.classList.add("kl-tool-row-border-right"),o.BB.css(r.el,{width:"45px"});var s=n({onClick:i.onNew,title:(0,g.LANG)("file-new"),image:t(h),extraPadding:1,contain:!0}),f=n({onClick:i.onImport,title:(0,g.LANG)("file-import"),image:t(c),extraPadding:1,contain:!0}),v=n({onClick:i.onSave,title:(0,g.LANG)("file-save"),image:t(u),extraPadding:1,contain:!0}),m=null;o.BB.canShareFiles()&&(m=n({onClick:i.onShare,title:(0,g.LANG)("file-share"),image:t(p),contain:!0,darkInvert:!0}));var y=n({onClick:i.onHelp,title:(0,g.LANG)("help"),image:t(d),contain:!0,darkInvert:!0});o.BB.append(this.rootEl,[r.el,s.el,f.el,v.el,m?m.el:void 0,y.el])}return(0,s.default)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}()})),i.register("kX3t5",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("6Sfz2")})),i.register("frUlg",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("eaJmh")})),i.register("7qUeg",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("kV8IH")})),i.register("g2tQ8",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("SROeX")})),i.register("cmBTx",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("lFrok")})),i.register("8pc1M",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("cvYlU")})),i.register("84zxV",(function(n,r){e(n.exports,"ToolDropdown",(function(){return m}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("7U0Ew"),l=i("eWjiX"),h=i("i8UFO"),c=i("8dsYZ"),u=i("6iPxE"),p=i("fZtJh"),d=i("eOZOu"),g=i("haxur"),f=i("32WFC"),v=i("1mH1z"),m=function(){"use strict";function e(i){var n=this;(0,a.default)(this,e),(0,o.default)(this,"smallMargin","6px 0"),(0,o.default)(this,"optionArr",["draw","fill","gradient","text","shape"]),this.imArr=[t(c),t(u),t(p),t(d),t(g)],this.titleArr=["".concat((0,v.LANG)("tool-brush")," [B]"),"".concat((0,v.LANG)("tool-paint-bucket")," [G]"),"".concat((0,v.LANG)("tool-gradient")," [G]"),"".concat((0,v.LANG)("tool-text")," [T]"),"".concat((0,v.LANG)("tool-shape")," [U]")],this.currentActiveIndex=0,this.isActive=!0;var r,s=!1;setTimeout((function(){for(var e=1;e<n.imArr.length;e++){(new Image).src=n.imArr[e]}}),100),this.rootEl=l.BB.el({css:{position:"relative",flexGrow:"1"}});var m,y,x=!1;l.BB.hasPointerEvents&&new l.BB.PointerListener({target:this.rootEl,onPointer:function(e){if("pointerdown"===e.type){if(s)return;r=setTimeout((function(){S()}),400),x=!0,m=e.pageX,y=e.pageY}else if("pointermove"===e.type)x&&!s&&l.BB.dist(m,y,e.pageX,e.pageY)>5&&(clearTimeout(r),S());else if("pointerup"===e.type){if(clearTimeout(r),s&&x)for(var t=document.elementFromPoint(e.pageX,e.pageY),a=0;a<n.dropdownBtnArr.length;a++)if(t===n.dropdownBtnArr[a].wrapper){L(),n.isActive=!0,n.currentActiveIndex=a,n.updateButton(),i.onChange(n.optionArr[n.currentActiveIndex]);break}x=!1}}}),this.activeButton=l.BB.el({parent:this.rootEl,className:"toolspace-row-button nohighlight toolspace-row-button-activated",title:this.titleArr[this.currentActiveIndex],onClick:function(e){if(n.isActive&&!s)return e.preventDefault(),e.stopPropagation(),void S();n.isActive=!0,i.onChange(n.optionArr[n.currentActiveIndex]),s&&L()},css:{padding:"10px 0",pointerEvents:"auto",height:"100%",boxSizing:"border-box"}}),this.activeButtonIm=l.BB.el({parent:this.activeButton,className:"dark-invert",css:{backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",width:"calc(100% - 7px)",height:"100%",pointerEvents:"none",opacity:"0.75"}}),this.arrowButton=l.BB.el({parent:this.activeButton,className:"dark-invert",css:{position:"absolute",right:"1px",bottom:"1px",width:"18px",height:"18px",cursor:"pointer",backgroundImage:"url('"+t(f)+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"60%"},title:"More Tools",onClick:function(e){e.preventDefault(),e.stopPropagation(),S()}});var B=l.BB.el({css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"}}),b=(new l.BB.PointerListener({target:B,onPointer:function(e){"pointerdown"===e.type&&(e.eventPreventDefault(),L())}}),l.BB.el({className:"tool-dropdown-wrapper",css:{position:"absolute",width:"100%",height:100*(this.optionArr.length-1)+"%",top:"100%",left:"0",zIndex:"1",boxSizing:"border-box",cursor:"pointer",transition:"height 0.1s ease-in-out, opacity 0.1s ease-in-out",borderBottomLeftRadius:"5px",borderBottomRightRadius:"5px",overflow:"hidden"}}));this.dropdownBtnArr=[];for(var w=function(e){var t=l.BB.el({parent:b,className:"tool-dropdown-button",title:e.title,css:{padding:"10px 0",height:100/(n.optionArr.length-1)+"%",boxSizing:"border-box"},onClick:function(t){t.preventDefault(),t.stopPropagation(),e.onClick(e.index)}});l.BB.el({parent:t,className:"dark-invert",css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",height:"100%",pointerEvents:"none",opacity:"0.75"}});return{wrapper:t,show:function(e){t.style.display=e?"block":"none"},setIsSmall:function(e){t.style.padding=e?n.smallMargin:"10px 0"}}},k=function(e){L(),n.isActive=!0,n.currentActiveIndex=e,n.updateButton(),i.onChange(n.optionArr[n.currentActiveIndex])},C=0;C<this.optionArr.length;C++)this.dropdownBtnArr.push(w({index:C,id:this.optionArr[C],image:this.imArr[C],title:this.titleArr[C],onClick:k}));var S=function(){h.dialogCounter.increase(.5),s=!0;for(var e=0;e<n.optionArr.length;e++)n.dropdownBtnArr[e].show(n.currentActiveIndex!==e);n.arrowButton.style.display="none",n.rootEl.style.zIndex="1",document.body.append(B),n.rootEl.append(b)},L=function(){h.dialogCounter.decrease(.5),s=!1,n.arrowButton.style.removeProperty("display"),n.rootEl.style.removeProperty("z-index"),document.body.removeChild(B),n.rootEl.removeChild(b)};this.updateButton()}return(0,s.default)(e,[{key:"updateButton",value:function(){this.activeButton.title=this.titleArr[this.currentActiveIndex],this.activeButtonIm.style.backgroundImage="url('"+this.imArr[this.currentActiveIndex]+"')"}},{key:"setIsSmall",value:function(e){this.activeButton.style.padding=e?this.smallMargin:"10px 0";for(var t=0;t<this.optionArr.length;t++)this.dropdownBtnArr[t].setIsSmall(e);e?(this.arrowButton.style.width="14px",this.arrowButton.style.height="14px"):(this.arrowButton.style.width="18px",this.arrowButton.style.height="18px")}},{key:"setActive",value:function(e){if(this.optionArr.includes(e)){this.isActive=!0;for(var t=0;t<this.optionArr.length;t++)if(this.optionArr[t]===e){this.currentActiveIndex=t;break}this.activeButton.classList.add("toolspace-row-button-activated"),this.updateButton()}else this.isActive=!1,this.activeButton.classList.remove("toolspace-row-button-activated")}},{key:"getActive",value:function(){return this.optionArr[this.currentActiveIndex]}},{key:"getElement",value:function(){return this.rootEl}}]),e}()})),i.register("8dsYZ",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("dW3eU")})),i.register("6iPxE",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("fnumN")})),i.register("fZtJh",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("6J8A8")})),i.register("eOZOu",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("da34V")})),i.register("haxur",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("eStsa")})),i.register("32WFC",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("eW5wL")})),i.register("9Kxky",(function(n,r){e(n.exports,"ToolspaceToolRow",(function(){return g}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("eWjiX"),l=i("84zxV"),h=i("4sBxW"),c=i("fORLP"),u=i("kRxRZ"),p=i("5ZTVn"),d=i("1mH1z"),g=function(){"use strict";function e(i){var n=this;(0,a.default)(this,e),this.rootEl=o.BB.el({className:"kl-toolspace-row",css:{height:"54px",display:"flex"}}),this.onActivate=i.onActivate,this.currentActiveStr="draw";var r=function(e){var t=e.doLighten?"6px 0":"8px 0",i=o.BB.el({className:"toolspace-row-button nohighlight",onClick:e.onClick,css:{padding:e.contain?"10px 0":""}}),n=o.BB.el({className:"dark-invert",css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%",transform:e.doMirror?"scale(-1, 1)":"",pointerEvents:"none",opacity:e.doLighten?"0.75":"1"}});i.append(n);var r=new o.BB.PointerListener({target:i,onEnterLeave:function(e){i.classList.toggle("toolspace-row-button-hover",e)}});return{el:i,pointerListener:r,setIsSmall:function(n){i.style.padding=e.contain?n?t:"10px 0":""}}},s=function(e){var t=o.BB.el({css:{flexGrow:"1",position:"relative"}}),i=o.BB.createSvg({elementType:"svg",width:"67px",height:"54px",viewBox:"0 0 100 100",preserveAspectRatio:"none"});o.BB.css(i,{position:"absolute",left:"0",top:"0"});var n=o.BB.createSvg({elementType:"defs",childrenArr:[{elementType:"filter",id:"innershadow",x0:"-50%",y0:"-50%",width:"200%",height:"200%",childrenArr:[{elementType:"feGaussianBlur",in:"SourceAlpha",stdDeviation:"10",result:"blur"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"SourceAlpha",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"SourceGraphic",operator:"over",result:"firstfilter"},{elementType:"feGaussianBlur",in:"firstfilter",stdDeviation:"10",result:"blur2"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"firstfilter",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"firstfilter",operator:"over"}]}]}),r=o.BB.createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M0,0 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});r.onclick=function(){e.onLeft(),r.classList.remove("toolspace-svg-triangle-button-hover")};var a=o.BB.createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M100,100 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});a.onclick=function(){e.onRight(),a.classList.remove("toolspace-svg-triangle-button-hover")};var s=new o.BB.PointerListener({target:r,onEnterLeave:function(e){r.classList.toggle("toolspace-svg-triangle-button-hover",e)}}),l=new o.BB.PointerListener({target:a,onEnterLeave:function(e){a.classList.toggle("toolspace-svg-triangle-button-hover",e)}});i.append(n,r,a),t.append(i);var h=o.BB.el({parent:t,className:"dark-invert",css:{backgroundImage:"url('"+e.leftImage+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",left:"10px",top:"8px",pointerEvents:"none"}});t.append(h);var c=o.BB.el({parent:t,className:"dark-invert",css:{backgroundImage:"url('"+(e.rightImage?e.rightImage:e.leftImage)+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",right:"10px",bottom:"8px",transform:e.rightImage?"":"scale(-1, 1)",pointerEvents:"none"}});return{el:t,setIsEnabledLeft:function(e){r.classList.toggle("toolspace-row-button-disabled",!e),h.classList.toggle("toolspace-row-button-disabled",!e)},setIsEnabledRight:function(e){a.classList.toggle("toolspace-row-button-disabled",!e),c.classList.toggle("toolspace-row-button-disabled",!e)},leftPointerListener:s,rightPointerListener:l}};this.toolDropdown=new(0,l.ToolDropdown)({onChange:function(e){n.setActive(e,!0)}}),this.rootEl.append(this.toolDropdown.getElement()),this.handButton=r({onClick:function(){n.setActive("hand",!0)},image:t(h),contain:!0,doLighten:!0}),this.handButton.el.classList.add("kl-tool-row-border-right"),this.handButton.el.title=(0,d.LANG)("tool-hand"),this.rootEl.append(this.handButton.el),this.zoomInNOutButton=s({onLeft:i.onZoomIn,onRight:i.onZoomOut,leftImage:t(c),rightImage:t(u)}),this.zoomInNOutButton.el.title=(0,d.LANG)("tool-zoom"),this.rootEl.append(this.zoomInNOutButton.el),this.zoomInButton=r({onClick:i.onZoomIn,image:t(c),contain:!0}),this.zoomInButton.el.title=(0,d.LANG)("zoom-in"),this.rootEl.append(this.zoomInButton.el),this.zoomOutButton=r({onClick:i.onZoomOut,image:t(u),contain:!0}),this.zoomOutButton.el.title=(0,d.LANG)("zoom-out"),this.rootEl.append(this.zoomOutButton.el),this.undoNRedoButton=s({onLeft:i.onUndo,onRight:i.onRedo,leftImage:t(p),rightImage:null}),this.undoNRedoButton.el.title=(0,d.LANG)("undo")+"/"+(0,d.LANG)("redo"),this.undoNRedoButton.setIsEnabledLeft(!1),this.undoNRedoButton.setIsEnabledRight(!1),this.rootEl.append(this.undoNRedoButton.el),this.undoButton=r({onClick:i.onUndo,image:t(p),contain:!0}),this.undoButton.el.title=(0,d.LANG)("undo"),this.undoButton.el.classList.add("toolspace-row-button-disabled"),this.rootEl.append(this.undoButton.el),this.redoButton=r({onClick:i.onRedo,image:t(p),contain:!0,doMirror:!0}),this.redoButton.el.title=(0,d.LANG)("redo"),this.redoButton.el.classList.add("toolspace-row-button-disabled"),this.rootEl.append(this.redoButton.el),this.zoomInButton.el.style.display="none",this.zoomOutButton.el.style.display="none",this.undoButton.el.style.display="none",this.redoButton.el.style.display="none"}return(0,s.default)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsSmall",value:function(e){o.BB.css(this.rootEl,{height:e?"36px":"54px"}),this.toolDropdown.setIsSmall(e),this.handButton.setIsSmall(e),this.zoomInButton.setIsSmall(e),this.zoomOutButton.setIsSmall(e),this.undoButton.setIsSmall(e),this.redoButton.setIsSmall(e),e?(this.zoomInNOutButton.el.style.display="none",this.undoNRedoButton.el.style.display="none",this.zoomInButton.el.style.display="block",this.zoomOutButton.el.style.display="block",this.undoButton.el.style.display="block",this.redoButton.el.style.display="block"):(this.zoomInNOutButton.el.style.display="block",this.undoNRedoButton.el.style.display="block",this.zoomInButton.el.style.display="none",this.zoomOutButton.el.style.display="none",this.undoButton.el.style.display="none",this.redoButton.el.style.display="none")}},{key:"setEnableZoomIn",value:function(e){this.zoomInButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.zoomInNOutButton.setIsEnabledLeft(e)}},{key:"setEnableZoomOut",value:function(e){this.zoomOutButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.zoomInNOutButton.setIsEnabledRight(e)}},{key:"setEnableUndo",value:function(e){this.undoButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.undoNRedoButton.setIsEnabledLeft(e)}},{key:"setEnableRedo",value:function(e){this.redoButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.undoNRedoButton.setIsEnabledRight(e)}},{key:"setActive",value:function(e,t){this.currentActiveStr!==e&&(this.currentActiveStr=e,this.toolDropdown.setActive(this.currentActiveStr),this.handButton.el.classList.toggle("toolspace-row-button-activated","hand"===this.currentActiveStr),t&&this.onActivate(this.currentActiveStr))}},{key:"getActive",value:function(){return this.currentActiveStr}}]),e}()})),i.register("4sBxW",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("b30IN")})),i.register("fORLP",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("jYhj7")})),i.register("kRxRZ",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("44EC1")})),i.register("5ZTVn",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("1YnIA")})),i.register("1Ax5m",(function(t,n){e(t.exports,"ToolspaceStabilizerRow",(function(){return h}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("eEL9N"),l=i("1mH1z"),h=function(){"use strict";function e(t){(0,r.default)(this,e),this.rootEl=s.BB.el({tagName:"label",className:"kl-stabilizer",content:(0,l.LANG)("stabilizer")+"&nbsp;",title:(0,l.LANG)("stabilizer-title")});var i=new(0,o.Select)({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"]],initValue:""+t.smoothing,onChange:function(e){t.onSelect(parseInt(e))}});this.rootEl.append(i.getElement()),this.pointerListener=new s.BB.PointerListener({target:this.rootEl,onWheel:function(e){i.setDeltaValue(e.deltaY)}})}return(0,a.default)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}()})),i.register("e4sAN",(function(n,r){e(n.exports,"TabRow",(function(){return h}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("eWjiX"),l=i("fqSj0"),h=function(){"use strict";function e(i){var n=this;(0,a.default)(this,e);this.rootEl=o.BB.el({className:"tabrow",css:{height:"35px"}}),this.tabArr=[];this.roundRight=o.BB.el({css:{width:"10px",height:"10px",backgroundImage:"url('".concat(t(l),"')"),backgroundSize:"cover",position:"absolute",right:"-10px",bottom:"0",pointerEvents:"none"}}),this.roundLeft=o.BB.el({css:{width:"10px",height:"10px",backgroundImage:"url('".concat(t(l),"')"),backgroundSize:"cover",position:"absolute",left:"-10px",bottom:"0",transform:"scale(-1,1)",pointerEvents:"none"}});for(var r=function(e,t,i){var r=!("isVisible"in e)||void 0===e.isVisible||e.isVisible,a={id:e.id,isVisible:r,onOpen:e.onOpen,onClose:e.onClose,update:function(e){a.el.className=e===a?i?"tabrow__tab tabrow__tab--opened-accented":"tabrow__tab tabrow__tab--opened":"tabrow__tab",a.el.style.display=a.isVisible?"block":"none"},el:o.BB.el({parent:n.rootEl,content:"label"in e?e.label:"",title:"title"in e?e.title:void 0,className:t===e.id?i?"tabrow__tab tabrow__tab--opened-accented":"tabrow__tab tabrow__tab--opened":"tabrow__tab",css:{lineHeight:"35px",display:r?"block":"none",zIndex:"0"},onClick:function(){n.activeTab!==a&&n.open(a.id)}})};"image"in e&&o.BB.el({tagName:"span",parent:a.el,className:"dark-invert",css:{backgroundImage:'url("'.concat(e.image,'")'),backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",display:"flex",height:"28px",justifyContent:"center",margin:"4px auto"}}),"css"in e&&void 0!==e.css&&o.BB.css(a.el,e.css);new o.BB.PointerListener({target:a.el,onEnterLeave:function(e){a.el.classList.toggle("tabrow__tab-hover",e)}});return t===a.id?(a.onOpen(),a.el.append(n.roundRight,n.roundLeft)):a.onClose(),a},s=null,h=0;h<i.tabArr.length;h++){var c=r(i.tabArr[h],i.initialId,i.useAccent||!1);c.id===i.initialId&&(s=c),this.tabArr.push(c)}if(!s)throw"invalid initialId";this.activeTab=s}return(0,s.default)(e,[{key:"update",value:function(){for(var e=0;e<this.tabArr.length;e++)this.tabArr[e].update(this.activeTab)}},{key:"getElement",value:function(){return this.rootEl}},{key:"open",value:function(e){for(var t=0;t<this.tabArr.length;t++)if(this.tabArr[t].id===e){if(this.activeTab===this.tabArr[t])return;return this.activeTab.onClose(),this.activeTab=this.tabArr[t],this.activeTab.onOpen(),this.activeTab.el.append(this.roundRight,this.roundLeft),void this.update()}throw"TabRow.open - invalid tabId"}},{key:"getOpenedTabId",value:function(){return""+this.activeTab.id}},{key:"setIsVisible",value:function(e,t){for(var i=0;i<this.tabArr.length;i++)if(this.tabArr[i].id===e)return this.tabArr[i].isVisible=!!t,void this.update();throw"TabRow.setIsVisible - invalid tabId"}}]),e}()})),i.register("fqSj0",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("6ae9h")})),i.register("khi8I",(function(n,r){e(n.exports,"HandUi",(function(){return p}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("7U0Ew"),l=i("eWjiX"),h=i("gGQwz"),c=i("6Dvin"),u=i("1mH1z"),p=function(){"use strict";function e(i){(0,a.default)(this,e),(0,o.default)(this,"isVisible",!0),this.rootEl=l.BB.el({css:{margin:"10px"}}),this.scale=i.scale,this.angleDeg=i.angleDeg,this.onAngleChange=i.onAngleChange;var n=l.BB.el({css:{marginBottom:"10px",display:"flex"}}),r=l.BB.el({css:{display:"flex",marginBottom:"10px"}}),s=l.BB.el({css:{display:"flex"}});this.rootEl.append(n,r,s),this.scaleEl=l.BB.el({css:{width:"55px",userSelect:"none"}}),n.append(this.scaleEl),this.angleIm=new Image,this.angleIm.src=t(h),l.BB.css(this.angleIm,{verticalAlign:"bottom",width:"20px",height:"20px",marginRight:"5px",borderRadius:"10px",background:"rgba(0,0,0,0.2)",userSelect:"none"}),n.append(this.angleIm),this.angleEl=l.BB.el({parent:n,css:{userSelect:"none"}}),this.updateUi();var p=l.BB.el({tagName:"button",content:(0,u.LANG)("hand-reset"),onClick:i.onReset});l.BB.makeUnfocusable(p);var d=l.BB.el({tagName:"button",content:(0,u.LANG)("hand-fit"),css:{marginLeft:"10px"},onClick:i.onFit});l.BB.makeUnfocusable(d),r.append(p,d);var g=l.BB.el({tagName:"button",content:'<img height="20" src="'+t(c)+'" alt="Rotate" style="transform: scale(-1, 1)"/>',onClick:function(){i.onAngleChange(-15,!0)}});l.BB.makeUnfocusable(g);var f=l.BB.el({tagName:"button",content:"0°",css:{marginLeft:"10px"},onClick:function(){i.onAngleChange(0)}});l.BB.makeUnfocusable(f);var v=l.BB.el({tagName:"button",content:'<img height="20" src="'+t(c)+'" alt="Rotate"/>',css:{marginLeft:"10px"},onClick:function(){i.onAngleChange(15,!0)}});l.BB.makeUnfocusable(v),s.append(g,f,v)}return(0,s.default)(e,[{key:"updateUi",value:function(){this.scaleEl.innerHTML=Math.round(100*this.scale)+"%",this.angleEl.innerHTML=Math.round(this.angleDeg)+"°",this.angleIm.style.transform="rotate("+this.angleDeg+"deg)",this.angleDeg%90==0?this.angleIm.style.boxShadow="inset 0 0 0 1px rgba(255,255,255, 1), 0 0 0 1px rgba(0, 0, 0, 0.3)":this.angleIm.style.boxShadow=""}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=!!e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.updateUi()}},{key:"update",value:function(e,t){this.scale=e,this.angleDeg=t,this.isVisible&&this.updateUi()}}]),e}()})),i.register("6Dvin",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("8l03e")})),i.register("dJXmR",(function(t,n){e(t.exports,"FillUi",(function(){return u}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("aP0jf"),l=i("eEL9N"),h=i("7bWhB"),c=i("1mH1z"),u=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.rootEl=s.BB.el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=s.BB.el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.colorSlider=t.colorSlider,this.opacitySlider=new(0,o.KlSlider)({label:(0,c.LANG)("opacity"),width:250,height:30,min:.01,max:1,value:1,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e}}),this.rootEl.append(this.opacitySlider.getElement()),this.toleranceSlider=new(0,o.KlSlider)({label:(0,c.LANG)("bucket-tolerance"),width:250,height:30,min:0,max:255,value:51,toValue:function(e){return 2.55*e},toDisplayValue:function(e){return e/2.55}}),s.BB.css(this.toleranceSlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.toleranceSlider.getElement());var n=s.BB.el({parent:this.rootEl,css:{display:"flex",marginTop:"10px"}}),a=s.BB.el({content:(0,c.LANG)("bucket-sample")+"&nbsp;",title:(0,c.LANG)("bucket-sample-title"),css:{fontSize:"15px"}});this.modeSelect=new(0,l.Select)({optionArr:[["all",(0,c.LANG)("bucket-sample-all")],["current",(0,c.LANG)("bucket-sample-active")],["above",(0,c.LANG)("bucket-sample-above")]],initValue:"all"});new s.BB.PointerListener({target:this.modeSelect.getElement(),onWheel:function(e){i.modeSelect.setDeltaValue(e.deltaY)}});a.append(this.modeSelect.getElement()),n.append(a);var u=s.BB.el({content:(0,c.LANG)("bucket-grow")+"&nbsp;",title:(0,c.LANG)("bucket-grow-title"),css:{fontSize:"15px",marginLeft:"10px"}});this.growSelect=new(0,l.Select)({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"]],initValue:"0"});new s.BB.PointerListener({target:this.growSelect.getElement(),onWheel:function(e){i.growSelect.setDeltaValue(e.deltaY)}});u.append(this.growSelect.getElement()),n.append(u),this.isContiguous=!0;var p=new(0,h.Checkbox)({init:!0,label:(0,c.LANG)("bucket-contiguous"),title:(0,c.LANG)("bucket-contiguous-title"),callback:function(e){i.isContiguous=e},css:{paddingRight:"5px",display:"inline-block",width:"50%"}});this.eraserToggle=new(0,h.Checkbox)({init:!1,label:(0,c.LANG)("eraser"),css:{paddingRight:"5px",display:"inline-block",width:"50%"}}),this.rootEl.append(s.BB.el({content:[p.getElement(),this.eraserToggle.getElement()],css:{display:"flex",marginTop:"10px"}}))}return(0,a.default)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=!!e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}},{key:"getTolerance",value:function(){return this.toleranceSlider.getValue()}},{key:"getOpacity",value:function(){return this.opacitySlider.getValue()}},{key:"getSample",value:function(){return this.modeSelect.getValue()}},{key:"getGrow",value:function(){return parseInt(this.growSelect.getValue(),10)}},{key:"getContiguous",value:function(){return this.isContiguous}},{key:"getIsEraser",value:function(){return this.eraserToggle.getValue()}}]),e}()})),i.register("iS9xS",(function(t,n){e(t.exports,"TextUi",(function(){return h}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=i("1mH1z"),h=function(){"use strict";function e(t){(0,r.default)(this,e),(0,s.default)(this,"isVisible",!0),this.rootEl=o.BB.el({css:{margin:"10px"}}),this.colorSlider=t.colorSlider,this.colorDiv=o.BB.el({parent:this.rootEl,css:{marginBottom:"10px"}});o.BB.el({parent:this.rootEl,content:(0,l.LANG)("text-instruction")})}return(0,a.default)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=!!e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}}]),e}()})),i.register("9J17G",(function(t,n){e(t.exports,"ShapeUi",(function(){return p}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=i("iFIyy"),h=i("7bWhB"),c=i("aP0jf"),u=i("1mH1z"),p=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),(0,s.default)(this,"shape","rect"),(0,s.default)(this,"mode","stroke"),this.rootEl=o.BB.el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=o.BB.el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.colorSlider=t.colorSlider;var n=35,a=o.BB.createSvg({elementType:"rect",x:"8",width:"19"}),p=o.BB.createSvg({elementType:"svg",width:"35",height:"35"});p.classList.add("dark-invert"),p.append(a),o.BB.css(p,{display:"block"});var d=o.BB.createSvg({elementType:"rect",x:"8",width:"19"}),g=o.BB.createSvg({elementType:"svg",width:"35",height:"35"});g.classList.add("dark-invert"),g.append(d),o.BB.css(g,{display:"block"});var f=o.BB.createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),v=o.BB.createSvg({elementType:"svg",width:"35",height:"35"});v.classList.add("dark-invert"),v.append(f),o.BB.css(v,{display:"block"});var m=o.BB.createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),y=o.BB.createSvg({elementType:"svg",width:"35",height:"35"});y.classList.add("dark-invert"),y.append(m),o.BB.css(y,{display:"block"});var x=o.BB.createSvg({elementType:"line",x1:"8",x2:"27"}),B=o.BB.createSvg({elementType:"svg",width:"35",height:"35"});B.classList.add("dark-invert"),B.append(x),o.BB.css(B,{display:"block"});var b=function(){var e=o.BB.clamp(Math.round(i.lineWidthSlider.getValue()/10),1,10)+"px";o.BB.css(a,{fill:"none",stroke:"black",strokeWidth:e}),o.BB.css(d,{fill:"black",stroke:"none"}),o.BB.css(f,{fill:"none",stroke:"black",strokeWidth:e}),o.BB.css(m,{fill:"black",stroke:"none"}),o.BB.css(x,{fill:"none",stroke:"black",strokeWidth:e}),i.fixedToggle.getValue()?(a.setAttribute("y","8"),a.setAttribute("height","19"),d.setAttribute("y","8"),d.setAttribute("height","19"),f.setAttribute("ry","9.5"),m.setAttribute("ry","9.5")):(a.setAttribute("y","10.8"),a.setAttribute("height",""+(n-21.6)),d.setAttribute("y","10.8"),d.setAttribute("height",""+(n-21.6)),f.setAttribute("ry",""+(17.5-10.8)),m.setAttribute("ry",""+(17.5-10.8))),i.snapToggle.getValue()?(x.setAttribute("y1","27"),x.setAttribute("y2","8")):(x.setAttribute("y1","24.2"),x.setAttribute("y2","10.8"))},w=o.BB.el({parent:this.rootEl,css:{display:"flex",justifyContent:"space-between",alignItems:"start"}}),k=new(0,l.Options)({optionArr:[{id:"rect-stroke",label:p,title:(0,u.LANG)("shape-rect")+" "+(0,u.LANG)("shape-stroke")},{id:"ellipse-stroke",label:v,title:(0,u.LANG)("shape-ellipse")+" "+(0,u.LANG)("shape-stroke")},{id:"line",label:B,title:(0,u.LANG)("shape-line")},{id:"rect-fill",label:g,title:(0,u.LANG)("shape-rect")+" "+(0,u.LANG)("shape-fill")},{id:"ellipse-fill",label:y,title:(0,u.LANG)("shape-ellipse")+" "+(0,u.LANG)("shape-fill")}],initId:this.shape+" "+this.mode,onChange:function(e){var t=e.split("-");i.shape=t[0],i.mode=t[1],o.BB.css(i.fixedToggle.getElement(),{display:"line"===i.shape?"none":""}),o.BB.css(i.snapToggle.getElement(),{display:"line"===i.shape?"":"none"}),o.BB.css(i.lineWidthSlider.getElement(),{display:"line"!==i.shape&&"fill"===i.mode?"none":""})},changeOnInit:!0});k.getElement().style.width="120px",w.append(k.getElement()),this.eraserToggle=new(0,h.Checkbox)({init:!1,label:(0,u.LANG)("eraser"),callback:function(){b()}}),this.lockAlphaToggle=new(0,h.Checkbox)({init:!1,label:(0,u.LANG)("lock-alpha"),title:(0,u.LANG)("lock-alpha-title"),doHighlight:!0}),this.lockAlphaToggle.getElement().style.marginTop="10px",w.append(o.BB.el({content:[this.eraserToggle.getElement(),this.lockAlphaToggle.getElement()]})),this.lineWidthSlider=new(0,c.KlSlider)({label:(0,u.LANG)("shape-line-width"),width:250,height:30,min:1,max:200,value:4,curve:"quadratic",onChange:function(){b()}}),o.BB.css(this.lineWidthSlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.lineWidthSlider.getElement()),this.opacitySlider=new(0,c.KlSlider)({label:(0,u.LANG)("opacity"),width:250,height:30,min:.01,max:1,value:1,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e}}),o.BB.css(this.opacitySlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.opacitySlider.getElement());var C=o.BB.el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}});this.outwardsToggle=new(0,h.Checkbox)({init:!1,label:(0,u.LANG)("shape-outwards"),css:{width:"50%",marginRight:"10px"}}),C.append(this.outwardsToggle.getElement()),this.fixedToggle=new(0,h.Checkbox)({init:!1,label:(0,u.LANG)("shape-fixed"),callback:function(){b()},css:{flexGrow:"1"}}),C.append(this.fixedToggle.getElement()),this.snapToggle=new(0,h.Checkbox)({init:!1,label:(0,u.LANG)("angle-snap"),title:(0,u.LANG)("angle-snap-title"),callback:function(){b()},css:{flexGrow:"1"}}),C.append(this.snapToggle.getElement()),b()}return(0,a.default)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=!!e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&(this.colorDiv.append(this.colorSlider.getElement()),this.colorDiv.append(this.colorSlider.getOutputElement()))}},{key:"getShape",value:function(){return this.shape}},{key:"getMode",value:function(){return this.mode}},{key:"getIsEraser",value:function(){return this.eraserToggle.getValue()}},{key:"getOpacity",value:function(){return this.opacitySlider.getValue()}},{key:"getLineWidth",value:function(){return this.lineWidthSlider.getValue()}},{key:"getIsOutwards",value:function(){return this.outwardsToggle.getValue()}},{key:"getIsFixed",value:function(){return this.fixedToggle.getValue()}},{key:"getIsSnap",value:function(){return this.snapToggle.getValue()}},{key:"getDoLockAlpha",value:function(){return this.lockAlphaToggle.getValue()}}]),e}()})),i.register("76Qvv",(function(t,n){e(t.exports,"newImageDialog",(function(){return p}));var r=i("eWjiX"),a=i("eEL9N"),s=i("43qNf"),o=i("2MaaK"),l=i("1mH1z"),h=i("cNr8p"),c=i("fohxs"),u=i("1C8RU");function p(e){var t=function(e,t,i,n,a){return r.BB.fitInto(e,t,Math.min(d,i-a),Math.min(d,n-a),1)},i=function(){b.value=""+Math.min(d,parseInt(b.value)),C.value=""+Math.min(d,parseInt(C.value));var e=parseInt(b.value),t=parseInt(C.value);(e<1||e>d||t<1||t>d)&&(e>d?e=d:t>d&&(t=d),b.value=""+e,C.value=""+t);for(var i=[[1,2],[2,1],[2,3],[3,2],[3,4],[4,3],[4,5],[5,4],[16,9],[9,16],[3,2],[2,3],[5,3],[3,5],[2,1],[1,2],[1.414,1],[1,1.414]],n=r.BB.reduce(e,t),a=null,s=null,o=0;o<i.length;o++)(0===o||Math.abs(i[o][0]/i[o][1]-n[0]/n[1])<s)&&(a=i[o],s=Math.abs(i[o][0]/i[o][1]-n[0]/n[1]));A.innerText=s>0&&s<.005?(0,l.LANG)("new-ratio")+": ~"+a[0]+":"+a[1]:(0,l.LANG)("new-ratio")+": "+n[0]+":"+n[1];var h=e,c=function(e,t){for(var i=e,n=t;;){if(!(i%=n))return n;if(!(n%=i))return i}}(e,t);e/=c,t/=c,t*=260,(e*=260)>260&&(t*=260/e,e=260),t>100&&(e*=100/t,t=100),F.style.width=e+"px",F.style.height=t+"px",r.BB.createCheckerDataUrl(parseInt(""+e/h*30),(function(e){H.style.background="url("+e+")"}),u.theme.isDark())},n=e.currentColor,p=e.secondaryColor,d=e.maxCanvasSize,g=e.canvasWidth,f=e.canvasHeight,v=e.workspaceWidth,m=e.workspaceHeight,y=e.onConfirm,x=e.onCancel,B=r.BB.el(),b=r.BB.el({tagName:"input"}),w={color:"#888",fontSize:"12px",marginLeft:"5px"},k=r.BB.el({textContent:(0,l.LANG)("new-px"),css:w}),C=r.BB.el({tagName:"input"}),S=r.BB.el({textContent:(0,l.LANG)("new-px"),css:w});b.setAttribute("data-ignore-focus","true"),C.setAttribute("data-ignore-focus","true"),b.type="number",b.min="1",b.max=""+d,r.BB.css(b,{width:"70px"}),C.type="number",C.min="1",C.max=""+d,C.style.width="70px",b.value=""+g,C.value=""+f,b.onclick=function(){b.focus(),i()},C.onclick=function(){C.focus(),i()};var L=(0,h.table)([[(0,l.LANG)("width")+":&nbsp;",b,k],[r.BB.el({css:{height:"5px"}}),"",""],[(0,l.LANG)("height")+":&nbsp;",C,S]]);r.BB.css(L,{marginBottom:"10px"});var A=r.BB.el({css:{marginTop:"5px",color:"#888"}}),I=r.BB.el(),E=r.BB.el({tagName:"button"});I.style.marginBottom="10px";var T=r.BB.el({tagName:"button"}),M=r.BB.el({tagName:"button"}),P=r.BB.el({tagName:"button"}),O=r.BB.el({tagName:"button"}),R=r.BB.el({tagName:"button"});T.textContent=(0,l.LANG)("new-current"),E.textContent=(0,l.LANG)("new-fit"),R.textContent=(0,l.LANG)("new-oversize"),P.textContent=(0,l.LANG)("new-landscape"),O.textContent=(0,l.LANG)("new-portrait"),M.textContent=(0,l.LANG)("new-square"),T.style.marginRight="5px",E.style.marginRight="5px",R.style.marginRight="5px",P.style.marginTop="5px",P.style.marginRight="5px",O.style.marginTop="5px",O.style.marginRight="5px",I.append(T,E,R,M,P,O);T.onclick=function(){b.value=""+g,C.value=""+f,i()},E.onclick=function(){b.value=""+v,C.value=""+m,i()},R.onclick=function(){b.value=""+(v+500),C.value=""+(m+500),i()},M.onclick=function(){var e=t(1,1,v,m,0);b.value=""+Math.round(e.width),C.value=""+Math.round(e.height),i()},P.onclick=function(){var e=t(4,3,v,m,0);b.value=""+Math.round(e.width),C.value=""+Math.round(e.height),i()},O.onclick=function(){var e=t(3,4,v,m,0);b.value=""+Math.round(e.width),C.value=""+Math.round(e.height),i()};var D=new(0,a.Select)({isFocusable:!0,optionArr:[["screen",(0,l.LANG)("new-screen")],["16 9",(0,l.LANG)("new-video")+" 16:9"],["3 2","3:2"],["5 3","5:3"],["2 1","2:1"],["paper",(0,l.LANG)("new-din-paper")+" √2:1"],["9 16","9:16"],["2 3","2:3"],["3 5","3:5"],["1 2","1:2"],["1 1.4142135623730951","1:√2"]],onChange:function(e){if("screen"===e)b.value=""+window.screen.width,C.value=""+window.screen.height;else if("paper"===e){var n=t(Math.sqrt(2),1,v,m,0);b.value=""+Math.round(n.width),C.value=""+Math.round(n.height)}else{var r=e.split(" "),a=t(parseFloat(r[0]),parseFloat(r[1]),v,m,0);b.value=""+Math.round(a.width),C.value=""+Math.round(a.height)}i(),D.setValue(null)}});setTimeout((function(){D.setValue(null)}),0),r.BB.css(D.getElement(),{width:"80px"}),I.append(D.getElement());var N={r:255,g:255,b:255,a:1},z=[{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1},{r:0,g:0,b:0,a:0},{r:n.r,g:n.g,b:n.b,a:1},{r:p.r,g:p.g,b:p.b,a:1}],j=0;u.theme.isDark()&&z.forEach((function(e,t){e.r===c.ERASE_COLOR&&e.g===c.ERASE_COLOR&&e.b===c.ERASE_COLOR&&(j=t,N=e)}));var G=new(0,s.ColorOptions)({colorArr:z,initialIndex:j,onChange:function(e){N=e,F.style.backgroundColor="rgba("+e.r+","+e.g+","+e.b+", "+e.a+")"}}),H=r.BB.el({className:"kl-transparent-preview",css:{boxSizing:"border-box",width:"340px",height:"140px",display:"table",padding:"10px",marginTop:"10px",marginLeft:"-20px"}}),F=r.BB.el({className:"kl-transparent-preview__canvas",css:{width:"200px",height:"100px",backgroundColor:"rgba("+N.r+","+N.g+","+N.b+", "+N.a+")",marginLeft:"auto",marginRight:"auto",color:"#aaa",fontSize:"16px",fontWeight:"bold",textAlign:"center",verticalAlign:"center",display:"table",overflow:"hidden"}});r.BB.el({parent:H,content:F,css:{display:"table-cell",verticalAlign:"middle"}}),r.BB.el({parent:F,css:{display:"table-cell",verticalAlign:"middle"}});u.theme.addIsDarkListener(i),b.onchange=function(){(""===b.value||parseInt(b.value)<0)&&(b.value="1"),i()},b.onkeyup=function(){i()},C.onchange=function(){(""===C.value||parseFloat(C.value)<0)&&(C.value="1"),i()},C.onkeyup=function(){i()},i(),B.append(I);var W=r.BB.el({parent:B,css:{display:"flex",justifyContent:"space-between",alignItems:"flex-end"}});r.BB.el({parent:W}).append(L,A),W.append(G.getElement()),B.append(H),(0,o.showModal)({target:document.body,message:"<b>".concat((0,l.LANG)("new-title"),"</b>"),div:B,buttons:["Ok","Cancel"],callback:function(e){b.onclick=null,C.onclick=null,T.onclick=null,E.onclick=null,R.onclick=null,M.onclick=null,P.onclick=null,O.onclick=null,b.onchange=null,b.onkeyup=null,C.onchange=null,C.onkeyup=null,D.destroy(),G.destroy(),u.theme.removeIsDarkListener(i),"Cancel"===e||parseInt(b.value)<=0||parseInt(C.value)<=0||isNaN(parseInt(b.value))||isNaN(parseInt(C.value))?x():y(parseInt(b.value),parseInt(C.value),N)},clickOnEnter:"Ok"})}})),i.register("cNr8p",(function(t,n){e(t.exports,"table",(function(){return s}));var r=i("4Ea8f"),a=i("eWjiX");function s(e,t){var i=a.BB.el({tagName:"table",className:"kl-table"});return e.forEach((function(e,n){var s,o=a.BB.el({tagName:"tr"});(s=o).append.apply(s,(0,r.default)(e.map((function(e,i){var r=a.BB.el({tagName:"td",content:e}),s=n+"."+i;return void 0!==t&&s in t&&(r.rowSpan=t[s].rowspan),r})))),i.append(o)})),i}})),i.register("1uc3b",(function(n,r){e(n.exports,"ToolspaceCollapser",(function(){return c}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("eWjiX"),l=i("9ecpQ"),h=i("1mH1z"),c=function(){"use strict";function e(i){var n=this;(0,a.default)(this,e),this.stateIsOpen=!0,this.directionStr="right",this.rootEl=o.BB.el({className:"kl-toolspace-toggle",css:{width:"36px",height:"36px",background:"rgba(100, 100, 100, 0.9)",color:"#fff",position:"absolute",top:"0",textAlign:"center",lineHeight:"36px",cursor:"pointer",userSelect:"none",padding:"6px",boxSizing:"border-box"},title:(0,h.LANG)("toggle-show-tools"),onClick:function(e){e.preventDefault(),n.stateIsOpen=!n.stateIsOpen,n.update(),i.onChange()}}),this.icon=o.BB.el({parent:this.rootEl,css:{backgroundImage:"url(".concat(t(l),")"),width:"100%",height:"100%",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",userSelect:"none"}}),this.rootEl.oncontextmenu=function(){return!1}}return(0,s.default)(e,[{key:"update",value:function(){"left"===this.directionStr?this.icon.style.transform=this.stateIsOpen?"rotate(180deg)":"":this.icon.style.transform=this.stateIsOpen?"":"rotate(180deg)"}},{key:"isOpen",value:function(){return this.stateIsOpen}},{key:"setDirection",value:function(e){this.directionStr=e,this.update()}},{key:"getElement",value:function(){return this.rootEl}}]),e}()})),i.register("9ecpQ",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("8K12o")})),i.register("keKW3",(function(n,r){e(n.exports,"textToolDialog",(function(){return S}));var a=i("3Rl3W"),s=i("a7ch7"),o=i("eWjiX"),l=i("h20yl"),h=i("43qNf"),c=i("eEL9N"),u=i("4nUqS"),p=i("1kyaA"),d=i("aP0jf"),g=i("2MaaK"),f=i("itzxn"),v=i("3RXBC"),m=i("dtB7M"),y=i("3qZsM"),x=i("68rzB"),B=i("fORLP"),b=i("kRxRZ"),w=i("1mH1z"),k=i("7jh4K"),C=i("1C8RU");function S(e){var i=function(){U=(0,k.throwIfNull)(W.createPattern(o.BB.createCheckerCanvas(8,C.theme.isDark()),"repeat")),n()},n=function(){N.clearRect(0,0,D.width,D.height);var t=(0,s.default)((0,a.default)({},e.color),{a:ge.getValue()}),i=(0,l.renderText)(D,{x:e.x,y:e.y,textStr:fe.value,align:ue.getValue(),isItalic:pe.getValue(),isBold:de.getValue(),size:parseFloat(se.value),font:he.getValue(),color:o.BB.ColorConverter.toRgbaStr(t),angleRad:e.angleRad});i.width=Math.max(i.width,1),i.height=Math.max(i.height,1);var n=o.BB.rotate(i.x,i.y,-e.angleRad/Math.PI*180),r=o.BB.rotate(i.width,i.height,-e.angleRad/Math.PI*180),h=e.x+n.x+r.x/2,c=e.y+n.y+r.y/2,u=o.BB.fitInto(i.width,i.height,M-100,P-100);O=Math.min(1,u.width/i.width),O=Math.min(4,O*Math.pow(2,ie)),j.save(),O>=4?j.imageSmoothingEnabled=!1:(j.imageSmoothingEnabled=!0,j.imageSmoothingQuality=O>=1?"low":"medium"),j.clearRect(0,0,F.width,F.height),j.translate(M/2,P/2),j.scale(O,O),j.rotate(e.angleRad),j.drawImage(R[e.layerIndex].canvas,-h,-c),j.drawImage(D,-h,-c),j.restore();var p=C.theme.isDark();H.save(),H.fillStyle=p?"rgb(33,33,33)":"rgb(158,158,158)",H.fillRect(0,0,M,P),H.save(),H.translate(M/2,P/2),H.scale(O,O),H.rotate(e.angleRad),H.imageSmoothingEnabled=!1;var d=1/O;H.globalAlpha=p?.25:.2,H.drawImage(p?K:X,-h-d,-c-d,D.width+2*d,D.height+2*d),H.globalAlpha=1,H.globalCompositeOperation="destination-out",H.drawImage(X,-h,-c,D.width,D.height),H.restore(),O>=4?H.imageSmoothingEnabled=!1:(H.imageSmoothingEnabled=!0,H.imageSmoothingQuality=O>=1?"low":"medium"),H.save(),H.translate(M/2,P/2),H.scale(O,O),H.rotate(e.angleRad);for(var g=0;g<e.layerIndex;g++)R[g].opacity>0&&(H.globalAlpha=R[g].opacity,H.globalCompositeOperation=R[g].mixModeStr,H.drawImage(R[g].canvas,-h,-c));H.restore(),H.globalAlpha=R[e.layerIndex].opacity,H.globalCompositeOperation=R[e.layerIndex].mixModeStr,H.drawImage(z,0,0),H.save(),H.translate(M/2,P/2),H.scale(O,O),H.rotate(e.angleRad);for(var f=e.layerIndex+1;f<R.length;f++)R[f].opacity>0&&(H.globalAlpha=R[f].opacity,H.globalCompositeOperation=R[f].mixModeStr,H.drawImage(R[f].canvas,-h,-c));H.restore(),H.restore(),W.save(),W.fillStyle=U,W.fillRect(0,0,F.width,F.height),W.drawImage(G,0,0),W.restore(),W.save(),W.globalCompositeOperation="difference",W.strokeStyle="#fff",W.lineWidth=1,W.strokeRect(Math.round(M/2-i.width/2*O),Math.round(P/2-i.height/2*O),Math.round(i.width*O),Math.round(i.height*O)),W.restore()},r=function(t,i){var r=o.BB.rotate(t,i,-e.angleRad/Math.PI*180);e.x+=r.x/O,e.y+=r.y/O,n()},S=function(e){ie=Math.min(2,Math.max(-2,ie+e)),n(),re.disabled=!L(1),ae.disabled=!L(-1)},L=function(e){return ie!==Math.min(2,Math.max(-2,ie+e))},A=function(){window.scrollTo(0,0)},I=o.BB.el(),E=window.innerWidth<550,T=window.innerHeight<630,M=E?340:540,P=E?T?210:260:T?230:350,O=1,R=e.klCanvas.getLayersFast(),D=o.BB.canvas(e.klCanvas.getWidth(),e.klCanvas.getHeight()),N=o.BB.ctx(D),z=o.BB.canvas(M,P),j=o.BB.ctx(z),G=o.BB.canvas(M,P),H=o.BB.ctx(G),F=o.BB.canvas(M,P),W=o.BB.ctx(F);o.BB.css(F,{display:"block"});var V=o.BB.el({parent:I,css:{position:"relative",width:M+"px",marginLeft:"-20px",cursor:"move",touchAction:"none"},onClick:function(){return fe.focus()}});o.BB.el({parent:V,className:"kl-text-preview-wrapper"}),V.append(F);var U=(0,k.throwIfNull)(W.createPattern(o.BB.createCheckerCanvas(8,C.theme.isDark()),"repeat")),X=o.BB.canvas(1,1),K=o.BB.canvas(1,1),Y=o.BB.ctx(X);Y.fillRect(0,0,1,1),(Y=o.BB.ctx(K)).fillStyle="#fff",Y.fillRect(0,0,1,1),C.theme.addIsDarkListener(i),C.theme.addIsDarkListener(n);var _=new o.BB.PointerListener({target:F,onPointer:function(e){"pointermove"===e.type&&e.button&&(e.eventPreventDefault(),r(-e.dX,-e.dY))},onWheel:function(e){S(-e.deltaY)}}),q=function(e){return e.preventDefault()};F.addEventListener("wheel",q);var Q=o.BB.el({parent:I,css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"10px"}}),Z=o.BB.el({parent:I,css:E?{}:{display:"flex",alignItems:"center",justifyContent:"space-between"}}),J=o.BB.el({parent:Z,css:{display:"flex",alignItems:"center",marginTop:"5px"}}),$=o.BB.el({parent:Z,css:{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:"5px",width:E?"":"300px"}}),ee=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];ee.unshift({r:e.secondaryColor.r,g:e.secondaryColor.g,b:e.secondaryColor.b,a:1}),ee.unshift({r:e.color.r,g:e.color.g,b:e.color.b,a:1});var te=new(0,h.ColorOptions)({colorArr:ee,initialIndex:0,onChange:function(t){e.color=t,n()}});te.getElement().title=(0,w.LANG)("text-color"),te.getElement().style.marginLeft="-5px",Q.append(te.getElement());var ie=0,ne=o.BB.el({parent:Q}),re=o.BB.el({parent:ne,content:'<img height="20" src="'.concat(t(B),'">'),title:(0,w.LANG)("zoom-in"),tagName:"button",onClick:function(){return S(1)},css:{fontWeight:"bold"}}),ae=o.BB.el({parent:ne,content:'<img height="20" src="'.concat(t(b),'">'),title:(0,w.LANG)("zoom-out"),tagName:"button",onClick:function(){return S(-1)},css:{fontWeight:"bold",marginLeft:"5px"}}),se=o.BB.el({parent:J,tagName:"input",title:(0,w.LANG)("text-size"),custom:{type:"number",min:1,max:1e4,value:e.size},css:{width:"60px"},onChange:function(){se.value=""+Math.max(1,Math.min(1e4,parseInt(se.value))),n()}}),oe=new o.BB.PointerListener({target:se,onWheel:function(e){se.value=""+Math.max(1,Math.min(1e3,parseInt(se.value)-e.deltaY)),n()}}),le=o.BB.el({css:{fontSize:"15px",marginLeft:"10px"}}),he=new(0,c.Select)({isFocusable:!0,optionArr:[["sans-serif","Sans-serif"],["serif","Serif"],["monospace","Monospace"],["cursive","Cursive"],["fantasy","Fantasy"]],initValue:e.font,onChange:function(){return n()}});le.append(he.getElement()),J.append(le);var ce=new o.BB.PointerListener({target:he.getElement(),onWheel:function(e){return he.setDeltaValue(e.deltaY)}}),ue=new(0,u.ImageRadioList)({optionArr:[{id:"left",title:(0,w.LANG)("text-left"),image:t(f),darkInvert:!0},{id:"center",title:(0,w.LANG)("text-center"),image:t(v),darkInvert:!0},{id:"right",title:(0,w.LANG)("text-right"),image:t(m),darkInvert:!0}],initId:e.align,onChange:function(){return n()}});$.append(ue.getElement());var pe=new(0,p.ImageToggle)({image:t(y),title:(0,w.LANG)("text-italic"),initValue:e.isItalic,onChange:function(){return n()},darkInvert:!0});$.append(pe.getElement());var de=new(0,p.ImageToggle)({image:t(x),title:(0,w.LANG)("text-bold"),initValue:e.isBold,onChange:function(){return n()},darkInvert:!0});$.append(de.getElement());var ge=new(0,d.KlSlider)({label:(0,w.LANG)("opacity"),width:150,height:30,min:.01,max:1,value:e.opacity,resolution:225,eventResMs:1e3/30,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(){return n()}});$.append(ge.getElement());var fe=o.BB.el({parent:I,tagName:"textarea",custom:{placeholder:(0,w.LANG)("text-placeholder"),"data-ignore-focus":"true"},css:{whiteSpace:"pre",overflow:"auto",width:"100%",height:"70px",resize:"vertical",marginTop:"10px"},onChange:function(){return n()}});fe.addEventListener("input",n),setTimeout((function(){fe.focus(),fe.select()}));var ve=new o.BB.KeyListener({onDown:function(e){o.BB.isInputFocused(!0)||("left"===e&&r(-1,0),"right"===e&&r(1,0),"up"===e&&r(0,-1),"down"===e&&r(0,1))}});window.addEventListener("scroll",A),(0,g.showModal)({target:document.body,message:"<b>".concat((0,w.LANG)("text-title"),"</b>"),div:I,buttons:["Ok","Cancel"],style:E?{}:{width:"500px"},callback:function(t){var r={x:e.x,y:e.y,textStr:fe.value,align:ue.getValue(),isItalic:pe.getValue(),isBold:de.getValue(),color:e.color,size:Number(se.value),font:he.getValue(),opacity:ge.getValue()};C.theme.removeIsDarkListener(n),window.removeEventListener("scroll",A),fe.removeEventListener("input",n),o.BB.destroyEl(fe),_.destroy(),oe.destroy(),ce.destroy(),F.removeEventListener("wheel",q),o.BB.destroyEl(V),o.BB.destroyEl(re),o.BB.destroyEl(ae),o.BB.destroyEl(se),te.destroy(),he.destroy(),ve.destroy(),ue.destroy(),pe.destroy(),de.destroy(),ge.destroy(),C.theme.removeIsDarkListener(i),"Ok"===t&&e.onConfirm(r)},autoFocus:!1,clickOnEnter:"Ok",ignoreBackground:!0}),n()}})),i.register("itzxn",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("2WSh2")})),i.register("3RXBC",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("lHK8L")})),i.register("dtB7M",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("3kjmQ")})),i.register("3qZsM",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("g8nvA")})),i.register("68rzB",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("axEKL")})),i.register("kDGzx",(function(t,n){e(t.exports,"showImportImageDialog",(function(){return h}));var r=i("eWjiX"),a=i("hRdOL"),s=i("7bWhB"),o=i("2MaaK"),l=i("1mH1z");function h(e){var t=function(t,i){var n=r.BB.fitInto(t,i,e.maxSize,e.maxSize);n.width<t?(c.innerHTML='<span class="kl-text-error">'.concat(t," X ").concat(i,"</span> ⟶ ").concat(Math.round(n.width)," X ").concat(Math.round(n.height)),c.title=(0,l.LANG)("import-too-large")):(c.innerHTML="".concat(t," X ").concat(i),c.title="")},i=r.BB.el(),n=window.innerWidth<550||window.innerHeight<550,h=n?{}:{width:"500px"},c=r.BB.el({css:{marginTop:"10px",textAlign:"center",color:"#888",lineHeight:"20px"}}),u=new(0,a.CropCopy)({width:n?340:540,height:n?300:400,canvas:e.image.canvas,isNotCopy:!0,onChange:function(e,i){c&&t(e,i)}});r.BB.css(u.getEl(),{marginLeft:"-20px"}),u.getEl().title=(0,l.LANG)("crop-drag-to-crop"),i.append(u.getEl(),c),t(e.image.width,e.image.height);var p,d,g=!1;if("psd"===e.image.type)if(e.image.layers){if(p=new(0,s.Checkbox)({init:g,label:(0,l.LANG)("import-flatten"),callback:function(e){g=e}}),i.append(p.getElement()),e.image.warningArr){var f=r.BB.el({className:"kl-import-note",content:(0,l.LANG)("import-psd-limited-support")}),v=e.image.warningArr;d=r.BB.el({parent:f,tagName:"a",content:"Details",css:{marginLeft:"5px"},onClick:function(){return function(e){for(var t=[],i={mask:"Masks not supported. Mask was applied.",clipping:"Clipping not supported. Clipping layers were merged.",group:"Groups not supported. Layers were ungrouped.",adjustment:"Adjustment layers not supported.","layer-effect":"Layer effects not supported.","smart-object":"Smart objects not supported.","blend-mode":"Unsupported layer blend mode.","bits-per-channel":"Unsupported color depth. Only 8bit per channel supported."},n=0;n<e.length;n++)t.push("- "+i[e[n]]);alert(t.join("\n"))}(v)}}),i.append(f)}}else{var m=r.BB.el({className:"kl-import-note",content:(0,l.LANG)("import-psd-unsupported")});i.append(m)}(0,o.showModal)({target:e.target,message:"<b>".concat((0,l.LANG)("import-title"),"</b>"),div:i,style:h,buttons:[(0,l.LANG)("import-btn-as-layer"),(0,l.LANG)("import-btn-as-image"),"Cancel"],primaries:[(0,l.LANG)("import-btn-as-layer"),(0,l.LANG)("import-btn-as-image")],callback:function(t){var i=u.getCroppedImage(),n=u.getRect(),a=e.image.width!==n.width&&e.image.height!==n.height;u.destroy(),r.BB.destroyEl(d),p&&p.destroy(),t===(0,l.LANG)("import-btn-as-layer")?e.callback({type:"as-layer",image:a?i:e.image.canvas}):t===(0,l.LANG)("import-btn-as-image")?"psd"===e.image.type?(g&&delete e.image.layers,e.callback({type:"as-image-psd",image:e.image,cropObj:n})):"image"===e.image.type&&e.callback({type:"as-image",image:i}):e.callback({type:"cancel"})},autoFocus:"As Image"})}})),i.register("941rU",(function(t,n){e(t.exports,"blendPsdToKl",(function(){return u})),e(t.exports,"blendKlToPsd",(function(){return p})),e(t.exports,"readPsd",(function(){return d})),e(t.exports,"klPsdToKlProject",(function(){return g}));var r,a,s=i("eelgW"),o=i("1mH1z"),l=i("705qg"),h=i("eWjiX");function c(){r||(r={"source-over":"normal",darken:"darken",multiply:"multiply","color-burn":"color burn",lighten:"lighten",screen:"screen","color-dodge":"color dodge",overlay:"overlay","soft-light":"soft light","hard-light":"hard light",difference:"difference",exclusion:"exclusion",hue:"hue",saturation:"saturation",color:"color",luminosity:"luminosity"},a=Object.fromEntries(Object.entries(r).map((function(e){return e.reverse()}))))}function u(e){return c(),a[e]}function p(e){return c(),r[e]}function d(e){var t=function(e){r.warningArr||(r.warningArr=[]),r.warningArr.includes(e)||r.warningArr.push(e)},i=function(e){var i=u(e);return i||(t("blend-mode"),i="source-over"),i},n=function(e,t){var i=h.BB.ctx(e),n=i.getImageData(0,0,e.width,e.height);if(0===t)for(var r=0;r<n.data.length;r+=4)n.data[r+3]=n.data[r];else for(var a=0;a<n.data.length;a+=4)n.data[a+3]=255-n.data[a];i.putImageData(n,0,0)};if(!e.canvas)throw new Error("psdObj.canvas undefined");var r={type:"psd",canvas:e.canvas,width:e.width,height:e.height};if(8!==e.bitsPerChannel&&t("bits-per-channel"),!e.children)return r.error=!0,r;var a=l.MAX_LAYERS,o=0;if(o+=function e(i){var n=0;if(i.blendMode){var r=u(i.blendMode);if(r&&"source-over"!==r)return 1}if(i.children)for(var a=0;a<i.children.length;a++){var s=i.children[a];s.clipping||s.adjustment||(s.children?(t("group"),n+=e(s)):n++)}return n}(e),o>a)return r.error=!0,r;return r.layers=[],r.layers=function e(a){var o,l,c=[],u=a.hidden?0:a.opacity,p=i(a.blendMode);if("source-over"!==p&&(o=(0,s.createCanvas)(r.width,r.height),l=h.BB.ctx(o)),a.mask&&(t("mask"),n(a.mask.canvas,a.mask.defaultColor)),a.children)for(var d=0;d<a.children.length;d++){var g=a.children[d];if(!g.clipping)if(g.adjustment)t("adjustment");else{var f=(g.children||g.canvas)&&a.children[d+1]&&a.children[d+1].clipping;if(f&&t("clipping"),g.children)for(var v=e(g),m=0;m<v.length;m++){var y=v[m],x=h.BB.ctx(y.image);if(f){var B=(0,s.createCanvas)(r.width,r.height),b=h.BB.ctx(B);b.drawImage(y.image,0,0);for(var w=d+1;w<a.children.length&&a.children[w].clipping;w++){var k=a.children[w];if(0!==k.opacity&&!k.hidden){if(void 0===k.blendMode)throw new Error("clippingItem.blendMode undefined");if(void 0===k.opacity)throw new Error("clippingItem.opacity undefined");if(void 0===k.canvas)throw new Error("clippingItem.canvas undefined");if(void 0===k.left)throw new Error("clippingItem.left undefined");if(void 0===k.top)throw new Error("clippingItem.top undefined");b.globalCompositeOperation=i(k.blendMode),b.globalAlpha=k.opacity,b.drawImage(k.canvas,k.left,k.top)}}x.globalCompositeOperation="source-atop",x.drawImage(B,0,0)}if(a.mask){if(x.globalCompositeOperation=0===a.mask.defaultColor?"destination-in":"destination-out",void 0===a.mask.canvas)throw new Error("psdGroupObj.mask.canvas undefined");if(void 0===a.mask.left)throw new Error("psdGroupObj.mask.left undefined");if(void 0===a.mask.top)throw new Error("psdGroupObj.mask.top undefined");x.drawImage(a.mask.canvas,a.mask.left,a.mask.top)}if(o){if(void 0===l)throw new Error("groupCtx undefined");l.globalCompositeOperation=y.mixModeStr,l.globalAlpha=y.opacity,l.drawImage(y.image,0,0)}else{if(void 0===u)throw new Error("groupOpacity undefined");y.opacity=y.opacity*u,c.push(y)}}else{var C=(0,s.createCanvas)(r.width,r.height),S=h.BB.ctx(C);if(g.canvas){if(void 0===g.top)throw new Error("item.top undefined");if(void 0===g.left)throw new Error("item.left undefined");S.drawImage(g.canvas,g.left,g.top)}if(g.effects&&t("layer-effect"),g.mask){if(t("mask"),void 0===g.mask.canvas)throw new Error("item.mask.canvas undefined");if(void 0===g.mask.defaultColor)throw new Error("item.mask.defaultColor undefined");if(void 0===g.mask.left)throw new Error("item.mask.left undefined");if(void 0===g.mask.top)throw new Error("item.mask.top undefined");n(g.mask.canvas,g.mask.defaultColor),S.globalCompositeOperation=0===g.mask.defaultColor?"destination-in":"destination-out",S.drawImage(g.mask.canvas,g.mask.left,g.mask.top)}if(f){if(void 0===g.right)throw new Error("item.right undefined");if(void 0===g.left)throw new Error("item.left undefined");if(void 0===g.bottom)throw new Error("item.bottom undefined");if(void 0===g.top)throw new Error("item.top undefined");if(void 0===g.canvas)throw new Error("item.canvas undefined");var L=(0,s.createCanvas)(g.right-g.left,g.bottom-g.top),A=h.BB.ctx(L);A.drawImage(g.canvas,0,0);for(var I=d+1;I<a.children.length&&a.children[I].clipping;I++){var E=a.children[I];if(0!==E.opacity&&!E.hidden){if(void 0===E.blendMode)throw new Error("clippingItem.blendMode undefined");if(void 0===E.opacity)throw new Error("clippingItem.opacity undefined");if(void 0===E.canvas)throw new Error("clippingItem.canvas undefined");if(void 0===E.left)throw new Error("clippingItem.left undefined");if(void 0===E.top)throw new Error("clippingItem.top undefined");A.globalCompositeOperation=i(E.blendMode),A.globalAlpha=E.opacity,A.drawImage(E.canvas,E.left-g.left,E.top-g.top)}}S.globalCompositeOperation="source-atop",S.drawImage(L,g.left,g.top)}if(a.mask){if(S.globalCompositeOperation=0===a.mask.defaultColor?"destination-in":"destination-out",void 0===a.mask.canvas)throw new Error("psdGroupObj.mask.canvas undefined");if(void 0===a.mask.left)throw new Error("psdGroupObj.mask.left undefined");if(void 0===a.mask.top)throw new Error("psdGroupObj.mask.top undefined");S.drawImage(a.mask.canvas,a.mask.left,a.mask.top)}if(void 0===u)throw new Error("groupOpacity undefined");if(void 0===g.blendMode)throw new Error("item.blendMode undefined");if(void 0===g.hidden)throw new Error("item.hidden  undefined");if(void 0===g.opacity)throw new Error("item.opacity undefined");if(o&&l)u>0&&(l.globalCompositeOperation=i(g.blendMode),l.globalAlpha=g.hidden?0:g.opacity,l.drawImage(C,0,0));else{if(void 0===g.name)throw new Error("item.name undefined");c.push({name:g.name,opacity:(g.hidden?0:g.opacity)*u,mixModeStr:i(g.blendMode),image:C})}}}}if(o){if(void 0===a.name)throw new Error("psdGroupObj.name undefined");if(void 0===u)throw new Error("groupOpacity undefined");c=[{name:a.name,opacity:u,mixModeStr:p,image:o}]}return c}({name:"root",opacity:1,blendMode:"normal",children:e.children}),r}function g(e){var t={width:e.width,height:e.height,layers:[]};return e.layers?t.layers=e.layers.map((function(e){return{name:e.name,opacity:e.opacity,mixModeStr:e.mixModeStr,image:e.image}})):t.layers=[{name:(0,o.LANG)("background"),opacity:1,mixModeStr:"source-over",image:e.canvas}],t}})),i.register("9BlwZ",(function(t,i){e(t.exports,"setDbName",(function(){return s})),e(t.exports,"getKlProjectObj",(function(){return l})),e(t.exports,"storeKlProjectObj",(function(){return h})),e(t.exports,"clear",(function(){return c}));var n=!!window.indexedDB,r="Klecks",a="ProjectStore";function s(e){r=""+e}function o(e,t,i){var s=function(e){o||(o=!0,i(e))},o=!1;if(n){var l;try{l=window.indexedDB.open(r,1)}catch(e){return void s(e.message)}l.onupgradeneeded=function(){try{l.result.createObjectStore(a,{keyPath:"id"}).createIndex("id","id",{unique:!0})}catch(e){s(e.message)}},l.onerror=function(){s("indexedDB.open failed, "+l.error)},l.onsuccess=function(){var i,n,h;try{if(!(i=l.result).objectStoreNames.contains(a))return window.indexedDB.deleteDatabase(r),void s("object store "+a+" missing. destroying db");(h=(n=i.transaction(a,"readwrite")).objectStore(a)).index("id")}catch(e){return void s(e.message)}i.onerror=function(e){s("database error, "+i.error)};try{e(h)}catch(e){return void s(e.message)}n.oncomplete=function(){o||(o=!0,t()),i.close()},n.onerror=function(){s("transaction error, "+n.error)}}}else setTimeout((function(){s("no indexed db available")}),0)}function l(e,t){var i;n?o((function(e){i=e.get(1)}),(function(){e(i.result)}),(function(e){t("execIndexedDBTransaction error, "+e)})):e(void 0)}function h(e,t,i){o((function(t){t.put(e)}),(function(){t()}),(function(e){i(e)}))}function c(e,t){o((function(e){e.delete(1)}),(function(){e()}),(function(e){t(e)}))}})),i.register("kyVjY",(function(n,r){e(n.exports,"filterLibStatus",(function(){return C})),e(n.exports,"filterLib",(function(){return S}));var a=i("fsSyS"),s=i("bBJjx"),o=i("fb1QA"),l=i("5XYnt"),h=i("hK7d4"),c=i("bE89l"),u=i("anXZw"),p=i("gDMhw"),d=i("6Dvin"),g=i("bNSoq"),f=i("dkVDV"),v=i("6aHfw"),m=i("kLbWO"),y=i("bgekB"),x=i("537C7"),B=i("kHVZD"),b=i("bphza"),w=i("tP4I2"),k=i("4w6gs"),C={isLoaded:!1},S={brightnessContrast:{lang:{name:"filter-bright-contrast-title",button:"filter-bright-contrast"},icon:t(a),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},cropExtend:{lang:{name:"filter-crop-title",button:"filter-crop-extend"},icon:t(s),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},curves:{lang:{name:"filter-curves-title",button:"filter-curves"},icon:t(o),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},distort:{lang:{name:"filter-distort",button:"filter-distort"},icon:t(k),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},flip:{lang:{name:"filter-flip-title",button:"filter-flip"},icon:t(l),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},hueSaturation:{lang:{name:"filter-hue-sat-title",button:"filter-hue-sat"},icon:t(h),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0},invert:{lang:{name:"filter-invert",button:"filter-invert"},icon:t(c),updatePos:!1,isInstant:!0,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0},perspective:{lang:{name:"filter-perspective-title",button:"filter-perspective"},icon:t(u),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},resize:{lang:{name:"filter-resize-title",button:"filter-resize"},icon:t(p),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},rotate:{lang:{name:"filter-rotate-title",button:"filter-rotate"},icon:t(d),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},tiltShift:{lang:{name:"filter-tilt-shift-title",button:"filter-tilt-shift"},icon:t(g),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},toAlpha:{lang:{name:"filter-to-alpha-title",button:"filter-to-alpha"},icon:t(f),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0},transform:{lang:{name:"filter-transform-title",button:"filter-transform"},icon:t(v),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},blur:{lang:{name:"filter-triangle-blur-title",button:"filter-triangle-blur"},icon:t(m),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0},unsharpMask:{lang:{name:"filter-unsharp-mask-title",button:"filter-unsharp-mask"},icon:t(y),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0},grid:{lang:{name:"filter-grid",button:"filter-grid"},icon:t(x),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},noise:{lang:{name:"filter-noise",button:"filter-noise"},icon:t(B),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},pattern:{lang:{name:"filter-pattern",button:"filter-pattern"},icon:t(b),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},vanishPoint:{lang:{name:"filter-vanish-point-title",button:"filter-vanish-point"},icon:t(w),updatePos:!1,getDialog:null,apply:null,inEmbed:!0}}})),i.register("fsSyS",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("7tOPd")})),i.register("bBJjx",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("fduLu")})),i.register("fb1QA",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("ijSd4")})),i.register("5XYnt",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("3lCpH")})),i.register("hK7d4",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("hhylW")})),i.register("bE89l",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("kV0ed")})),i.register("anXZw",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("dNk9L")})),i.register("gDMhw",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("aj5Gc")})),i.register("bNSoq",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("6D2tK")})),i.register("dkVDV",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("7nesm")})),i.register("6aHfw",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("leHUT")})),i.register("kLbWO",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("3lP2j")})),i.register("bgekB",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("7G4sY")})),i.register("537C7",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("7n1Rt")})),i.register("kHVZD",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("ijwf0")})),i.register("bphza",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("18gIG")})),i.register("tP4I2",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("786LQ")})),i.register("4w6gs",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("kcnOE")})),i.register("dAXbp",(function(t,n){e(t.exports,"brushes",(function(){return u}));var r=i("68QTJ"),a=i("5PSXS"),s=i("ewgr9"),o=i("kic4a"),l=i("7cUpm"),h=i("ltaBP"),c=i("6Nq1H"),u={PenBrush:r.PenBrush,BlendBrush:a.BlendBrush,SketchyBrush:s.SketchyBrush,PixelBrush:o.PixelBrush,ChemyBrush:c.ChemyBrush,SmudgeBrush:h.SmudgeBrush,EraserBrush:l.EraserBrush}})),i.register("68QTJ",(function(t,n){e(t.exports,"PenBrush",(function(){return p}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=i("5CF7D"),h=i("hrnUX"),c=0,u=2*Math.PI,p=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"history",new h.KL.DecoyKlHistory),(0,s.default)(this,"settingHasOpacityPressure",!1),(0,s.default)(this,"settingHasSizePressure",!0),(0,s.default)(this,"settingSize",2),(0,s.default)(this,"settingSpacing",.8489),(0,s.default)(this,"settingOpacity",1),(0,s.default)(this,"settingAlphaId",c),(0,s.default)(this,"settingLockLayerAlpha",!1),(0,s.default)(this,"hasDrawnDot",!1),(0,s.default)(this,"lastInput",{x:0,y:0,pressure:0}),(0,s.default)(this,"lastInput2",{x:0,y:0,pressure:0}),(0,s.default)(this,"inputIsDrawing",!1),(0,s.default)(this,"bezierLine",null),(0,s.default)(this,"alphaCanvas128",o.BB.canvas(128,128)),(0,s.default)(this,"alphaCanvas64",o.BB.canvas(64,64)),(0,s.default)(this,"alphaCanvas32",o.BB.canvas(32,32)),(0,s.default)(this,"alphaOpacityArr",[1,.9,1,1])}return(0,a.default)(e,[{key:"updateAlphaCanvas",value:function(){if(this.settingAlphaId!==c&&3!==this.settingAlphaId)for(var e,t=[[this.alphaCanvas128,128],[this.alphaCanvas64,64],[this.alphaCanvas32,32]],i=0;i<t.length;i++)(e=o.BB.ctx(t[i][0])).save(),e.clearRect(0,0,t[i][1],t[i][1]),e.fillStyle="rgba("+this.settingColor.r+", "+this.settingColor.g+", "+this.settingColor.b+", "+this.alphaOpacityArr[this.settingAlphaId]+")",e.fillRect(0,0,t[i][1],t[i][1]),e.globalCompositeOperation="destination-in",e.imageSmoothingQuality="high",e.drawImage(l.alphaImArr[this.settingAlphaId],0,0,t[i][1],t[i][1]),e.restore()}},{key:"calcOpacity",value:function(e){return this.settingOpacity*(this.settingHasOpacityPressure?e*e:1)}},{key:"drawDot",value:function(e,t,i,n,r,a){if(!(i<=0))if(this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop"),a&&a[3]===n||(this.context.globalAlpha=n),a||this.settingAlphaId!==c&&3!==this.settingAlphaId||(this.context.fillStyle=this.settingColorStr),this.settingAlphaId===c)this.context.beginPath(),this.context.arc(e,t,i,0,u),this.context.closePath(),this.context.fill(),this.hasDrawnDot=!0;else if(3===this.settingAlphaId)void 0!==r&&(this.context.save(),this.context.translate(e,t),this.context.rotate(r/180*Math.PI),this.context.fillRect(-i,-i,2*i,2*i),this.context.restore(),this.hasDrawnDot=!0);else{this.context.save(),this.context.translate(e,t);var s=this.alphaCanvas128;i<=32&&i>16?s=this.alphaCanvas64:i<=16&&(s=this.alphaCanvas32),this.context.scale(i,i),1===this.settingAlphaId&&this.context.rotate(53123*(e+t)%u),this.context.drawImage(s,-1,-1,2,2),this.context.restore(),this.hasDrawnDot=!0}}},{key:"continueLine",value:function(e,t,i,n){var r=this;null===this.bezierLine&&(this.bezierLine=new o.BB.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,(function(){})));var a,s=[],l=function(e){var t=o.BB.mix(r.lastInput2.pressure,n,e.t),i=r.calcOpacity(t),a=Math.max(.1,r.settingSize*(r.settingHasSizePressure?t:1));s.push([e.x,e.y,a,i,e.angle])},h=i*this.settingSpacing;null===e||null===t?this.bezierLine.addFinal(h,l):this.bezierLine.add(e,t,h,l),this.context.save();for(var c=0;c<s.length;c++){var u=s[c];this.drawDot(u[0],u[1],u[2],u[3],u[4],a),a=u}this.context.restore()}},{key:"startLine",value:function(e,t,i){this.historyEntry={tool:["brush","PenBrush"],actions:[{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setAlpha",params:[this.settingAlphaId]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]}]},i=o.BB.clamp(i,0,1);var n=this.calcOpacity(i),r=this.settingHasSizePressure?Math.max(.1,i*this.settingSize):Math.max(.1,this.settingSize);this.hasDrawnDot=!1,this.inputIsDrawing=!0,this.context.save(),this.drawDot(e,t,r,n),this.context.restore(),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2.pressure=i,this.inputArr=[{x:e,y:t,pressure:i}],this.historyEntry.actions.push({action:"startLine",params:[e,t,i]})}},{key:"goLine",value:function(e,t,i){if(this.inputIsDrawing){this.historyEntry.actions.push({action:"goLine",params:[e,t,i]});var n=o.BB.clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.context.save(),this.continueLine(e,t,r,this.lastInput.pressure),this.context.restore(),this.lastInput.x=e,this.lastInput.y=t,this.lastInput2.pressure=this.lastInput.pressure,this.lastInput.pressure=n,this.inputArr.push({x:e,y:t,pressure:i})}}},{key:"endLine",value:function(e,t){var i=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);if(this.context.save(),this.continueLine(null,null,i,this.lastInput.pressure),this.context.restore(),this.inputIsDrawing=!1,3===this.settingAlphaId&&!this.hasDrawnDot){var n=this.inputArr[0];this.inputArr.forEach((function(e){e.pressure>n.pressure&&(n=e)})),this.context.save();var r=o.BB.clamp(n.pressure,0,1),a=this.calcOpacity(r);this.drawDot(n.x,n.y,i,a,0),this.context.restore()}this.bezierLine=null,this.historyEntry&&(this.historyEntry.actions.push({action:"endLine",params:[e,t]}),this.history.push(this.historyEntry),this.historyEntry=void 0),this.hasDrawnDot=!1,this.inputArr=[]}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.lastInput.x=i,this.lastInput.y=n,this.lastInput.pressure=1,!this.inputIsDrawing&&void 0!==e){var r,a=o.BB.pointsToAngleDeg({x:e,y:t},{x:i,y:n}),s=Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2)),l=(i-e)/s,h=(n-t)/s,c=this.settingSize*this.settingSpacing;for(this.lineToolLastDot=this.settingSize*this.settingSpacing,this.context.save(),r=this.lineToolLastDot;r<=s;r+=c)this.drawDot(e+l*r,t+h*r,this.settingSize,this.settingOpacity,a);this.context.restore();var u={tool:["brush","PenBrush"],actions:[{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setAlpha",params:[this.settingAlphaId]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]},{action:"drawLineSegment",params:[e,t,i,n]}]};this.history.push(u)}}},{key:"isDrawing",value:function(){return this.inputIsDrawing}},{key:"setAlpha",value:function(e){this.settingAlphaId!==e&&(this.settingAlphaId=e,this.updateAlphaCanvas())}},{key:"setColor",value:function(e){this.settingColor!==e&&(this.settingColor={r:e.r,g:e.g,b:e.b},this.settingColorStr="rgb("+this.settingColor.r+","+this.settingColor.g+","+this.settingColor.b+")",this.updateAlphaCanvas())}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.history=e}},{key:"setSize",value:function(e,t){this.settingSize=e}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setSpacing",value:function(e){this.settingSpacing=e}},{key:"sizePressure",value:function(e){this.settingHasSizePressure=e}},{key:"opacityPressure",value:function(e){this.settingHasOpacityPressure=e}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"getSpacing",value:function(){return this.settingSpacing}},{key:"getSize",value:function(){return this.settingSize}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}}]),e}()})),i.register("5CF7D",(function(t,n){e(t.exports,"alphaImArr",(function(){return a}));var r=i("74D3O"),a=[];a[1]=(0,r.genBrushAlpha01)(128),a[2]=(0,r.genBrushAlpha02)(128)})),i.register("74D3O",(function(t,n){e(t.exports,"genBrushAlpha01",(function(){return s})),e(t.exports,"genBrushAlpha02",(function(){return l}));var r=i("eWjiX"),a=i("gZSR2");function s(e){for(var t=e/500,i=e,n=r.BB.canvas(e,i),s=r.BB.ctx(n),o=s.createImageData(e,i),l=0;l<e;l++)for(var h=0;h<i;h++){var c=4*(h*e+l),u=t+.04*a.noise.simplex2(l/50/t,h/50/t),p=100+(a.noise.simplex2(l/50/u,h/50/u)+1)/2*100;p-=(a.noise.simplex2(l/10/t,h/10/t)+1)/2*100;var d=r.BB.dist(e/2,i/2,l,h);p*=r.BB.clamp(1-((d-e/2.5)/(e/14)+a.noise.simplex2(l/22/u,h/22/u)),0,1),p*=2*r.BB.clamp(1-d/e,0,1),o.data[c]=0,o.data[c+1]=0,o.data[c+2]=0,o.data[c+3]=r.BB.clamp(p,0,255)}return s.putImageData(o,0,0),n}function o(e,t,i){var n=r.BB.Vec2.sub(i,t),a=r.BB.Vec2.sub(e,t),s=r.BB.clamp(r.BB.Vec2.dot(a,n)/r.BB.Vec2.dot(n,n),0,1);return r.BB.Vec2.len(r.BB.Vec2.sub(a,r.BB.Vec2.mul(n,s)))}function l(e){var t=1/4;for(var i={x:t*e,y:e-e*t},n={x:e-e*t,y:t*e},a=e,s=r.BB.canvas(e,a),l=r.BB.ctx(s),h=l.createImageData(e,a),c=0;c<e;c++)for(var u=0;u<a;u++){var p=4*(u*e+c),d=o({x:c,y:u},i,n);d=r.BB.clamp(255-(d-.16666666666666666*e)/(.08333333333333333*e)*255,0,255),h.data[p]=0,h.data[p+1]=0,h.data[p+2]=0,h.data[p+3]=d}return l.putImageData(h,0,0),s}})),i.register("gZSR2",(function(t,n){e(t.exports,"noise",(function(){return g}));var r=i("gFgFC"),a=i("kiQ5H"),s={},o=function(){"use strict";function e(t,i,n){(0,r.default)(this,e),this.x=t,this.y=i,this.z=n}return(0,a.default)(e,[{key:"dot2",value:function(e,t){return this.x*e+this.y*t}}]),e}(),l=[new o(1,1,0),new o(-1,1,0),new o(1,-1,0),new o(-1,-1,0),new o(1,0,1),new o(-1,0,1),new o(1,0,-1),new o(-1,0,-1),new o(0,1,1),new o(0,-1,1),new o(0,1,-1),new o(0,-1,-1)],h=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],c=new Array(512),u=new Array(512);s.seed=function(e){e>0&&e<1&&(e*=65536),(e=Math.floor(e))<256&&(e|=e<<8);for(var t=0;t<256;t++){var i=void 0;i=1&t?h[t]^255&e:h[t]^e>>8&255,c[t]=c[t+256]=i,u[t]=u[t+256]=l[i%12]}},s.seed(0);var p=.5*(Math.sqrt(3)-1),d=(3-Math.sqrt(3))/6;s.simplex2=function(e,t){var i,n,r=(e+t)*p,a=Math.floor(e+r),s=Math.floor(t+r),o=(a+s)*d,l=e-a+o,h=t-s+o;l>h?(i=1,n=0):(i=0,n=1);var g=l-i+d,f=h-n+d,v=l-1+2*d,m=h-1+2*d,y=u[(a&=255)+c[s&=255]],x=u[a+i+c[s+n]],B=u[a+1+c[s+1]],b=.5-l*l-h*h,w=.5-g*g-f*f,k=.5-v*v-m*m;return 70*((b<0?0:(b*=b)*b*y.dot2(l,h))+(w<0?0:(w*=w)*w*x.dot2(g,f))+(k<0?0:(k*=k)*k*B.dot2(v,m)))};var g=s})),i.register("5PSXS",(function(t,n){e(t.exports,"BlendBrush",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=i("eg83P"),h=256,c=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"isTesting",!1),(0,s.default)(this,"size",29),(0,s.default)(this,"opacity",.6),(0,s.default)(this,"blending",.65),(0,s.default)(this,"settingLockLayerAlpha",!1),(0,s.default)(this,"settingSizePressure",!0),(0,s.default)(this,"settingOpacityPressure",!1),(0,s.default)(this,"blendCol",{r:0,g:0,b:0,a:1}),(0,s.default)(this,"blendMix",.45),(0,s.default)(this,"isDrawing",!1),(0,s.default)(this,"lastInput",{x:0,y:0,pressure:0}),(0,s.default)(this,"lastInput2",{x:0,y:0,pressure:0})}return(0,a.default)(e,[{key:"updateRedrawBounds",value:function(e){this.redrawBounds=o.BB.updateBounds(this.redrawBounds,e)}},{key:"getCellsWidth",value:function(){return Math.ceil(this.context.canvas.width/h)}},{key:"drawChangedCells",value:function(){var e=this,t=this.cells.map((function(e){return null}));this.getTouchedCells(this.redrawBounds).forEach((function(i,n){i&&(t[n]=e.cells[n])})),this.drawCells(t),this.redrawBounds=null}},{key:"getTouchedCells",value:function(e){for(var t=this.cells.map((function(e){return!1})),i=this.getCellsWidth(),n=(e={x1:Math.floor(e.x1/h),y1:Math.floor(e.y1/h),x2:Math.floor(e.x2/h),y2:Math.floor(e.y2/h)}).x1;n<=e.x2;n++)for(var r=e.y1;r<=e.y2;r++)t[r*i+n]=!0;return t}},{key:"sliceBounds",value:function(e){var t=this,i=this.getCellsWidth(),n=[];return this.getTouchedCells(e).forEach((function(r,a){if(r){var s=a%i*h,o=Math.floor(a/i)*h,l=t.cells[a].width,c=t.cells[a].height,u={x1:Math.max(0,e.x1-s),y1:Math.max(0,e.y1-o),x2:Math.min(l-1,e.x2-s),y2:Math.min(c-1,e.y2-o)};u.x1>u.x2||u.y1>u.y2||n.push({index:a,bounds:u})}})),n}},{key:"copyFromCanvas",value:function(e){var t=this;if(e){var i=this.getTouchedCells(e),n=this.getCellsWidth();i.forEach((function(e,i){if(e&&!t.cells[i]){var r=i%n,a=Math.floor(i/n),s=(Math.min(r*h+h,t.context.canvas.width)-1)%h+1,l=(Math.min(a*h+h,t.context.canvas.height)-1)%h+1,c=o.BB.canvas(s,l),u=o.BB.ctx(c);u.drawImage(t.context.canvas,-r*h,-a*h),t.cells[i]=u.getImageData(0,0,s,l)}}))}}},{key:"getAverage",value:function(e,t,i){var n=this;i=Math.max(.5,.75*i);var r=Math.max(0,Math.floor(e-i)),a=Math.max(0,Math.floor(t-i)),s=Math.min(this.context.canvas.width-1,Math.ceil(e+i)),o=Math.min(this.context.canvas.height-1,Math.ceil(t+i));if(r>s||a>o)return{r:0,g:0,b:0,a:0};var l,h=0,c=0,u=0,p=0;return this.sliceBounds({x1:r,y1:a,x2:s,y2:o}).forEach((function(e){for(var t=n.cells[e.index].width,i=n.cells[e.index].data,r=e.bounds,a=r.y1;a<=r.y2;a+=4)for(var s=r.x1,o=a*t*4+4*r.x1;s<=r.x2;s+=4,o+=16)l=i[o+3],h+=i[o]*l,c+=i[o+1]*l,u+=i[o+2]*l,p+=l})),0!==p&&(h/=p,c/=p,u/=p,p=Math.min(1,p)),{r:h,g:c,b:u,a:p}}},{key:"prepDot",value:function(e,t,i){i=Math.max(.5,i);var n=Math.max(0,Math.floor(e-i)),r=Math.max(0,Math.floor(t-i)),a=Math.min(this.context.canvas.width-1,Math.ceil(e+i)),s=Math.min(this.context.canvas.height-1,Math.ceil(t+i));return n>a||r>s?null:{x1:n,y1:r,x2:a,y2:s}}},{key:"drawDot",value:function(e){for(var t=this,i=0,n=e.size>30?1024:512,r=[],a=0;a<n;a++)r[a]=(Math.random()-.5)/1.001+.5;var s=[8,4,4,4,2,2,2,2,2,2][Math.floor(2*e.size)],c=s?s*s:0,u=[];if(s)for(var p=0,d=0;d<s;d++)for(var g=0;g<s;g++,p+=2)u[p]=(d+1)/s,u[p+1]=(g+1)/s;var f=.8*Math.pow(e.opacity,2),v=1-f,m=f/v,y=e.size*e.size,x=y*v/e.opacity,B=(1+m)*e.opacity,b=this.sliceBounds({x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2}),w=this.getCellsWidth();b.forEach((function(a){for(var s=a.index%w*h,p=Math.floor(a.index/w)*h,d=t.cells[a.index].width,g=t.cells[a.index].data,f=a.bounds.y1,v=f+p-e.y;f<=a.bounds.y2;f++,v++)for(var m=a.bounds.x1,b=f*d*4+4*a.bounds.x1,k=m+s-e.x;m<=a.bounds.x2;m++,b+=4,k++){var C=0;if(c){for(var S=0;S<u.length;S+=2){var L=o.BB.lenSquared(k+u[S],v+u[S+1]);L>=y||(C+=(0,l.clamp)(B-L/x,0,e.opacity))}if(!C)continue;C/=c}else{var A=Math.pow(k,2)+Math.pow(v,2);if(A>=y)continue;C=(0,l.clamp)(B-A/x,0,e.opacity)}var I=1-C,E=g[b+3]/255;if(t.settingLockLayerAlpha){var T=e.r*C+g[b]*I,M=e.g*C+g[b+1]*I,P=e.b*C+g[b+2]*I;E&&(g[b]=Math.floor(T+r[i]),g[b+1]=Math.floor(M+r[i]),g[b+2]=Math.floor(P+r[i]))}else{var O=e.r*C+g[b]*E*I,R=e.g*C+g[b+1]*E*I,D=e.b*C+g[b+2]*E*I,N=1-I*(1-E);g[b+3]=Math.floor(Math.min(255,255*N)+.5),N&&(g[b]=Math.floor(O/N+r[i]),g[b+1]=Math.floor(R/N+r[i]),g[b+2]=Math.floor(D/N+r[i]))}i=(i+1)%n}}))}},{key:"calcSpacing",value:function(e){return o.BB.mix(2*e/2,2*e/9,(0,l.clamp)((e-2.7)/9.3,0,1))}},{key:"continueLine",value:function(e,t,i,n){var r,a,s=this;this.drawBuffer=[];var l,h=this.settingSizePressure?Math.max(1,i*this.size):Math.max(1,this.size),c=this.calcSpacing(h),u=e,p=t;if(null===e&&(u=this.lastInput.x,p=this.lastInput.y),0===this.blending)this.mixr=this.color.r,this.mixg=this.color.g,this.mixb=this.color.b;else{var d;if(n)d={r:this.localColOld.r,g:this.localColOld.g,b:this.localColOld.b,a:0};else{var g=[u,p,this.settingSizePressure?Math.max(.5,i*this.size):Math.max(.5,this.size)],f=this.prepDot(g[0],g[1],g[2]);this.copyFromCanvas(f),d=this.getAverage(g[0],g[1],g[2])}l={r:0,g:0,b:0,a:0},d.a>0&&0===this.blendCol.a?(this.blendCol.r=d.r,this.blendCol.g=d.g,this.blendCol.b=d.b,this.blendCol.a=d.a,l.r=this.blendCol.r,l.g=this.blendCol.g,l.b=this.blendCol.b,l.a=this.blendCol.a):(0===d.a&&(d.r=this.color.r,d.g=this.color.g,d.b=this.color.b,d.a=1-this.blending),this.blendCol.r=o.BB.mix(this.blendCol.r,o.BB.mix(this.blendCol.r,d.r,this.blendMix),d.a),this.blendCol.g=o.BB.mix(this.blendCol.g,o.BB.mix(this.blendCol.g,d.g,this.blendMix),d.a),this.blendCol.b=o.BB.mix(this.blendCol.b,o.BB.mix(this.blendCol.b,d.b,this.blendMix),d.a),this.blendCol.a=Math.min(1,this.blendCol.a+d.a),l.r=this.blendCol.r,l.g=this.blendCol.g,l.b=this.blendCol.b,l.a=this.blendCol.a)}var v=function(e){if(!(s.blending>=1&&s.blendCol.a<=0)){var t=e.t;r=s.lastInput2.pressure*(1-t)+i*t,a=s.settingOpacityPressure?s.opacity*r*r:s.opacity,h=s.settingSizePressure?Math.max(.1,r*s.size):Math.max(.1,s.size),0!=s.blending&&(s.mixr=o.BB.mix(s.localColOld.r,l.r,t),s.mixg=o.BB.mix(s.localColOld.g,l.g,t),s.mixb=o.BB.mix(s.localColOld.b,l.b,t)),1===s.blending&&0===s.localColOld.a&&(s.mixr=l.r,s.mixg=l.g,s.mixb=l.b);var n=s.prepDot(e.x,e.y,h);n&&(s.updateRedrawBounds(n),s.drawBuffer.push({x:e.x,y:e.y,size:h,opacity:a,x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y2,r:o.BB.mix(s.color.r,s.mixr,s.blending),g:o.BB.mix(s.color.g,s.mixg,s.blending),b:o.BB.mix(s.color.b,s.mixb,s.blending)}))}};null===e?this.bezierLine.addFinal(c,v):this.bezierLine.add(e,t,c,v),this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach((function(e){s.drawDot(e)})),this.drawBuffer=[],this.localColOld=l}},{key:"setHistory",value:function(e){this.history=e}},{key:"getSize",value:function(){return this.size}},{key:"setSize",value:function(e){this.size=e}},{key:"getOpacity",value:function(){return this.opacity}},{key:"setOpacity",value:function(e){this.opacity=e}},{key:"getBlending",value:function(){return this.blending}},{key:"setBlending",value:function(e){this.blending=e}},{key:"setColor",value:function(e){this.color=o.BB.copyObj(e)}},{key:"setContext",value:function(e){this.context=e}},{key:"setSizePressure",value:function(e){this.settingSizePressure=!!e}},{key:"setOpacityPressure",value:function(e){this.settingOpacityPressure=!!e}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=!!e}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"setIsTesting",value:function(e){this.isTesting=!!e}},{key:"startLine",value:function(e,t,i){var n=this;this.historyEntry={tool:["brush","BlendBrush"],actions:[]};var r=Math.ceil(this.context.canvas.width/h)*Math.ceil(this.context.canvas.height/h);this.cells="0".repeat(r).split("").map((function(e){return null})),this.isDrawing=!0,i=Math.max(0,Math.min(1,i));var a=this.settingOpacityPressure?this.opacity*i*i:this.opacity,s=this.settingSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size);if(0===this.blending)this.mixr=this.color.r,this.mixg=this.color.g,this.mixb=this.color.b;else{this.copyFromCanvas(this.prepDot(e,t,s));var l=this.getAverage(e,t,this.settingSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size));0===l.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:l.r,g:l.g,b:l.b,a:l.a},this.mixr=this.blendCol.r,this.mixg=this.blendCol.g,this.mixb=this.blendCol.b}if(this.localColOld={r:this.mixr,g:this.mixg,b:this.mixb,a:this.blendCol.a},this.redrawBounds=null,this.drawBuffer=[],this.blending<1||this.blendCol.a>0){var c=this.prepDot(e,t,s);c&&(this.updateRedrawBounds(c),this.drawBuffer.push({x:e,y:t,size:s,opacity:a,x1:c.x1,y1:c.y1,x2:c.x2,y2:c.y2,r:o.BB.mix(this.color.r,this.mixr,this.blending),g:o.BB.mix(this.color.g,this.mixg,this.blending),b:o.BB.mix(this.color.b,this.mixb,this.blending)}))}this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach((function(e){n.drawDot(e)})),this.drawBuffer=[],this.bezierLine=new o.BB.BezierLine,this.bezierLine.add(e,t,0,(function(){})),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2=o.BB.copyObj(this.lastInput),this.redrawBounds&&!this.isTesting&&this.drawChangedCells()}},{key:"goLine",value:function(e,t,i,n){this.isDrawing&&(this.continueLine(e,t,this.lastInput.pressure,n),this.lastInput2=o.BB.copyObj(this.lastInput),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.redrawBounds&&!this.isTesting&&this.drawChangedCells())}},{key:"endLine",value:function(){this.bezierLine&&this.continueLine(null,null,this.lastInput.pressure,!1),this.isDrawing=!1,this.bezierLine=null,this.redrawBounds&&this.drawChangedCells(),this.historyEntry&&this.history&&this.cells.find((function(e){return!!e}))&&(this.historyEntry.actions.push({action:"drawCells",params:[this.cells]}),this.history.push(this.historyEntry),this.historyEntry=null),this.cells=null}},{key:"drawCells",value:function(e){var t=this,i=this.getCellsWidth();e.forEach((function(e,n){if(e){var r=n%i*h,a=Math.floor(n/i)*h;t.context.putImageData(e,r,a)}}))}},{key:"drawLineSegment",value:function(e,t,i,n){var r=this;if(this.lastInput.x=i,this.lastInput.y=n,!this.isDrawing&&void 0!==e){var a=Math.ceil(this.context.canvas.width/h)*Math.ceil(this.context.canvas.height/h);this.cells="0".repeat(a).split("").map((function(e){return null})),this.redrawBounds=null,this.drawBuffer=[],this.copyFromCanvas(this.prepDot(e,t,Math.max(.1,this.size)));var s=this.getAverage(e,t,Math.max(.1,this.size));0===s.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:s.r,g:s.g,b:s.b,a:s.a},this.mixr=this.color.r*(1-this.blendCol.a)+(this.blending*this.blendCol.r+this.color.r*(1-this.blending))*this.blendCol.a,this.mixg=this.color.g*(1-this.blendCol.a)+(this.blending*this.blendCol.g+this.color.g*(1-this.blending))*this.blendCol.a,this.mixb=this.color.b*(1-this.blendCol.a)+(this.blending*this.blendCol.b+this.color.b*(1-this.blending))*this.blendCol.a;for(var l=this.settingOpacityPressure?1*this.opacity*1:this.opacity,c=this.settingSizePressure?Math.max(.1,1*this.size):Math.max(.1,this.size),u=Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2)),p=(i-e)/u,d=(n-t)/u,g=this.calcSpacing(c),f=0;f<=u;f+=g){var v=this.prepDot(e+p*f,t+d*f,c);v&&(this.copyFromCanvas(v),this.drawBuffer.push({x:e+p*f,y:t+d*f,size:c,opacity:l,x1:v.x1,y1:v.y1,x2:v.x2,y2:v.y2,r:o.BB.mix(this.color.r,this.mixr,this.blending),g:o.BB.mix(this.color.g,this.mixg,this.blending),b:o.BB.mix(this.color.b,this.mixb,this.blending)}))}this.drawBuffer.forEach((function(e){r.drawDot(e)})),this.drawBuffer=[],this.history&&this.cells.find((function(e){return!!e}))&&(this.drawCells(this.cells),this.historyEntry={tool:["brush","BlendBrush"],actions:[{action:"drawCells",params:[this.cells]}]},this.history.push(this.historyEntry),this.historyEntry=null),this.cells=null}}}]),e}()})),i.register("ewgr9",(function(t,n){e(t.exports,"SketchyBrush",(function(){return u}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=i("hrnUX"),h=o.BB.canvas(32,32),c=o.BB.ctx(h),u=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"settingSize",1),(0,s.default)(this,"settingOpacity",.2),(0,s.default)(this,"settingBlending",.5),(0,s.default)(this,"settingScale",1),(0,s.default)(this,"lastX",0),(0,s.default)(this,"lastY",0),(0,s.default)(this,"inputIsDrawing",!1),(0,s.default)(this,"lastInput",{x:0,y:0,pressure:0}),(0,s.default)(this,"history",new l.KL.DecoyKlHistory),(0,s.default)(this,"sketchySeed",0),(0,s.default)(this,"points",[]),(0,s.default)(this,"count",0),(0,s.default)(this,"mixmode",[function(e,t){return e},function(e,t){var i=new o.BB.RGB(e.r,e.g,e.b);return i.r*=t.r/255,i.g*=t.g/255,i.b*=t.b/255,i}])}return(0,a.default)(e,[{key:"rand",value:function(){return this.sketchySeed++,.5*Math.sin(6324634.2345*Math.cos(5342.3423*this.sketchySeed))+.5}},{key:"setHistory",value:function(e){this.history=e}},{key:"setSeed",value:function(e){this.sketchySeed=parseInt(""+e)}},{key:"getSeed",value:function(){return parseInt(""+this.sketchySeed)}},{key:"getSize",value:function(){return this.settingSize/2}},{key:"setColor",value:function(e){this.settingColor=e}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"getBlending",value:function(){return this.settingBlending}},{key:"setBlending",value:function(e){this.settingBlending=e}},{key:"setSize",value:function(e){this.settingSize=2*e}},{key:"getScale",value:function(){return this.settingScale}},{key:"setScale",value:function(e){this.settingScale=e}},{key:"setContext",value:function(e){this.context=e}},{key:"startLine",value:function(e,t,i,n){n&&this.lastInput.x?(this.inputIsDrawing=!0,this.endLine()):(this.inputIsDrawing=!0,this.lastX=e,this.lastY=t,this.lastInput.x=e,this.lastInput.y=t,this.historyEntry={tool:["brush","SketchyBrush"],actions:[{action:"setScale",params:[this.settingScale]},{action:"setSize",params:[this.settingSize/2]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setBlending",params:[this.settingBlending]},{action:"startLine",params:[e,t,i]}]})}},{key:"goLine",value:function(e,t,i,n){if(this.inputIsDrawing&&(e!==this.lastInput.x||t!==this.lastInput.y)){var r,a,s,l,h=parseInt(""+e),c=parseInt(""+t);this.points.push([h,c]);var u=this.settingColor.r,p=this.settingColor.g,d=this.settingColor.b;if(null!==n)u=n.r,p=n.g,d=n.b;else if(0!==this.settingBlending&&h+5>=0&&c+5>=0&&h-5<this.context.canvas.width-1&&c-5<this.context.canvas.height-1){u=0,p=0,d=0;var g=Math.min(this.context.canvas.width-1,Math.max(0,h-5)),f=Math.min(this.context.canvas.height-1,Math.max(0,c-5)),v=Math.min(this.context.canvas.width-1,Math.max(0,h+5)),m=Math.min(this.context.canvas.height-1,Math.max(0,c+5));if(m-=f,(v-=g)>0&&m>0){for(var y=this.context.getImageData(g,f,v,m),x=0,B=0;B<y.data.length;B+=4)u+=y.data[B+0],p+=y.data[B+1],d+=y.data[B+2],x++;u/=x,p/=x,d/=x}var b=this.mixmode[0](new o.BB.RGB(u,p,d),this.settingColor);u=parseInt(""+o.BB.mix(this.settingColor.r,b.r,this.settingBlending)),p=parseInt(""+o.BB.mix(this.settingColor.g,b.g,this.settingBlending)),d=parseInt(""+o.BB.mix(this.settingColor.b,b.b,this.settingBlending))}for(this.context.save(),this.context.strokeStyle="rgba("+u+", "+p+", "+d+", "+this.settingOpacity+")",this.context.lineWidth=this.settingSize,this.context.beginPath(),this.context.moveTo(this.lastX,this.lastY),this.context.lineTo(h,c),r=0;r<this.points.length;r++)(l=(a=this.points[r][0]-this.points[this.count][0])*a+(s=this.points[r][1]-this.points[this.count][1])*s)<4e3*this.settingScale*this.settingScale&&this.rand()>l/2e3/this.settingScale/this.settingScale&&(this.context.moveTo(this.points[this.count][0]+.3*a,this.points[this.count][1]+.3*s),this.context.lineTo(this.points[r][0]-.3*a,this.points[r][1]-.3*s));this.context.stroke(),this.context.restore(),this.count++,this.lastX=h,this.lastY=c,this.lastInput.x=h,this.lastInput.y=c,this.historyEntry.actions.push({action:"goLine",params:[e,t,i,{r:u,g:p,b:d}]})}}},{key:"endLine",value:function(){this.inputIsDrawing=!1,this.count=0,this.points=[],this.historyEntry&&(this.historyEntry.actions.push({action:"endLine",params:[]}),this.history.push(this.historyEntry),this.historyEntry=void 0)}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.lastInput.x=i,this.lastInput.y=n,!this.inputIsDrawing&&void 0!==e){this.context.save(),this.context.lineWidth=this.settingSize;var r=this.settingColor.r,a=this.settingColor.g,s=this.settingColor.b;if(e+5>=0&&t+5>=0&&e-5<this.context.canvas.width-1&&t-5<this.context.canvas.height-1){r=0,a=0,s=0;var l=Math.min(this.context.canvas.width-1,Math.max(0,e-5)),u=Math.min(this.context.canvas.height-1,Math.max(0,t-5)),p=Math.min(this.context.canvas.width-1,Math.max(0,e+5)),d=Math.min(this.context.canvas.height-1,Math.max(0,t+5));if(d-=u,(p-=l)>0&&d>0){var g=Math.min(h.width,p),f=Math.min(h.height,d);c.save(),c.globalCompositeOperation="copy",c.drawImage(this.context.canvas,l,u,p,d,0,0,g,f),c.restore();for(var v=c.getImageData(l,u,p,d),m=0,y=0;y<v.data.length;y+=4)r+=v.data[y+0],a+=v.data[y+1],s+=v.data[y+2],m++;r/=m,a/=m,s/=m}}var x=this.mixmode[0](new o.BB.RGB(r,a,s),this.settingColor);r=parseInt(""+(this.settingBlending*x.r+this.settingColor.r*(1-this.settingBlending))),a=parseInt(""+(this.settingBlending*x.g+this.settingColor.g*(1-this.settingBlending))),s=parseInt(""+(this.settingBlending*x.b+this.settingColor.b*(1-this.settingBlending))),this.context.strokeStyle="rgba("+r+", "+a+", "+s+", "+this.settingOpacity+")",this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(i,n),this.context.stroke(),this.context.strokeStyle="rgba("+r+", "+a+", "+s+", "+this.settingOpacity+")",this.context.restore();var B={tool:["brush","SketchyBrush"],actions:[{action:"setScale",params:[this.settingScale]},{action:"setSize",params:[this.settingSize/2]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setBlending",params:[this.settingBlending]},{action:"drawLineSegment",params:[e,t,i,n]}]};this.history.push(B)}}},{key:"isDrawing",value:function(){return this.inputIsDrawing}}]),e}()})),i.register("kic4a",(function(t,n){e(t.exports,"PixelBrush",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=i("hrnUX"),h=i("fohxs"),c=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"history",new l.KL.DecoyKlHistory),(0,s.default)(this,"settingHasSizePressure",!0),(0,s.default)(this,"settingHasOpacityPressure",!1),(0,s.default)(this,"settingSize",.5),(0,s.default)(this,"settingSpacing",.9),(0,s.default)(this,"settingOpacity",1),(0,s.default)(this,"settingLockLayerAlpha",!1),(0,s.default)(this,"settingIsEraser",!1),(0,s.default)(this,"settingUseDither",!0),(0,s.default)(this,"inputIsDrawing",!1),(0,s.default)(this,"lastInput",{x:0,y:0,pressure:0}),(0,s.default)(this,"lastInput2",{x:0,y:0,pressure:0}),(0,s.default)(this,"bezierLine",null),(0,s.default)(this,"ditherArr",[[3,2],[1,0],[3,0],[1,2],[2,1],[0,3],[0,1],[2,3],[2,0],[0,2],[0,0],[2,2],[1,1],[3,3],[3,1],[1,3]]),this.ditherCanvas=o.BB.canvas(4,4),this.ditherCtx=o.BB.ctx(this.ditherCanvas)}return(0,a.default)(e,[{key:"updateDither",value:function(){this.ditherCtx.clearRect(0,0,4,4),this.ditherCtx.fillStyle=this.settingIsEraser?"rgb(".concat(h.ERASE_COLOR,",").concat(h.ERASE_COLOR,",").concat(h.ERASE_COLOR,")"):this.settingColorStr;for(var e=0;e<Math.max(1,Math.round(this.settingOpacity*this.ditherArr.length));e++)this.ditherCtx.fillRect(this.ditherArr[e][0],this.ditherArr[e][1],1,1);this.ditherPattern=this.context.createPattern(this.ditherCanvas,"repeat")}},{key:"cubicCurveOverThreshold",value:function(e,t,i,n,r){var a=o.BB.Vec2.nor({x:n.x-e.x,y:n.y-e.y}),s=o.BB.Vec2.nor({x:t.x-e.x,y:t.y-e.y}),l=o.BB.Vec2.nor({x:n.x-i.x,y:n.y-i.y});return Math.max(o.BB.Vec2.dist(a,s),o.BB.Vec2.dist(a,l))>r}},{key:"plotCubicBezierLine",value:function(e,t,i,n){var r=this.cubicCurveOverThreshold(e,t,i,n,.1);e.x=Math.floor(e.x),e.y=Math.floor(e.y),n.x=Math.floor(n.x),n.y=Math.floor(n.y);var a=o.BB.dist(e.x,e.y,n.x,n.y);if(!r||a<7)this.plotLine(e.x,e.y,n.x,n.y,!0);else{for(var s=Math.max(2,Math.round(a/4)),l=[],h=0;h<=s;h++){var c=h/s,u=Math.pow(1-c,3),p=3*c*Math.pow(1-c,2),d=3*Math.pow(c,2)*(1-c),g=Math.pow(c,3);l.push({x:u*e.x+p*t.x+d*i.x+g*n.x,y:u*e.y+p*t.y+d*i.y+g*n.y})}for(var f=0;f<s;f++)this.plotLine(Math.round(l[f].x),Math.round(l[f].y),Math.round(l[f+1].x),Math.round(l[f+1].y),!0)}}},{key:"drawDot",value:function(e,t,i,n){this.context.save(),this.settingIsEraser?(this.context.fillStyle=this.settingUseDither?this.ditherPattern:"#fff",this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):(this.context.fillStyle=this.settingUseDither?this.ditherPattern:this.settingColorStr,this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop")),this.context.globalAlpha=this.settingUseDither?1:n,this.context.fillRect(Math.round(e+-i),Math.round(t+-i),Math.round(2*i),Math.round(2*i)),this.context.restore()}},{key:"continueLine",value:function(e,t,i,n){var r=this;null===this.bezierLine&&(this.bezierLine=new o.BB.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,(function(){}))),this.context.save();var a=function(e){var t=o.BB.mix(r.lastInput2.pressure,n,e.t),i=r.settingOpacity*(r.settingHasOpacityPressure?t*t:1),a=Math.max(.5,r.settingSize*(r.settingHasSizePressure?t:1));r.drawDot(e.x,e.y,a,i)},s=function(e){r.plotCubicBezierLine(e.p1,e.p2,e.p3,e.p4)};if(1===Math.round(2*this.settingSize))null===e||null===t?this.bezierLine.addFinal(4,void 0,s):this.bezierLine.add(e,t,4,void 0,s);else{var l=i*this.settingSpacing;null===e||null===t?this.bezierLine.addFinal(l,a):this.bezierLine.add(e,t,l,a)}this.context.restore()}},{key:"plotLine",value:function(e,t,i,n,r){this.context.save(),this.settingIsEraser?(this.context.fillStyle=this.settingUseDither?this.ditherPattern:"#fff",this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):(this.context.fillStyle=this.settingUseDither?this.ditherPattern:this.settingColorStr,this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop")),this.context.globalAlpha=this.settingUseDither?1:this.settingOpacity,e=Math.floor(e),t=Math.floor(t),i=Math.floor(i),n=Math.floor(n);for(var a=Math.abs(i-e),s=e<i?1:-1,o=-Math.abs(n-t),l=t<n?1:-1,h=a+o;r?r=!1:this.context.fillRect(e,t,1,1),e!==i||t!==n;){var c=2*h;c>=o&&(h+=o,e+=s),c<=a&&(h+=a,t+=l)}this.context.restore()}},{key:"startLine",value:function(e,t,i){this.historyEntry={tool:["brush","PixelBrush"],actions:[{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]},{action:"setIsEraser",params:[this.settingIsEraser]},{action:"setUseDither",params:[this.settingUseDither]}]},this.settingUseDither&&this.updateDither(),i=Math.max(0,Math.min(1,i));var n=this.settingHasOpacityPressure?this.settingOpacity*i*i:this.settingOpacity,r=this.settingHasSizePressure?Math.max(.5,i*this.settingSize):Math.max(.5,this.settingSize);this.inputIsDrawing=!0,this.drawDot(e,t,r,n),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2=o.BB.copyObj(this.lastInput),this.historyEntry.actions.push({action:"startLine",params:[e,t,i]})}},{key:"goLine",value:function(e,t,i){if(this.inputIsDrawing){this.historyEntry.actions.push({action:"goLine",params:[e,t,i]});var n=o.BB.clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(e,t,r,this.lastInput.pressure),this.lastInput2=o.BB.copyObj(this.lastInput),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=n}}},{key:"endLine",value:function(e,t){var i=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(null,null,i,this.lastInput.pressure),this.inputIsDrawing=!1,this.bezierLine=null,this.historyEntry&&(this.historyEntry.actions.push({action:"endLine",params:[e,t]}),this.history.push(this.historyEntry),this.historyEntry=void 0)}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.lastInput.x=i,this.lastInput.y=n,this.lastInput.pressure=1,!this.inputIsDrawing&&void 0!==e){if(this.settingUseDither&&this.updateDither(),1===Math.round(2*this.settingSize))this.plotLine(e,t,i,n,!0);else{var r,a=Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2)),s=(i-e)/a,o=(n-t)/a,l=this.settingSize*this.settingSpacing;for(this.lineToolLastDot=this.settingSize*this.settingSpacing,r=this.lineToolLastDot;r<=a;r+=l)this.drawDot(e+s*r,t+o*r,this.settingSize,this.settingOpacity)}var h={tool:["brush","PixelBrush"],actions:[{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]},{action:"setIsEraser",params:[this.settingIsEraser]},{action:"setUseDither",params:[this.settingUseDither]},{action:"drawLineSegment",params:[e,t,i,n]}]};this.history.push(h)}}},{key:"isDrawing",value:function(){return this.inputIsDrawing}},{key:"setColor",value:function(e){this.settingColor!==e&&(this.settingColor=e,this.settingColorStr="rgb("+this.settingColor.r+","+this.settingColor.g+","+this.settingColor.b+")")}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.history=e}},{key:"setSize",value:function(e){this.settingSize=Math.round(2*e)/2}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setSpacing",value:function(e){this.settingSpacing=e}},{key:"sizePressure",value:function(e){this.settingHasSizePressure=e}},{key:"opacityPressure",value:function(e){this.settingHasOpacityPressure=e}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"setIsEraser",value:function(e){this.settingIsEraser=!!e}},{key:"setUseDither",value:function(e){this.settingUseDither=!!e}},{key:"getSpacing",value:function(){return this.settingSpacing}},{key:"getSize",value:function(){return this.settingSize}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}},{key:"getIsEraser",value:function(){return this.settingIsEraser}},{key:"getUseDither",value:function(){return this.settingUseDither}}]),e}()})),i.register("7cUpm",(function(t,n){e(t.exports,"EraserBrush",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=i("hrnUX"),h=i("fohxs"),c=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"size",30),(0,s.default)(this,"spacing",.4),(0,s.default)(this,"opacity",1),(0,s.default)(this,"useSizePressure",!0),(0,s.default)(this,"useOpacityPressure",!1),(0,s.default)(this,"isTransparentBG",!1),(0,s.default)(this,"history",new l.KL.DecoyKlHistory),(0,s.default)(this,"isBaseLayer",!1),(0,s.default)(this,"started",!1),(0,s.default)(this,"lastInput",{x:0,y:0,pressure:0}),(0,s.default)(this,"lastInput2",{x:0,y:0,pressure:0})}return(0,a.default)(e,[{key:"drawDot",value:function(e,t,i,n){this.context.save(),this.isBaseLayer?this.isTransparentBG?this.context.globalCompositeOperation="destination-out":this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out";var r=this.context.createRadialGradient(i,i,0,i,i,i),a=Math.pow(n,2);a=Math.max(0,Math.min((i-1)/i,a));var s=Math.max(0,Math.min(1,n)),o=2*s-s*s;r.addColorStop(a,"rgba(".concat(h.ERASE_COLOR,", ").concat(h.ERASE_COLOR,", ").concat(h.ERASE_COLOR,", ")+o+")"),r.addColorStop(1,"rgba(".concat(h.ERASE_COLOR,", ").concat(h.ERASE_COLOR,", ").concat(h.ERASE_COLOR,", 0)")),this.context.fillStyle=r,this.context.translate(e-i,t-i),this.context.fillRect(0,0,2*i,2*i),this.context.restore()}},{key:"continueLine",value:function(e,t,i){var n,r,a=this;i=Math.max(0,Math.min(1,i));var s=this.useSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size),o=Math.max(1,Math.max(.5,1-this.opacity)*s*this.spacing),l=function(e){var t=e.t;n=a.lastInput2.pressure*(1-t)+i*t,r=a.useOpacityPressure?a.opacity*n*n:a.opacity,s=a.useSizePressure?Math.max(.1,n*a.size):Math.max(.1,a.size),a.drawDot(e.x,e.y,s,r)};null===e?this.bezierLine.addFinal(o,l):this.bezierLine.add(e,t,o,l)}},{key:"startLine",value:function(e,t,i){this.historyEntry={tool:["brush","EraserBrush"],actions:[{action:"opacityPressure",params:[this.useOpacityPressure]},{action:"sizePressure",params:[this.useSizePressure]},{action:"setSize",params:[this.size]},{action:"setOpacity",params:[this.opacity]},{action:"setTransparentBG",params:[this.isTransparentBG]},{action:"startLine",params:[e,t,i]}]},this.isBaseLayer=0===this.context.canvas.index,i=Math.max(0,Math.min(1,i));var n=this.useOpacityPressure?this.opacity*i*i:this.opacity,r=this.useSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size);this.started=!0,r>1&&this.drawDot(e,t,r,n),this.lastDot=r*this.spacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2=o.BB.copyObj(this.lastInput),this.bezierLine=new o.BB.BezierLine,this.bezierLine.add(e,t,0,(function(){}))}},{key:"goLine",value:function(e,t,i){var n;this.started&&this.historyEntry&&(null===(n=this.historyEntry.actions)||void 0===n||n.push({action:"goLine",params:[e,t,i]}),this.continueLine(e,t,this.lastInput.pressure),this.lastInput2=o.BB.copyObj(this.lastInput),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i)}},{key:"endLine",value:function(){var e;(this.bezierLine&&this.continueLine(null,null,this.lastInput.pressure),this.started=!1,this.bezierLine=void 0,this.historyEntry)&&(null===(e=this.historyEntry.actions)||void 0===e||e.push({action:"endLine",params:[]}),this.history.push(this.historyEntry),this.historyEntry=void 0)}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.isBaseLayer=0===this.context.canvas.index,this.lastInput.x=i,this.lastInput.y=n,!this.started&&void 0!==e){var r,a=Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2)),s=(i-e)/a,o=(n-t)/a,l=Math.max(1,Math.max(.5,1-this.opacity)*this.size*this.spacing);for(this.lastDot=0,r=this.lastDot;r<=a;r+=l)this.drawDot(e+s*r,t+o*r,this.size,this.opacity);var h={tool:["brush","EraserBrush"],actions:[{action:"opacityPressure",params:[this.useOpacityPressure]},{action:"sizePressure",params:[this.useSizePressure]},{action:"setSize",params:[this.size]},{action:"setOpacity",params:[this.opacity]},{action:"setTransparentBG",params:[this.isTransparentBG]},{action:"drawLineSegment",params:[e,t,i,n]}]};this.history.push(h)}}},{key:"isDrawing",value:function(){return this.started}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.history=e}},{key:"setSize",value:function(e){this.size=e}},{key:"setOpacity",value:function(e){this.opacity=e}},{key:"sizePressure",value:function(e){this.useSizePressure=e}},{key:"opacityPressure",value:function(e){this.useOpacityPressure=e}},{key:"setTransparentBG",value:function(e){this.isTransparentBG=!!e}},{key:"getSize",value:function(){return this.size}},{key:"getOpacity",value:function(){return this.opacity}}]),e}()})),i.register("ltaBP",(function(t,n){e(t.exports,"SmudgeBrush",(function(){return p}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=i("hrnUX"),h=i("eg83P"),c=256;function u(e,t){for(var i=(t=o.BB.copyObj(t)).brush.size,n=t.brush.center.x,r=t.brush.center.y,a=t.aP.y*e.width+t.aP.x,s=4*(t.bP.y*e.width+t.bP.x-a),l=0,c=i>30?1024:512,u=[],p=0;p<c;p++)u[p]=(Math.random()-.5)/1.001+.5;var d=Math.max(3,Math.min(8,t.brush.size-8)),g=function(a,s,p,g){var f=o.BB.dist(n,r,p,g),v=1-t.brush.opacity*(1-(0,h.clamp)((f-(i-d))/d,0,1));if(1!==v){if(e.data[a+3])if(e.data[s+3]){var m;m=e.data[a+3]<e.data[s+3]?1-e.data[a+3]/e.data[s+3]*(1-v):e.data[s+3]/e.data[a+3]*v,e.data[s]=Math.floor(o.BB.mix(e.data[a],e.data[s+0],m)+u[l]),e.data[s+1]=Math.floor(o.BB.mix(e.data[a+1],e.data[s+1],m)+u[l]),e.data[s+2]=Math.floor(o.BB.mix(e.data[a+2],e.data[s+2],m)+u[l]),l=(l+1)%c}else e.data[s]=e.data[a+0],e.data[s+1]=e.data[a+1],e.data[s+2]=e.data[a+2];else;t.brush.alphaLock||(e.data[s+3]=Math.floor(o.BB.mix(e.data[a+3],e.data[s+3],v)+.5))}},f=4*t.bP.x,v=f+4*(t.size.w-1);if(t.aP.y<t.bP.y)for(var m=t.size.h-1,y=t.bP.y+t.size.h-1;m>=0;m--,y--)for(var x=(m+t.bP.y)*e.width*4,B=v+x,b=v+x-s,w=t.bP.x+t.size.w-1;B>=f+x;B-=4,b-=4,w--)g(b,B,w,y);else if(t.aP.y>t.bP.y)for(var k=0,C=t.bP.y;k<t.size.h;k++,C++)for(var S=(k+t.bP.y)*e.width*4,L=v+S,A=v+S-s,I=t.bP.x+t.size.w-1;L>=f+S;L-=4,A-=4,I--)g(A,L,I,C);else if(t.aP.x<t.bP.x)for(var E=t.size.h-1,T=t.bP.y+t.size.h-1;E>=0;E--,T--)for(var M=(E+t.bP.y)*e.width*4,P=v+M,O=v+M-s,R=t.bP.x+t.size.w-1;P>=f+M;P-=4,O-=4,R--)g(O,P,R,T);else for(var D=0,N=t.bP.y;D<t.size.h;D++,N++)for(var z=(D+t.bP.y)*e.width*4,j=f+z,G=f+z-s,H=t.bP.x;j<v+z;j+=4,G+=4,H++)g(G,j,H,N)}var p=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"history",new l.KL.DecoyKlHistory),(0,s.default)(this,"settingColor",{r:0,g:0,b:0}),(0,s.default)(this,"settingSize",35),(0,s.default)(this,"settingSpacing",.20446882736951905),(0,s.default)(this,"settingOpacity",.8),(0,s.default)(this,"settingHasSizePressure",!1),(0,s.default)(this,"settingHasOpacityPressure",!1),(0,s.default)(this,"settingLockLayerAlpha",!1),(0,s.default)(this,"lastInput",{x:0,y:0,pressure:0}),(0,s.default)(this,"lastInput2",{x:0,y:0,pressure:0}),(0,s.default)(this,"isDrawing",!1),(0,s.default)(this,"bezierLine",null),(0,s.default)(this,"drawBuffer",[])}return(0,a.default)(e,[{key:"updateRedrawBounds",value:function(e){this.redrawBounds=o.BB.updateBounds(this.redrawBounds,e)}},{key:"updateCompleteRedrawBounds",value:function(e,t,i,n){this.completeRedrawBounds=o.BB.updateBounds(this.completeRedrawBounds,{x1:e,y1:t,x2:i,y2:n})}},{key:"copyFromCanvas",value:function(){var e=this,t=this.copiedCells.map((function(e){return!1})),i=[],n=Math.ceil(this.copyImageData.width/c);this.redrawBounds&&(i.push({x1:Math.floor(this.redrawBounds.x1/c),y1:Math.floor(this.redrawBounds.y1/c),x2:Math.floor(this.redrawBounds.x2/c),y2:Math.floor(this.redrawBounds.y2/c)}),i.forEach((function(e){for(var i=e.x1;i<=e.x2;i++)for(var r=e.y1;r<=e.y2;r++)t[r*n+i]=!0})),t.forEach((function(t,i){if(t&&!e.copiedCells[i]){e.copiedCells[i]=!0;var r=i%n,a=Math.floor(i/n),s=(Math.min(r*c+c,e.copyImageData.width)-1)%c+1,l=(Math.min(a*c+c,e.copyImageData.height)-1)%c+1,h=o.BB.canvas(s,l),u=o.BB.ctx(h);u.drawImage(e.context.canvas,-r*c,-a*c);for(var p=u.getImageData(0,0,s,l),d=0;d<l;d++)for(var g=0,f=d*s*4,v=4*((a*c+d)*e.copyImageData.width+r*c);g<s;g++,f+=4,v+=4)e.copyImageData.data[v]=p.data[f],e.copyImageData.data[v+1]=p.data[f+1],e.copyImageData.data[v+2]=p.data[f+2],e.copyImageData.data[v+3]=p.data[f+3]}})))}},{key:"prepDot",value:function(e,t,i,n){if(this.lastDot){i=Math.round(i);var r=Math.round(2*i),a=Math.round(2*i),s=function(e,t,i,n,r){if(i.x===n.x&&i.y===n.y)return null;i=o.BB.copyObj(i),n=o.BB.copyObj(n),r=o.BB.copyObj(r);var a=0,s=0,l=0,h=0;return i.x<0&&(h=-i.x),i.y<0&&(a=-i.y),n.x<0&&(h=Math.max(h,-n.x)),n.y<0&&(a=Math.max(a,-n.y)),i.x+r.w>e&&(s=i.x+r.w-e),i.y+r.h>t&&(l=i.y+r.h-t),n.x+r.w>e&&(s=Math.max(s,n.x+r.w-e)),n.y+r.h>t&&(l=Math.max(l,n.y+r.h-t)),i.x+=h,n.x+=h,i.y+=a,n.y+=a,r.w=r.w-h-s,r.h=r.h-a-l,r.w<=0||r.h<=0?null:{aP:{x:i.x,y:i.y},bP:{x:n.x,y:n.y},size:{w:r.w,h:r.h}}}(this.copyImageData.width,this.copyImageData.height,{x:Math.round(this.lastDot.x-i),y:Math.round(this.lastDot.y-i)},{x:Math.round(e-i),y:Math.round(t-i)},{w:r,h:a});if(s){var l={aP:s.aP,bP:s.bP,size:s.size,brush:{center:{x:e,y:t},size:i,opacity:n,alphaLock:this.settingLockLayerAlpha}};this.updateRedrawBounds({x1:l.bP.x,y1:l.bP.y,x2:l.bP.x+2*l.brush.size,y2:l.bP.y+2*l.brush.size}),this.drawBuffer.push(l)}this.lastDot={x:e,y:t}}else this.lastDot={x:e,y:t}}},{key:"continueLine",value:function(e,t,i,n){var r=this;this.drawBuffer=[],null===this.bezierLine&&(this.bezierLine=new o.BB.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,(function(){})));var a=[],s=function(e){var t=o.BB.mix(r.lastInput2.pressure,n,e.t),i=r.settingOpacity*(r.settingHasOpacityPressure?t*t:1),s=Math.max(.1,r.settingSize*(r.settingHasSizePressure?t:1));a.push([e.x,e.y,s,i,e.angle])},l=i*this.settingSpacing/3;null===e?this.bezierLine.addFinal(l,s):this.bezierLine.add(e,t,l,s);for(var h=0;h<a.length;h++){var c=a[h];this.prepDot(c[0],c[1],c[2],c[3]),c}this.copyFromCanvas();for(var p=0;p<this.drawBuffer.length;p++)u(this.copyImageData,this.drawBuffer[p])}},{key:"startLine",value:function(e,t,i){this.historyEntry={tool:["brush","SmudgeBrush"],actions:[]},i=o.BB.clamp(i,0,1);var n=this.settingHasOpacityPressure?this.settingOpacity*i*i:this.settingOpacity,r=this.settingHasSizePressure?Math.max(.1,i*this.settingSize):Math.max(.1,this.settingSize);this.lastDot=null,this.isDrawing=!0,this.copyImageData=new ImageData(this.context.canvas.width,this.context.canvas.height);var a=Math.ceil(this.context.canvas.width/c)*Math.ceil(this.context.canvas.height/c);this.copiedCells="0".repeat(a).split("").map((function(e){return!1})),this.prepDot(e,t,r,n),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2.pressure=i,this.completeRedrawBounds=null}},{key:"goLine",value:function(e,t,i){if(this.isDrawing){this.redrawBounds=null;var n=o.BB.clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(e,t,r,this.lastInput.pressure),this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1-1,this.redrawBounds.y2-this.redrawBounds.y1-1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.lastInput.x=e,this.lastInput.y=t,this.lastInput2.pressure=this.lastInput.pressure,this.lastInput.pressure=n}}},{key:"endLine",value:function(){this.redrawBounds=null;var e=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);if(this.context.save(),this.continueLine(null,null,e,this.lastInput.pressure),this.context.restore(),this.isDrawing=!1,this.bezierLine=null,this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1-1,this.redrawBounds.y2-this.redrawBounds.y1-1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.historyEntry&&this.completeRedrawBounds){var t=this.copyImageData;if(!(0===this.completeRedrawBounds.x1&&0===this.completeRedrawBounds.y1&&this.completeRedrawBounds.x2>=this.context.canvas.width-1&&this.completeRedrawBounds.y2>=this.context.canvas.height-1)){var i=o.BB.canvas(this.completeRedrawBounds.x2-this.completeRedrawBounds.x1+1,this.completeRedrawBounds.y2-this.completeRedrawBounds.y1+1);o.BB.ctx(i).drawImage(this.context.canvas,-this.completeRedrawBounds.x1,-this.completeRedrawBounds.y1),t=i}this.historyEntry.actions.push({action:"drawImage",params:[t,this.completeRedrawBounds.x1,this.completeRedrawBounds.y1]}),this.history.push(this.historyEntry),this.historyEntry=void 0}this.copyImageData=null}},{key:"drawImage",value:function(e,t,i){e instanceof ImageData?this.context.putImageData(e,t,i):(this.context.clearRect(t,i,e.width,e.height),this.context.drawImage(e,t,i))}},{key:"drawLineSegment",value:function(e,t,i,n){}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"setColor",value:function(e){this.settingColor.r===e.r&&this.settingColor.g===e.g&&this.settingColor.b===e.b||(this.settingColor={r:e.r,g:e.g,b:e.b},this.settingColorStr=o.BB.ColorConverter.toRgbStr(this.settingColor))}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.history=e}},{key:"setSize",value:function(e){this.settingSize=e}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setSpacing",value:function(e){this.settingSpacing=e}},{key:"sizePressure",value:function(e){this.settingHasSizePressure=!!e}},{key:"opacityPressure",value:function(e){this.settingHasOpacityPressure=!!e}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=!!e}},{key:"getSpacing",value:function(){return this.settingSpacing}},{key:"getSize",value:function(){return this.settingSize}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}}]),e}()})),i.register("6Nq1H",(function(t,n){e(t.exports,"ChemyBrush",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("3Rl3W"),l=i("eWjiX"),h=i("fohxs"),c=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"settingSize",.25),(0,s.default)(this,"settingOpacity",1),(0,s.default)(this,"settingLockLayerAlpha",!1),(0,s.default)(this,"settingIsEraser",!1),(0,s.default)(this,"settingMode","fill"),(0,s.default)(this,"settingDistort",0),(0,s.default)(this,"settingXSymmetry",!1),(0,s.default)(this,"settingYSymmetry",!1),(0,s.default)(this,"settingGradient",!1),(0,s.default)(this,"isDrawing",!1)}return(0,a.default)(e,[{key:"updateCompleteRedrawBounds",value:function(e,t){var i={x1:e,y1:t,x2:e,y2:t};this.settingXSymmetry&&(i=l.BB.updateBounds(i,{x1:-e+this.copyCanvas.width,y1:t,x2:-e+this.copyCanvas.width,y2:t})),this.settingYSymmetry&&(i=l.BB.updateBounds(i,{x1:e,y1:-t+this.copyCanvas.height,x2:e,y2:-t+this.copyCanvas.height}));var n="stroke"===this.settingMode?this.settingSize+1:1;i.x1=Math.floor(i.x1-n),i.y1=Math.floor(i.y1-n),i.x2=Math.ceil(i.x2+n),i.y2=Math.ceil(i.y2+n),this.completeRedrawBounds=l.BB.updateBounds(this.completeRedrawBounds,i)}},{key:"drawShape",value:function(){var e=this;this.context.save(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.drawImage(this.copyCanvas,0,0);var t=(0,o.default)({},this.settingColor);if(this.settingIsEraser?(t.r=h.ERASE_COLOR,t.g=h.ERASE_COLOR,t.b=h.ERASE_COLOR,this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop"),this.path){var i=new Path2D;this.path.forEach((function(e,t){0===t?i.moveTo(e.x,e.y):i.lineTo(e.x,e.y)}));var n=l.BB.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:this.settingOpacity});if(this.settingGradient){var r=this.path[0].x>this.path[this.path.length-1].x,a=this.context.createLinearGradient(0,r?this.minY:this.maxY,0,r?this.maxY:this.minY);a.addColorStop(0,l.BB.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:this.settingOpacity})),a.addColorStop(1,l.BB.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:0})),n=a}"fill"===this.settingMode?this.context.fillStyle=n:(this.context.lineWidth=2*this.settingSize,this.context.lineJoin="bevel",this.context.strokeStyle=n);var s=function(){"fill"===e.settingMode?e.context.fill(i):e.context.stroke(i)};s(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,0),this.context.scale(-1,1),this.context.translate(-this.context.canvas.width/2,0),s(),this.context.restore()),this.settingYSymmetry&&(this.context.save(),this.context.translate(0,this.context.canvas.height/2),this.context.scale(1,-1),this.context.translate(0,-this.context.canvas.height/2),s(),this.context.restore(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,this.context.canvas.height/2),this.context.scale(-1,-1),this.context.translate(-this.context.canvas.width/2,-this.context.canvas.height/2),s(),this.context.restore()))}this.context.restore()}},{key:"setHistory",value:function(e){this.history=e}},{key:"getSize",value:function(){return"stroke"===this.settingMode?this.settingSize:0}},{key:"setSize",value:function(e){this.settingSize=e}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setColor",value:function(e){this.settingColor=l.BB.copyObj(e)}},{key:"setContext",value:function(e){this.context=e}},{key:"setMode",value:function(e){this.settingMode=e}},{key:"getMode",value:function(){return this.settingMode}},{key:"setDistort",value:function(e){this.settingDistort=l.BB.clamp(e,0,1)}},{key:"getDistort",value:function(){return this.settingDistort}},{key:"setXSymmetry",value:function(e){this.settingXSymmetry=!!e}},{key:"getXSymmetry",value:function(){return this.settingXSymmetry}},{key:"setYSymmetry",value:function(e){this.settingYSymmetry=!!e}},{key:"getYSymmetry",value:function(){return this.settingYSymmetry}},{key:"setGradient",value:function(e){this.settingGradient=!!e}},{key:"getGradient",value:function(){return this.settingGradient}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=!!e}},{key:"getIsEraser",value:function(){return this.settingIsEraser}},{key:"setIsEraser",value:function(e){this.settingIsEraser=!!e}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"startLine",value:function(e,t){this.isDrawing=!0,this.path=[{x:e,y:t}],this.minY=t,this.maxY=t,this.copyCanvas=l.BB.canvas(this.context.canvas.width,this.context.canvas.height),l.BB.ctx(this.copyCanvas).drawImage(this.context.canvas,0,0),this.completeRedrawBounds=null,this.updateCompleteRedrawBounds(e,t)}},{key:"goLine",value:function(e,t){if(this.isDrawing){var i={x:e,y:t};this.settingDistort>0&&(i.x+=(Math.random()-.5)*this.settingDistort*80,i.y+=(Math.random()-.5)*this.settingDistort*80),this.minY=Math.min(this.minY,i.y),this.maxY=Math.max(this.maxY,i.y),this.path.push(i),this.updateCompleteRedrawBounds(e,t),this.drawShape()}}},{key:"endLine",value:function(){if(this.isDrawing=!1,this.completeRedrawBounds=l.BB.boundsInArea(this.completeRedrawBounds,this.copyCanvas.width,this.copyCanvas.height),this.path.length>1&&this.completeRedrawBounds){var e=l.BB.canvas(this.completeRedrawBounds.x2-this.completeRedrawBounds.x1+1,this.completeRedrawBounds.y2-this.completeRedrawBounds.y1+1);l.BB.ctx(e).drawImage(this.context.canvas,-this.completeRedrawBounds.x1,-this.completeRedrawBounds.y1),this.history.push({tool:["brush","ChemyBrush"],actions:[{action:"drawImage",params:[e,this.completeRedrawBounds.x1,this.completeRedrawBounds.y1]}]})}this.path=null,this.copyCanvas=null}},{key:"drawImage",value:function(e,t,i){this.context.save(),this.context.clearRect(t,i,e.width,e.height),this.context.drawImage(e,t,i),this.context.restore()}},{key:"drawLineSegment",value:function(e,t,i,n){}}]),e}()})),i.register("3P46L",(function(t,n){e(t.exports,"brushesUI",(function(){return u}));var r=i("cVFne"),a=i("9mjXI"),s=i("iYbUv"),o=i("brjBD"),l=i("9rc5F"),h=i("dS2qM"),c=i("vCnsd"),u={penBrush:r.penBrushUi,blendBrush:a.blendBrushUi,sketchyBrush:s.sketchyBrushUi,pixelBrush:o.pixelBrushUi,chemyBrush:c.chemyBrushUi,smudgeBrush:h.smudgeBrushUi,eraserBrush:l.eraserBrushUi}})),i.register("cVFne",(function(n,r){e(n.exports,"penBrushUi",(function(){return y}));var a,s,o=i("eWjiX"),l=i("dAXbp"),h=i("7NTKy"),c=i("gWfkn"),u=i("7bWhB"),p=i("aP0jf"),d=i("lCF5N"),g=i("iEKHy"),f=i("74D3O"),v=i("1mH1z"),m=i("iFIyy"),y=(a={image:t(g),tooltip:(0,v.LANG)("brush-pen"),sizeSlider:{min:.5,max:100,curve:o.BB.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]},Ui:null},s=[(0,v.LANG)("brush-pen-circle"),(0,v.LANG)("brush-pen-chalk"),(0,v.LANG)("brush-pen-calligraphy"),(0,v.LANG)("brush-pen-square")],v.languageStrings.subscribe((function(){a.tooltip=(0,v.LANG)("brush-pen"),s=[(0,v.LANG)("brush-pen-circle"),(0,v.LANG)("brush-pen-chalk"),(0,v.LANG)("brush-pen-calligraphy"),(0,v.LANG)("brush-pen-square")]})),a.Ui=function(e){var t,i,n=function(e){g.setSize(e),g.setSpacing(Math.max(2,B.interpolate(e))/15)},r=document.createElement("div"),g=new l.brushes.PenBrush;g.setHistory(c.klHistory),e.onSizeChange(g.getSize());var y=new(0,m.Options)({optionArr:[0,1,2,3].map((function(e){var t=o.BB.el({className:"dark-invert",css:{width:"31px",height:"31px",backgroundSize:"contain",margin:"2px"}}),i=o.BB.canvas(70,70),n=o.BB.ctx(i);return 0===e||3===e?0===e?(n.beginPath(),n.arc(35,35,30,0,2*Math.PI),n.closePath(),n.fill()):n.fillRect(5,5,60,60):1===e?n.drawImage((0,f.genBrushAlpha01)(60),5,5):2===e&&n.drawImage((0,f.genBrushAlpha02)(60),5,5),t.style.backgroundImage="url("+i.toDataURL("image/png")+")",{id:e,label:t,title:s[e]}})),initId:0,onChange:function(e){g.setAlpha(e)}}),x=new(0,u.Checkbox)({init:g.getLockAlpha(),label:(0,v.LANG)("lock-alpha"),callback:function(e){g.setLockAlpha(e)},doHighlight:!0,title:(0,v.LANG)("lock-alpha-title"),css:{display:"inline-block"}}),B=new o.BB.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);!function(){t=new(0,p.KlSlider)({label:(0,v.LANG)("brush-size"),width:225,height:30,min:a.sizeSlider.min,max:a.sizeSlider.max,value:g.getSize(),curve:a.sizeSlider.curve,eventResMs:h.eventResMs,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){n(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?o.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),i=new(0,p.KlSlider)({label:(0,v.LANG)("opacity"),width:225,height:30,min:a.opacitySlider.min,max:a.opacitySlider.max,value:a.opacitySlider.max,curve:a.opacitySlider.curve,eventResMs:h.eventResMs,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){g.setOpacity(t),e.onOpacityChange(t)}});var s=(0,d.createPenPressureToggle)(!0,(function(e){g.sizePressure(e)})),l=(0,d.createPenPressureToggle)(!1,(function(e){g.opacityPressure(e)}));r.append(o.BB.el({content:[t.getElement(),s],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),o.BB.el({content:[i.getElement(),l],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),o.BB.el({content:y.getElement(),css:{marginTop:"10px"}}),o.BB.el({content:x.getElement(),css:{marginTop:"10px"}}))}(),this.increaseSize=function(e){g.isDrawing()||t.changeSliderValue(e)},this.decreaseSize=function(e){g.isDrawing()||t.changeSliderValue(-e)},this.getSize=function(){return g.getSize()},this.setSize=function(e){n(e),t.setValue(e)},this.getOpacity=function(){return g.getOpacity()},this.setOpacity=function(e){g.setOpacity(e),i.setValue(e)},this.setColor=function(e){g.setColor(e)},this.setContext=function(e){g.setContext(e)},this.startLine=function(e,t,i){g.startLine(e,t,i)},this.goLine=function(e,t,i){g.goLine(e,t,i)},this.endLine=function(e,t){g.endLine(e,t)},this.getBrush=function(){return g},this.isDrawing=function(){return g.isDrawing()},this.getElement=function(){return r}},a)})),i.register("7NTKy",(function(t,i){e(t.exports,"eventResMs",(function(){return n}));var n=20})),i.register("iEKHy",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("6218s")})),i.register("9mjXI",(function(n,r){e(n.exports,"blendBrushUi",(function(){return f}));var a,s=i("eWjiX"),o=i("lCF5N"),l=i("7NTKy"),h=i("7bWhB"),c=i("dAXbp"),u=i("gWfkn"),p=i("aP0jf"),d=i("jxqXH"),g=i("1mH1z"),f=(a={image:t(d),tooltip:(0,g.LANG)("brush-blend"),sizeSlider:{min:.5,max:100,curve:s.BB.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1},Ui:null},g.languageStrings.subscribe((function(){a.tooltip=(0,g.LANG)("brush-blend")})),a.Ui=function(e){var t,i,n=function(e){d.setSize(e)},r=document.createElement("div"),d=new c.brushes.BlendBrush;d.setHistory(u.klHistory),e.onSizeChange(d.getSize()),function(){t=new(0,p.KlSlider)({label:(0,g.LANG)("brush-size"),width:225,height:30,min:a.sizeSlider.min,max:a.sizeSlider.max,value:58,curve:a.sizeSlider.curve,eventResMs:l.eventResMs,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){n(t),e.onSizeChange(t)}}),i=new(0,p.KlSlider)({label:(0,g.LANG)("opacity"),width:225,height:30,min:a.opacitySlider.min,max:a.opacitySlider.max,value:d.getOpacity(),curve:a.opacitySlider.curve,eventResMs:l.eventResMs,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){d.setOpacity(t),e.onOpacityChange(t)}});var c=new(0,p.KlSlider)({label:(0,g.LANG)("brush-blending"),width:225,height:30,min:0,max:1,value:d.getBlending(),eventResMs:l.eventResMs,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(e){d.setBlending(e)}});c.getElement().style.marginTop="10px";var u=(0,o.createPenPressureToggle)(!0,(function(e){d.setSizePressure(e)})),f=(0,o.createPenPressureToggle)(!1,(function(e){d.setOpacityPressure(e)})),v=new(0,h.Checkbox)({init:d.getLockAlpha(),label:(0,g.LANG)("lock-alpha"),callback:function(e){d.setLockAlpha(e)},doHighlight:!0,title:(0,g.LANG)("lock-alpha-title"),css:{marginTop:"10px",display:"inline-block"}});r.append(s.BB.el({content:[t.getElement(),u],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),s.BB.el({content:[i.getElement(),f],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),c.getElement(),v.getElement())}(),this.increaseSize=function(e){d.getIsDrawing()||t.changeSliderValue(e)},this.decreaseSize=function(e){d.getIsDrawing()||t.changeSliderValue(-e)},this.getSize=function(){return d.getSize()},this.setSize=function(e){n(e),t.setValue(e)},this.getOpacity=function(){return d.getOpacity()},this.setOpacity=function(e){d.setOpacity(e),i.setValue(e)},this.setColor=function(e){d.setColor(e)},this.setContext=function(e){d.setContext(e)},this.startLine=function(e,t,i){d.startLine(e,t,i)},this.goLine=function(e,t,i,n){d.goLine(e,t,i,n)},this.endLine=function(){d.endLine()},this.getBrush=function(){return d},this.isDrawing=function(){return d.getIsDrawing()},this.getElement=function(){return r}},a)})),i.register("jxqXH",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("50oCU")})),i.register("iYbUv",(function(n,r){e(n.exports,"sketchyBrushUi",(function(){return d}));var a,s=i("dAXbp"),o=i("7NTKy"),l=i("gWfkn"),h=i("aP0jf"),c=i("1SGPc"),u=i("1mH1z"),p=i("eWjiX"),d=(a={image:t(c),tooltip:(0,u.LANG)("brush-sketchy"),sizeSlider:{min:.5,max:10},opacitySlider:{min:.01,max:1},Ui:null},u.languageStrings.subscribe((function(){a.tooltip=(0,u.LANG)("brush-sketchy")})),a.Ui=function(e){var t,i,n=document.createElement("div"),r=new s.brushes.SketchyBrush;r.setHistory(l.klHistory),e.onSizeChange(r.getSize()),function(){t=new(0,h.KlSlider)({label:(0,u.LANG)("brush-size"),width:250,height:30,min:a.sizeSlider.min,max:a.sizeSlider.max,value:2*r.getSize(),eventResMs:o.eventResMs,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){r.setSize(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?p.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),i=new(0,h.KlSlider)({label:(0,u.LANG)("opacity"),width:250,height:30,min:a.opacitySlider.min,max:a.opacitySlider.max,value:r.getOpacity(),eventResMs:o.eventResMs,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){r.setOpacity(t),e.onOpacityChange(t)}});var s=new(0,h.KlSlider)({label:(0,u.LANG)("brush-blending"),width:250,height:30,min:0,max:1,value:r.getBlending(),eventResMs:o.eventResMs,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(e){r.setBlending(e)}}),l=new(0,h.KlSlider)({label:(0,u.LANG)("brush-sketchy-scale"),width:250,height:30,min:1,max:20,value:r.getScale(),eventResMs:o.eventResMs,onChange:function(e){r.setScale(e)}});i.getElement().style.marginTop="10px",s.getElement().style.marginTop="10px",l.getElement().style.marginTop="10px",n.append(t.getElement(),i.getElement(),s.getElement(),l.getElement())}(),this.increaseSize=function(e){r.isDrawing()||t.changeSliderValue(e)},this.decreaseSize=function(e){r.isDrawing()||t.changeSliderValue(-e)},this.getSize=function(){return r.getSize()},this.setSize=function(e){!function(e){r.setSize(e)}(e),t.setValue(e)},this.getOpacity=function(){return r.getOpacity()},this.setOpacity=function(e){r.setOpacity(e),i.setValue(e)},this.setColor=function(e){r.setColor(e)},this.setContext=function(e){r.setContext(e)},this.startLine=function(e,t,i){r.startLine(e,t,i)},this.goLine=function(e,t,i){r.goLine(e,t,i,null)},this.endLine=function(){r.endLine()},this.getSeed=function(){return parseInt(r.getSeed())},this.setSeed=function(e){r.setSeed(parseInt(e))},this.getBrush=function(){return r},this.isDrawing=function(){return r.isDrawing()},this.getElement=function(){return n}},a)})),i.register("1SGPc",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("jDYzC")})),i.register("brjBD",(function(n,r){e(n.exports,"pixelBrushUi",(function(){return f}));var a,s=i("eWjiX"),o=i("dAXbp"),l=i("7NTKy"),h=i("gWfkn"),c=i("7bWhB"),u=i("aP0jf"),p=i("lCF5N"),d=i("1qfk4"),g=i("1mH1z"),f=(a={image:t(d),tooltip:(0,g.LANG)("brush-pixel"),sizeSlider:{min:.5,max:100,curve:s.BB.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]},Ui:null},g.languageStrings.subscribe((function(){a.tooltip=(0,g.LANG)("brush-pixel")})),a.Ui=function(e){var t,i,n=function(e){d.setSize(e),d.setSpacing(y.interpolate(e)/e)},r=document.createElement("div"),d=new o.brushes.PixelBrush;d.setHistory(h.klHistory),e.onSizeChange(d.getSize());var f=new(0,c.Checkbox)({init:d.getLockAlpha(),label:(0,g.LANG)("lock-alpha"),callback:function(e){d.setLockAlpha(e)},doHighlight:!0,title:(0,g.LANG)("lock-alpha-title"),css:{marginRight:"10px"}}),v=new(0,c.Checkbox)({init:d.getIsEraser(),label:(0,g.LANG)("eraser"),callback:function(e){d.setIsEraser(e)},css:{marginRight:"10px"}}),m=new(0,c.Checkbox)({init:d.getUseDither(),label:(0,g.LANG)("brush-pixel-dither"),callback:function(e){d.setUseDither(e)}}),y=new s.BB.SplineInterpolator([[.5,.45],[100,4]]);!function(){t=new(0,u.KlSlider)({label:(0,g.LANG)("brush-size"),width:225,height:30,min:a.sizeSlider.min,max:a.sizeSlider.max,value:d.getSize(),curve:a.sizeSlider.curve,eventResMs:l.eventResMs,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){n(t),e.onSizeChange(t)}}),i=new(0,u.KlSlider)({label:(0,g.LANG)("opacity"),width:225,height:30,min:a.opacitySlider.min,max:a.opacitySlider.max,value:a.opacitySlider.max,eventResMs:l.eventResMs,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){d.setOpacity(t),e.onOpacityChange(t)}});var o=(0,p.createPenPressureToggle)(!0,(function(e){d.sizePressure(e)}));r.append(s.BB.el({content:[t.getElement(),o],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),i.getElement()),s.BB.el({parent:r,css:{display:"flex",marginTop:"10px"}}).append(f.getElement(),v.getElement(),m.getElement())}(),this.increaseSize=function(e){d.isDrawing()||t.changeSliderValue(e)},this.decreaseSize=function(e){d.isDrawing()||t.changeSliderValue(-e)},this.getSize=function(){return d.getSize()},this.setSize=function(e){n(e),t.setValue(2*e)},this.getOpacity=function(){return d.getOpacity()},this.setOpacity=function(e){d.setOpacity(e),i.setValue(100*e)},this.setColor=function(e){d.setColor(e)},this.setContext=function(e){d.setContext(e)},this.startLine=function(e,t,i){d.startLine(e,t,i)},this.goLine=function(e,t,i){d.goLine(e,t,i)},this.endLine=function(e,t){d.endLine(e,t)},this.getBrush=function(){return d},this.isDrawing=function(){return d.isDrawing()},this.getElement=function(){return r}},a)})),i.register("1qfk4",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("j07R3")})),i.register("9rc5F",(function(n,r){e(n.exports,"eraserBrushUi",(function(){return f}));var a,s=i("eWjiX"),o=i("dAXbp"),l=i("7NTKy"),h=i("gWfkn"),c=i("aP0jf"),u=i("lCF5N"),p=i("7bWhB"),d=i("6kk87"),g=i("1mH1z"),f=(a={image:t(d),tooltip:(0,g.LANG)("eraser")+" [E]",sizeSlider:{min:.5,max:200,curve:s.BB.quadraticSplineInput(.5,200,.1)},opacitySlider:{min:.01,max:1},Ui:null},g.languageStrings.subscribe((function(){a.tooltip=(0,g.LANG)("eraser")+" [E]"})),a.Ui=function(e){var t,i,n=function(e){d.setSize(e)},r=document.createElement("div"),d=new o.brushes.EraserBrush;d.setHistory(h.klHistory),e.onSizeChange(d.getSize());var f=!1;!function(){t=new(0,c.KlSlider)({label:(0,g.LANG)("brush-size"),width:225,height:30,min:a.sizeSlider.min,max:a.sizeSlider.max,value:30,curve:a.sizeSlider.curve,eventResMs:l.eventResMs,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){n(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?s.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),i=new(0,c.KlSlider)({label:(0,g.LANG)("opacity"),width:225,height:30,min:a.opacitySlider.min,max:a.opacitySlider.max,value:a.opacitySlider.max,eventResMs:l.eventResMs,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){d.setOpacity(t),e.onOpacityChange(t)}});var o=(0,u.createPenPressureToggle)(!0,(function(e){d.sizePressure(e)})),h=(0,u.createPenPressureToggle)(!1,(function(e){d.opacityPressure(e)}));r.append(s.BB.el({content:[t.getElement(),o],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),s.BB.el({content:[i.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}));var v=new(0,p.Checkbox)({init:!1,label:(0,g.LANG)("brush-eraser-transparent-bg"),callback:function(e){f=e,d.setTransparentBG(e)},css:{marginTop:"10px"}});r.append(v.getElement())}(),this.increaseSize=function(e){d.isDrawing()||t.changeSliderValue(e)},this.decreaseSize=function(e){d.isDrawing()||t.changeSliderValue(-e)},this.getSize=function(){return d.getSize()},this.setSize=function(e){n(e),t.setValue(e)},this.getOpacity=function(){return d.getOpacity()},this.setOpacity=function(e){d.setOpacity(e),i.setValue(e)},this.setColor=function(e){},this.setContext=function(e){d.setContext(e)},this.startLine=function(e,t,i){d.startLine(e,t,i)},this.goLine=function(e,t,i){d.goLine(e,t,i)},this.endLine=function(){d.endLine()},this.getBrush=function(){return d},this.getIsTransparentBg=function(){return f},this.isDrawing=function(){return d.isDrawing()},this.getElement=function(){return r}},a)})),i.register("6kk87",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("fvqmo")})),i.register("dS2qM",(function(n,r){e(n.exports,"smudgeBrushUi",(function(){return f}));var a,s=i("eWjiX"),o=i("dAXbp"),l=i("7NTKy"),h=i("gWfkn"),c=i("7bWhB"),u=i("aP0jf"),p=i("lCF5N"),d=i("1rnhH"),g=i("1mH1z"),f=(a={image:t(d),tooltip:(0,g.LANG)("brush-smudge"),sizeSlider:{min:.5,max:100,curve:s.BB.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]},Ui:null},g.languageStrings.subscribe((function(){a.tooltip=(0,g.LANG)("brush-smudge")})),a.Ui=function(e){var t,i,n=function(e){d.setSize(e),d.setSpacing(Math.max(2,v.interpolate(e))/15)},r=document.createElement("div"),d=new o.brushes.SmudgeBrush;d.setHistory(h.klHistory),e.onSizeChange(d.getSize());var f=new(0,c.Checkbox)({init:d.getLockAlpha(),label:(0,g.LANG)("lock-alpha"),callback:function(e){d.setLockAlpha(e)},doHighlight:!0,title:(0,g.LANG)("lock-alpha-title")}),v=new s.BB.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);!function(){t=new(0,u.KlSlider)({label:(0,g.LANG)("brush-size"),width:225,height:30,min:a.sizeSlider.min,max:a.sizeSlider.max,value:d.getSize(),curve:a.sizeSlider.curve,eventResMs:l.eventResMs,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){n(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?s.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),i=new(0,u.KlSlider)({label:(0,g.LANG)("opacity"),width:225,height:30,min:a.opacitySlider.min,max:a.opacitySlider.max,value:d.getOpacity(),curve:a.opacitySlider.curve,eventResMs:l.eventResMs,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){d.setOpacity(t),e.onOpacityChange(t)}});var o=(0,p.createPenPressureToggle)(!1,(function(e){d.sizePressure(e)})),h=(0,p.createPenPressureToggle)(!1,(function(e){d.opacityPressure(e)}));r.append(s.BB.el({content:[t.getElement(),o],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),s.BB.el({content:[i.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}})),s.BB.el({parent:r,css:{marginTop:"10px"}}).append(f.getElement())}(),this.increaseSize=function(e){d.getIsDrawing()||t.changeSliderValue(e)},this.decreaseSize=function(e){d.getIsDrawing()||t.changeSliderValue(-e)},this.getSize=function(){return d.getSize()},this.setSize=function(e){n(e),t.setValue(e)},this.getOpacity=function(){return d.getOpacity()},this.setOpacity=function(e){d.setOpacity(e),i.setValue(e)},this.setColor=function(e){d.setColor(e)},this.setContext=function(e){d.setContext(e)},this.startLine=function(e,t,i){d.startLine(e,t,i)},this.goLine=function(e,t,i){d.goLine(e,t,i)},this.endLine=function(e,t){d.endLine()},this.getBrush=function(){return d},this.isDrawing=function(){return d.getIsDrawing()},this.getElement=function(){return r}},a)})),i.register("1rnhH",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("gNPk4")})),i.register("vCnsd",(function(n,r){e(n.exports,"chemyBrushUi",(function(){return v}));var a,s=i("eWjiX"),o=i("7NTKy"),l=i("7bWhB"),h=i("dAXbp"),c=i("gWfkn"),u=i("aP0jf"),p=i("5rmB7"),d=i("iFIyy"),g=i("cmnov"),f=i("1mH1z"),v=(a={image:t(p),tooltip:(0,f.LANG)("brush-chemy"),sizeSlider:{min:.25,max:25,curve:s.BB.quadraticSplineInput(.25,25,.1),isDisabled:!0},opacitySlider:{min:.01,max:1},Ui:null},f.languageStrings.subscribe((function(){a.tooltip=(0,f.LANG)("brush-chemy")})),a.Ui=function(e){var t,i,n=function(e){p.setSize(e)},r=document.createElement("div"),p=new h.brushes.ChemyBrush;p.setHistory(c.klHistory),e.onSizeChange(p.getSize()),function(){t=new(0,u.KlSlider)({label:(0,f.LANG)("brush-size"),width:250,height:30,min:a.sizeSlider.min,max:a.sizeSlider.max,value:p.getSize(),curve:a.sizeSlider.curve,eventResMs:o.eventResMs,isEnabled:"stroke"===p.getMode(),toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){n(t),e.onSizeChange(t)},formatFunc:function(e){return e<5?s.BB.round(e,1):Math.round(e)},manualInputRoundDigits:1}),i=new(0,u.KlSlider)({label:(0,f.LANG)("opacity"),width:250,height:30,min:a.opacitySlider.min,max:a.opacitySlider.max,value:p.getOpacity(),eventResMs:o.eventResMs,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){p.setOpacity(t),e.onOpacityChange(t)}}),s.BB.css(i.getElement(),{marginTop:"10px"});var h=new(0,l.Checkbox)({init:p.getIsEraser(),label:(0,f.LANG)("eraser"),callback:function(e){p.setIsEraser(e)},css:{marginTop:"10px",marginLeft:"10px"}}),c=new(0,l.Checkbox)({init:p.getLockAlpha(),label:(0,f.LANG)("lock-alpha"),callback:function(e){p.setLockAlpha(e)},doHighlight:!0,title:(0,f.LANG)("lock-alpha-title"),css:{marginTop:"10px"}}),v=s.BB.el({css:{display:"flex",marginTop:"10px"}}),m=19,y=new(0,d.Options)({optionArr:[{id:"fill",label:s.BB.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"#000",style:"transform-origin: 0 0; transform: translate(-0.5px, -0.5px) scale(".concat(m,", ").concat(m,") translate(0.5px, 0.5px)"),d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:(0,f.LANG)("brush-chemy-fill")},{id:"stroke",label:s.BB.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 0.12px; transform-origin: 0 0; transform: translate(-0.5px, -0.5px) scale(".concat(m,", ").concat(m,") translate(0.5px, 0.5px)"),d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:(0,f.LANG)("brush-chemy-stroke")}],initId:p.getMode(),onChange:function(i){p.setMode(i),a.sizeSlider.isDisabled="fill"===p.getMode(),t.setIsEnabled(!a.sizeSlider.isDisabled);var n=p.getSize();t.setValue(n),e.onSizeChange(n),e.onConfigChange()}}),x=new(0,g.BoxToggle)({label:s.BB.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 1px",d:"M ".concat(17.5,",").concat(8," ").concat(17.5,",").concat(27)}]}),title:(0,f.LANG)("brush-chemy-mirror-x"),init:p.getXSymmetry(),onChange:function(e){p.setXSymmetry(e)}}),B=new(0,g.BoxToggle)({label:s.BB.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 1px",d:"M ".concat(8,",").concat(17.5," ").concat(27,",").concat(17.5)}]}),title:(0,f.LANG)("brush-chemy-mirror-y"),init:p.getYSymmetry(),onChange:function(e){p.setYSymmetry(e)}}),b=new(0,g.BoxToggle)({label:s.BB.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"defs",childrenArr:[{elementType:"linearGradient",id:"gradient",x1:"0",y1:"0",x2:"0",y2:"1",childrenArr:[{elementType:"stop",offset:"0%","stop-color":"rgba(0,0,0,0)"},{elementType:"stop",offset:"100%","stop-color":"rgba(0,0,0,1)"}]}]},{elementType:"rect",fill:"url('#gradient')",x:"8",y:"8",width:"19",height:"19"}]}),title:(0,f.LANG)("brush-chemy-gradient"),init:p.getGradient(),onChange:function(e){p.setGradient(e)}});s.BB.css(x.getElement(),{marginLeft:"10px"});var w={marginLeft:"4px"};s.BB.css(B.getElement(),w),s.BB.css(b.getElement(),w),v.append(y.getElement(),x.getElement(),B.getElement(),b.getElement()),r.append(t.getElement(),i.getElement(),v,s.BB.el({content:[c.getElement(),h.getElement()],css:{display:"flex"}}))}(),this.increaseSize=function(e){p.getIsDrawing()||"stroke"!==p.getMode()||t.changeSliderValue(e)},this.decreaseSize=function(e){p.getIsDrawing()||"stroke"!==p.getMode()||t.changeSliderValue(-e)},this.getSize=function(){return p.getSize()},this.setSize=function(e){n(e),t.setValue(e)},this.getOpacity=function(){return p.getOpacity()},this.setOpacity=function(e){p.setOpacity(e),i.setValue(e)},this.setColor=function(e){p.setColor(e)},this.setContext=function(e){p.setContext(e)},this.startLine=function(e,t,i){p.startLine(e,t)},this.goLine=function(e,t,i,n){p.goLine(e,t)},this.endLine=function(){p.endLine()},this.getBrush=function(){return p},this.isDrawing=function(){return p.getIsDrawing()},this.getElement=function(){return r}},a)})),i.register("5rmB7",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("371uF")})),i.register("h62LS",(function(t,n){e(t.exports,"showIframeModal",(function(){return o}));var r=i("eWjiX"),a=i("dLlkc"),s=i("1mH1z");function o(e,t){if(t||!(window.innerHeight<500||window.innerWidth<700)){var i=r.BB.el({tagName:"iframe",custom:{src:e},css:{width:"100%",height:"100%",opacity:"0"}});setTimeout((function(){i.style.opacity=""}),500);var n,o=r.BB.el();t||(n=r.BB.el({tagName:"a",parent:o,content:(0,s.LANG)("modal-new-tab"),custom:{href:"help",target:"_blank"},onClick:function(){l.close()}}),i.onload=function(){n&&i.contentWindow&&r.BB.setAttributes(n,{href:""+i.contentWindow.location}),i.style.opacity=""});var l=new(0,a.DynamicModal)({title:o,content:i,width:880,isMaxHeight:!0,onClose:function(){n&&(i.src="about:blank",r.BB.destroyEl(n),n=void 0)}})}else window.open(e)}})),i.register("fRGIf",(function(t,n){e(t.exports,"RadioList",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=function(){"use strict";function e(t){var i=t.name,n=t.init,a=t.items,l=t.ignoreFocus,h=this;(0,r.default)(this,e),(0,s.default)(this,"inputs",[]),this.el=o.BB.el({className:"kl-radio"}),a.forEach((function(e){var t=o.BB.el({tagName:"label"}),r=o.BB.el({tagName:"input",parent:t,custom:{name:i,value:e.value,type:"radio"}});l&&r.setAttribute("data-ignore-focus","true"),n===e.value&&(r.checked=!0),t.append(e.label),h.el.append(t),h.inputs.push(r)}))}return(0,a.default)(e,[{key:"getValue",value:function(){for(var e=0;e<this.inputs.length;e++)if(this.inputs[e].checked)return this.inputs[e].value;return null}},{key:"getElement",value:function(){return this.el}}]),e}()})),i.register("9pcu9",(function(n,r){e(n.exports,"BrowserStorageUi",(function(){return f}));var a=i("3kC7t"),s=i("gFgFC"),o=i("kiQ5H"),l=i("2gUX3"),h=i("eWjiX"),c=i("auzYC"),u=i("h62LS"),p=i("hrnUX"),d=i("1mH1z"),g=i("1C8RU"),f=function(){"use strict";function e(i,n,r,o,p){var f,v=this;(0,s.default)(this,e),this.projectStore=i,this.getProject=n,this.saveReminder=r,this.klRootEl=o,this.options=p,this.element=h.BB.el({css:{display:"grid",gridTemplateColumns:"1fr 0fr",gridTemplateRows:"0fr 0fr 0fr",gap:"0 0",gridTemplateAreas:'"title title" "preview store" "preview clear"'}});var m=h.BB.el({parent:this.element,content:(0,d.LANG)("file-storage"),css:{gridArea:"title",display:"flex",margin:"-5px 0"}});if(this.infoEl=h.BB.el({parent:m,content:"?",className:"kl-storage-about",title:(0,d.LANG)("file-storage-about"),onClick:function(){(0,u.showIframeModal)("./help/#help-browser-storage",!1)}}),this.projectStore.isBroken())h.BB.el({parent:this.element,content:"🔴 "+(0,d.LANG)("file-storage-cant-access"),css:{marginTop:"10px"}});else{this.previewEl=h.BB.el({parent:this.element,title:(0,d.LANG)("file-storage-thumb-title"),className:"kl-storage-preview"}),this.ageEl=h.BB.el({css:{position:"absolute",right:"1px",bottom:"1px",width:"calc(100% - 2px)",textAlign:"center",background:"rgba(0,0,0,0.7)",color:"#fff",textSize:"13px"}});var y=(null==p?void 0:p.isFocusable)?{}:{tabIndex:-1};this.storeButtonEl=h.BB.el({parent:this.element,tagName:"button",className:"grid-button",content:(0,d.LANG)("file-storage-store"),css:{gridArea:"store"},custom:y,onClick:function(){return v.store()}}),this.clearButtonEl=h.BB.el({parent:this.element,tagName:"button",className:"grid-button",content:'<img src="'+t(c)+'" height="20"/> '+(0,d.LANG)("file-storage-clear"),css:{gridArea:"clear"},custom:y,onClick:function(){return v.clear()}}),(null===(f=this.options)||void 0===f?void 0:f.hideClearButton)&&(this.clearButtonEl.style.visibility="hidden"),this.storeListener={onUpdate:function(e,t){v.updateThumb(e,t)}},this.projectStore.subscribe(this.storeListener),this.updateCheckerboard=function(){v.thumbnail&&h.BB.css(v.thumbnail,{background:"url('"+h.BB.createCheckerCanvas(4,g.theme.isDark()).toDataURL("image/png")+"')"})},g.theme.addIsDarkListener(this.updateCheckerboard),setInterval((function(){return v.updateAge()}),6e4);var x=this;(0,a.default)((function(){var e,t;return(0,l.__generator)(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,x.projectStore.read()];case 1:return(e=i.sent())?x.updateThumb(e.timestamp,e.thumbnail):x.updateThumb(),[3,3];case 2:return t=i.sent(),setTimeout((function(){throw new Error("storage-ui: failed initial read browser storage, "+t)}),0),[3,3];case 3:return[2]}}))}))()}}return(0,o.default)(e,[{key:"updateAge",value:function(){if(this.timestamp){var e,t=(new Date).getTime()-this.timestamp;t=Math.floor(t/1e3/60),e=(0,d.LANG)("file-storage-min-ago").replace("{x}",""+t),t>60&&(t=Math.floor(t/60),e=(0,d.LANG)("file-storage-hours-ago").replace("{x}",""+t),t>24&&(t=Math.floor(t/24),e=(0,d.LANG)("file-storage-days-ago").replace("{x}",""+t),t>31&&(e=(0,d.LANG)("file-storage-month-ago")))),this.ageEl.textContent=e}}},{key:"resetButtons",value:function(){this.timestamp?(this.storeButtonEl.textContent=(0,d.LANG)("file-storage-overwrite"),this.storeButtonEl.disabled=!1,this.clearButtonEl.disabled=!1):(this.storeButtonEl.textContent=(0,d.LANG)("file-storage-store"),this.storeButtonEl.disabled=!1,this.clearButtonEl.disabled=!0)}},{key:"updateThumb",value:function(e,t){this.timestamp=e,this.thumbnail=t,this.timestamp&&t?(t.classList.add("kl-storage-preview__im"),this.previewEl.innerHTML="",this.updateAge(),this.previewEl.append(t,this.ageEl)):this.previewEl.innerHTML=(0,d.LANG)("file-storage-empty"),this.resetButtons()}},{key:"store",value:function(){var e=this;return(0,a.default)((function(){var t;return(0,l.__generator)(this,(function(i){switch(i.label){case 0:return e.storeButtonEl.textContent=(0,d.LANG)("file-storage-storing"),e.storeButtonEl.disabled=!0,e.clearButtonEl.disabled=!0,[4,new Promise((function(e){setTimeout((function(){return e(null)}),20)}))];case 1:i.sent(),i.label=2;case 2:return i.trys.push([2,4,,5]),[4,e.projectStore.store(e.getProject())];case 3:return i.sent(),e.saveReminder.reset(),[3,5];case 4:return t=i.sent(),e.resetButtons(),p.KL.popup({target:e.klRootEl,type:"error",message:["".concat((0,d.LANG)("file-storage-failed-1"),"<ul>"),"<li>".concat((0,d.LANG)("file-storage-failed-2"),"</li>"),"<li>".concat((0,d.LANG)("file-storage-failed-3"),"</li>"),"<li>".concat((0,d.LANG)("file-storage-failed-4"),"</li>"),"</ul>"].join(""),buttons:["Ok"]}),setTimeout((function(){throw new Error("storage-ui: failed to store browser storage, "+t)}),0),[3,5];case 5:return[2]}}))}))()}},{key:"clear",value:function(){var e=this;return(0,a.default)((function(){var t;return(0,l.__generator)(this,(function(i){switch(i.label){case 0:e.storeButtonEl.disabled=!0,e.clearButtonEl.disabled=!0,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,e.projectStore.clear()];case 2:return i.sent(),[3,4];case 3:return t=i.sent(),e.resetButtons(),p.KL.popup({target:e.klRootEl,type:"error",message:(0,d.LANG)("file-storage-failed-clear"),buttons:["Ok"]}),setTimeout((function(){throw new Error("storage-ui: failed to clear browser storage, "+t)}),0),[3,4];case 4:return[2]}}))}))()}},{key:"getElement",value:function(){return this.element}},{key:"show",value:function(){}},{key:"hide",value:function(){}},{key:"destroy",value:function(){h.BB.destroyEl(this.infoEl),h.BB.destroyEl(this.storeButtonEl),h.BB.destroyEl(this.clearButtonEl),g.theme.removeIsDarkListener(this.updateCheckerboard),this.projectStore.unsubscribe(this.storeListener)}}]),e}()})),i.register("6mTnI",(function(t,n){e(t.exports,"ProjectStore",(function(){return d}));var r=i("3kC7t"),a=i("gFgFC"),s=i("kiQ5H"),o=i("7U0Ew"),l=i("2gUX3"),h=i("3hwQ7"),c=i("9BlwZ"),u=i("6l0gQ");function p(e){return new Promise((function(t,i){e(t,i)}))}var d=function(){"use strict";function e(){var t=this;(0,a.default)(this,e),(0,o.default)(this,"listeners",[]),(0,o.default)(this,"accessHasFailed",!1),window.addEventListener("storage",(function(e){if("indexedDbUpdatedAt"===e.key&&0!==t.listeners.length)try{var i=t;(0,r.default)((function(){var e;return(0,l.__generator)(this,(function(t){switch(t.label){case 0:return[4,i.read()];case 1:return(e=t.sent())?i.emit(e.timestamp,e.thumbnail):i.emit(),[2]}}))}))()}catch(e){0===e.message.indexOf("db-error")&&(t.accessHasFailed=!0)}}))}return(0,s.default)(e,[{key:"lowLevelStore",value:function(e){return(0,r.default)((function(){return(0,l.__generator)(this,(function(t){switch(t.label){case 0:return[4,new Promise((function(t,i){(0,c.storeKlProjectObj)(e,t,i)}))];case 1:return t.sent(),[2]}}))}))()}},{key:"lowLevelRead",value:function(){return(0,r.default)((function(){return(0,l.__generator)(this,(function(e){switch(e.label){case 0:return[4,p(c.getKlProjectObj)];case 1:return[2,e.sent()]}}))}))()}},{key:"lowLevelClear",value:function(){return(0,r.default)((function(){return(0,l.__generator)(this,(function(e){switch(e.label){case 0:return[4,p(c.clear)];case 1:return e.sent(),[2]}}))}))()}},{key:"emit",value:function(e,t){this.listeners.forEach((function(i){i.onUpdate(e,t)}))}},{key:"updateTimestamp",value:function(){u.LocalStorage.setItem("indexedDbUpdatedAt",""+(new Date).getTime())}},{key:"read",value:function(){var e=this;return(0,r.default)((function(){var t,i,n,r;return(0,l.__generator)(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,e.lowLevelRead()];case 1:return t=a.sent(),[3,3];case 2:throw i=a.sent(),e.accessHasFailed=!0,new Error("db-error: "+i);case 3:if(!t)return[2,void 0];a.label=4;case 4:return a.trys.push([4,6,,7]),[4,h.ProjectConverter.readStorageProject(t)];case 5:return n=a.sent(),[3,7];case 6:throw r=a.sent(),new Error("format-error: "+r);case 7:return[2,n]}}))}))()}},{key:"store",value:function(e){var t=this;return(0,r.default)((function(){var i,n,r,a,s;return(0,l.__generator)(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),i=h.ProjectConverter.createStorageProject(e),[4,t.lowLevelStore(i)];case 1:return o.sent(),[3,3];case 2:throw n=o.sent(),t.accessHasFailed=!0,new Error("db-error: "+n);case 3:return[4,t.lowLevelRead()];case 4:r=o.sent(),o.label=5;case 5:return o.trys.push([5,7,,9]),[4,h.ProjectConverter.readStorageProject(r)];case 6:return a=o.sent(),[3,9];case 7:return s=o.sent(),[4,t.lowLevelClear()];case 8:throw o.sent(),t.updateTimestamp(),setTimeout((function(){return t.emit()}),0),new Error("format-error: "+s);case 9:return t.updateTimestamp(),setTimeout((function(){return t.emit(a.timestamp,a.thumbnail)}),0),[2]}}))}))()}},{key:"clear",value:function(){var e=this;return(0,r.default)((function(){return(0,l.__generator)(this,(function(t){switch(t.label){case 0:return[4,e.lowLevelClear()];case 1:return t.sent(),e.updateTimestamp(),setTimeout((function(){return e.emit()}),0),[2]}}))}))()}},{key:"subscribe",value:function(e){this.listeners.includes(e)||this.listeners.push(e)}},{key:"unsubscribe",value:function(e){for(var t=0;t<this.listeners.length;t++)if(e===this.listeners[t])return void this.listeners.splice(t,1)}},{key:"isBroken",value:function(){return this.accessHasFailed}}]),e}()})),i.register("3hwQ7",(function(t,n){e(t.exports,"ProjectConverter",(function(){return p}));var r=i("3kC7t"),a=i("gFgFC"),s=i("kiQ5H"),o=i("2gUX3"),l=i("eWjiX"),h=i("aSJRf"),c=i("2wCWz");function u(e){return new Promise((function(t,i){var n=new Image;try{n.src=l.BB.imageBlobToUrl(e)}catch(e){return void i("imageBlobToUrl, "+e.message)}n.onload=function(){URL.revokeObjectURL(n.src),t(n)},n.onabort=function(){i("layer image failed loading")},n.onerror=function(){i("layer image failed loading")}}))}var p=function(){"use strict";function e(){(0,a.default)(this,e)}return(0,s.default)(e,null,[{key:"createThumbnail",value:function(e){var t=l.BB.fitInto(e.width,e.height,240,240).width/e.width;return(0,h.drawProject)(e,t)}},{key:"createStorageProject",value:function(t){return{id:1,timestamp:(new Date).getTime(),thumbnail:(0,c.base64ToBlob)(e.createThumbnail(t).toDataURL("image/png")),width:t.width,height:t.height,layers:t.layers.map((function(e){var t;if(!(e.image instanceof HTMLCanvasElement))throw new Error("Not implemented");return t=(0,c.base64ToBlob)(e.image.toDataURL("image/png")),{name:e.name,opacity:e.opacity,mixModeStr:e.mixModeStr,blob:t}}))}}},{key:"readStorageProject",value:function(t){return(0,r.default)((function(){var i,n,r;return(0,o.__generator)(this,(function(a){switch(a.label){case 0:if(!t.width||!t.height||isNaN(t.width)||isNaN(t.height)||t.width<1||t.height<1)throw new Error("readStorageProject invalid canvas size: "+t.width+", "+t.height);return n={width:t.width,height:t.height},[4,Promise.all(t.layers.map((function(e){return u(e.blob)})))];case 1:return n.layers=a.sent().map((function(e,i){return{name:t.layers[i].name,opacity:t.layers[i].opacity,mixModeStr:t.layers[i].mixModeStr,image:e}})),i=n,t.thumbnail?[4,u(t.thumbnail)]:[3,3];case 2:return r=a.sent(),[3,4];case 3:r=e.createThumbnail(i),a.label=4;case 4:return[2,{project:i,timestamp:t.timestamp,thumbnail:r}]}}))}))()}}]),e}()})),i.register("2wCWz",(function(t,i){function n(e){for(var t=e.match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/),i=atob(t[3]),n=new ArrayBuffer(i.length),r=new Uint8Array(n),a=0;a<r.length;a++)r[a]=i.charCodeAt(a);return new Blob([r],{type:t[1]})}e(t.exports,"base64ToBlob",(function(){return n}))})),i.register("eK8ID",(function(n,r){e(n.exports,"FileTab",(function(){return m}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("eWjiX"),l=i("hrnUX"),h=i("9pcu9"),c=i("1mH1z"),u=i("frUlg"),p=i("g2tQ8"),d=i("cmBTx"),g=i("fEvzb"),f=i("7qUeg"),v=i("bJupx"),m=function(){"use strict";function e(i,n,r,s,m,y,x,B,b,w,k,C){var S=this;(0,a.default)(this,e),this.exportType=s,this.rootEl=document.createElement("div");setTimeout((function(){var e=document.createElement("div"),a=document.createElement("button"),s=document.createElement("button"),L=document.createElement("button"),A=document.createElement("button"),I=document.createElement("button");a.style.cssFloat="left",o.BB.css(s,{cssFloat:"left",clear:"both",flexGrow:"1"}),o.BB.css(I,{cssFloat:"left",clear:"both"}),a.tabIndex=-1,s.tabIndex=-1,L.tabIndex=-1,A.tabIndex=-1,I.tabIndex=-1,a.innerHTML='<img class="dark-no-invert" src=\''.concat(t(u),"' alt='icon' height='20'/>").concat((0,c.LANG)("file-new")),s.innerHTML="<img src='".concat(t(p),"' alt='icon' height='20'/>").concat((0,c.LANG)("file-save")),L.innerHTML="<img src='".concat(t(d),"' alt='icon' height='20'/>").concat((0,c.LANG)("file-share")),A.innerHTML="<img style='float:left' src='".concat(t(g),"' height='20' alt='icon'/>").concat((0,c.LANG)("file-upload")),I.innerHTML="<img src='".concat(t(v),"' alt='icon' height='20'/>").concat((0,c.LANG)("file-copy")),I.title=(0,c.LANG)("file-copy-title"),a.className="grid-button",s.className="grid-button",L.className="grid-button",A.className="grid-button",I.className="grid-button";var E=o.BB.el({className:"grid-button",css:{position:"relative",cursor:"pointer",cssFloat:"left"}}),T=o.BB.el({parent:E,css:{width:"120px",height:"28px",overflow:"hidden",cursor:"pointer",position:"relative"}});S.importButton=o.BB.el({tagName:"input",parent:T,css:{display:"none"}}),S.importButton.tabIndex=-1,S.importButton.type="file",S.importButton.multiple=!0,S.importButton.accept="image",S.importButton.size=71,S.importButton.onchange=function(){S.importButton&&(S.importButton.files&&y(S.importButton.files,"default"),S.importButton.value="")};var M=o.BB.el({tagName:"button",parent:E,content:"<img class=\"dark-no-invert\" style='float:left' height='20' src='"+t(f)+"' alt='icon'/>"+(0,c.LANG)("file-import"),css:{width:"120px",display:"box",position:"absolute",left:"0",top:"0",cursor:"pointer"}});M.tabIndex=-1,M.onclick=function(){return S.importButton&&S.importButton.click()};var P=new l.KL.Select({optionArr:[["png","PNG"],["psd","PSD"],["layers",(0,c.LANG)("layers")+" (PNG)"]],initValue:S.exportType,onChange:function(e){S.exportType=e,m(S.exportType),x()},title:(0,c.LANG)("file-format")});o.BB.css(P.getElement(),{width:"50%",height:"30px",marginTop:"10px",marginLeft:"10px"}),a.onclick=B,s.onclick=function(){x()},L.onclick=function(){L.disabled=!0,b((function(){L.disabled=!1}))},A.onclick=function(){return w()},I.onclick=function(){I.blur(),k()};var O=o.BB.el({className:"kl-toolspace-note",textContent:(0,c.LANG)("file-no-autosave"),css:{margin:"10px 10px 0 10px"}}),R=function(){var e=document.createElement("div"),t=document.createElement("div"),i=o.BB.el({className:"grid-hr"});return e.append(t,i),o.BB.css(t,{clear:"both"}),e};S.fileBrowserStorage=new(0,h.BrowserStorageUi)(n,r,C,i),o.BB.css(S.fileBrowserStorage.getElement(),{margin:"10px"});var D=o.BB.el({content:[s,P.getElement()],className:"kl-file-save-row"});o.BB.append(e,[O,a,E,o.BB.el({css:{clear:"both"}}),D,I,o.BB.canShareFiles()?L:void 0,o.BB.el({css:{clear:"both"}}),R(),S.fileBrowserStorage.getElement(),R(),A]),S.rootEl.append(e)}),1)}return(0,s.default)(e,[{key:"refresh",value:function(){}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){e&&this.refresh()}},{key:"triggerImport",value:function(){this.importButton&&this.importButton.click()}}]),e}()})),i.register("fEvzb",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("gJzzT")})),i.register("2umOB",(function(t,n){e(t.exports,"FilterTab",(function(){return u}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("4R9ai"),o=i("eWjiX"),l=i("hrnUX"),h=i("gWfkn"),c=i("1mH1z"),u=function(){"use strict";function e(t,i,n,a,s,o,l,h,c,u,p){(0,r.default)(this,e),this.klRootEl=t,this.klColorSlider=i,this.layerManager=n,this.klCanvasWorkspace=a,this.handUi=s,this.getCurrentColor=o,this.getKlMaxCanvasSize=l,this.getKlCanvas=h,this.getCurrentLayerCtx=c,this.isEmbed=u,this.statusOverlay=p,this.isInit=!1,this.rootEl=document.createElement("div")}return(0,a.default)(e,[{key:"init",value:function(){var e=this,t=l.KL.filterLib,i=[];if(!l.KL.filterLibStatus.isLoaded)throw new Error("filters not loaded");var n=function(n){var r=document.createElement("button"),a=(0,c.LANG)(t[n].lang.button),s="<img "+(t[n].darkNoInvert?'class="dark-no-invert"':"")+' height="20" width="18" src="'+t[n].icon+'" alt="icon" />';r.innerHTML=s+a,r.className="grid-button",o.BB.css(r,{lineHeight:"20px",fontSize:"12px"}),r.tabIndex=-1;var u=(0,c.LANG)(t[n].lang.name);return r.onclick=function(){if("apply"in t[n]){var i=function(i){!1===t[n].apply({context:e.getCurrentLayerCtx(),klCanvas:e.getKlCanvas(),history:h.klHistory,input:i})&&alert("Couldn't apply the edit action"),!0===t[n].updatePos&&(e.klCanvasWorkspace.resetView(),e.handUi.update(e.klCanvasWorkspace.getScale(),e.klCanvasWorkspace.getAngleDeg())),e.layerManager.update()};if(t[n].isInstant)r.blur(),i(null),e.statusOverlay.out('"'+u+'" '+(0,c.LANG)("filter-applied"),!0);else{var a,s=e.klColorSlider.getSecondaryRGB(),o=t[n].getDialog({context:e.getCurrentLayerCtx(),klCanvas:e.getKlCanvas(),maxWidth:e.getKlMaxCanvasSize(),maxHeight:e.getKlMaxCanvasSize(),currentColorRgb:{r:e.getCurrentColor().r,g:e.getCurrentColor().g,b:e.getCurrentColor().b},secondaryColorRgb:{r:s.r,g:s.g,b:s.b}});if(!o)return;o.errorCallback=function(e){setTimeout((function(){throw alert("Error: could not perform action"),e}),0),a()};var p={};"width"in o&&(p.width=o.width+"px"),l.KL.popup({target:e.klRootEl,message:"<b>"+u+"</b>",div:o.element,style:p,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(e){!function(e,t){if("Cancel"!=e){var n;try{n=t.getInput()}catch(e){throw-1!==e.message.indexOf(".getInput is not a function")?"filterDialog.getInput is not a function, filter: "+u:e}i(n)}else t.destroy&&t.destroy()}(e,o)},closeFunc:function(e){a=e}})}}else alert("Application not fully loaded")},i[i.length]=r,r},r=function(i){Object.entries(t).forEach((function(t){var r=(0,s.default)(t,2),a=r[0],o=r[1];i.includes(a)&&(e.isEmbed&&!o.inEmbed||e.rootEl.append(n(a)))}))};r(["cropExtend","flip","perspective","resize","rotate","transform"]),this.rootEl.append(o.BB.el({className:"grid-hr"})),r(["brightnessContrast","curves","distort","hueSaturation","invert","tiltShift","toAlpha","blur","unsharpMask"]),this.rootEl.append(o.BB.el({className:"grid-hr"})),r(["grid","noise","pattern","vanishPoint"]),this.isInit=!0}},{key:"getElement",value:function(){return this.rootEl}},{key:"show",value:function(){this.isInit||this.init(),this.rootEl.style.display="block"}},{key:"hide",value:function(){this.rootEl.style.display="none"}}]),e}()})),i.register("5ENro",(function(n,r){e(n.exports,"imgurUpload",(function(){return g}));var a=i("3kC7t"),s=i("2gUX3"),o=i("eWjiX"),l=i("hrnUX"),h=i("2wCWz"),c=i("1mH1z"),u=i("2lMgk");function p(e,t,i,n,r){return d.apply(this,arguments)}function d(){return(d=(0,a.default)((function(e,i,n,r,a){var l,p,d,g,f,v,m,y,x;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(l=(0,h.base64ToBlob)(e.toDataURL("image/"+r)),!(p=window.open()))throw new Error("could not create new tab");d=p.document.createElement("div"),(g=p.document.createElement("img")).src=t(u),d.append(g),o.BB.css(g,{filter:"invert(1)"}),o.BB.css(p.document.body,{backgroundColor:"#121211",backgroundImage:"linear-gradient(#2b2b2b 0%, #121211 50%)",backgroundRepeat:"no-repeat"}),(f=p.document.createElement("div")).style.marginTop="10px",d.append(f),f.textContent=(0,c.LANG)("upload-uploading"),p.document.body.append(d),o.BB.css(d,{marginLeft:"auto",marginRight:"auto",marginTop:"100px",fontFamily:"Arial, sans-serif",fontSize:"20px",textAlign:"center",transition:"opacity 0.3s ease-in-out",opacity:"0",color:"#ccc"}),setTimeout((function(){d.style.opacity="1"}),20),s.label=1;case 1:return s.trys.push([1,3,,4]),(m=new FormData).append("title",i),m.append("description",n),m.append("image",l),[4,fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID "+a},body:m})];case 2:return v=s.sent(),[3,4];case 3:throw y=s.sent(),p.close(),new Error(y);case 4:if(!v.ok)throw p.close(),new Error;return[4,v.json()];case 5:return x=s.sent().data,p.location.href=x.link.replace(/\.(jpg|png)/,""),[2,x]}}))}))).apply(this,arguments)}function g(e,t,i,n){if(!n)throw new Error("imgur key missing");var r=o.BB.el({tagName:"input"});r.type="text",r.value=(0,c.LANG)("upload-title-untitled");var h=o.BB.el({tagName:"textarea",custom:{rows:2},css:{width:"100%",maxWidth:"100%"}}),u=o.BB.el({textContent:(0,c.LANG)("upload-name")+":"}),d=o.BB.el({textContent:(0,c.LANG)("upload-caption")+":",css:{marginTop:"10px"}}),g=o.BB.el({content:'<br/><a href="https://imgur.com/tos" target="_blank" rel="noopener noreferrer">'.concat((0,c.LANG)("terms-of-service"),"</a>")}),f=new l.KL.RadioList({name:"filetype",init:"jpeg",items:[{label:"JPG",value:"jpeg"},{label:"PNG",value:"png"}],ignoreFocus:!0});o.BB.css(f.getElement(),{marginBottom:"10px"});var v,m=o.BB.el(),y=o.BB.el({className:"info-hint",textContent:(0,c.LANG)("upload-link-notice")});m.append(y,f.getElement(),u,r,d,h,g),l.KL.popup({target:t,message:"<b>".concat((0,c.LANG)("upload-title"),"</b>"),type:"upload",div:m,buttons:[(0,c.LANG)("upload-submit"),"Cancel"],clickOnEnter:(0,c.LANG)("upload-submit"),primaries:[(0,c.LANG)("upload-submit")],autoFocus:(0,c.LANG)("upload-submit"),callback:(v=(0,a.default)((function(a){var o;return(0,s.__generator)(this,(function(s){switch(s.label){case 0:if(a!==(0,c.LANG)("upload-submit")&&"Yes"!==a&&"Ok"!==a)return[3,4];s.label=1;case 1:return s.trys.push([1,3,,4]),[4,p(e.getCompleteCanvas(1),r.value,h.value,f.getValue(),n)];case 2:return o=s.sent(),l.KL.popup({target:t,type:"ok",message:"<h3>".concat((0,c.LANG)("upload-success"),"</h3><br>").concat((0,c.LANG)("upload-delete"),"<br><a target='_blank' rel=\"noopener noreferrer\" href='https://imgur.com/delete/").concat(o.deletehash,"'>imgur.com/delete/").concat(o.deletehash,"</a><br><br>"),buttons:["Ok"]}),i.reset(),[3,4];case 3:return s.sent(),l.KL.popup({target:t,type:"error",message:(0,c.LANG)("upload-failed"),buttons:["Ok"]}),[3,4];case 4:return[2]}}))})),function(e){return v.apply(this,arguments)})})}})),i.register("2lMgk",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("c3ZSC")})),i.register("lkluh",(function(t,n){e(t.exports,"loadAgPsd",(function(){return o}));var r,a=i("3kC7t"),s=i("2gUX3");function o(){return l.apply(this,arguments)}function l(){return(l=(0,a.default)((function(){return(0,s.__generator)(this,(function(e){switch(e.label){case 0:return r?[3,2]:[4,i("bxnoy")];case 1:r=e.sent(),e.label=2;case 2:return[2,r]}}))}))).apply(this,arguments)}})),i.register("bxnoy",(function(e,t){e.exports=i("ih7W4")(i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("kNYzr")).then((function(){return i("2m2jt")}))})),i.register("5ngYX",(function(t,n){e(t.exports,"SaveReminder",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("hrnUX"),o=i("eWjiX"),l=i("1mH1z"),h=i("9pcu9"),c=function(){"use strict";function e(t,i,n,a,s,o,l){var h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"Klecks";(0,r.default)(this,e),this.history=t,this.showReminder=i,this.changeTitle=n,this.onSaveAsPsd=a,this.isDrawing=s,this.projectStore=o,this.getProject=l,this.title=h,this.lastSavedActionNumber=null}return(0,a.default)(e,[{key:"showPopup",value:function(){var e=this;if(!this.projectStore||!this.getProject)throw new Error("projectStore and getProject need to be set");var t=Math.round((performance.now()-this.lastSavedAt)/1e3/60),i=o.BB.el();i.append(o.BB.el({content:(0,l.LANG)("save-reminder-text",{a:"<strong>"+t,b:"</strong>"}),css:{marginBottom:"20px"}}));var n=o.BB.el({css:{borderTop:"1px solid #aaa",margin:"0 -20px",padding:"20px"}}),r=o.BB.el({css:{borderTop:"1px solid #aaa",margin:"0 -20px",padding:"20px",paddingBottom:"0"}});i.append(n,r);var a=o.BB.el({tagName:"button",className:"kl-button",content:(0,l.LANG)("save-reminder-save-psd"),onClick:function(){return e.onSaveAsPsd()}});n.append(a,o.BB.el({content:(0,l.LANG)("save-reminder-psd-layers"),css:{marginTop:"10px"}}));var c=new(0,h.BrowserStorageUi)(this.projectStore,this.getProject,this,document.body,{hideClearButton:!0,isFocusable:!0});r.append(c.getElement()),s.KL.popup({target:document.body,message:"<b>".concat((0,l.LANG)("save-reminder-title"),"</b>"),div:i,ignoreBackground:!0,callback:function(){c.destroy(),o.BB.destroyEl(a),e.closeFunc=null,e.lastReminderShownAt=performance.now()},closeFunc:function(t){e.closeFunc=t}}),setTimeout((function(){a.focus()}),40)}},{key:"init",value:function(){var e=this,t=function(e){e.preventDefault(),e.returnValue=""};null===this.lastSavedActionNumber&&(this.lastSavedActionNumber=this.history.getActionNumber(),this.lastReminderShownAt=performance.now(),this.lastSavedAt=performance.now(),this.showReminder&&setInterval((function(){if("visible"===document.visibilityState){var t=Math.abs(e.history.getActionNumber()-e.lastSavedActionNumber);0===s.KL.dialogCounter.get()&&!e.isDrawing()&&e.lastReminderShownAt+12e5<performance.now()&&t>=100&&e.showPopup()}}),5e3),this.history.addListener((function(){var i=e.history.getActionNumber();e.lastSavedActionNumber!==i?window.onbeforeunload=t:window.onbeforeunload=null})),this.changeTitle&&document.addEventListener("visibilitychange",(function(){if("visible"===document.visibilityState)document.title=e.title,clearInterval(e.unsavedInterval);else{var t=e.history.getActionNumber();if(e.lastSavedActionNumber!==t){document.title=(0,l.LANG)("unsaved")+" - "+e.title;var i=0;e.unsavedInterval=setInterval((function(){i=(i+1)%2,document.title=1===i?(0,l.LANG)("unsaved")+" · "+e.title:(0,l.LANG)("unsaved")+" - "+e.title}),18e4)}}})))}},{key:"reset",value:function(){null!==this.lastSavedActionNumber&&(this.lastSavedActionNumber=this.history.getActionNumber(),this.lastReminderShownAt=performance.now(),this.lastSavedAt=performance.now(),window.onbeforeunload=null,this.closeFunc&&this.closeFunc())}}]),e}()})),i.register("eyygR",(function(t,n){e(t.exports,"SaveToComputer",(function(){return h}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("hrnUX"),l=i("6hBII"),h=function(){"use strict";function e(t,i,n,a,s){(0,r.default)(this,e),this.saveReminder=t,this.klRootEl=i,this.getExportType=n,this.getKlCanvas=a,this.filenameBase=s}return(0,a.default)(e,[{key:"saveImage",value:function(e,t,i){var n=e.toDataURL(i).match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/);if(!n)throw new Error("saveImage: empty parts");for(var r=atob(n[3]),a=new ArrayBuffer(r.length),s=new Uint8Array(a),o=0;o<s.length;o++)s[o]=r.charCodeAt(o);var h=new Blob([s],{type:n[1]});(0,l.saveAs)(h,t)}},{key:"save",value:function(e){var t=this;if(this.saveReminder.reset(),e||(e=this.getExportType()),"png"===e){var i=s.BB.getDate()+this.filenameBase+".png",n=this.getKlCanvas().getCompleteCanvas(1);try{this.saveImage(n,i,"image/png")}catch(e){throw alert("could not save"),new Error("failed png export")}}else if("layers"===e)for(var r=s.BB.getDate()+this.filenameBase,a=this.getKlCanvas().getLayersFast(),h=0;h<a.length;h++){var c=a[h],u=[r,"_",(""+(h+1)).padStart(2,"0"),"_",c.name,".","png"];this.saveImage(c.canvas,u.join(""),"image/png")}else if("psd"===e){for(var p=this.getKlCanvas().getLayersFast(),d={width:this.getKlCanvas().getWidth(),height:this.getKlCanvas().getHeight(),children:[],canvas:this.getKlCanvas().getCompleteCanvas(1)},g=0;g<p.length;g++){var f=p[g];d.children.push({name:f.name,opacity:f.opacity,canvas:f.canvas,blendMode:o.KL.PSD.blendKlToPsd(f.mixModeStr),left:0,top:0})}o.KL.loadAgPsd().then((function(e){var i=e.writePsdBuffer(d),n=new Blob([i],{type:"application/octet-stream"});(0,l.saveAs)(n,s.BB.getDate()+t.filenameBase+".psd")})).catch((function(){alert("Error: failed to load PSD library")}))}}}]),e}()})),i.register("6hBII",(function(t,i){function n(e,t){var i=document.createElementNS("http://www.w3.org/1999/xhtml","a");i.download=t,i.rel="noopener",i.href=URL.createObjectURL(e),setTimeout((function(){return URL.revokeObjectURL(i.href)}),4e4),setTimeout((function(){return i.click()}),0)}e(t.exports,"saveAs",(function(){return n}))})),i.register("6rdi0",(function(t,n){e(t.exports,"UndoRedoCatchup",(function(){return u}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("4R9ai"),o=i("hrnUX"),l=i("gWfkn"),h=i("7jh4K");function c(e,t,i,n,r,a){if("brush"===e.tool[0]){var l=n[e.tool[1]];e.actions.forEach((function(e){l[e.action].apply(l,e.params)}))}else if("canvas"===e.tool[0]){var c=e.params,u=i[e.action].apply(i,c);if("number"==typeof u){t=u;var p=(0,h.throwIfNull)(i.getLayerContext(t));r(p),Object.entries(n).forEach((function(e){return(0,s.default)(e,2)[1].setContext(p)}))}}else if("filter"===e.tool[0]){var d=[{context:a(),klCanvas:i,input:e.params[0].input,history:new o.KL.DecoyKlHistory}];o.KL.filterLib[e.tool[1]][e.action].apply(null,d)}else if("misc"===e.tool[0]&&"focusLayer"===e.action){t=e.params[0];var g=(0,h.throwIfNull)(i.getLayerContext(t));r(g),Object.entries(n).forEach((function(e){return(0,s.default)(e,2)[1].setContext(g)}))}else if("misc"===e.tool[0]&&"importImage"===e.action){var f=i.addLayer();if("number"==typeof f){t=f,e.params[1]&&i.renameLayer(t,e.params[1]);var v=(0,h.throwIfNull)(i.getLayerContext(t));r(v),Object.entries(n).forEach((function(e){return(0,s.default)(e,2)[1].setContext(v)}))}a().drawImage(e.params[0],0,0)}return t}var u=function(){"use strict";function e(t,i,n,a,s,o,l,h,c,u){(0,r.default)(this,e),this.brushUiMap=t,this.layerPreview=i,this.layerManager=n,this.handUi=a,this.klCanvasWorkspace=s,this.getInitState=o,this.getKlCanvas=l,this.getCurrentLayerCtx=h,this.setCurrentLayerCtx=c,this.getCurrentBrush=u,this.doIgnore=!1}return(0,a.default)(e,[{key:"shouldIgnoreTest",value:function(){var e=this;return!!this.doIgnore||(this.doIgnore=!0,setTimeout((function(){e.doIgnore=!1}),0),!1)}},{key:"undo",value:function(){var e=this;if(this.shouldIgnoreTest()||!l.klHistory.canUndo())return!1;var t=l.klHistory.undo(),i=this.getKlCanvas();l.klHistory.pause(!0);var n=this.getInitState(),r=i.getWidth(),a=i.getHeight();i.copy(n.canvas);var s=n.focus;this.setCurrentLayerCtx(i.getLayerContext(s));var u={};for(var p in o.KL.brushes)o.KL.brushes.hasOwnProperty(p)&&(u[p]=new o.KL.brushes[p],u[p].setContext(this.getCurrentLayerCtx()));return u.SketchyBrush.setSeed(n.brushes.SketchyBrush.getSeed()),t.forEach((function(t){s=c(t,s,i,u,(function(t){return e.setCurrentLayerCtx(t)}),(function(){return(0,h.throwIfNull)(e.getCurrentLayerCtx())}))})),r===i.getWidth()&&a===i.getHeight()||(this.klCanvasWorkspace.resetView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())),this.layerManager.update(s),this.layerPreview.setLayer(i.getLayer(s)),this.brushUiMap.sketchyBrush.setSeed(u.SketchyBrush.getSeed()),this.getCurrentBrush().setContext(this.getCurrentLayerCtx()),this.klCanvasWorkspace.setLastDrawEvent(null),l.klHistory.pause(!1),!0}},{key:"redo",value:function(){var e=this;if(this.shouldIgnoreTest()||!l.klHistory.canRedo())return!1;var t=l.klHistory.redo();if(!t)return setTimeout((function(){throw new Error("redo failed. redo entry undefined")})),!1;var i=this.getKlCanvas();l.klHistory.pause(!0);var n=i.getWidth(),r=i.getHeight(),a={};for(var s in o.KL.brushes)o.KL.brushes.hasOwnProperty(s)&&(a[s]=new o.KL.brushes[s],a[s].setContext(this.getCurrentLayerCtx()));a.SketchyBrush.setSeed(this.brushUiMap.sketchyBrush.getSeed()),c(t,0,i,a,(function(t){return e.setCurrentLayerCtx(t)}),(function(){return(0,h.throwIfNull)(e.getCurrentLayerCtx())})),n===i.getWidth()&&r===i.getHeight()||(this.klCanvasWorkspace.resetView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg()));var u=i.getLayerIndex(this.getCurrentLayerCtx().canvas);return this.layerManager.update(u),this.layerPreview.setLayer(i.getLayer(u)),this.brushUiMap.sketchyBrush.setSeed(a.SketchyBrush.getSeed()),this.getCurrentBrush().setContext(this.getCurrentLayerCtx()),this.klCanvasWorkspace.setLastDrawEvent(null),l.klHistory.pause(!1),!0}},{key:"catchup",value:function(e){if(e&&e.bufferUpdate){var t=this.getInitState(),i=t.canvas.getLayerContext(t.focus);t.focus=c(e.bufferUpdate,t.focus,t.canvas,t.brushes,(function(e){i=e}),(function(){return(0,h.throwIfNull)(i)}))}}}]),e}()})),i.register("7pyBK",(function(t,n){e(t.exports,"BrushSettingService",(function(){return s}));var r=i("gFgFC"),a=i("kiQ5H"),s=function(){"use strict";function e(t,i,n,a,s,o,l){if((0,r.default)(this,e),this.onSetColor=t,this.onSetSize=i,this.onSetOpacity=n,this.onGetColor=a,this.onGetSize=s,this.onGetOpacity=o,this.onGetSliderConfig=l,this.subscriberArr=[],e.instance)throw new Error("BrushSettingService already instantiated");e.instance=this}return(0,a.default)(e,[{key:"emit",value:function(e,t){for(var i=0;i<this.subscriberArr.length;i++)this.subscriberArr[i]!==t&&this.subscriberArr[i](e)}},{key:"emitColor",value:function(e,t){this.emit({type:"color",value:e},t)}},{key:"emitSize",value:function(e,t){this.emit({type:"size",value:e},t)}},{key:"emitOpacity",value:function(e,t){this.emit({type:"opacity",value:e},t)}},{key:"emitSliderConfig",value:function(e,t){this.emit({type:"sliderConfig",value:e},t)}},{key:"setColor",value:function(e,t){this.onSetColor(e),this.emitColor(e,t)}},{key:"setSize",value:function(e,t){this.onSetSize(e)}},{key:"setOpacity",value:function(e,t){this.onSetOpacity(e)}},{key:"getColor",value:function(){return this.onGetColor()}},{key:"getSize",value:function(){return this.onGetSize()}},{key:"getOpacity",value:function(){return this.onGetOpacity()}},{key:"getSliderConfig",value:function(){return this.onGetSliderConfig()}},{key:"subscribe",value:function(e){this.subscriberArr.includes(e)||this.subscriberArr.push(e)}},{key:"unsubscribe",value:function(e){for(var t=0;t<this.subscriberArr.length;t++)e===this.subscriberArr[t]&&(this.subscriberArr.splice(t,1),t--)}}]),e}()})),i.register("bIgqE",(function(n,r){e(n.exports,"SettingsTab",(function(){return x}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("4Ea8f"),l=i("eWjiX"),h=i("1mH1z"),c=i("hrnUX"),u=i("fgfvl"),p=i("dLlkc"),d=i("dd3r9"),g=i("kX3t5"),f=i("741YV"),v=i("6l0gQ"),m=i("1C8RU"),y=i("7jh4K"),x=function(){"use strict";function e(n,r){(0,a.default)(this,e);var s=function(e){return"dark"===e?"⬛ "+(0,h.LANG)("theme-dark"):"⬜ "+(0,h.LANG)("theme-light")},x=function(){return l.BB.el({tagName:"a",content:(0,h.LANG)("licenses"),onClick:function(){i("eSypg").then((function(e){new(0,p.DynamicModal)({title:l.BB.el({content:(0,h.LANG)("licenses")}),content:l.BB.el({content:l.BB.el({content:e.licenses.replace(/\n/g,"<br>"),css:{padding:"20px"}}),css:{height:"100%",overflowY:"scroll"}}),width:800,isMaxHeight:!0})}))}})};this.el=l.BB.el({css:{margin:"10px"}});var B=h.languageStrings.getAutoLanguage(),b=l.BB.el({parent:this.el,content:l.BB.el({content:(0,h.LANG)("settings-language")+":",css:{marginRight:"5px",marginBottom:"2px"}}),css:{display:"flex",alignItems:"center",flexWrap:"wrap"}}),w=[["auto",(0,h.LANG)("auto")+" → ".concat(B.name," (").concat(B.code,")")]].concat((0,o.default)(u.languages.map((function(e){return[e.code,e.name+" (".concat(e.code,")")]})))),k=new c.KL.Select({initValue:v.LocalStorage.getItem(h.LS_LANGUAGE_KEY)?v.LocalStorage.getItem(h.LS_LANGUAGE_KEY):"auto",optionArr:w,onChange:function(e){"auto"===e?v.LocalStorage.removeItem(h.LS_LANGUAGE_KEY):v.LocalStorage.setItem(h.LS_LANGUAGE_KEY,e),C.style.display="block"}});l.BB.css(k.getElement(),{flexGrow:"1"});var C=l.BB.el({className:"kl-toolspace-note",content:(0,h.LANG)("settings-language-reload"),css:{display:"none",marginTop:"5px",flexGrow:"1"}});b.append(k.getElement(),C);var S=new c.KL.Select({optionArr:[["auto",(0,h.LANG)("auto")+" → "+s(m.theme.getMediaQueryTheme())],["light",s("light")],["dark",s("dark")]],initValue:m.theme.getStoredTheme()||"auto",onChange:function(e){m.theme.setStoredTheme("auto"===e?void 0:e)}});(l.BB.css(S.getElement(),{flexGrow:"1"}),(0,y.addIsDarkListener)((function(){S.updateLabel("auto",(0,h.LANG)("auto")+" → "+s(m.theme.getMediaQueryTheme()))})),l.BB.el({parent:this.el,content:[l.BB.el({content:(0,h.LANG)("settings-theme")+":",css:{marginRight:"5px",marginBottom:"2px"}}),S.getElement()],css:{marginTop:"15px",display:"flex",alignItems:"center",flexWrap:"wrap"}}),l.BB.el({tagName:"button",parent:this.el,content:'<img height="20" width="18" src="'+t(f)+'" alt="icon" style="margin-right: 5px"/>'+(0,h.LANG)("switch-ui-left-right"),onClick:function(){return n()},css:{marginTop:"15px"},custom:{tabIndex:"-1"}}),this.el.append(l.BB.el({className:"grid-hr",css:{margin:"10px 0"}})),r)?(this.el.append(r),r.innerHTML||l.BB.el({parent:r,css:{textAlign:"center"}}).append(l.BB.el({content:'<img alt="icon" height="20" style="vertical-align:middle" src="'.concat(t(d),'"> <a href="https://bitbof.com" target="_blank" tabIndex="-1">bitbof</a> © 2023<br>')}),x())):l.BB.el({parent:this.el,css:{textAlign:"center"},content:'\n<img alt="Klecks" class="dark-invert" height="25" src="'.concat(t(g),'"><br>\n<img alt="icon" height="20" style="vertical-align:middle" src="').concat(t(d),'"> <a href="https://bitbof.com" target="_blank" tabIndex="-1">bitbof</a> © 2023<br>')}).append(x(),document.createTextNode(" | "),l.BB.el({tagName:"a",content:(0,h.LANG)("donate"),custom:{href:"https://kleki.com/donate/",target:"_blank"}}),document.createTextNode(" | "),l.BB.el({tagName:"a",content:(0,h.LANG)("source-code"),custom:{href:"https://klecks.org",target:"_blank"}}));window.addEventListener("storage",(function(e){e.key===h.LS_LANGUAGE_KEY&&k.setValue(v.LocalStorage.getItem(h.LS_LANGUAGE_KEY)?v.LocalStorage.getItem(h.LS_LANGUAGE_KEY):"auto")}))}return(0,s.default)(e,[{key:"getElement",value:function(){return this.el}}]),e}()})),i.register("dd3r9",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("hTlU7")})),i.register("741YV",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("hxlHN")})),i.register("eSypg",(function(e,t){e.exports=i("ih7W4")(i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("79hnx")).then((function(){return i("jNQF2")}))})),i.register("iVHpg",(function(t,n){e(t.exports,"ToolspaceScroller",(function(){return h}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=i("1mH1z"),l=i("i8UFO"),h=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.toolspace=t.toolspace,this.upBtn=s.BB.el({parent:this.toolspace,title:(0,o.LANG)("scroll"),className:"kl-scroller",css:{top:"0",transform:"rotate(180deg)"}}),this.downBtn=s.BB.el({parent:this.toolspace,title:(0,o.LANG)("scroll"),className:"kl-scroller",css:{bottom:"0"}}),this.updateUiState(t.uiState);new s.BB.PointerListener({target:this.upBtn,onPointer:function(e){"pointerdown"===e.type&&(i.upInterval=setInterval((function(){i.toolspace.scrollBy(0,-13),i.update()}),20)),"pointerup"===e.type&&(clearInterval(i.upInterval),setTimeout((function(){i.upInterval=null,i.update()}),50))}}),new s.BB.PointerListener({target:this.downBtn,onPointer:function(e){"pointerdown"===e.type&&(i.downInterval=setInterval((function(){i.toolspace.scrollBy(0,13),i.update()}),20)),"pointerup"===e.type&&(clearInterval(i.downInterval),setTimeout((function(){i.downInterval=null,i.update()}),50))}});var n=function(e){i.toolspace.scrollBy(0,Math.round(.7*e.deltaY)),i.update()};this.upBtn.addEventListener("wheel",n),this.downBtn.addEventListener("wheel",n),this.update(),new MutationObserver((function(){return i.update()})).observe(this.toolspace,{attributes:!0,childList:!0,subtree:!0}),window.addEventListener("resize",(function(){return i.update()})),l.dialogCounter.subscribe((function(e){i.upBtn.style.opacity=e>=1?"0":"",i.downBtn.style.opacity=e>=1?"0":""}))}return(0,a.default)(e,[{key:"update",value:function(){this.toolspace.scrollHeight>this.toolspace.offsetHeight+3?(this.upInterval||(this.upBtn.style.display=0===this.toolspace.scrollTop?"none":"block"),this.downInterval||(this.downBtn.style.display=this.toolspace.scrollTop+this.toolspace.offsetHeight+1>=this.toolspace.scrollHeight?"none":"block")):(this.upBtn.style.display="none",this.downBtn.style.display="none")}},{key:"updateUiState",value:function(e){s.BB.css(this.upBtn,{left:"left"===e?"0":"",right:"right"===e?"0":""}),s.BB.css(this.downBtn,{left:"left"===e?"0":"",right:"right"===e?"0":""})}}]),e}()})),i.register("5Gc7M",(function(t,n){e(t.exports,"GradientUi",(function(){return p}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=i("eWjiX"),l=i("aP0jf"),h=i("1mH1z"),c=i("7bWhB"),u=i("iFIyy"),p=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),(0,s.default)(this,"settings",{opacity:1,type:"linear",doLockAlpha:!1,doSnap:!1,isReversed:!1,isEraser:!1}),this.colorSlider=t.colorSlider,this.rootEl=o.BB.el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=o.BB.el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.iconArr=[];[0,1,2].forEach((function(){var e=o.BB.el({className:"dark-invert",css:{width:"33px",height:"33px",borderRadius:"3px",margin:"1px"}});i.iconArr.push(e)})),this.updateIcons();var n=new(0,u.Options)({optionArr:[{id:"linear",label:this.iconArr[0],title:(0,h.LANG)("gradient-linear")},{id:"linear-mirror",label:this.iconArr[1],title:(0,h.LANG)("gradient-linear-mirror")},{id:"radial",label:this.iconArr[2],title:(0,h.LANG)("gradient-radial")}],initId:"linear",onChange:function(e){i.settings.type=e}});this.rootEl.append(n.getElement());var a=new(0,l.KlSlider)({label:(0,h.LANG)("opacity"),width:250,height:30,min:.01,max:1,value:this.settings.opacity,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(e){i.settings.opacity=e}});o.BB.css(a.getElement(),{marginTop:"10px"}),this.rootEl.append(a.getElement());var p=o.BB.el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),d=new(0,c.Checkbox)({init:!1,label:(0,h.LANG)("reverse"),callback:function(e){i.settings.isReversed=e,i.updateIcons()},css:{width:"50%"}}),g=new(0,c.Checkbox)({init:!1,label:(0,h.LANG)("angle-snap"),title:(0,h.LANG)("angle-snap-title"),callback:function(e){i.settings.doSnap=e},css:{width:"50%"}});p.append(d.getElement(),g.getElement());var f=o.BB.el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),v=new(0,c.Checkbox)({init:this.settings.isEraser,label:(0,h.LANG)("eraser"),callback:function(e){i.settings.isEraser=e},css:{width:"50%"}}),m=new(0,c.Checkbox)({init:!1,label:(0,h.LANG)("lock-alpha"),title:(0,h.LANG)("lock-alpha-title"),callback:function(e){i.settings.doLockAlpha=e},doHighlight:!0,css:{width:"50%"}});f.append(v.getElement(),m.getElement())}return(0,a.default)(e,[{key:"updateIcons",value:function(){var e=this.settings.isReversed?"#0000":"#000",t=this.settings.isReversed?"#000":"#0000";this.iconArr[0].style.background="linear-gradient(".concat(e,", ").concat(t,")"),this.iconArr[1].style.background="linear-gradient(".concat(t,", ").concat(e,", ").concat(t,")"),this.iconArr[2].style.background="radial-gradient(".concat(e,", ").concat(t,")")}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=!!e,this.rootEl.style.display=e?"block":"none",e&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}},{key:"getSettings",value:function(){return o.BB.copyObj(this.settings)}}]),e}()})),i.register("jmL5A",(function(n,r){e(n.exports,"EmbedToolspaceTopRow",(function(){return u}));var a=i("gFgFC"),s=i("kiQ5H"),o=i("eWjiX"),l=i("741YV"),h=i("8pc1M"),c=i("1mH1z"),u=function(){"use strict";function e(i){(0,a.default)(this,e);var n=function(e){var t=6+(e.extraPadding?e.extraPadding:0),i=o.BB.el({className:"toolspace-row-button nohighlight",title:e.title,onClick:e.onClick,css:{padding:e.content?"":e.contain?t+"px 0":""}});if(e.content)i.append(e.content);else{var n=o.BB.el({className:"dark-invert",css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%"}});n.style.pointerEvents="none",i.append(n)}var r=new o.BB.PointerListener({target:i,onEnterLeave:function(e){i.classList.toggle("toolspace-row-button-hover",e)}});return{el:i,pointerListener:r}};this.rootEl=o.BB.el({className:"kl-toolspace-row",css:{height:"36px",display:"flex"}});var r=n({onClick:i.onSubmit,title:(0,c.LANG)("submit-title"),content:o.BB.el({content:(0,c.LANG)("submit"),className:"toolspace-row-button__submit",css:{display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%"}}),contain:!0});r.el.style.width="45px";var s=n({onClick:i.onHelp,title:(0,c.LANG)("help"),image:t(h),contain:!0}),u=n({onClick:i.onLeftRight,title:(0,c.LANG)("switch-ui-left-right"),image:t(l),contain:!0});this.rootEl.append(r.el,u.el,s.el)}return(0,s.default)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}()})),i.register("iUR3L",(function(t,n){e(t.exports,"importFilters",(function(){return S}));var r=i("kyVjY"),a=i("iiVKq"),s=i("lorQQ"),o=i("8Ri8I"),l=i("fADXF"),h=i("bIns5"),c=i("30jcG"),u=i("cCks8"),p=i("huXOx"),d=i("dsRff"),g=i("lhchB"),f=i("lXpcU"),v=i("1CjeM"),m=i("dNWKZ"),y=i("94Tq7"),x=i("d8Fqy"),B=i("gtdB1"),b=i("lQzx7"),w=i("10iZP"),k=i("dteOZ");function C(e,t){t.getDialog&&(e.getDialog=t.getDialog),e.apply=t.apply}function S(){r.filterLibStatus.isLoaded||(C(r.filterLib.brightnessContrast,a.filterBrightnessContrast),C(r.filterLib.cropExtend,s.filterCropExtend),C(r.filterLib.curves,o.filterCurves),C(r.filterLib.flip,l.filterFlip),C(r.filterLib.hueSaturation,h.filterHueSaturation),C(r.filterLib.invert,c.filterInvert),C(r.filterLib.perspective,u.filterPerspective),C(r.filterLib.resize,p.filterResize),C(r.filterLib.rotate,d.filterRotate),C(r.filterLib.tiltShift,g.filterTiltShift),C(r.filterLib.transform,f.filterTransform),C(r.filterLib.blur,v.filterBlur),C(r.filterLib.unsharpMask,m.filterUnsharpMask),C(r.filterLib.toAlpha,y.filterToAlpha),C(r.filterLib.grid,x.filterGrid),C(r.filterLib.noise,B.filterNoise),C(r.filterLib.pattern,b.filterPattern),C(r.filterLib.distort,w.filterDistort),C(r.filterLib.vanishPoint,k.filterVanishPoint),r.filterLibStatus.isLoaded=!0)}})),i.register("iiVKq",(function(t,n){e(t.exports,"filterBrightnessContrast",(function(){return c}));var r=i("eWjiX"),a=i("aP0jf"),s=i("cH2YE"),o=i("i5nyl"),l=i("a5EFw"),h=i("1mH1z"),c={getDialog:function(e){var t=document.createElement("div"),i={element:t},n=e.context,c=e.klCanvas;if(!n||!c)return!1;var u=c.getLayers(),p=c.getLayerIndex(n.canvas),d=r.BB.fitInto(n.canvas.width,n.canvas.height,280,200,1),g=parseInt(""+d.width),f=parseInt(""+d.height),v=r.BB.canvas(g,f),m=r.BB.ctx(v);return m.save(),v.width>n.canvas.width&&(m.imageSmoothingEnabled=!1),m.drawImage(n.canvas,0,0,g,f),m.restore(),setTimeout((function(){var e=0,n=0;t.innerHTML=(0,h.LANG)("filter-bright-contrast-description")+"<br/><br/>";var c=(0,l.getSharedFx)();if(c){var d=c.texture(v);c.draw(d).update();var m=new(0,a.KlSlider)({label:(0,h.LANG)("filter-bright-contrast-brightness"),width:300,height:30,min:0,max:100,value:50*(e+1),eventResMs:s.eventResMs,onChange:function(t){e=t/50-1,c.draw(d).brightnessContrast(e,n).update(),w.render()}}),y=new(0,a.KlSlider)({label:(0,h.LANG)("filter-bright-contrast-contrast"),width:300,height:30,min:0,max:100,value:50*(n+1),eventResMs:s.eventResMs,onChange:function(t){n=t/50-1,c.draw(d).brightnessContrast(e,n).update(),w.render()}});m.getElement().style.marginBottom="10px",t.append(m.getElement(),y.getElement());for(var x=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}}),B=[],b=0;b<u.length;b++)B.push({image:b===p?c:u[b].context.canvas,opacity:u[b].opacity,mixModeStr:u[b].mixModeStr});var w=new(0,o.KlCanvasPreview)({width:parseInt(""+g),height:parseInt(""+f),layers:B}),k=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+g)+"px",height:parseInt(""+f)+"px"}});k.append(w.getElement()),x.append(k),t.append(x);try{c.draw(d).brightnessContrast(e,n).update(),w.render()}catch(e){t.errorCallback(e)}i.destroy=function(){m.destroy(),y.destroy(),d.destroy(),w.destroy()},i.getInput=function(){return i.destroy(),{brightness:e,contrast:n}}}}),1),i},apply:function(e){var t=e.context,i=e.input.brightness,n=e.input.contrast,r=e.history;if(!t||!r)return!1;r.pause(!0);var a=(0,l.getSharedFx)();if(!a)return!1;var s=a.texture(t.canvas);return a.draw(s).brightnessContrast(i,n).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),s.destroy(),r.pause(!1),r.push({tool:["filter","brightnessContrast"],action:"apply",params:[{input:e.input}]}),!0}}})),i.register("cH2YE",(function(t,i){e(t.exports,"eventResMs",(function(){return n}));var n=60})),i.register("a5EFw",(function(t,n){e(t.exports,"getSharedFx",(function(){return s}));var r=i("6N0h0"),a=null;try{a=(0,r.fxCanvas)()}catch(e){}function s(){if(!a||a._.gl.isContextLost())try{a=(0,r.fxCanvas)()}catch(e){}return a}})),i.register("6N0h0",(function(t,n){e(t.exports,"fxCanvas",(function(){return T}));var r,a,s,o,l,h,c,u,p=i("76shC"),d=i("fvBHO"),g=i("7dEWP"),f=i("8dg54"),v=i("1Vq1u"),m=i("h6IOH"),y=i("9uhWc"),x=i("e0olz"),B=i("2myDH"),b=i("44j8K"),w=i("kSoEy"),k=i("9WU1L"),C=i("bJIp5"),S=i("fkecp"),L=i("3u9Uu"),A=i("6lIef"),I=i("lwXVT"),E=i("eWjiX"),T=(r=function(e){return{_:e,loadContentsOf:function(e){(0,g.setGl)(this._.gl),this._.loadContentsOf(e)},destroy:function(){(0,g.setGl)(this._.gl),this._.destroy()}}},a=function(e){return r(f.FxTexture.fromElement(e))},s=function(e,t){var i=function(){var e=g.gl.UNSIGNED_BYTE;if(g.gl.getExtension("WEBGL_color_buffer_float")&&g.gl.getExtension("OES_texture_float")&&g.gl.getExtension("OES_texture_float_linear")){var t=new(0,f.FxTexture)(100,100,g.gl.RGBA,g.gl.FLOAT);try{t.drawTo((function(){e=g.gl.FLOAT}))}catch(e){}t.destroy()}return e}();this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=e,this.height=t,this._.texture=new(0,f.FxTexture)(e,t,g.gl.RGBA,i),this._.spareTexture=new(0,f.FxTexture)(e,t,g.gl.RGBA,i),this._.extraTexture=this._.extraTexture||new(0,f.FxTexture)(0,0,g.gl.RGBA,i),this._.flippedShader=this._.flippedShader||new(0,d.FxShader)(null,"\nuniform sampler2D texture;\nvarying vec2 texCoord;\nvoid main() {\n    gl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));\n}\n        ","flippedShader"),this._.isInitialized=!0},o=function(e,t,i){return this._.isInitialized&&e._.width==this.width&&e._.height==this.height||s.call(this,t||e._.width,i||e._.height),e._.use(),this._.texture.drawTo((function(){d.FxShader.getDefaultShader().drawRect()})),this},l=function(){return this._.texture.use(),this._.flippedShader.drawRect(),this},h=function(){var e=new(0,f.FxTexture)(this._.texture.width,this._.texture.height,g.gl.RGBA,g.gl.UNSIGNED_BYTE);return this._.texture.use(),e.drawTo((function(){d.FxShader.getDefaultShader().drawRect()})),r(e)},c=function(){var e=this._.texture.width,t=this._.texture.height,i=new Uint8Array(e*t*4);return this._.texture.drawTo((function(){g.gl.readPixels(0,0,e,t,g.gl.RGBA,g.gl.UNSIGNED_BYTE,i)})),i},u=function(e){return function(){for(var t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];return(0,g.setGl)(this._.gl),e.apply(this,i)}},function(){var e=E.BB.canvas();try{(0,g.setGl)(E.BB.throwIfNull(e.getContext("experimental-webgl",{premultipliedAlpha:!1})))}catch(e){(0,g.setGl)(null)}if(!g.gl)throw"This browser does not support WebGL";return e._={gl:g.gl,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},e.texture=u(a),e.draw=u(o),e.update=u(l),e.contents=u(h),e.getPixelArray=u(c),e.brightnessContrast=u(p.brightnessContrast),e.hueSaturation=u(m.hueSaturation),e.triangleBlur=u(x.triangleBlur),e.unsharpMask=u(w.unsharpMask),e.perspective=u(S.perspective),e.matrixWarp=u(b.matrixWarp),e.tiltShift=u(B.tiltShift),e.noise=u(y.noise),e.curves=u(v.curves),e.invert=u(C.invert),e.multiplyAlpha=u(I.multiplyAlpha),e.unmultiplyAlpha=u(L.unmultiplyAlpha),e.toAlpha=u(k.toAlpha),e.distort=u(A.distort),e})})),i.register("76shC",(function(t,n){e(t.exports,"brightnessContrast",(function(){return l}));var r=i("eWjiX"),a=i("jrAes"),s=i("fvBHO"),o=i("7dEWP"),l=function(e,t){return o.gl.brightnessContrast=o.gl.brightnessContrast||new(0,s.FxShader)(null,"        uniform sampler2D texture;        uniform float brightness;        uniform float contrast;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.rgb += brightness;            if (contrast > 0.0) {                color.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;            } else {                color.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;            }            gl_FragColor = color;        }    ","brightnessContrast"),a.simpleShader.call(this,o.gl.brightnessContrast,{brightness:r.BB.clamp(e,-1,1),contrast:r.BB.clamp(t,-1,1)}),this}})),i.register("jrAes",(function(t,i){function n(e,t,i,n){(i||this._.texture).use(),this._.spareTexture.drawTo((function(){e.uniforms(t).drawRect()})),this._.spareTexture.swapWith(n||this._.texture)}e(t.exports,"simpleShader",(function(){return n}))})),i.register("fvBHO",(function(t,n){e(t.exports,"FxShader",(function(){return p}));var r,a=i("gFgFC"),s=i("kiQ5H"),o=i("4R9ai"),l=i("7dEWP"),h=i("eWjiX"),c="    attribute vec2 vertex;    attribute vec2 _texCoord;    varying vec2 texCoord;    void main() {        texCoord = _texCoord;        gl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);    }",u="    uniform sampler2D texture;    varying vec2 texCoord;    void main() {        gl_FragColor = texture2D(texture, texCoord);    }";var p=function(){"use strict";function e(t,i,n){if((0,a.default)(this,e),this.vertexAttribute=null,this.texCoordAttribute=null,this.program=h.BB.throwIfNull(l.gl.createProgram()),t=t||c,i=i||u,r||(r=this.testPrecisionSupport(l.gl.HIGH_FLOAT)?"highp":this.testPrecisionSupport(l.gl.MEDIUM_FLOAT)?"mediump":"lowp"),i="precision "+r+" float;"+i,l.gl.attachShader(this.program,this.compileSource(l.gl.VERTEX_SHADER,t,n+"(vertex)")),l.gl.attachShader(this.program,this.compileSource(l.gl.FRAGMENT_SHADER,i,n+"(fragment)")),l.gl.linkProgram(this.program),!l.gl.getProgramParameter(this.program,l.gl.LINK_STATUS))throw"link error: "+l.gl.getProgramInfoLog(this.program)}return(0,s.default)(e,[{key:"compileSource",value:function(e,t,i){var n=h.BB.throwIfNull(l.gl.createShader(e));if(l.gl.shaderSource(n,t.replace(/#define.*/,"")),l.gl.compileShader(n),!l.gl.getShaderParameter(n,l.gl.COMPILE_STATUS))throw"compile error: "+i+" - "+l.gl.getShaderInfoLog(n);return n}},{key:"testPrecisionSupport",value:function(e){var t=l.gl.getShaderPrecisionFormat(l.gl.FRAGMENT_SHADER,e);return null!==t&&0!==t.precision}},{key:"destroy",value:function(){l.gl.deleteProgram(this.program),this.program=null}},{key:"uniforms",value:function(e){var t=this;return l.gl.useProgram(this.program),Object.entries(e).forEach((function(e){var i,n=(0,o.default)(e,2),r=n[0],a=n[1],s=l.gl.getUniformLocation(t.program,r);if(null!==s)if(i=a,"[object Array]"==Object.prototype.toString.call(i))switch(a.length){case 1:l.gl.uniform1fv(s,new Float32Array(a));break;case 2:l.gl.uniform2fv(s,new Float32Array(a));break;case 3:l.gl.uniform3fv(s,new Float32Array(a));break;case 4:l.gl.uniform4fv(s,new Float32Array(a));break;case 9:l.gl.uniformMatrix3fv(s,!1,new Float32Array(a));break;case 16:l.gl.uniformMatrix4fv(s,!1,new Float32Array(a));break;default:throw"dont't know how to load uniform \""+r+'" of length '+a.length}else{if(!function(e){return"[object Number]"==Object.prototype.toString.call(e)}(a))throw'attempted to set uniform "'+r+'" to invalid value '+(a||"undefined").toString();l.gl.uniform1f(s,a)}})),this}},{key:"textures",value:function(e){var t=this;return l.gl.useProgram(this.program),Object.entries(e).forEach((function(e){var i=(0,o.default)(e,2),n=i[0],r=i[1];l.gl.uniform1i(l.gl.getUniformLocation(t.program,n),r)})),this}},{key:"drawRect",value:function(e,t,i,n){var r,a=l.gl.getParameter(l.gl.VIEWPORT);t=t!==r?(t-a[1])/a[3]:0,e=e!==r?(e-a[0])/a[2]:0,i=i!==r?(i-a[0])/a[2]:1,n=n!==r?(n-a[1])/a[3]:1,l.gl.vertexBuffer!==r&&null!==l.gl.vertexBuffer||(l.gl.vertexBuffer=h.BB.throwIfNull(l.gl.createBuffer())),l.gl.bindBuffer(l.gl.ARRAY_BUFFER,l.gl.vertexBuffer),l.gl.bufferData(l.gl.ARRAY_BUFFER,new Float32Array([e,t,e,n,i,t,i,n]),l.gl.STATIC_DRAW),null==l.gl.texCoordBuffer&&(l.gl.texCoordBuffer=h.BB.throwIfNull(l.gl.createBuffer()),l.gl.bindBuffer(l.gl.ARRAY_BUFFER,l.gl.texCoordBuffer),l.gl.bufferData(l.gl.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),l.gl.STATIC_DRAW)),null==this.vertexAttribute&&(this.vertexAttribute=l.gl.getAttribLocation(this.program,"vertex"),l.gl.enableVertexAttribArray(this.vertexAttribute)),null==this.texCoordAttribute&&(this.texCoordAttribute=l.gl.getAttribLocation(this.program,"_texCoord"),l.gl.enableVertexAttribArray(this.texCoordAttribute)),l.gl.useProgram(this.program),l.gl.bindBuffer(l.gl.ARRAY_BUFFER,l.gl.vertexBuffer),l.gl.vertexAttribPointer(this.vertexAttribute,2,l.gl.FLOAT,!1,0,0),l.gl.bindBuffer(l.gl.ARRAY_BUFFER,l.gl.texCoordBuffer),l.gl.vertexAttribPointer(this.texCoordAttribute,2,l.gl.FLOAT,!1,0,0),l.gl.drawArrays(l.gl.TRIANGLE_STRIP,0,4)}}],[{key:"getDefaultShader",value:function(){return l.gl.defaultShader=l.gl.defaultShader||new e,l.gl.defaultShader}}]),e}()})),i.register("7dEWP",(function(t,i){var n;function r(e){n=e}e(t.exports,"gl",(function(){return n})),e(t.exports,"setGl",(function(){return r}))})),i.register("8dg54",(function(t,n){e(t.exports,"FxTexture",(function(){return l}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7dEWP"),o=i("eWjiX"),l=function(){"use strict";function e(t,i,n,a){(0,r.default)(this,e),this.gl=s.gl,this.id=o.BB.throwIfNull(s.gl.createTexture()),this.width=t,this.height=i,this.format=n,this.type=a,this.canvas=null,s.gl.bindTexture(s.gl.TEXTURE_2D,this.id),s.gl.texParameteri(s.gl.TEXTURE_2D,s.gl.TEXTURE_MAG_FILTER,s.gl.LINEAR),s.gl.texParameteri(s.gl.TEXTURE_2D,s.gl.TEXTURE_MIN_FILTER,s.gl.LINEAR),s.gl.texParameteri(s.gl.TEXTURE_2D,s.gl.TEXTURE_WRAP_S,s.gl.CLAMP_TO_EDGE),s.gl.texParameteri(s.gl.TEXTURE_2D,s.gl.TEXTURE_WRAP_T,s.gl.CLAMP_TO_EDGE),t&&i&&s.gl.texImage2D(s.gl.TEXTURE_2D,0,this.format,t,i,0,this.format,this.type,null)}return(0,a.default)(e,[{key:"loadContentsOf",value:function(e){this.width=e.width||e.videoWidth,this.height=e.height||e.videoHeight,s.gl.bindTexture(s.gl.TEXTURE_2D,this.id),s.gl.texImage2D(s.gl.TEXTURE_2D,0,this.format,this.format,this.type,e)}},{key:"initFromBytes",value:function(e,t,i){this.width=e,this.height=t,this.format=s.gl.RGBA,this.type=s.gl.UNSIGNED_BYTE,s.gl.bindTexture(s.gl.TEXTURE_2D,this.id),s.gl.texImage2D(s.gl.TEXTURE_2D,0,s.gl.RGBA,e,t,0,s.gl.RGBA,this.type,new Uint8Array(i))}},{key:"destroy",value:function(){s.gl.deleteTexture(this.id),this.id=null}},{key:"use",value:function(e){s.gl.activeTexture(s.gl.TEXTURE0+(e||0)),s.gl.bindTexture(s.gl.TEXTURE_2D,this.id)}},{key:"unuse",value:function(e){s.gl.activeTexture(s.gl.TEXTURE0+(e||0)),s.gl.bindTexture(s.gl.TEXTURE_2D,null)}},{key:"ensureFormat",value:function(e,t,i,n){e==this.width&&t==this.height&&i==this.format&&n==this.type||(this.width=e,this.height=t,this.format=i,this.type=n,s.gl.bindTexture(s.gl.TEXTURE_2D,this.id),s.gl.texImage2D(s.gl.TEXTURE_2D,0,this.format,e,t,0,this.format,this.type,null))}},{key:"ensureFormatViaTexture",value:function(e){this.ensureFormat(e.width,e.height,e.format,e.type)}},{key:"drawTo",value:function(e){if(s.gl.framebuffer=s.gl.framebuffer||s.gl.createFramebuffer(),s.gl.bindFramebuffer(s.gl.FRAMEBUFFER,s.gl.framebuffer),s.gl.framebufferTexture2D(s.gl.FRAMEBUFFER,s.gl.COLOR_ATTACHMENT0,s.gl.TEXTURE_2D,this.id,0),s.gl.checkFramebufferStatus(s.gl.FRAMEBUFFER)!==s.gl.FRAMEBUFFER_COMPLETE)throw new Error("incomplete framebuffer");s.gl.viewport(0,0,this.width,this.height),e(),s.gl.bindFramebuffer(s.gl.FRAMEBUFFER,null)}},{key:"swapWith",value:function(e){var t;t=e.id,e.id=this.id,this.id=t,t=e.width,e.width=this.width,this.width=t,t=e.height,e.height=this.height,this.height=t,t=e.format,e.format=this.format,this.format=t}}],[{key:"fromElement",value:function(t){var i=new e(0,0,s.gl.RGBA,s.gl.UNSIGNED_BYTE);return i.loadContentsOf(t),i}}]),e}()})),i.register("1Vq1u",(function(t,n){e(t.exports,"curves",(function(){return l}));var r=i("fRyi0"),a=i("7dEWP"),s=i("fvBHO"),o=i("jrAes"),l=function(e,t,i){for(var n=(0,r.splineInterpolate)(e),l=(0,r.splineInterpolate)(t),h=(0,r.splineInterpolate)(i),c=[],u=0;u<256;u++)c.splice(c.length,0,n[u],l[u],h[u],255);return this._.extraTexture.initFromBytes(256,1,c),this._.extraTexture.use(1),a.gl.curves=a.gl.curves||new(0,s.FxShader)(null,"        uniform sampler2D texture;        uniform sampler2D map;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.r = texture2D(map, vec2(color.r)).r;            color.g = texture2D(map, vec2(color.g)).g;            color.b = texture2D(map, vec2(color.b)).b;            gl_FragColor = color;        }    ","curves"),a.gl.curves.textures({map:1}),o.simpleShader.call(this,a.gl.curves,{}),this}})),i.register("fRyi0",(function(t,n){e(t.exports,"splineInterpolate",(function(){return a}));var r=i("eWjiX");function a(e){for(var t=new r.BB.SplineInterpolator(e),i=[],n=0;n<256;n++)i.push(r.BB.clamp(Math.floor(256*t.interpolate(n/255)),0,255));return i}})),i.register("h6IOH",(function(t,n){e(t.exports,"hueSaturation",(function(){return l}));var r=i("7dEWP"),a=i("fvBHO"),s=i("jrAes"),o=i("eWjiX"),l=function(e,t){return r.gl.hueSaturation=r.gl.hueSaturation||new(0,a.FxShader)(null,"        uniform sampler2D texture;        uniform float hue;        uniform float saturation;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);                        /* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */            float angle = hue * 3.14159265;            float s = sin(angle), c = cos(angle);            vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;            float len = length(color.rgb);            color.rgb = vec3(                dot(color.rgb, weights.xyz),                dot(color.rgb, weights.zxy),                dot(color.rgb, weights.yzx)            );                        /* saturation adjustment */            float average = (color.r + color.g + color.b) / 3.0;            if (saturation > 0.0) {                color.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));            } else {                color.rgb += (average - color.rgb) * (-saturation);            }                        gl_FragColor = color;        }    ","hueSaturation"),s.simpleShader.call(this,r.gl.hueSaturation,{hue:o.BB.clamp(e,-1,1),saturation:o.BB.clamp(t,-1,1)}),this}})),i.register("9uhWc",(function(n,r){e(n.exports,"noise",(function(){return h}));var a=i("7dEWP"),s=i("fvBHO"),o=i("jrAes"),l=i("3TO8L"),h=function(e,i,n,r,h,c,u,p,d,g,f,v,m){return a.gl.noise=a.gl.noise||new(0,s.FxShader)(null,t(l).replace(/#define.*/,""),"noise"),o.simpleShader.call(this,a.gl.noise,{seed:e,type:i,scale:[n[0],n[1]],offset:r,octaves:h,samples:c,texSize:[this.width,this.height],peaks:u,brightness:p,contrast:d,isReversed:g?1:0,colA:f?[f.r/255,f.g/255,f.b/255]:[0,0,0],colB:v?[v.r/255,v.g/255,v.b/255]:[1,1,1],channels:"rgb"===m?0:1}),this}})),i.register("3TO8L",(function(e,t){e.exports="#define GLSLIFY 1\nuniform sampler2D texture;\nvarying vec2 texCoord;\nuniform vec2 texSize;\n\nuniform float seed;\nuniform float type;\nuniform vec2 scale;\nuniform vec2 offset;\nuniform float octaves;\nuniform float samples;\n\nuniform float peaks;\nuniform float contrast;\nuniform float brightness;\nuniform float isReversed;\n\nuniform vec3 colA;\nuniform vec3 colB;\n\nuniform float channels; // 0 - rgb, 1 - alpha\n\n// fbm, cellular_noise based on\n// https://github.com/Gonkee/Gonkees-Shaders\n// MIT, Copyright © Gonkee\n\n// hash & simplex based on\n// https://www.shadertoy.com/view/Msf3WH\n// MIT, Copyright © 2013 Inigo Quilez\n// https://www.youtube.com/c/InigoQuilez\n// https://iquilezles.org\n\nfloat rand(vec2 co) {\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nfloat value_noise(vec2 coord){\n    return rand(floor(coord) / 100.0);\n}\n\nfloat cellular_noise(vec2 coord) {\n    vec2 i = floor(coord);\n    vec2 f = fract(coord);\n\n    float min_dist = 99999.0;\n    for (float x = -1.0; x <= 1.0; x++) {\n        for (float y = -1.0; y <= 1.0; y++) {\n            vec2 node = rand(i + vec2(x, y)) + vec2(x, y);\n            float dist = sqrt((f - node).x * (f - node).x + (f - node).y * (f - node).y);\n            min_dist = min(min_dist, dist);\n        }\n    }\n    return min_dist;\n}\n\n// ---------- Simplex Alternative ---------------------\n\nvec3 hash(vec3 p)\n{ p=vec3(dot(p, vec3(127.1, 311.7, 74.7))\n, dot(p, vec3(269.5, 183.3, 246.1))\n, dot(p, vec3(113.5, 271.9, 124.6)))\n;return fract(sin(p)*43758.5453123)*2.-1.; }\n\nmat3 hash(mat3 p)\n{ return mat3(hash(p[0]), hash(p[1]), hash(p[2])); }\n\nvec3 dots(mat3 a, vec3 w, mat3 b){ return vec3\n(dot(a[0], w-b[0]), dot(a[1], w-b[1]), dot(a[2], w-b[2])); }\n\n//return noiseGra13dx as .x, and its derivatives as .yzw\n// https://www.shadertoy.com/view/llByD1\nvec3 noiseGra13dx(in vec3 x) {\n    vec3 p=floor(x), w=fract(x)\n    #if 1\n    , u=w*w*w*(w*(w*6.-15.)+10.), v=30.*w*w*(w*(w-2.)+1.)//quintic hermite\n    #else\n    , u=w*w*(3.-2.*w), v=6.*w*(1.-w)//cubic hermite\n    #endif\n    //gradients\n    , G=hash(p+vec3(0)), F=hash(p+vec3(1))\n    ;mat3 D=hash(mat3(p, p, p)+mat3(1)), E=hash(mat3(p, p, p)+1.-mat3(1));\n    //projections\n    vec3 d=dots(D, w, mat3(1)), e=dots(E, w, 1.-mat3(1));\n    //interpolations\n    float g=dot(G, w), f=dot(F, w-vec3(1));\n    vec3 h=u.yzx*(g-d.xyx-d.yzz+e.zxy)+d-g, U=u*h, a=d-e;\n    mat3 S=D-mat3(G, G, G), W=D-E;\n    a.x=(a.x+a.y+a.z)+f-g;\n    ;float b=u.x*u.y*u.z;\n\n    vec4 result = vec4(g+U.x+U.y+U.z+a.x*b// value\n    , G*(1.-b)+b*(W[0]+W[1]+W[2]+F)//https://www.shadertoy.com/view/llByD1\n    +u.x*(S[0]+u.y*(G-D[0]-D[1]+E[2]))// derivatives\n    +u.y*(S[1]+u.z*(G-D[1]-D[2]+E[0]))\n    +u.z*(S[2]+u.x*(G-D[0]-D[2]+E[1]))\n    +v*(u.zxy*(g-d.xxy-d.zyz+e.yzx)+h+u.yzx*u.zxy*a.x));\n    return 0.5 + 0.5 * result.xxx;\n}\n\nfloat fbm(vec2 coord) {\n    float normalize_factor = 0.0;\n    float value = 0.0;\n    float scale = 0.5;\n\n    for (float i = 0.0; i < 7.0; i++){\n        if (i < octaves) {\n            if (type == 0.0) {\n                value += value_noise(coord) * scale;\n            } else if (type == 1.0) {\n                value += noiseGra13dx(vec3(coord.x, coord.y, 0.0)).r * scale;\n            } else if (type == 2.0) {\n                value += cellular_noise(coord) * scale;\n            }\n            normalize_factor += scale;\n            coord *= 2.0;\n            scale *= 0.5;\n        }\n    }\n    return value / normalize_factor;\n}\n\nfloat render (vec2 pos) {\n    float result = fbm(pos);\n    //\n\n    if (peaks > 0.0) {\n        result = abs(mod(result * peaks - 0.5, 1.0) - 0.5) * 2.0;// triangle\n        //result = mod(result * (peaks + 1.0), 1.0); // sawtooth\n    }\n\n    result += brightness;\n    if (contrast > 0.0) {\n        result = clamp((result - 0.5) / (1.0 - contrast) + 0.5, 0.0, 1.0);\n    } else if (contrast < 0.0) {\n        result = clamp((result - 0.5) * (1.0 + contrast) + 0.5, 0.0, 1.0);\n    }\n\n    if (isReversed == 1.0) {\n        result = 1.0 - result;\n    }\n    return result;\n}\n\nvoid main() {\n    vec4 color;\n\n    vec2 seedOffset;\n    seedOffset.x = (rand(vec2(seed, 0.0)) * 100.0 - 50.0);\n    seedOffset.y = (rand(vec2(0.0, seed)) * 100.0 - 50.0);\n\n    float val = 0.0;\n    vec2 basePos = texCoord * texSize / scale - offset / scale + seedOffset;\n\n    if (samples == 1.0) {\n        val = render(basePos);\n\n    }/* else if (samples == 4.0) {\n        for (float i = 0.0; i < 2.0; i++) {\n            for (float e = 0.0; e < 2.0; e++) {\n                val += render(basePos + (vec2(i, e) - 0.5) * 0.5 / scale);\n            }\n        }\n        val /= 4.0;\n\n    }*/ else if (samples == 16.0) {\n        for (float i = 0.0; i < 4.0; i++) {\n            for (float e = 0.0; e < 4.0; e++) {\n                val += render(basePos + (vec2(i, e) - 0.25) * 0.25 / scale);\n            }\n        }\n        val /= 16.0;\n    }\n\n    if (channels == 0.0) {\n        gl_FragColor = vec4(vec3(mix(colA, colB, val)), 1.0);\n    } else {\n        gl_FragColor = vec4(vec3(1.0), val);\n    }\n}"})),i.register("e0olz",(function(t,n){e(t.exports,"triangleBlur",(function(){return l}));var r=i("7dEWP"),a=i("fvBHO"),s=i("4urfK"),o=i("jrAes"),l=function(e){return r.gl.triangleBlur=r.gl.triangleBlur||new(0,a.FxShader)(null,"        uniform sampler2D texture;        uniform vec2 delta;        varying vec2 texCoord;        "+s.randomShaderFunc+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta * percent);                                /* switch to pre-multiplied alpha to correctly blur transparent images */                sample.rgb *= sample.a;                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;                        /* switch back from pre-multiplied alpha */            gl_FragColor.rgb /= gl_FragColor.a + 0.00001;        }    ","triangleBlur"),o.simpleShader.call(this,r.gl.triangleBlur,{delta:[e/this.width,0]}),o.simpleShader.call(this,r.gl.triangleBlur,{delta:[0,e/this.height]}),this}})),i.register("4urfK",(function(t,i){e(t.exports,"randomShaderFunc",(function(){return n}));var n="    float random(vec3 scale, float seed) {        /* use the fragment position for a different seed per-pixel */        return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);    }"})),i.register("2myDH",(function(t,n){e(t.exports,"tiltShift",(function(){return l}));var r=i("7dEWP"),a=i("fvBHO"),s=i("4urfK"),o=i("jrAes"),l=function(e,t,i,n,l,h){r.gl.tiltShift=r.gl.tiltShift||new(0,a.FxShader)(null,"        uniform sampler2D texture;        uniform float blurRadius;        uniform float gradientRadius;        uniform vec2 start;        uniform vec2 end;        uniform vec2 delta;        uniform vec2 texSize;        varying vec2 texCoord;        "+s.randomShaderFunc+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        vec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));            float radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;            for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);                                /* switch to pre-multiplied alpha to correctly blur transparent images */                sample.rgb *= sample.a;                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;                        /* switch back from pre-multiplied alpha */            gl_FragColor.rgb /= gl_FragColor.a + 0.00001;        }    ","tiltShift");var c=i-e,u=n-t,p=Math.sqrt(c*c+u*u);return o.simpleShader.call(this,r.gl.tiltShift,{blurRadius:l,gradientRadius:h,start:[e,t],end:[i,n],delta:[c/p,u/p],texSize:[this.width,this.height]}),o.simpleShader.call(this,r.gl.tiltShift,{blurRadius:l,gradientRadius:h,start:[e,t],end:[i,n],delta:[-u/p,c/p],texSize:[this.width,this.height]}),this}})),i.register("44j8K",(function(t,n){e(t.exports,"matrixWarp",(function(){return l}));var r=i("7dEWP"),a=i("gDZ5A"),s=i("jrAes"),o=i("5taNf"),l=function(e,t,i){if(r.gl.matrixWarp=r.gl.matrixWarp||(0,a.warpShader)("        uniform mat3 matrix;        uniform bool useTextureSpace;    ","        if (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;        vec3 warp = matrix * vec3(coord, 1.0);        coord = warp.xy / warp.z;        if (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;    "),4==(e=e.flat()).length)e=[e[0],e[1],0,e[2],e[3],0,0,0,1];else if(9!=e.length)throw"can only warp with 2x2 or 3x3 matrix";return s.simpleShader.call(this,r.gl.matrixWarp,{matrix:t?(0,o.getInverse)(e):e,texSize:[this.width,this.height],useTextureSpace:i?1:0}),this}})),i.register("gDZ5A",(function(t,n){e(t.exports,"warpShader",(function(){return a}));var r=i("fvBHO");function a(e,t){return new(0,r.FxShader)(null,e+"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {        vec2 coord = texCoord * texSize;        "+t+"        gl_FragColor = texture2D(texture, coord / texSize);        vec2 clampedCoord = clamp(coord, vec2(0.0), texSize);        if (coord != clampedCoord) {            /* fade to transparent if we are outside the image */            gl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));        }    }","warp")}})),i.register("5taNf",(function(t,i){function n(e,t,i,n,r,a,s,o){var l=i-r,h=n-a,c=s-r,u=o-a,p=e-i+r-s,d=t-n+a-o,g=l*u-c*h,f=(p*u-c*d)/g,v=(l*d-p*h)/g;return[i-e+f*i,n-t+f*n,f,s-e+v*s,o-t+v*o,v,e,t,1]}function r(e){var t=e[0],i=e[1],n=e[2],r=e[3],a=e[4],s=e[5],o=e[6],l=e[7],h=e[8],c=t*a*h-t*s*l-i*r*h+i*s*o+n*r*l-n*a*o;return[(a*h-s*l)/c,(n*l-i*h)/c,(i*s-n*a)/c,(s*o-r*h)/c,(t*h-n*o)/c,(n*r-t*s)/c,(r*l-a*o)/c,(i*o-t*l)/c,(t*a-i*r)/c]}function a(e,t){return[e[0]*t[0]+e[1]*t[3]+e[2]*t[6],e[0]*t[1]+e[1]*t[4]+e[2]*t[7],e[0]*t[2]+e[1]*t[5]+e[2]*t[8],e[3]*t[0]+e[4]*t[3]+e[5]*t[6],e[3]*t[1]+e[4]*t[4]+e[5]*t[7],e[3]*t[2]+e[4]*t[5]+e[5]*t[8],e[6]*t[0]+e[7]*t[3]+e[8]*t[6],e[6]*t[1]+e[7]*t[4]+e[8]*t[7],e[6]*t[2]+e[7]*t[5]+e[8]*t[8]]}e(t.exports,"getSquareToQuad",(function(){return n})),e(t.exports,"getInverse",(function(){return r})),e(t.exports,"multiply",(function(){return a}))})),i.register("kSoEy",(function(t,n){e(t.exports,"unsharpMask",(function(){return o}));var r=i("7dEWP"),a=i("fvBHO"),s=i("jrAes"),o=function(e,t){return r.gl.unsharpMask=r.gl.unsharpMask||new(0,a.FxShader)(null,"        uniform sampler2D blurredTexture;        uniform sampler2D originalTexture;        uniform float strength;        uniform float threshold;        varying vec2 texCoord;        void main() {            vec4 blurred = texture2D(blurredTexture, texCoord);            vec4 original = texture2D(originalTexture, texCoord);            gl_FragColor = mix(blurred, original, 1.0 + strength);        }    ","unsharpMask"),this._.extraTexture.ensureFormatViaTexture(this._.texture),this._.texture.use(),this._.extraTexture.drawTo((function(){a.FxShader.getDefaultShader().drawRect()})),this._.extraTexture.use(1),this.triangleBlur(e),r.gl.unsharpMask.textures({originalTexture:1}),s.simpleShader.call(this,r.gl.unsharpMask,{strength:t}),this._.extraTexture.unuse(1),this}})),i.register("9WU1L",(function(t,n){e(t.exports,"toAlpha",(function(){return o}));var r=i("7dEWP"),a=i("fvBHO"),s=i("jrAes"),o=function(e,t){return r.gl.toAlpha=r.gl.toAlpha||new(0,a.FxShader)(null,"    uniform bool isInverted;    uniform vec4 replace;    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        float alpha = (color.r + color.g + color.b) / 3.0;        if (isInverted) alpha = 1.0 - alpha;        alpha = min(color.a, alpha);        if (replace.a > 0.0) color = replace;        gl_FragColor = vec4(color.r, color.g, color.b, alpha);    }","toAlpha"),s.simpleShader.call(this,r.gl.toAlpha,{isInverted:e?1:0,replace:t?[t.r/255,t.g/255,t.b/255,t.a]:[0,0,0,0],texSize:[this.width,this.height]}),this}})),i.register("bJIp5",(function(t,n){e(t.exports,"invert",(function(){return o}));var r=i("7dEWP"),a=i("fvBHO"),s=i("jrAes"),o=function(){return r.gl.invert=r.gl.invert||new(0,a.FxShader)(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        color.rgb = 1.0 - color.rgb;        gl_FragColor = color;    }","invert"),s.simpleShader.call(this,r.gl.invert,{texSize:[this.width,this.height]}),this}})),i.register("fkecp",(function(t,n){e(t.exports,"perspective",(function(){return s}));var r=i("4Ea8f"),a=i("5taNf"),s=function(e,t){var i=a.getSquareToQuad.apply(void 0,(0,r.default)(t)),n=a.getSquareToQuad.apply(void 0,(0,r.default)(e)),s=(0,a.multiply)((0,a.getInverse)(i),n);return this.matrixWarp(s)}})),i.register("3u9Uu",(function(t,n){e(t.exports,"unmultiplyAlpha",(function(){return o}));var r=i("7dEWP"),a=i("fvBHO"),s=i("jrAes"),o=function(){return r.gl.unmultiplyAlpha=r.gl.unmultiplyAlpha||new(0,a.FxShader)(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        if(color.a > 0.0) {            color.rgb /= color.a;        }        gl_FragColor = color;    }","unmultiplyAlpha"),s.simpleShader.call(this,r.gl.unmultiplyAlpha,{texSize:[this.width,this.height]}),this}})),i.register("6lIef",(function(t,n){e(t.exports,"distort",(function(){return o}));var r=i("7dEWP"),a=i("gDZ5A"),s=i("jrAes"),o=function(e){return r.gl.distort=r.gl.distort||(0,a.warpShader)("        uniform float stepSize;        uniform vec2 scale;        uniform vec2 strength;        uniform vec2 phase;        uniform float type;        ","        const float PI = 3.14159265;        float x = coord.x;        float y = coord.y;        if (stepSize > 1.0) {            x = floor(x / stepSize) * stepSize;            y = floor(y / stepSize) * stepSize;        }        float distortX = sin((x/scale.x + phase.x) * PI * 2.0) * strength.x;        float distortY = sin((y/scale.y + phase.y) * PI * 2.0) * strength.y;        if (type == 0.0) {            coord.y += distortX;            coord.x += distortY;        } else if (type == 1.0) {            coord.x += distortX;            coord.y += distortY;        } else if (type == 2.0) {            gl_FragColor = texture2D(texture, vec2(x, y) / texSize);            coord.y += sin(gl_FragColor.r/scale.x*200.0 + phase.x * PI * 2.0) * strength.x;            coord.x += cos(gl_FragColor.g/scale.y*200.0 + phase.y * PI * 2.0) * strength.y;        }        coord.x = mod(coord.x, texSize.x);        coord.y = mod(coord.y, texSize.y);                "),s.simpleShader.call(this,r.gl.distort,{stepSize:e.stepSize,type:e.distortType,scale:[e.scale.x,e.scale.y],strength:[e.strength.x,e.strength.y],phase:[e.phase.x,e.phase.y],texSize:[this.width,this.height]}),this}})),i.register("lwXVT",(function(t,n){e(t.exports,"multiplyAlpha",(function(){return o}));var r=i("7dEWP"),a=i("fvBHO"),s=i("jrAes"),o=function(){return r.gl.multiplyAlpha=r.gl.multiplyAlpha||new(0,a.FxShader)(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        color.rgb *= color.a;        gl_FragColor = color;    }","multiplyAlpha"),s.simpleShader.call(this,r.gl.multiplyAlpha,{texSize:[this.width,this.height]}),this}})),i.register("lorQQ",(function(t,n){e(t.exports,"filterCropExtend",(function(){return u}));var r=i("eWjiX"),a=i("dJPtW"),s=i("7bWhB"),o=i("43qNf"),l=i("32CBv"),h=i("1mH1z"),c=i("1C8RU"),u={getDialog:function(e){var t=function(){B=parseInt(P.value),b=parseInt(O.value),w=parseInt(R.value),k=parseInt(D.value);var e=u.getWidth()+B+b,t=u.getHeight()+w+k;e<=0&&(C&&(B=-u.getWidth()-b+1,P.value=""+B),S&&(b=-u.getWidth()-B+1,O.value=""+b),e=1),e>I&&(C&&(B=-u.getWidth()-b+I,P.value=""+B),S&&(b=-u.getWidth()-B+I,O.value=""+b),e=I),t<=0&&(L&&(w=-u.getHeight()-k+1,R.value=""+w),A&&(k=-u.getHeight()-w+1,D.value=""+k),t=1),t>E&&(L&&(w=-u.getHeight()-k+E,R.value=""+w),A&&(k=-u.getHeight()-w+E,D.value=""+k),t=E),Y.setTransform({x:-B,y:-w,width:e,height:t}),C=!1,S=!1,L=!1,A=!1},i=function(e){var t=r.BB.fitInto(e.width,e.height,260,180,1);x=t.width/e.width;var i=r.BB.centerWithin(340,V,t.width,t.height);p.style.width=u.getWidth()*x+"px",p.style.height=u.getHeight()*x+"px",K.style.left=i.x-e.x*x+"px",K.style.top=i.y-e.y*x+"px",B=parseInt(""+-e.x),w=parseInt(""+-e.y),b=parseInt(""+(e.x+e.width-u.getWidth())),k=parseInt(""+(e.y+e.height-u.getHeight())),P.value=""+B,R.value=""+w,O.value=""+b,D.value=""+k,r.BB.createCheckerDataUrl(parseInt(""+50*x),(function(e){U.style.background="url("+e+")",0!==G.a&&(p.style.background="url("+e+")")}),c.theme.isDark()),U.style.backgroundPosition=i.x+"px "+i.y+"px",Y.setScale(x)},n=function(){t()},u=e.klCanvas;if(!u)return!1;var p=r.BB.canvas(),d=r.BB.fitInto(u.getWidth(),u.getHeight(),560,400,1),g=parseInt(""+d.width),f=parseInt(""+d.height),v=g/u.getWidth();p.width=g,p.height=f,p.style.display="block",r.BB.ctx(p).drawImage(u.getCompleteCanvas(v),0,0,g,f);var m=document.createElement("div"),y={element:m};m.innerHTML=(0,h.LANG)("filter-crop-description")+"<br/><br/>";var x,B=0,b=0,w=0,k=0,C=!1,S=!1,L=!1,A=!1,I=e.maxWidth,E=e.maxHeight,T=r.BB.el({css:{lineHeight:"30px",height:"35px"}}),M=r.BB.el({css:{lineHeight:"30px",height:"35px"}});m.append(T,M);var P=(0,a.input)({init:0,type:"number",min:-u.getWidth(),max:I,css:{width:"75px",marginRight:"20px"},callback:function(e){C=!0,t()}}),O=(0,a.input)({init:0,type:"number",min:-u.getWidth(),max:I,css:{width:"75px"},callback:function(e){S=!0,t()}}),R=(0,a.input)({init:0,type:"number",min:-u.getHeight(),max:E,css:{width:"75px",marginRight:"20px"},callback:function(e){L=!0,t()}}),D=(0,a.input)({init:0,type:"number",min:-u.getHeight(),max:E,css:{width:"75px"},callback:function(e){A=!0,t()}}),N={display:"inline-block",width:"60px"};T.append(r.BB.el({content:(0,h.LANG)("filter-crop-left")+":",css:N}),P,r.BB.el({content:(0,h.LANG)("filter-crop-right")+":",css:N}),O),M.append(r.BB.el({content:(0,h.LANG)("filter-crop-top")+":",css:N}),R,r.BB.el({content:(0,h.LANG)("filter-crop-bottom")+":",css:N}),D);var z=!0,j=new(0,s.Checkbox)({init:!0,label:(0,h.LANG)("filter-crop-rule-thirds"),allowTab:!0,callback:function(e){z=e,Y.showThirds(z)}});m.append(r.BB.el({css:{clear:"both"}}));var G={r:0,g:0,b:0,a:0},H=[{r:0,g:0,b:0,a:0},{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1}];H.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),H.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1});var F=new(0,o.ColorOptions)({label:(0,h.LANG)("filter-crop-fill"),colorArr:H,onChange:function(e){0===(G=e).a?(X.style.background="",p.style.background=""):(X.style.background=r.BB.ColorConverter.toRgbStr(G),r.BB.createCheckerDataUrl(parseInt(""+50*x),(function(e){p.style.background="url("+e+")"}),c.theme.isDark()))}}),W=r.BB.el({css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"10px"}});m.append(W),W.append(j.getElement(),F.getElement());var V=218,U=r.BB.el({className:"kl-edit-crop-preview",css:{width:"340px",marginTop:"10px",marginLeft:"-20px",height:V+"px",backgroundColor:"#9e9e9e",position:"relative",borderTop:"1px solid rgb(144,144,144)",borderBottom:"1px solid rgb(144,144,144)",overflow:"hidden",userSelect:"none",touchAction:"none"}});U.oncontextmenu=function(){return!1};var X=r.BB.el({css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"}});U.append(X);var K=document.createElement("div");K.style.position="absolute",K.style.left="0px",K.style.top="0px",U.append(K);r.BB.el({parent:K,content:p,css:{boxShadow:"0 0 0px 1px rgb(130,130,130)",position:"absolute",left:"0px",top:"0px"}});m.append(U);var Y=new(0,l.Cropper)({x:0,y:0,width:u.getWidth(),height:u.getHeight(),scale:x,callback:i,maxW:I,maxH:E});return i(Y.getTransform()),K.append(Y.getElement()),c.theme.addIsDarkListener(n),y.destroy=function(){Y.destroy(),j.destroy(),c.theme.removeIsDarkListener(n),F.destroy()},y.getInput=function(){return y.destroy(),{left:B,right:b,top:w,bottom:k,fillColor:0===G.a?void 0:G}},y},apply:function(e){var t=e.klCanvas,i=e.history;return!(!t||!i||isNaN(e.input.left)||isNaN(e.input.right)||isNaN(e.input.top)||isNaN(e.input.bottom))&&(i.pause(!0),t.resizeCanvas(e.input),i.pause(!1),i.push({tool:["filter","cropExtend"],action:"apply",params:[{input:r.BB.copyObj(e.input)}]}),!0)}}})),i.register("8Ri8I",(function(t,n){e(t.exports,"filterCurves",(function(){return h}));var r=i("eWjiX"),a=i("i5nyl"),s=i("a5EFw"),o=i("1mH1z"),l=i("hRvnE"),h={getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),h=i.getLayerIndex(t.canvas),c=r.BB.fitInto(t.canvas.width,t.canvas.height,280,200,1),u=parseInt(""+c.width),p=parseInt(""+c.height),d=r.BB.canvas(u,p),g=r.BB.ctx(d);g.save(),d.width>t.canvas.width&&(g.imageSmoothingEnabled=!1),g.drawImage(t.canvas,0,0,u,p),g.restore();var f,v=r.BB.el(),m={element:v};return setTimeout((function(){v.innerHTML=(0,o.LANG)("filter-curves-description")+"<br/><br/>";var e=(0,l.getDefaultCurvesInput)(),t=(0,s.getSharedFx)();if(t){var i=t.texture(d);t.draw(i).update();var c=new(0,l.CurvesInput)({curves:e,callback:function(n){e=n,function(){try{t.draw(i).curves(e.r,e.g,e.b).update(),f&&f.render()}catch(e){v.errorCallback(e)}}()}}),g=c.getModeButtons();v.append(c.getElement());for(var y=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}}),x=[],B=0;B<n.length;B++)x.push({image:B===h?t:n[B].context.canvas,opacity:n[B].opacity,mixModeStr:n[B].mixModeStr});f=new(0,a.KlCanvasPreview)({width:parseInt(""+u),height:parseInt(""+p),layers:x});var b=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+u)+"px",height:parseInt(""+p)+"px"}});b.append(f.getElement()),y.append(b),v.append(y),m.destroy=function(){c.destroy(),i.destroy(),g.destroy(),f.destroy()},m.getInput=function(){return m.destroy(),{curves:e}}}}),1),m},apply:function(e){var t=e.context,i=e.input.curves,n=e.history;if(!t||!n)return!1;n.pause(!0);var r=(0,s.getSharedFx)();if(!r)return!1;var a=r.texture(t.canvas);return r.draw(a).curves(i.r,i.g,i.b).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(r,0,0),a.destroy(),n.pause(!1),n.push({tool:["filter","curves"],action:"apply",params:[{input:e.input}]}),!0}}})),i.register("hRvnE",(function(t,n){e(t.exports,"getDefaultCurvesInput",(function(){return h})),e(t.exports,"CurvesInput",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("iFIyy"),o=i("1mH1z"),l=i("eWjiX");function h(){return l.BB.copyObj({r:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],g:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],b:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]]})}var c=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.rootEl=l.BB.el({css:{position:"relative",marginBottom:"10px"}}),this.rootEl.oncontextmenu=function(){return!1};var n="All",a=t.curves;this.modeButtons=new(0,s.Options)({optionArr:[{id:"All",label:(0,o.LANG)("filter-curves-all")},{id:"Red",label:(0,o.LANG)("red")},{id:"Green",label:(0,o.LANG)("green")},{id:"Blue",label:(0,o.LANG)("blue")}],initId:"All",onChange:function(e){"All"===(n=e)&&(a=h());var t=a.r;"Green"===n&&(t=a.g),"Blue"===n&&(t=a.b),i.p0.setPos(0,p-t[0][1]*p),i.p1.setPos(t[1][0]*u,p-t[1][1]*p),i.p2.setPos(t[2][0]*u,p-t[2][1]*p),i.p3.setPos(u,p-t[3][1]*p),y()}}),this.rootEl.append(this.modeButtons.getElement());var c=l.BB.el({parent:this.rootEl,className:"kl-curves-graph",css:{position:"relative",marginTop:"10px"}}),u=300,p=100,d=l.BB.canvas(u,p),g=l.BB.ctx(d);c.append(d);var f=function(e){return Math.max(0,Math.min(1,e))},v=function(e,t,i,n){var r=t,a=e,s=l.BB.el({className:"kl-curves-graph__grip",css:{left:e-7+"px",top:t-7+"px",width:"14px",height:"14px",borderRadius:"14px"}}),o=new l.BB.PointerListener({target:s,onPointer:function(o){o.eventPreventDefault(),"pointerdown"===o.type&&(a=e,r=t),"left"===o.button&&"pointermove"===o.type&&(n||(a+=o.dX),e=Math.max(0,Math.min(u,a)),r+=o.dY,t=Math.max(0,Math.min(p,r)),l.BB.css(s,{left:e-7+"px",top:t-7+"px"}),i({x:e,y:t}))}});c.append(s);return{el:s,setPos:function(i,n){r=t=n,a=e=i,l.BB.css(s,{left:e-7+"px",top:t-7+"px"})},pointerListener:o}},m=function(e,t,i){"All"===n&&(a.r[e]=[f(t/u),f(1-i/p)],a.g[e]=[f(t/u),f(1-i/p)],a.b[e]=[f(t/u),f(1-i/p)]),"Red"===n&&(a.r[e]=[f(t/u),f(1-i/p)]),"Green"===n&&(a.g[e]=[f(t/u),f(1-i/p)]),"Blue"===n&&(a.b[e]=[f(t/u),f(1-i/p)])};this.p0=v(0,p,(function(e){m(0,e.x,e.y),y()}),!0),this.p1=v(u/3,p/3*2,(function(e){m(1,e.x,e.y),y()})),this.p2=v(u/3*2,p/3,(function(e){m(2,e.x,e.y),y()})),this.p3=v(u,0,(function(e){m(3,e.x,e.y),y()}),!0);var y=function(){(g=l.BB.ctx(d)).clearRect(0,0,d.width,d.height);for(var e={r:[],g:[],b:[]},i=0;i<a.r.length;i++)e.r.push(a.r[i]),e.g.push(a.g[i]),e.b.push(a.b[i]);var r=function(e){g.beginPath();for(var t=new l.BB.SplineInterpolator(e),i=0;i<100;i++){var n=t.interpolate(i/100);n=Math.max(0,Math.min(1,n)),0===i?g.moveTo(i/100*u,p-n*p):g.lineTo(i/100*u,p-n*p)}g.stroke()};g.save(),"All"===n?(g.strokeStyle="black",r(e.r)):(g.globalAlpha=.5,g.strokeStyle="red",r(e.r),g.strokeStyle="green",r(e.g),g.strokeStyle="blue",r(e.b)),g.restore(),t.callback(e)};y()}return(0,a.default)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.p0.pointerListener.destroy(),this.p1.pointerListener.destroy(),this.p2.pointerListener.destroy(),this.p3.pointerListener.destroy()}},{key:"getModeButtons",value:function(){return this.modeButtons}}]),e}()})),i.register("fADXF",(function(t,n){e(t.exports,"filterFlip",(function(){return c}));var r=i("eWjiX"),a=i("7bWhB"),s=i("i5nyl"),o=i("1mH1z"),l=i("7jh4K"),h=i("iFIyy"),c={getDialog:function(e){var t=function(){var e=r.BB.ctx(k.image);e.save(),e.clearRect(0,0,k.image.width,k.image.height),y&&(v&&(e.translate(k.image.width,0),e.scale(-1,1)),m&&(e.translate(0,k.image.height),e.scale(1,-1)));for(var t=0;t<l.length;t++)e.save(),y||c!==t||(v&&(e.translate(k.image.width,0),e.scale(-1,1)),m&&(e.translate(0,k.image.height),e.scale(1,-1))),e.canvas.width>l[t].context.canvas.width&&(e.imageSmoothingEnabled=!1),e.globalAlpha=l[t].opacity,e.globalCompositeOperation=l[t].mixModeStr,e.drawImage(l[t].context.canvas,0,0,k.image.width,k.image.height),e.restore();C.render(),e.restore()},i=e.context,n=e.klCanvas;if(!i||!n)return!1;var l=n.getLayers(),c=n.getLayerIndex(i.canvas),u=r.BB.fitInto(i.canvas.width,i.canvas.height,280,200,1),p=parseInt(""+u.width),d=parseInt(""+u.height),g=document.createElement("div"),f={element:g},v=!0,m=!1,y=!0;g.innerHTML=(0,o.LANG)("filter-flip-description")+"<br/><br/>";var x=new(0,a.Checkbox)({init:v,label:(0,o.LANG)("filter-flip-horizontal")+" ⟷",allowTab:!0,callback:function(e){v=e,t()},css:{marginBottom:"10px"}}),B=new(0,a.Checkbox)({init:m,label:(0,o.LANG)("filter-flip-vertical")+" ↕",allowTab:!0,callback:function(e){m=e,t()},css:{marginBottom:"10px"}});g.append(x.getElement()),g.append(B.getElement());var b=new(0,h.Options)({optionArr:[{id:!0,label:(0,o.LANG)("filter-flip-image")},{id:!1,label:(0,o.LANG)("filter-flip-layer")}],onChange:function(e){y=e,t()}});g.append(b.getElement());var w=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}}),k={image:r.BB.canvas(Math.round(p),Math.round(d)),opacity:1,mixModeStr:"source-over"},C=new(0,s.KlCanvasPreview)({width:Math.round(p),height:Math.round(d),layers:[k]}),S=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+p)+"px",height:parseInt(""+d)+"px"}});return S.append(C.getElement()),w.append(S),setTimeout(t,0),g.append(w),f.destroy=function(){x.destroy(),B.destroy(),b.destroy(),C.destroy()},f.getInput=function(){return f.destroy(),{horizontal:v,vertical:m,flipCanvas:y}},f},apply:function(e){var t=e.context,i=e.klCanvas,n=e.history,r=e.input.horizontal,a=e.input.vertical,s=e.input.flipCanvas;return!!(t&&i&&n)&&(n.pause(!0),i.flip(r,a,s?void 0:(0,l.throwIfNull)(i.getLayerIndex(t.canvas))),n.pause(!1),n.push({tool:["filter","flip"],action:"apply",params:[{input:e.input}]}),!0)}}})),i.register("bIns5",(function(t,n){e(t.exports,"filterHueSaturation",(function(){return c}));var r=i("eWjiX"),a=i("cH2YE"),s=i("aP0jf"),o=i("i5nyl"),l=i("a5EFw"),h=i("1mH1z"),c={getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),c=i.getLayerIndex(t.canvas),u=r.BB.fitInto(t.canvas.width,t.canvas.height,280,200,1),p=parseInt(""+u.width),d=parseInt(""+u.height),g=r.BB.canvas(p,d),f=r.BB.ctx(g);f.save(),g.width>t.canvas.width&&(f.imageSmoothingEnabled=!1),f.drawImage(t.canvas,0,0,p,d),f.restore();var v=document.createElement("div"),m={element:v};return setTimeout((function(){var e=0,t=0;v.innerHTML=(0,h.LANG)("filter-hue-sat-description")+"<br/><br/>";var i=(0,l.getSharedFx)();if(i){var u=i.texture(g);i.draw(u).update();var f=new(0,s.KlSlider)({label:(0,h.LANG)("filter-hue-sat-hue"),width:300,height:30,min:-100,max:100,value:100*e,eventResMs:a.eventResMs,onChange:function(n){e=n/100,i.draw(u).hueSaturation(e,t).update(),w.render()}}),y=new(0,s.KlSlider)({label:(0,h.LANG)("filter-hue-sat-saturation"),width:300,height:30,min:0,max:100,value:50*(t+1),eventResMs:a.eventResMs,onChange:function(n){t=n/50-1,i.draw(u).hueSaturation(e,t).update(),w.render()}});f.getElement().style.marginBottom="10px",v.append(f.getElement(),y.getElement());for(var x=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}}),B=[],b=0;b<n.length;b++)B.push({image:b===c?i:n[b].context.canvas,opacity:n[b].opacity,mixModeStr:n[b].mixModeStr});var w=new(0,o.KlCanvasPreview)({width:parseInt(""+p),height:parseInt(""+d),layers:B}),k=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+p)+"px",height:parseInt(""+d)+"px"}});k.append(w.getElement()),x.append(k),v.append(x);try{i.draw(u).hueSaturation(e,t).update(),w.render()}catch(e){v.errorCallback(e)}m.destroy=function(){f.destroy(),y.destroy(),u.destroy(),w.destroy()},m.getInput=function(){return m.destroy(),{hue:e,saturation:t}}}}),1),m},apply:function(e){var t=e.context,i=e.input.hue,n=e.history,r=e.input.saturation;if(!t||null===i||null===r||!n)return!1;n.pause(!0);var a=(0,l.getSharedFx)();if(!a)return!1;var s=a.texture(t.canvas);return a.draw(s).hueSaturation(i,r).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),s.destroy(),n.pause(!1),n.push({tool:["filter","hueSaturation"],action:"apply",params:[{input:e.input}]}),!0}}})),i.register("30jcG",(function(t,n){e(t.exports,"filterInvert",(function(){return a}));var r=i("a5EFw"),a={apply:function(e){var t=e.context,i=e.history;if(!t||!i)return!1;i.pause(!0);var n=(0,r.getSharedFx)();if(!n)return!1;var a=n.texture(t.canvas);return n.draw(a).invert().update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(n,0,0),a.destroy(),i.pause(!1),i.push({tool:["filter","invert"],action:"apply",params:[{input:e.input}]}),!0}}})),i.register("cCks8",(function(t,n){e(t.exports,"filterPerspective",(function(){return h}));var r=i("eWjiX"),a=i("i5nyl"),s=i("a5EFw"),o=i("1mH1z"),l=i("5vheV"),h={getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=window.innerWidth<550,h=i.getLayers(),c=i.getLayerIndex(t.canvas),u=r.BB.fitInto(t.canvas.width,t.canvas.height,n?280:490,n?200:240,1),p=parseInt(""+u.width),d=parseInt(""+u.height),g=Math.min(p,t.canvas.width),f=Math.min(d,t.canvas.height),v=r.BB.canvas(g,f),m=r.BB.ctx(v);m.save(),g>t.canvas.width&&(m.imageSmoothingEnabled=!1),m.drawImage(t.canvas,0,0,g,f),m.restore();var y=p/t.canvas.width,x=document.createElement("div"),B={element:x};n||(B.width=500);var b=[];return setTimeout((function(){x.innerHTML=(0,o.LANG)("filter-perspective-description")+"<br/><br/>";var e=(0,s.getSharedFx)();if(e){var t,i,u,m,w,k,C,S,L=e.texture(v);e.draw(L).update(),t=D(0,0,N),i=D(p,0,N),u=D(p,d,N),m=D(0,d,N),w=D(0,0),k=D(p,0),C=D(p,d),S=D(0,d);var A=new(0,l.TwoTabs)({left:(0,o.LANG)("compare-before"),right:(0,o.LANG)("compare-after"),init:1,onChange:function(e){0===e?(w.style.display="none",k.style.display="none",C.style.display="none",S.style.display="none",t.style.display="block",i.style.display="block",u.style.display="block",m.style.display="block",t.copy(w),i.copy(k),u.copy(C),m.copy(S)):(t.style.display="none",i.style.display="none",u.style.display="none",m.style.display="none",w.style.display="block",k.style.display="block",C.style.display="block",S.style.display="block",w.copy(t),k.copy(i),C.copy(u),S.copy(m)),R()}});x.append(A.getElement());var I=r.BB.el({className:"kl-preview-wrapper",css:{width:n?"340px":"540px",height:n?"260px":"300px",marginTop:"0"}});I.oncontextmenu=function(){return!1};for(var E=[],T=0;T<h.length;T++){var M=T===c?e:h[T].context.canvas;E.push({image:M,opacity:h[T].opacity,mixModeStr:h[T].mixModeStr})}var P=new(0,a.KlCanvasPreview)({width:parseInt(""+p),height:parseInt(""+d),layers:E}),O=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+p)+"px",height:parseInt(""+d)+"px"}});O.append(P.getElement()),I.append(O),O.append(w,k,C,S),t.style.display="none",i.style.display="none",u.style.display="none",m.style.display="none",O.append(t,i,u,m),x.append(I),R(),B.destroy=function(){for(var e=0;e<b.length;e++)b[e].destroy();L.destroy(),P.destroy()},B.getInput=function(){return B.destroy(),{before:[t.x/y,t.y/y,i.x/y,i.y/y,u.x/y,u.y/y,m.x/y,m.y/y],after:[w.x/y,w.y/y,k.x/y,k.y/y,C.x/y,C.y/y,S.x/y,S.y/y]}}}function R(){try{e.draw(L).multiplyAlpha().perspective([t.x,t.y,i.x,i.y,u.x,u.y,m.x,m.y].map((function(e,t){return t%2==0?e/p*g:e/d*f})),[w.x,w.y,k.x,k.y,C.x,C.y,S.x,S.y].map((function(e,t){return t%2==0?e/p*g:e/d*f}))).unmultiplyAlpha().update(),P.render()}catch(e){x.errorCallback(e)}}function D(e,t,i){var n=document.createElement("div");n.x=e,n.y=t,r.BB.css(n,{width:"14px",height:"14px",backgroundColor:"#fff",boxShadow:"inset 0 0 0 2px #000",borderRadius:"14px",position:"absolute",cursor:"move",left:n.x-7+"px",top:n.y-7+"px",userSelect:"none",touchAction:"none"});var a=new r.BB.PointerListener({target:n,onPointer:function(e){e.eventPreventDefault(),"left"===e.button&&"pointermove"===e.type&&(n.x+=e.dX,n.y+=e.dY,n.style.left=n.x-7+"px",n.style.top=n.y-7+"px",i&&i(),R())}});return n.copy=function(e){n.x=e.x,n.y=e.y,n.style.left=n.x-7+"px",n.style.top=n.y-7+"px"},b.push(a),n}function N(){w.copy(t),k.copy(i),C.copy(u),S.copy(m)}}),1),B},apply:function(e){var t=e.context,i=e.history,n=e.input.before,r=e.input.after;if(!(t&&n&&r&&i))return!1;i.pause(!0);var a=(0,s.getSharedFx)();if(!a)return!1;var o=a.texture(t.canvas);return a.draw(o).multiplyAlpha().perspective(n,r).unmultiplyAlpha().update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),o.destroy(),i.pause(!1),i.push({tool:["filter","perspective"],action:"apply",params:[{input:e.input}]}),!0}}})),i.register("5vheV",(function(t,n){e(t.exports,"TwoTabs",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){var i=this;(0,r.default)(this,e),this.value=t.init,this.rootEl=s.BB.el({className:"kl-2-tabs"}),this.leftTab=s.BB.el({parent:this.rootEl,content:t.left,className:"kl-2-tabs__left"}),this.leftTab.onpointerdown=function(){return!1},this.rightTab=s.BB.el({parent:this.rootEl,content:t.right,className:"kl-2-tabs__right"}),this.rightTab.onpointerdown=function(){return!1},this.update(),this.leftTab.onclick=function(){0!==i.value&&(i.value=0,i.update(),t.onChange(i.value))},this.rightTab.onclick=function(){1!==i.value&&(i.value=1,i.update(),t.onChange(i.value))}}return(0,a.default)(e,[{key:"update",value:function(){this.leftTab.classList.toggle("kl-2-tabs--active",0===this.value),this.rightTab.classList.toggle("kl-2-tabs--active",1===this.value)}},{key:"getElement",value:function(){return this.rootEl}}]),e}()})),i.register("huXOx",(function(n,r){e(n.exports,"filterResize",(function(){return p}));var a=i("eWjiX"),s=i("7bWhB"),o=i("eEL9N"),l=i("bNBIp"),h=i("1mH1z"),c=i("cNr8p"),u=i("1C8RU"),p={getDialog:function(e){var i=function(){if(0===S.value.length&&T||0===L.value.length&&E)return E=!1,void(T=!1);if(S.value=""+Math.max(1,parseInt(S.value)),L.value=""+Math.max(1,parseInt(L.value)),P&&(E&&(S.value=""+parseInt(""+parseInt(L.value)*M)),T&&(L.value=""+parseInt(""+parseInt(S.value)/M)),parseInt(S.value)>b||parseInt(L.value)>w)){var e=a.BB.fitInto(parseInt(S.value),parseInt(L.value),b,w,1);S.value=""+parseInt(""+e.width),L.value=""+parseInt(""+e.height)}parseInt(S.value)>b&&(S.value=""+b),parseInt(L.value)>w&&(L.value=""+w),E=!1,T=!1,x=parseInt(S.value),B=parseInt(L.value);var t=a.BB.fitInto(x,B,280,200,1),i=parseInt(""+t.width),n=parseInt(""+t.height);f=i/x;var s=a.BB.centerWithin(340,220,i,n);"smooth"===R.getValue()?(D.style.imageRendering=f>1?"pixelated":"",D.width=r.getWidth(),D.height=r.getHeight(),N.save(),N.imageSmoothingQuality="high",N.drawImage(v,0,0),a.BB.resizeCanvas(D,x,B),N.restore()):(D.style.imageRendering="pixelated",D.width=x,D.height=B,N.save(),N.imageSmoothingEnabled=!1,N.drawImage(v,0,0,D.width,D.height),N.restore()),D.style.width=Math.max(1,i)+"px",D.style.height=Math.max(1,n)+"px",j.style.left=s.x+"px",j.style.top=s.y+"px",j.style.width=Math.max(1,i)+"px",j.style.height=Math.max(1,n)+"px"},n=function(){a.BB.createCheckerDataUrl(8,(function(e){z.style.background="url("+e+")"}),u.theme.isDark())},r=e.klCanvas;if(!r)return!1;var p=a.BB.fitInto(r.getWidth(),r.getHeight(),280,200,1),d=parseInt(""+p.width),g=parseInt(""+p.height),f=d/r.getWidth(),v=r.getCompleteCanvas(1),m=document.createElement("div"),y={element:m},x=r.getWidth(),B=r.getHeight();m.innerHTML=(0,h.LANG)("filter-resize-description")+"<br/><br/>";var b=e.maxWidth,w=e.maxHeight,k=a.BB.el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),C=a.BB.el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),S=a.BB.el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+b,value:""+r.getWidth()}}),L=a.BB.el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+w,value:""+r.getHeight()}});S.onclick=function(){this.focus(),T=!0,i()},L.onclick=function(){this.focus(),E=!0,i()},S.onchange=function(){T=!0,i()},L.onchange=function(){E=!0,i()},k.append((0,h.LANG)("width")+": ",S),C.append((0,h.LANG)("height")+": ",L),a.BB.el({css:{background:"url("+t(l)+") no-repeat 140px 5px",backgroundSize:"50px 52px"}}).append(k,C);var A=new Image;A.src=t(l),A.height=40;var I=(0,c.table)([[(0,h.LANG)("width")+":&nbsp;",S,A],[a.BB.el({css:{height:"5px"}}),"",""],[(0,h.LANG)("height")+":&nbsp;",L]],{.2:{rowspan:3}});a.BB.css(I,{marginBottom:"10px"}),m.append(I);var E=!1,T=!1,M=r.getWidth()/r.getHeight(),P=!0,O=new(0,s.Checkbox)({init:!0,label:(0,h.LANG)("constrain-proportions"),allowTab:!0,callback:function(e){P=e,A.style.display=P?"":"none",P&&(S.value=""+r.getWidth(),L.value=""+r.getHeight(),i())}});m.append(a.BB.el({css:{clear:"both"}}));var R=new(0,o.Select)({isFocusable:!0,optionArr:[["smooth",(0,h.LANG)("algorithm-smooth")],["pixelated",(0,h.LANG)("algorithm-pixelated")]],title:(0,h.LANG)("scaling-algorithm"),initValue:"smooth",onChange:function(){i()}});a.BB.el({parent:m,css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}).append(O.getElement(),R.getElement());var D=a.BB.canvas(d,g);D.style.imageRendering="pixelated";var N=a.BB.ctx(D),z=a.BB.el({className:"kl-transparent-preview",css:{width:"340px",marginLeft:"-20px",height:"220px",display:"table",marginTop:"10px",position:"relative",userSelect:"none"}}),j=a.BB.el({parent:z,content:D,className:"kl-transparent-preview__canvas",css:{width:d+"px",height:g+"px",position:"absolute",overflow:"hidden"}});return u.theme.addIsDarkListener(n),n(),m.append(z),i(),y.destroy=function(){O.destroy(),u.theme.removeIsDarkListener(n)},y.getInput=function(){return y.destroy(),{width:x,height:B,algorithm:R.getValue()}},y},apply:function(e){var t=e.klCanvas,i=e.history,n=e.input.width,r=e.input.height,a=e.input.algorithm;return!(!t||!i)&&(i.pause(!0),t.resize(n,r,a),i.pause(!1),i.push({tool:["filter","resize"],action:"apply",params:[{input:e.input}]}),!0)}}})),i.register("bNBIp",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("c92cL")})),i.register("dsRff",(function(t,n){e(t.exports,"filterRotate",(function(){return o}));var r=i("eWjiX"),a=i("1mH1z"),s=i("1C8RU"),o={getDialog:function(e){var t=function(){if(x.style.WebkitTransform="rotate("+g+"deg)",x.style.MozTransform="rotate("+g+"deg)",x.style.OTransform="rotate("+g+"deg)",x.style.msTransform="rotate("+g+"deg)",90===Math.abs(g%180)){var e=r.BB.fitInto(h,l,280,200,1),t=parseInt(""+e.height)/l;x.style.WebkitTransform="rotate("+g+"deg) scale("+t+")",x.style.MozTransform="rotate("+g+"deg) scale("+t+")",x.style.OTransform="rotate("+g+"deg) scale("+t+")",x.style.msTransform="rotate("+g+"deg) scale("+t+")"}},i=function(){r.BB.createCheckerDataUrl(8,(function(e){x.style.background="url("+e+")"}),s.theme.isDark())},n=e.klCanvas;if(!n)return!1;var o=r.BB.fitInto(n.getWidth(),n.getHeight(),280,200,1),l=parseInt(""+o.width),h=parseInt(""+o.height),c=l/n.getWidth(),u=r.BB.canvas(l,h);u.style.display="block",r.BB.ctx(u).drawImage(n.getCompleteCanvas(c),0,0,l,h);var p=document.createElement("div"),d={element:p},g=0;p.innerHTML=(0,a.LANG)("filter-rotate-description")+"<br/><br/>";var f=document.createElement("button");f.innerHTML="<span style='font-size: 1.3em'>⟳</span> 90°";var v=document.createElement("button");v.innerHTML="<span style='font-size: 1.3em'>⟲</span> 90°",v.style.marginRight="5px",f.onclick=function(){g+=90,t()},v.onclick=function(){g-=90,t()},p.append(v,f);var m=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px",display:"table"}}),y=r.BB.el({parent:m,css:{display:"table-cell",verticalAlign:"middle"}}),x=r.BB.el({parent:y,content:u,className:"kl-preview-wrapper__canvas",css:{width:l+"px",height:h+"px",marginLeft:"auto",marginRight:"auto",overflow:"hidden"}});return s.theme.addIsDarkListener(i),i(),x.style.transition="all 0.2s ease-out",p.append(m),t(),d.destroy=function(){s.theme.removeIsDarkListener(i)},d.getInput=function(){return d.destroy(),{deg:g}},d},apply:function(e){var t=e.klCanvas,i=e.history;return!(!t||!i)&&(i.pause(!0),t.rotate(e.input.deg),i.pause(!1),i.push({tool:["filter","rotate"],action:"apply",params:[{input:e.input}]}),!0)}}})),i.register("lhchB",(function(t,n){e(t.exports,"filterTiltShift",(function(){return c}));var r=i("eWjiX"),a=i("cH2YE"),s=i("aP0jf"),o=i("i5nyl"),l=i("a5EFw"),h=i("1mH1z"),c={getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),c=i.getLayerIndex(t.canvas),u=r.BB.fitInto(t.canvas.width,t.canvas.height,280,200,1),p=parseInt(""+u.width),d=parseInt(""+u.height),g=Math.min(p,t.canvas.width),f=Math.min(d,t.canvas.height),v=r.BB.canvas(g,f),m=r.BB.ctx(v);m.save(),g>t.canvas.width&&(m.imageSmoothingEnabled=!1),m.drawImage(t.canvas,0,0,g,f),m.restore();var y=g/t.canvas.width,x=p/t.canvas.width,B=document.createElement("div"),b={element:B},w=[];return setTimeout((function(){var e=20,t=200;B.innerHTML=(0,h.LANG)("filter-tilt-shift-description")+"<br/><br/>";var i=(0,l.getSharedFx)();if(i){var u,g,f=i.texture(v);i.draw(f).update(),u=T(parseInt(""+p/6),parseInt(""+d/2)),g=T(parseInt(""+(p-p/6)),parseInt(""+(d-d/3)));var m=new(0,s.KlSlider)({label:(0,h.LANG)("filter-tilt-shift-blur"),width:300,height:30,min:0,max:200,value:e,eventResMs:a.eventResMs,onChange:function(t){e=t,E()}});m.getElement().style.marginBottom="10px",B.append(m.getElement());var k=new(0,s.KlSlider)({label:(0,h.LANG)("filter-tilt-shift-gradient"),width:300,height:30,min:0,max:1e3,value:t,eventResMs:a.eventResMs,onChange:function(e){t=e,E()}});B.append(k.getElement());var C=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}});C.oncontextmenu=function(){return!1};for(var S=[],L=0;L<n.length;L++)S.push({image:L===c?i:n[L].context.canvas,opacity:n[L].opacity,mixModeStr:n[L].mixModeStr});var A=new(0,o.KlCanvasPreview)({width:parseInt(""+p),height:parseInt(""+d),layers:S}),I=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+p)+"px",height:parseInt(""+d)+"px"}});I.append(A.getElement()),C.append(I),I.append(u,g),B.append(C),E(),b.destroy=function(){for(var e=0;e<w.length;e++)w[e].destroy();m.destroy(),k.destroy(),f.destroy(),A.destroy()},b.getInput=function(){return b.destroy(),{a:{x:u.x/x,y:u.y/x},b:{x:g.x/x,y:g.y/x},blur:e,gradient:t}}}function E(){try{i.draw(f).tiltShift(u.x/x*y,u.y/x*y,g.x/x*y,g.y/x*y,e*y,t*y).update(),A.render()}catch(e){B.errorCallback(e)}}function T(e,t){var i=r.BB.el({css:{width:"14px",height:"14px",backgroundColor:"#fff",boxShadow:"inset 0 0 0 2px #000",borderRadius:"14px",position:"absolute",cursor:"move",left:e-7+"px",top:t-7+"px",userSelect:"none",touchAction:"none"}});i.x=e,i.y=t;var n=new r.BB.PointerListener({target:i,onPointer:function(e){e.eventPreventDefault(),"left"===e.button&&"pointermove"===e.type&&(i.x+=e.dX,i.y+=e.dY,i.style.left=i.x-7+"px",i.style.top=i.y-7+"px",E())}});return w.push(n),i}}),1),b},apply:function(e){var t=e.context,i=e.history,n=e.input.a,r=e.input.b,a=e.input.blur,s=e.input.gradient;if(!t||!i)return!1;i.pause(!0);var o=(0,l.getSharedFx)();if(!o)return!1;var h=o.texture(t.canvas);return o.draw(h).tiltShift(n.x,n.y,r.x,r.y,a,s).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(o,0,0),h.destroy(),i.pause(!1),i.push({tool:["filter","tiltShift"],action:"apply",params:[{input:e.input}]}),!0}}})),i.register("lXpcU",(function(t,n){e(t.exports,"filterTransform",(function(){return c}));var r=i("eWjiX"),a=i("7bWhB"),s=i("i5nyl"),o=i("cNhNm"),l=i("eEL9N"),h=i("1mH1z"),c={getDialog:function(e){var t=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(u){var t=u.getTransform();if(JSON.stringify(t)!==J||e){J=JSON.stringify(t),B<1&&(t.x*=B,t.y*=B,t.width*=B,t.height*=B);var i=q[g].image,n=r.BB.ctx(i);n.save(),n.clearRect(0,0,i.width,i.height),r.BB.drawTransformedImageWithBounds(n,d[g].context.canvas,t,b,"pixelated"===Y.getValue()||r.BB.testShouldPixelate(t,t.width/w.width,t.height/w.height)),n.restore(),$.render()}}},i=function(){u.setPos({x:parseInt(T.value)+w.x,y:parseInt(E.value)+w.y}),u.setAngleDeg(parseInt(M.value)),t()},n=e.context,c=e.klCanvas;if(!n||!c)return!1;var u,p=window.innerWidth<550,d=c.getLayers(),g=c.getLayerIndex(n.canvas),f=r.BB.fitInto(n.canvas.width,n.canvas.height,p?280:490,p?200:240,1),v=parseInt(""+f.width),m=parseInt(""+f.height),y=Math.min(v,n.canvas.width),x=Math.min(m,n.canvas.height),B=v/n.canvas.width,b=r.BB.canvasBounds(n);if(null===b)return alert((0,h.LANG)("filter-transform-empty")),!1;var w={x:b.x+b.width/2,y:b.y+b.height/2,width:b.width,height:b.height,angleDeg:0},k=document.createElement("div"),C={element:k};p||(C.width=500),k.innerHTML=(0,h.LANG)("filter-transform-description");var S=new r.BB.KeyListener({onDown:function(e){r.BB.isInputFocused(!0)||("left"===e&&(T.value=""+(parseFloat(T.value)-1),i()),"right"===e&&(T.value=""+(parseFloat(T.value)+1),i()),"up"===e&&(E.value=""+(parseFloat(E.value)-1),i()),"down"===e&&(E.value=""+(parseFloat(E.value)+1),i()))}}),L=document.createElement("div"),A=document.createElement("div"),I=document.createElement("div"),E=document.createElement("input"),T=document.createElement("input"),M=document.createElement("input");(L.style.width="100px",L.style.height="30px",A.style.width="100px",A.style.height="30px",A.style.display="inline-block",L.style.display="inline-block",I.style.display="inline-block",I.style.width="150px",I.style.height="30px",E.type="number",T.type="number",M.type="number",T.style.width="70px",E.style.width="70px",M.style.width="70px",E.value="0",T.value="0",M.value="0",E.onclick=function(){this.focus(),i()},T.onclick=function(){this.focus(),i()},M.onclick=function(){this.focus(),i()},E.onchange=function(){i()},T.onchange=function(){i()},M.onchange=function(){i()},E.onkeyup=function(){i()},T.onkeyup=function(){i()},M.onkeyup=function(){i()},L.append("X: ",T),A.append("Y: ",E),I.append((0,h.LANG)("filter-transform-rotation")+": ",M),p)||r.BB.el({parent:k,css:{marginTop:"10px"}}).append(L,A,I);var P={marginLeft:"10px",marginTop:"10px"},O=r.BB.el({parent:k,css:{display:"flex",flexWrap:"wrap",marginLeft:"-10px"}}),R=r.BB.el({parent:O,tagName:"button",content:(0,h.LANG)("filter-transform-flip")+" X",onClick:function(){var e=u.getTransform();u.setSize(-e.width,e.height)},css:P}),D=r.BB.el({parent:O,tagName:"button",content:(0,h.LANG)("filter-transform-flip")+" Y",onClick:function(){var e=u.getTransform();u.setSize(e.width,-e.height)},css:P}),N=r.BB.el({parent:O,tagName:"button",content:"-90°",onClick:function(){var e=u.getTransform();e.angleDeg-=90,e.angleDeg%=360,u.setAngleDeg(e.angleDeg),M.value=""+Math.round(e.angleDeg),t()},css:P}),z=r.BB.el({parent:O,tagName:"button",content:"+90°",onClick:function(){var e=u.getTransform();e.angleDeg+=90,e.angleDeg%=360,u.setAngleDeg(e.angleDeg),M.value=""+Math.round(e.angleDeg),t()},css:P}),j=r.BB.el({parent:O,tagName:"button",content:"2x",onClick:function(){var e=u.getTransform();W.getValue()?u.setSize(u.getRatio()*e.height*2,2*e.height):u.setSize(2*e.width,2*e.height)},css:P}),G=r.BB.el({parent:O,tagName:"button",content:"1/2x",onClick:function(){var e=u.getTransform();u.setSize(Math.round(e.width/2),Math.round(e.height/2))},css:P}),H=r.BB.el({parent:O,tagName:"button",content:(0,h.LANG)("center"),onClick:function(){var e=u.getTransform();u.setPos({x:n.canvas.width/2,y:n.canvas.height/2}),u.setAngleDeg(e.angleDeg),t()},css:P}),F=!0,W=new(0,a.Checkbox)({init:!0,label:(0,h.LANG)("filter-transform-constrain"),title:(0,h.LANG)("constrain-proportions"),allowTab:!0,callback:function(e){F=e,u.setConstrained(F)},css:{display:"inline-block"}}),V=!1,U=new(0,a.Checkbox)({init:!0,label:(0,h.LANG)("filter-transform-snap"),title:(0,h.LANG)("filter-transform-snap-title"),allowTab:!0,callback:function(e){V=e,u.setSnapping(V)},css:{display:"inline-block",marginLeft:"10px"}}),X=r.BB.el();X.append(W.getElement(),U.getElement()),k.append(r.BB.el({css:{clear:"both",height:"10px"}}));var K=r.BB.el({parent:k,css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),Y=new(0,l.Select)({isFocusable:!0,optionArr:[["smooth",(0,h.LANG)("algorithm-smooth")],["pixelated",(0,h.LANG)("algorithm-pixelated")]],initValue:"smooth",title:(0,h.LANG)("scaling-algorithm"),onChange:function(){t(!0)}});K.append(X,Y.getElement());var _=r.BB.el({className:"kl-preview-wrapper",css:{width:p?"340px":"540px",height:p?"260px":"300px"}});_.oncontextmenu=function(){return!1};for(var q=[],Q=0;Q<d.length;Q++){var Z=void 0;if(Q===g)Z=r.BB.canvas(parseInt(""+y),parseInt(""+x)),r.BB.ctx(Z).drawImage(d[Q].context.canvas,0,0,Z.width,Z.height);else Z=d[Q].context.canvas;q.push({image:Z,opacity:d[Q].opacity,mixModeStr:d[Q].mixModeStr})}var J,$=new(0,s.KlCanvasPreview)({width:parseInt(""+v),height:parseInt(""+m),layers:q}),ee=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+v)+"px",height:parseInt(""+m)+"px"}});return ee.append($.getElement()),_.append(ee),u=new(0,o.FreeTransform)({x:w.x,y:w.y,width:w.width,height:w.height,angleDeg:w.angleDeg,isConstrained:!0,snapX:[0,n.canvas.width],snapY:[0,n.canvas.height],callback:function(e){T.value=""+Math.round(e.x-w.x),E.value=""+Math.round(e.y-w.y),M.value=""+Math.round(e.angleDeg),t()},scale:B}),r.BB.css(u.getElement(),{position:"absolute",left:"0",top:"0"}),ee.append(u.getElement()),t(),k.append(_),C.destroy=function(){S.destroy(),u.destroy(),W.destroy(),U.destroy(),r.BB.destroyEl(R),r.BB.destroyEl(D),r.BB.destroyEl(N),r.BB.destroyEl(z),r.BB.destroyEl(j),r.BB.destroyEl(G),r.BB.destroyEl(H),$.destroy()},C.getInput=function(){var e=u.getTransform(),t={transform:e,bounds:b,isPixelated:"pixelated"===Y.getValue()||r.BB.testShouldPixelate(e,e.width/w.width,e.height/w.height)};return C.destroy(),r.BB.copyObj(t)},C},apply:function(e){var t=e.context,i=e.history;if(!t||!i)return!1;i.pause(!0);var n=e.input,a=r.BB.copyCanvas(t.canvas);return t.clearRect(0,0,t.canvas.width,t.canvas.height),r.BB.drawTransformedImageWithBounds(t,a,n.transform,n.bounds,n.isPixelated),i.pause(!1),i.push({tool:["filter","transform"],action:"apply",params:[{input:n}]}),!0}}})),i.register("1CjeM",(function(t,n){e(t.exports,"filterBlur",(function(){return c}));var r=i("eWjiX"),a=i("aP0jf"),s=i("cH2YE"),o=i("i5nyl"),l=i("a5EFw"),h=i("1mH1z"),c={getDialog:function(e){var t=e.klCanvas,i=e.context;if(!t||!i)return!1;var n=t.getLayers(),c=t.getLayerIndex(i.canvas),u=r.BB.fitInto(i.canvas.width,i.canvas.height,280,200,1),p=parseInt(""+u.width),d=parseInt(""+u.height),g=Math.min(p,i.canvas.width),f=Math.min(d,i.canvas.height),v=r.BB.canvas(g,f),m=r.BB.ctx(v);m.save(),g>i.canvas.width&&(m.imageSmoothingEnabled=!1),m.drawImage(i.canvas,0,0,g,f),m.restore();var y=g/i.canvas.width,x=document.createElement("div"),B={element:x};return setTimeout((function(){var e=10;x.innerHTML=(0,h.LANG)("filter-triangle-blur-description")+"<br/><br/>";var t=(0,l.getSharedFx)();if(t){var i=t.texture(v);t.draw(i).update();var u=new(0,a.KlSlider)({label:(0,h.LANG)("radius"),width:300,height:30,min:1,max:200,value:e,eventResMs:s.eventResMs,onChange:function(n){e=n,t.draw(i).triangleBlur(e*y).update(),b.render()}});x.append(u.getElement());for(var g=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}}),f=[],m=0;m<n.length;m++)f.push({image:m===c?t:n[m].context.canvas,opacity:n[m].opacity,mixModeStr:n[m].mixModeStr});var b=new(0,o.KlCanvasPreview)({width:parseInt(""+p),height:parseInt(""+d),layers:f}),w=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+p)+"px",height:parseInt(""+d)+"px"}});w.append(b.getElement()),g.append(w),x.append(g);try{t.draw(i).triangleBlur(e*y).update(),b.render()}catch(e){x.errorCallback(e)}B.destroy=function(){i.destroy(),u.destroy(),b.destroy()},B.getInput=function(){return B.destroy(),{radius:e}}}}),1),B},apply:function(e){var t=e.context,i=e.history,n=e.input.radius;if(!t||!n||!i)return!1;i.pause(!0);var r=(0,l.getSharedFx)();if(!r)return!1;var a=r.texture(t.canvas);return r.draw(a).triangleBlur(n).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(r,0,0),a.destroy(),i.pause(!1),i.push({tool:["filter","blur"],action:"apply",params:[{input:e.input}]}),!0}}})),i.register("dNWKZ",(function(t,n){e(t.exports,"filterUnsharpMask",(function(){return c}));var r=i("eWjiX"),a=i("cH2YE"),s=i("aP0jf"),o=i("i5nyl"),l=i("a5EFw"),h=i("1mH1z"),c={getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),c=i.getLayerIndex(t.canvas),u=r.BB.fitInto(t.canvas.width,t.canvas.height,280,200,1),p=parseInt(""+u.width),d=parseInt(""+u.height),g=Math.min(p,t.canvas.width),f=Math.min(d,t.canvas.height),v=r.BB.canvas(g,f),m=r.BB.ctx(v);m.save(),g>t.canvas.width&&(m.imageSmoothingEnabled=!1),m.drawImage(t.canvas,0,0,g,f),m.restore();var y=g/t.canvas.width,x=document.createElement("div"),B={element:x};return setTimeout((function(){var e=2,t=.51;x.innerHTML=(0,h.LANG)("filter-unsharp-mask-description")+"<br/><br/>";var i=(0,l.getSharedFx)();if(i){var u=i.texture(v);i.draw(u).update();var g=new(0,s.KlSlider)({label:(0,h.LANG)("radius"),width:300,height:30,min:0,max:200,value:2,eventResMs:a.eventResMs,onChange:function(n){e=n,i.draw(u).unsharpMask(e*y,t).update(),k.render()},curve:[[0,0],[.1,2],[.5,50],[1,200]]}),f=new(0,s.KlSlider)({label:(0,h.LANG)("filter-unsharp-mask-strength"),width:300,height:30,min:0,max:50,value:5.1,eventResMs:a.eventResMs,onChange:function(n){t=n/10,i.draw(u).unsharpMask(e*y,t).update(),k.render()},curve:[[0,0],[.1,2],[.5,10],[1,50]]});g.getElement().style.marginBottom="10px",x.append(g.getElement()),x.append(f.getElement());for(var m=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}}),b=[],w=0;w<n.length;w++)b.push({image:w===c?i:n[w].context.canvas,opacity:n[w].opacity,mixModeStr:n[w].mixModeStr});var k=new(0,o.KlCanvasPreview)({width:parseInt(""+p),height:parseInt(""+d),layers:b}),C=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+p)+"px",height:parseInt(""+d)+"px"}});C.append(k.getElement()),m.append(C),x.append(m);try{i.draw(u).unsharpMask(e*y,t).update(),k.render()}catch(e){x.errorCallback(e)}B.destroy=function(){g.destroy(),f.destroy(),u.destroy(),k.destroy()},B.getInput=function(){return B.destroy(),{radius:e,strength:t}}}}),1),B},apply:function(e){var t=e.context,i=e.history,n=e.input.radius,r=e.input.strength;if(!t||null===n||null===r||!i)return!1;i.pause(!0);var a=(0,l.getSharedFx)();if(!a)return!1;var s=a.texture(t.canvas);return a.draw(s).unsharpMask(n,r).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),s.destroy(),i.pause(!1),i.push({tool:["filter","unsharpMask"],action:"apply",params:[{input:e.input}]}),!0}}})),i.register("94Tq7",(function(t,n){e(t.exports,"filterToAlpha",(function(){return c}));var r=i("eWjiX"),a=i("iFIyy"),s=i("43qNf"),o=i("i5nyl"),l=i("a5EFw"),h=i("1mH1z"),c={getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),c=i.getLayerIndex(t.canvas),u=r.BB.fitInto(t.canvas.width,t.canvas.height,280,200,1),p=parseInt(""+u.width),d=parseInt(""+u.height),g=r.BB.canvas(p,d),f=r.BB.ctx(g);f.save(),g.width>t.canvas.width&&(f.imageSmoothingEnabled=!1),f.drawImage(t.canvas,0,0,p,d),f.restore();var v=document.createElement("div"),m={element:v};return setTimeout((function(){v.append(r.BB.el({content:(0,h.LANG)("filter-to-alpha-description"),css:{marginBottom:"5px"}}));var t=(0,l.getSharedFx)();if(t){var i=t.texture(g);t.draw(i).update();var u="inverted-luminance",f=new(0,a.Options)({optionArr:[{id:"inverted-luminance",label:(0,h.LANG)("filter-to-alpha-inverted-lum")},{id:"luminance",label:(0,h.LANG)("filter-to-alpha-lum")}],initId:u,onChange:function(e){u=e,L()}});v.append(f.getElement());var y={r:0,g:0,b:0,a:1},x=[null,{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];x.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),x.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1});var B=new(0,s.ColorOptions)({label:(0,h.LANG)("filter-to-alpha-replace"),colorArr:x,initialIndex:1,onChange:function(e){y=e,L()}});B.getElement().style.marginTop="10px",v.append(B.getElement());for(var b=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}}),w=[],k=0;k<n.length;k++)w.push({image:k===c?t:n[k].context.canvas,opacity:n[k].opacity,mixModeStr:n[k].mixModeStr});var C=new(0,o.KlCanvasPreview)({width:parseInt(""+p),height:parseInt(""+d),layers:w}),S=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+p)+"px",height:parseInt(""+d)+"px"}});S.append(C.getElement()),b.append(S),v.append(b),setTimeout((function(){try{L()}catch(e){v.errorCallback(e)}}),1),m.destroy=function(){i.destroy(),f.destroy(),C.destroy()},m.getInput=function(){return m.destroy(),{sourceId:u,selectedRgbaObj:y}}}function L(){t.draw(i).toAlpha("inverted-luminance"===u,y).update(),C.render()}}),1),m},apply:function(e){var t=e.context,i=e.history,n=e.input.sourceId,r=e.input.selectedRgbaObj;if(!t||!n||!i)return!1;i.pause(!0);var a=(0,l.getSharedFx)();if(!a)return!1;var s=a.texture(t.canvas);return a.draw(s).toAlpha("inverted-luminance"===n,r).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),s.destroy(),i.pause(!1),i.push({tool:["filter","toAlpha"],action:"apply",params:[{input:e.input}]}),!0}}})),i.register("d8Fqy",(function(t,n){e(t.exports,"filterGrid",(function(){return c}));var r=i("eWjiX"),a=i("i5nyl"),s=i("1mH1z"),o=i("dJPtW"),l=i("43qNf"),h=i("1xi6g"),c={getDialog:function(e){var t=function(){var e=r.BB.ctx(M.image);e.save(),e.clearRect(0,0,f,v),e.drawImage(i.canvas,0,0,f,v),(0,h.drawGrid)(e,B.x,B.y,Math.max(B.thickness*m,1),B.color,B.opacity),e.restore(),P.render()},i=e.context,n=e.klCanvas;if(!i||!n)return!1;var c=n.getLayers(),u=n.getLayerIndex(i.canvas),p=r.BB.fitInto(i.canvas.width,i.canvas.height,280,200,1),d=parseInt(""+p.width),g=parseInt(""+p.height),f=Math.min(d,i.canvas.width),v=Math.min(g,i.canvas.height),m=f/i.canvas.width,y=document.createElement("div"),x={element:y};y.innerHTML=(0,s.LANG)("filter-grid-description")+"<br/><br/>";var B={x:2,y:2,thickness:2,color:"#000",opacity:1},b=r.BB.el({parent:y,css:{display:"flex",alignItems:"center"}}),w=r.BB.el({parent:y,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),k=(0,o.input)({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){B.x=parseFloat(e),t()}}),C=(0,o.input)({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){B.y=parseFloat(e),t()}}),S=(0,o.input)({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){B.thickness=parseFloat(e),t()}}),L={r:0,g:0,b:0,a:1},A=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];A.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),A.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1}),B.color=r.BB.ColorConverter.toRgbStr(L);var I=new(0,l.ColorOptions)({label:(0,s.LANG)("shape-stroke"),colorArr:A,onChange:function(e){L=e,B.color=r.BB.ColorConverter.toRgbStr(L),t()}}),E={display:"inline-block",marginRight:"5px"};b.append(r.BB.el({content:"X:",css:E}),k,r.BB.el({content:"Y:",css:E}),C),w.append(r.BB.el({content:(0,s.LANG)("shape-line-width")+":",css:E}),S,r.BB.el({css:{flexGrow:"1"}}),I.getElement());var T=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}}),M={image:r.BB.canvas(f,v),opacity:c[u].opacity,mixModeStr:c[u].mixModeStr},P=new(0,a.KlCanvasPreview)({width:Math.round(d),height:Math.round(g),layers:c.map((function(e,t){return t===u?M:{image:e.context.canvas,opacity:e.opacity,mixModeStr:e.mixModeStr}}))}),O=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+d)+"px",height:parseInt(""+g)+"px"}});return O.append(P.getElement()),T.append(O),setTimeout(t,0),y.append(T),x.destroy=function(){P.destroy(),I.destroy()},x.getInput=function(){return x.destroy(),r.BB.copyObj(B)},x},apply:function(e){var t=e.context,i=e.klCanvas,n=e.history;return!!(t&&i&&n)&&(n.pause(!0),(0,h.drawGrid)(t,e.input.x,e.input.y,e.input.thickness,e.input.color,e.input.opacity),n.pause(!1),n.push({tool:["filter","grid"],action:"apply",params:[{input:e.input}]}),!0)}}})),i.register("1xi6g",(function(t,i){function n(e,t,i,n,r,a){e.save();var s=e.canvas.width,o=e.canvas.height,l=(n=Math.round(n))%2==0;e.beginPath(),e.lineWidth=n,e.strokeStyle=r,e.globalAlpha=a;for(var h=0;h<t-1;h++){var c=s/t*(h+1);c=l?Math.round(c):Math.round(c+.5)-.5,e.moveTo(c,0),e.lineTo(c,o)}for(var u=0;u<i-1;u++){var p=o/i*(u+1);p=l?Math.round(p):Math.round(p+.5)-.5,e.moveTo(0,p),e.lineTo(s,p)}e.stroke(),e.restore()}e(t.exports,"drawGrid",(function(){return n}))})),i.register("gtdB1",(function(t,n){e(t.exports,"filterNoise",(function(){return y}));var r=i("eWjiX"),a=i("i5nyl"),s=i("1mH1z"),o=i("aP0jf"),l=i("a5EFw"),h=i("iFIyy"),c=i("cH2YE"),u=i("eEL9N"),p=i("bBcC4"),d=i("hrnUX"),g=i("dJ1E2"),f=i("7bWhB"),v=[{type:0,scaleX:1,scaleY:1,offsetX:0,offsetY:0,octaves:1,samples:1,peaks:0,brightness:0,contrast:0,isReversed:!0},{type:1,scaleX:166,scaleY:164,offsetX:105,offsetY:30,octaves:6,samples:1,peaks:0,brightness:.055,contrast:.23,isReversed:!0},{type:1,scaleX:235,scaleY:190,offsetX:3227,offsetY:2156,octaves:4,samples:16,peaks:22,brightness:-.375,contrast:1,isReversed:!1},{type:1,scaleX:40,scaleY:40,offsetX:0,offsetY:0,octaves:1,samples:1,peaks:0,brightness:0,contrast:0,isReversed:!1},{type:0,scaleX:26,scaleY:26,offsetX:557,offsetY:365,octaves:1,samples:1,peaks:0,brightness:.02,contrast:1,isReversed:!0},{type:1,scaleX:1500,scaleY:1500,offsetX:745,offsetY:2871,octaves:5,samples:16,peaks:156.02,brightness:.03,contrast:1,isReversed:!0},{type:1,scaleX:11,scaleY:11,offsetX:2940,offsetY:2045,octaves:1,samples:16,peaks:1,brightness:-.045,contrast:1,isReversed:!0},{type:2,scaleX:74,scaleY:74,offsetX:4816,offsetY:1304,octaves:3,samples:1,peaks:2.78,brightness:0,contrast:0,isReversed:!1}];function m(e,t){e.noise(t.seed?t.seed:0,t.type,[t.scaleX,t.scaleY],[e.width/2,e.height/2],t.octaves,t.samples,t.peaks,t.brightness,t.contrast,t.isReversed,t.colA,t.colB,t.channels?t.channels:"rgb").update()}var y={getDialog:function(e){var t=function(){var e=r.BB.ctx(_.image);e.save(),e.clearRect(0,0,k,C),e.drawImage(i.canvas,0,0,k,C),e.globalAlpha=R.opacity;var t=r.BB.copyObj(v[R.presetIndex]);t.seed=R.seed,t.scaleX=t.scaleX*R.scale/50*S,t.scaleY=t.scaleY*R.scale/50*S,t.colA=R.colA,t.colB=R.colB,t.isReversed=R.isReversed?!t.isReversed:t.isReversed,t.channels=R.channels,m(L,t),"alpha"===R.channels?e.globalCompositeOperation="destination-out":e.globalCompositeOperation=R.mixModeStr,e.drawImage(L,0,0),e.restore(),q.render()},i=e.context,n=e.klCanvas;if(!i||!n)return!1;var y=n.getLayers(),x=n.getLayerIndex(i.canvas),B=r.BB.fitInto(i.canvas.width,i.canvas.height,280,200,1),b=parseInt(""+B.width),w=parseInt(""+B.height),k=Math.min(b,i.canvas.width),C=Math.min(w,i.canvas.height),S=k/i.canvas.width,L=(0,l.getSharedFx)();if(L){var A,I=[],E=r.BB.canvas(32,32),T=r.BB.ctx(E);A=L.texture(E),L.draw(A).update(),A.destroy(),v.forEach((function(e,t){var i=new Image,n=r.BB.copyObj(e);n.scaleX/=10,n.scaleY/=10,m(L,n),T.drawImage(L,0,0),i.src=E.toDataURL("image/png"),I.push(i)}));var M=r.BB.canvas(k,C);A=L.texture(M),L.draw(A).update(),M=null;var P=document.createElement("div"),O={element:P};P.innerHTML=(0,s.LANG)("filter-noise-description")+"<br/><br/>";var R={seed:300*Math.random(),presetIndex:0,scale:50,opacity:.5,isReversed:!1,channels:"rgb",mixModeStr:"source-over",colA:{r:0,g:0,b:0},colB:{r:255,g:255,b:255}},D=new(0,h.Options)({optionArr:I.map((function(e,t){return r.BB.css(e,{margin:"1px",borderRadius:"3px",transition:"all 0.1s ease-in-out"}),{id:""+t,label:e}})),initId:"0",onChange:function(e){R.presetIndex=Number(e),t()}});D.getElement().style.marginBottom="10px",P.append(D.getElement());var N=new(0,o.KlSlider)({label:(0,s.LANG)("filter-noise-scale"),width:300,height:30,min:1,max:1e3,value:R.scale,eventResMs:c.eventResMs,curve:r.BB.quadraticSplineInput(1,1e3,.1),onChange:function(e){R.scale=e,t()}});N.getElement().style.marginBottom="10px";var z=new(0,o.KlSlider)({label:(0,s.LANG)("opacity"),width:300,height:30,min:.01,max:1,value:R.opacity,eventResMs:c.eventResMs,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(e){R.opacity=e,t()}});z.getElement().style.marginBottom="10px";var j=r.BB.el({css:{display:"flex",alignItems:"center",marginBottom:"10px"}}),G=r.BB.el({css:{display:"flex"}}),H=new(0,h.Options)({optionArr:[{id:"rgb",label:"RGB"},{id:"alpha",label:(0,s.LANG)("filter-noise-alpha")}],initId:"rgb",onChange:function(e){R.channels=e,G.style.visibility="rgb"===e?"":"hidden",t()}}),F=new(0,f.Checkbox)({label:(0,s.LANG)("reverse"),callback:function(e){R.isReversed=e,t()},allowTab:!0}),W=new(0,u.Select)({isFocusable:!0,optionArr:["source-over",null,"darken","multiply","color-burn",null,"lighten","screen","color-dodge",null,"overlay","soft-light","hard-light",null,"difference","exclusion",null,"hue","saturation","color","luminosity"].map((function(e){return e?[e,(0,p.translateBlending)(e)]:null})),initValue:R.mixModeStr,onChange:function(e){R.mixModeStr=e,t()}});W.getElement().title=(0,s.LANG)("layers-blending");var V=r.BB.el({css:{display:"flex"}}),U={width:"34px",height:"34px",marginRight:"5px"},X=d.KL.input({type:"color",init:"#"+g.ColorConverter.toHexString(R.colA),callback:function(e){R.colA=g.ColorConverter.hexToRGB(e),t()},css:U}),K=d.KL.input({type:"color",init:"#"+g.ColorConverter.toHexString(R.colB),callback:function(e){R.colB=g.ColorConverter.hexToRGB(e),t()},css:U});V.append(X,K),j.append(H.getElement(),r.BB.el({css:{flexGrow:"1"}}),F.getElement()),G.append(W.getElement(),r.BB.el({css:{flexGrow:"1"}}),V),P.append(N.getElement(),z.getElement(),j,G);var Y=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}}),_={image:r.BB.canvas(k,C),opacity:y[x].opacity,mixModeStr:y[x].mixModeStr},q=new(0,a.KlCanvasPreview)({width:Math.round(b),height:Math.round(w),layers:y.map((function(e,t){return t===x?_:{image:e.context.canvas,opacity:e.opacity,mixModeStr:e.mixModeStr}}))}),Q=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+b)+"px",height:parseInt(""+w)+"px"}});return Q.append(q.getElement()),Y.append(Q),setTimeout(t,0),P.append(Y),O.destroy=function(){D.destroy(),N.destroy(),z.destroy(),F.destroy(),H.destroy(),A.destroy(),W.destroy(),q.destroy()},O.getInput=function(){return O.destroy(),r.BB.copyObj(R)},O}},apply:function(e){var t=e.context,i=e.klCanvas,n=e.history;if(!t||!i||!n)return!1;n.pause(!0);var a=(0,l.getSharedFx)();if(!a)return!1;var s=a.texture(t.canvas);a.draw(s).update(),s.destroy();var o=e.input,h=r.BB.copyObj(v[o.presetIndex]);return h.seed=o.seed,h.scaleX=h.scaleX*o.scale/50,h.scaleY=h.scaleY*o.scale/50,h.colA=o.colA,h.colB=o.colB,h.isReversed=o.isReversed?!h.isReversed:h.isReversed,h.channels=o.channels,m(a,h),t.save(),t.globalAlpha=o.opacity,"alpha"===o.channels?t.globalCompositeOperation="destination-out":t.globalCompositeOperation=o.mixModeStr,t.drawImage(a,0,0),t.restore(),n.pause(!1),n.push({tool:["canvas"],action:"replaceLayer",params:[i.getLayerIndex(t.canvas),t.getImageData(0,0,t.canvas.width,t.canvas.height)]}),!0}}})),i.register("lQzx7",(function(t,n){e(t.exports,"filterPattern",(function(){return p}));var r=i("eWjiX"),a=i("dJPtW"),s=i("aP0jf"),o=i("1mH1z"),l=i("cH2YE"),h=i("i5nyl"),c=i("5vheV");function u(e,t){var i=t.blend?Math.round(t.blend*t.width/2):0,n=t.blend?Math.round(t.blend*t.height/2):0,a=r.BB.canvas(t.width,t.height);if(t.blend){var s=r.BB.canvas(2*t.width,2*t.height),o=r.BB.ctx(s),l="#0000",h="#000";o.drawImage(e.canvas,-t.x+i,-t.y+n),o.save();var c=o.createLinearGradient(0,t.height,0,2*t.height);c.addColorStop(0,h),c.addColorStop(t.blend,l),o.globalCompositeOperation="destination-in",o.fillStyle=c,o.fillRect(0,0,s.width,s.height),o.restore(),o.save(),(c=o.createLinearGradient(0,0,0,t.height)).addColorStop(0,l),c.addColorStop(t.blend,h),o.globalCompositeOperation="destination-in",o.fillStyle=c,o.fillRect(0,0,2*t.width,2*t.height),o.restore(),o.save(),o.globalCompositeOperation="lighter",o.drawImage(s,0,-t.height),o.restore(),o.save(),(c=o.createLinearGradient(t.width,0,2*t.width,0)).addColorStop(0,h),c.addColorStop(t.blend,l),o.globalCompositeOperation="destination-in",o.fillStyle=c,o.fillRect(0,0,s.width,s.height),o.restore(),o.save(),(c=o.createLinearGradient(0,0,t.width,0)).addColorStop(0,l),c.addColorStop(t.blend,h),o.globalCompositeOperation="destination-in",o.fillStyle=c,o.fillRect(0,0,2*t.width,2*t.height),o.restore(),o.save(),o.globalCompositeOperation="lighter",o.drawImage(s,-t.width,0),o.restore(),r.BB.ctx(a).drawImage(s,0,0)}else r.BB.ctx(a).drawImage(e.canvas,-t.x,-t.y);e.save(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.translate(t.offsetX-i,t.offsetY-n),e.fillStyle=e.createPattern(a,"repeat"),e.fillRect(-t.offsetX+i,-t.offsetY+n,e.canvas.width,e.canvas.height),e.restore()}var p={getDialog:function(e){var t=function(){b.value=""+y.x,w.value=""+y.y,k.value=""+y.width,C.value=""+y.height},i=function(e,t,i,n,r){var a=Math.round(t+.5)-.5,s=Math.round(i+.5)-.5,o=Math.round(t+n-a),l=Math.round(i+r-s);e.strokeRect(a,s,o,l)},n=function(e){if(e||!x||JSON.stringify(x)!==JSON.stringify(y)){if(0===A){_.clearRect(0,0,v,m),_.drawImage(f.canvas,0,0);var t=G.image,n=r.BB.ctx(t);n.save(),n.clearRect(0,0,D,N),n.drawImage(Y,0,0,D,N),n.restore();var a=y.width*z,s=y.height*z,o=r.BB.ctx(W);o.save(),o.clearRect(0,0,O,R),o.strokeStyle="#fff",i(o,y.x*z,y.y*z,a,s),y.blend>.05&&(o.strokeStyle="#f0f",i(o,y.x*z-a/2*y.blend,y.y*z-s/2*y.blend,a*(1+y.blend),s*(1+y.blend))),o.restore()}else{_.clearRect(0,0,v,m),_.drawImage(f.canvas,0,0),u(_,y);var l=G.image,h=r.BB.ctx(l);h.clearRect(0,0,D,N),h.drawImage(Y,0,0,D,N)}F.render(),x=r.BB.copyObj(y)}},p=window.innerWidth<550,d=1024,g=r.BB.el({content:(0,o.LANG)("filter-pattern-description")+"<br><br>"}),f=e.context,v=f.canvas.width,m=f.canvas.height,y={x:0,y:0,width:v<=250?Math.round(v/4):200,height:m<=250?Math.round(m/4):200,blend:0,offsetX:0,offsetY:0},x=null,B=r.BB.canvasBounds(f);B&&B.width<=d&&B.height<=d&&(B.width<.75*v||B.height<.75*m)?(y.x=B.x,y.y=B.y,y.width=B.width,y.height=B.height):(y.x=Math.round(v/2-y.width/2),y.y=Math.round(m/2-y.height/2));var b=(0,a.input)({init:y.x,type:"number",min:0,max:v,css:{width:"100%"},callback:function(e){y.x=Number(e),n()}}),w=(0,a.input)({init:y.y,type:"number",min:0,max:m,css:{width:"100%"},callback:function(e){y.y=Number(e),n()}}),k=(0,a.input)({init:y.width,type:"number",min:1,max:Math.min(d,v),css:{width:"100%"},callback:function(e){y.width=Number(e),n()}}),C=(0,a.input)({init:y.height,type:"number",min:1,max:Math.min(d,m),css:{width:"100%"},callback:function(e){y.height=Number(e),n()}}),S={marginLeft:"5px",flex:"1"};g.append(r.BB.el({content:[r.BB.el({tagName:"label",content:["X:",b],css:S}),r.BB.el({tagName:"label",content:["Y:",w],css:S}),r.BB.el({tagName:"label",content:[(0,o.LANG)("width")+":",k],css:S}),r.BB.el({tagName:"label",content:[(0,o.LANG)("height")+":",C],css:S})],css:{display:"flex",marginLeft:"-5px"}}));var L=new(0,s.KlSlider)({label:(0,o.LANG)("brush-blending"),width:300,height:30,min:0,max:1,value:y.blend,eventResMs:l.eventResMs,onChange:function(e){y.blend=e,n()},formatFunc:function(e){return r.BB.round(e,2)},manualInputRoundDigits:2});r.BB.css(L.getElement(),{margin:"10px 0"}),g.append(L.getElement());var A=1,I=new(0,c.TwoTabs)({left:(0,o.LANG)("compare-before"),right:(0,o.LANG)("compare-after"),init:A,onChange:function(e){A=e,W.style.display=0===e?"block":"none",n(!0)}});g.append(I.getElement());var E=e.klCanvas,T=E.getLayers(),M=E.getLayerIndex(f.canvas),P=r.BB.fitInto(f.canvas.width,f.canvas.height,p?280:490,p?200:240,1),O=parseInt(""+P.width),R=parseInt(""+P.height),D=Math.min(O,f.canvas.width),N=Math.min(R,f.canvas.height),z=(f.canvas.width,O/f.canvas.width),j=r.BB.el({className:"kl-preview-wrapper",css:{width:p?"340px":"540px",height:p?"260px":"300px",marginTop:"0"}}),G={image:r.BB.canvas(D,N),opacity:T[M].opacity,mixModeStr:T[M].mixModeStr},H=T.map((function(e,t){return t===M?G:{image:e.context.canvas,opacity:e.opacity,mixModeStr:e.mixModeStr}})),F=new(0,h.KlCanvasPreview)({width:Math.round(O),height:Math.round(R),layers:H}),W=r.BB.canvas(O,R);r.BB.css(W,{position:"absolute",left:"0",top:"0",mixBlendMode:"difference",imageRendering:"pixelated"});var V=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+O)+"px",height:parseInt(""+R)+"px"}});V.append(F.getElement(),W),j.append(V),g.append(j);var U={start:null,end:null,oldSettings:null,state:null},X=new r.BB.KeyListener({});j.oncontextmenu=function(){return!1},V.style.touchAction="none";var K=new r.BB.PointerListener({target:V,onPointer:function(e){if(0===A)if("pointerdown"===e.type){if(!U.state){U.oldSettings=r.BB.copyObj(y);var i=e.relX/z,a=e.relY/z;r.BB.isInsideRect({x:i,y:a},{x:y.x,y:y.y,width:y.width,height:y.height})?U.state="move":U.state="select",U.start={x:i,y:a}}}else if("pointermove"===e.type){var s=e.relX/z,o=e.relY/z;if("select"===U.state){U.end={x:s,y:o};var l=Math.max(0,Math.min(U.start.x,U.end.x)),h=Math.max(0,Math.min(U.start.y,U.end.y)),c=Math.min(v,Math.max(U.start.x,U.end.x)),u=Math.min(m,Math.max(U.start.y,U.end.y));y.x=Math.floor(l),y.y=Math.floor(h),y.width=Math.min(d,Math.ceil(c-y.x)),y.height=Math.min(d,Math.ceil(u-y.y)),X.isPressed("shift")&&(y.width=Math.min(y.width,y.height),y.height=Math.min(y.width,y.height)),0!==y.width&&0!==y.height||(y=r.BB.copyObj(U.oldSettings)),t(),n()}else if("move"===U.state){var p=Math.round(s-U.start.x),g=Math.round(o-U.start.y);y.x=r.BB.clamp(U.oldSettings.x+p,0,v-y.width),y.y=r.BB.clamp(U.oldSettings.y+g,0,m-y.height),t(),n()}}else"pointerup"===e.type&&U.state&&(U.state=null);else"pointerdown"===e.type?U.state||(U.state="move",U.oldSettings=r.BB.copyObj(y),U.start={x:e.relX/z,y:e.relY/z},U.end=null):"pointermove"===e.type?U.state&&(U.end={x:e.relX/z,y:e.relY/z},y.offsetX=Math.round(U.end.x-U.start.x)+U.oldSettings.offsetX,y.offsetY=Math.round(U.end.y-U.start.y)+U.oldSettings.offsetY,n()):"pointerup"===e.type&&U.state&&(U.end||(y.offsetX=0,y.offsetY=0,n()),U.state=null)}}),Y=r.BB.canvas(v,m),_=r.BB.ctx(Y);n();var q={element:g,destroy:function(){L.destroy(),X.destroy(),K.destroy(),F.destroy()},getInput:function(){return r.BB.copyObj(y)}};return p||(q.width=500),q},apply:function(e){var t=e.klCanvas,i=e.context,n=e.history;return!(!t||!n)&&(n.pause(!0),u(i,e.input),n.pause(!1),n.push({tool:["filter","pattern"],action:"apply",params:[{input:e.input}]}),!0)}}})),i.register("10iZP",(function(t,n){e(t.exports,"filterDistort",(function(){return p}));var r=i("eWjiX"),a=i("aP0jf"),s=i("1mH1z"),o=i("cH2YE"),l=i("i5nyl"),h=i("a5EFw"),c=i("iFIyy"),u=i("7bWhB"),p={getDialog:function(e){var t=function(e){"x"===e?(f.scale.y=f.scale.x,f.strength.y=f.strength.x,f.phase.y=f.phase.x,T[3].setValue(f.scale.y),T[4].setValue(f.strength.y),T[5].setValue(f.phase.y)):(f.scale.x=f.scale.y,f.strength.x=f.strength.y,f.phase.x=f.phase.y,T[0].setValue(f.scale.x),T[1].setValue(f.strength.x),T[2].setValue(f.phase.x)),i()},i=function(){H.draw(F).multiplyAlpha().distort(f).unmultiplyAlpha().update(),U.render()},n=window.innerWidth<550,p=r.BB.el({content:(0,s.LANG)("filter-distort-description")+"<br><br>"}),d=e.context,g=!0,f={distortType:0,scale:{x:100,y:100},strength:{x:20,y:20},phase:{x:0,y:0},stepSize:1},v=[],m=32,y=r.BB.canvas(m,m),x=r.BB.ctx(y);x.beginPath(),x.arc(16,16,12.8,0,2*Math.PI),x.fill();var B=x.createLinearGradient(0,0,m,m);B.addColorStop(0,"#00f"),B.addColorStop(.5,"#f00"),B.addColorStop(1,"#fff"),x.fillStyle=B,x.globalCompositeOperation="source-atop",x.fillRect(0,0,m,m),(B=x.createLinearGradient(m,0,0,m)).addColorStop(0,"#000"),B.addColorStop(1,"#000"),x.fillStyle=B,x.globalCompositeOperation="destination-atop",x.fillRect(0,0,m,m);var b=(0,h.getSharedFx)(),w=b.texture(y);b.draw(w).update();[0,1,2].forEach((function(e){var t=new Image,i=r.BB.copyObj(f);i.distortType=e,i.scale.x/=20,i.scale.y/=20,i.strength.x/=20,i.strength.y/=20,b.draw(w).multiplyAlpha().distort(i).unmultiplyAlpha().update(),x.clearRect(0,0,m,m),x.drawImage(b,0,0),t.src=y.toDataURL("image/png"),v.push(t)})),w.destroy();var k=r.BB.el({parent:p,css:{display:"flex",alignItems:"center"}}),C=new(0,c.Options)({optionArr:v.map((function(e,t){return r.BB.css(e,{margin:"1px",borderRadius:"3px",transition:"all 0.1s ease-in-out"}),{id:""+t,label:e}})),initId:"0",onChange:function(e){f.distortType=Number(e),i()}}),S=new(0,u.Checkbox)({init:!0,label:(0,s.LANG)("filter-distort-sync-xy"),callback:function(e){(g=e)&&t("x")}});k.append(C.getElement(),r.BB.el({css:{flexGrow:"1"}}),S.getElement());var L=r.BB.el({parent:p,css:{display:"flex",flexWrap:"wrap"}}),A=r.BB.el({parent:L,css:{marginRight:"10px"}}),I=r.BB.el({parent:L}),E=n?300:245,T=[];["x","y"].forEach((function(e,n){var l=0===n?A:I,h=new(0,a.KlSlider)({label:(0,s.LANG)("filter-noise-scale")+" "+e.toUpperCase(),width:E,height:30,min:1,max:1e3,curve:"quadratic",value:f.scale[e],eventResMs:o.eventResMs,onChange:function(n){f.scale[e]=n,g?t(e):i()}});h.getElement().style.marginTop="20px",l.append(h.getElement());var c=new(0,a.KlSlider)({label:(0,s.LANG)("filter-unsharp-mask-strength")+" "+e.toUpperCase(),width:E,height:30,min:0,max:200,curve:"quadratic",value:f.strength[e],eventResMs:o.eventResMs,onChange:function(n){f.strength[e]=n,g?t(e):i()}});c.getElement().style.marginTop="10px",l.append(c.getElement());var u=new(0,a.KlSlider)({label:(0,s.LANG)("filter-distort-phase")+" "+e.toUpperCase(),width:E,height:30,min:0,max:1,value:f.phase[e],manualInputRoundDigits:2,eventResMs:o.eventResMs,formatFunc:function(e){return r.BB.round(e,2)},onChange:function(n){f.phase[e]=n,g?t(e):i()}});u.getElement().style.marginTop="10px",l.append(u.getElement()),T.push(h),T.push(c),T.push(u)}));var M=new(0,a.KlSlider)({label:(0,s.LANG)("filter-distort-stepsize"),width:300,height:30,min:1,max:300,curve:"quadratic",value:f.stepSize,eventResMs:o.eventResMs,onChange:function(e){f.stepSize=Math.round(e),i()}});M.getElement().style.marginTop="20px",p.append(M.getElement());var P=e.klCanvas,O=P.getLayers(),R=P.getLayerIndex(d.canvas),D=r.BB.fitInto(d.canvas.width,d.canvas.height,n?280:490,n?200:240,1),N=parseInt(""+D.width),z=parseInt(""+D.height),j=Math.min(N,d.canvas.width),G=(Math.min(z,d.canvas.height),d.canvas.width,d.canvas.width,r.BB.el({className:"kl-preview-wrapper",css:{width:n?"340px":"540px",height:n?"260px":"300px"}})),H=(0,h.getSharedFx)();if(H){var F=H.texture(d.canvas);H.draw(F).update();var W={image:H,opacity:O[R].opacity,mixModeStr:O[R].mixModeStr},V=O.map((function(e,t){return t===R?W:{image:e.context.canvas,opacity:e.opacity,mixModeStr:e.mixModeStr}})),U=new(0,l.KlCanvasPreview)({width:Math.round(N),height:Math.round(z),layers:V}),X=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+N)+"px",height:parseInt(""+z)+"px"}});X.append(U.getElement()),G.append(X),p.append(G),i();var K={element:p,destroy:function(){C.destroy(),T.forEach((function(e){return e.destroy()})),M.destroy(),S.destroy(),F.destroy(),U.destroy()},getInput:function(){return r.BB.copyObj(f)}};return n||(K.width=500),K}},apply:function(e){var t=e.klCanvas,i=e.context,n=e.history;if(!t||!n)return!1;n.pause(!0);var r=(0,h.getSharedFx)();if(!r)return!1;var a=r.texture(i.canvas);return r.draw(a).multiplyAlpha().distort(e.input).unmultiplyAlpha().update(),i.clearRect(0,0,i.canvas.width,i.canvas.height),i.drawImage(r,0,0),a.destroy(),n.pause(!1),n.push({tool:["filter","distort"],action:"apply",params:[{input:e.input}]}),!0}}})),i.register("dteOZ",(function(t,n){e(t.exports,"filterVanishPoint",(function(){return p}));var r=i("eWjiX"),a=i("i5nyl"),s=i("1mH1z"),o=i("dJPtW"),l=i("43qNf"),h=i("jsIPR"),c=i("aP0jf"),u=i("cH2YE"),p={getDialog:function(e){var t=function(){var e=r.BB.ctx(D.image);e.save(),e.clearRect(0,0,m,y),e.drawImage(i.canvas,0,0,m,y),(0,h.drawVanishPoint)(e,k.x*x,k.y*x,k.lines,Math.max(k.thickness*x,1),k.color,k.opacity),e.restore(),N.render()},i=e.context,n=e.klCanvas;if(!i||!n)return!1;var p=n.getLayers(),d=n.getLayerIndex(i.canvas),g=r.BB.fitInto(i.canvas.width,i.canvas.height,280,200,1),f=parseInt(""+g.width),v=parseInt(""+g.height),m=Math.min(f,i.canvas.width),y=Math.min(v,i.canvas.height),x=m/i.canvas.width,B=f/i.canvas.width,b=document.createElement("div"),w={element:b};b.innerHTML=(0,s.LANG)("filter-vanish-point-description")+"<br/><br/>";var k={x:i.canvas.width/2,y:i.canvas.height/2,lines:8,thickness:2,color:{r:0,g:0,b:0},opacity:1},C=new(0,c.KlSlider)({label:(0,s.LANG)("filter-vanish-point-lines"),width:300,height:30,min:2,max:20,value:k.lines,curve:"quadratic",eventResMs:u.eventResMs,onChange:function(e){k.lines=Math.round(e),t()}});C.getElement().style.marginBottom="10px",b.append(C.getElement());var S=r.BB.el({parent:b,css:{display:"flex",alignItems:"center"}}),L=r.BB.el({parent:b,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),A=(0,o.input)({init:k.x,type:"number",css:{width:"75px",marginRight:"20px"},callback:function(e){k.x=parseFloat(e),t()}}),I=(0,o.input)({init:k.y,type:"number",css:{width:"75px",marginRight:"20px"},callback:function(e){k.y=parseFloat(e),t()}}),E=(0,o.input)({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){k.thickness=parseFloat(e),t()}}),T={r:0,g:0,b:0,a:1},M=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];M.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),M.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1}),k.color=r.BB.copyObj(T);var P=new(0,l.ColorOptions)({label:(0,s.LANG)("shape-stroke"),colorArr:M,onChange:function(e){T=e,k.color=r.BB.copyObj(T),t()}}),O={display:"inline-block",marginRight:"5px"};S.append(r.BB.el({content:"X:",css:O}),A,r.BB.el({content:"Y:",css:O}),I),L.append(r.BB.el({content:(0,s.LANG)("shape-line-width")+":",css:O}),E,r.BB.el({css:{flexGrow:"1"}}),P.getElement());var R=r.BB.el({className:"kl-preview-wrapper",css:{width:"340px",height:"220px"}}),D={image:r.BB.canvas(m,y),opacity:p[d].opacity,mixModeStr:p[d].mixModeStr},N=new(0,a.KlCanvasPreview)({width:Math.round(f),height:Math.round(v),layers:p.map((function(e,t){return t===d?D:{image:e.context.canvas,opacity:e.opacity,mixModeStr:e.mixModeStr}}))}),z=r.BB.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+f)+"px",height:parseInt(""+v)+"px",cursor:"move"}});z.append(N.getElement()),R.append(z);var j={start:null,end:null,state:null,oldSettings:null};R.oncontextmenu=function(){return!1},z.style.touchAction="none";var G=new r.BB.PointerListener({target:z,onPointer:function(e){"pointerdown"===e.type?j.state||(j.state="move",j.oldSettings=r.BB.copyObj(k),j.start={x:e.relX/B,y:e.relY/B},j.end=null):"pointermove"===e.type?j.state&&(j.end={x:e.relX/B,y:e.relY/B},k.x=Math.round(j.end.x-j.start.x+j.oldSettings.x),k.y=Math.round(j.end.y-j.start.y+j.oldSettings.y),A.value=""+k.x,I.value=""+k.y,t()):"pointerup"===e.type&&j.state&&(j.state=null)}});return setTimeout(t,0),b.append(R),w.destroy=function(){C.destroy(),G.destroy(),N.destroy(),P.destroy()},w.getInput=function(){return w.destroy(),r.BB.copyObj(k)},w},apply:function(e){var t=e.context,i=e.klCanvas,n=e.history;return!!(t&&i&&n)&&(n.pause(!0),(0,h.drawVanishPoint)(t,e.input.x,e.input.y,e.input.lines,e.input.thickness,e.input.color,e.input.opacity),n.pause(!1),n.push({tool:["filter","vanishPoint"],action:"apply",params:[{input:e.input}]}),!0)}}})),i.register("jsIPR",(function(t,n){e(t.exports,"drawVanishPoint",(function(){return s}));var r=i("3ujzu"),a=i("eWjiX");function s(e,t,i,n,s,o,l){e.save();for(var h=180/n,c=0;c<180;c+=h){var u=a.BB.rotateAround({x:t,y:i},{x:t+9999,y:i},c);(0,r.drawShape)(e,{type:"line",x1:t,y1:i,x2:u.x,y2:u.y,isOutwards:!0,opacity:l,strokeRgb:o,lineWidth:s})}e.restore()}})),i.register("3WOmu",(function(t,n){e(t.exports,"klCanvasToPsdBlob",(function(){return o}));var r=i("3kC7t"),a=i("2gUX3"),s=i("hrnUX");function o(e){return l.apply(this,arguments)}function l(){return(l=(0,r.default)((function(e){var t,n,r,o;return(0,a.__generator)(this,(function(a){switch(a.label){case 0:return t=e.getLayersFast(),n={width:e.getWidth(),height:e.getHeight(),children:t.map((function(e){return{name:e.name,opacity:e.opacity,canvas:e.canvas,blendMode:s.KL.PSD.blendKlToPsd(e.mixModeStr),left:0,top:0}}))},[4,i("bxnoy")];case 1:return r=a.sent(),o=r.writePsdBuffer(n),[2,new Blob([o],{type:"application/octet-stream"})]}}))}))).apply(this,arguments)}})),i.register("iuTWx",(function(t,n){e(t.exports,"LineSmoothing",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("eWjiX"),o=function(){"use strict";function e(t){(0,r.default)(this,e),this.smoothing=s.BB.clamp(t.smoothing,0,1)}return(0,a.default)(e,[{key:"chainIn",value:function(e){var t=this;if(e=s.BB.copyObj(e),this.timeout&&clearTimeout(this.timeout),this.interval&&clearInterval(this.interval),"down"===e.type&&(this.lastMixedInput={x:e.x,y:e.y,pressure:e.pressure}),"move"===e.type){var i=e.x,n=e.y,r=e.pressure;e.x=s.BB.mix(e.x,this.lastMixedInput.x,this.smoothing),e.y=s.BB.mix(e.y,this.lastMixedInput.y,this.smoothing),e.pressure=s.BB.mix(e.pressure,this.lastMixedInput.pressure,this.smoothing),this.lastMixedInput={x:e.x,y:e.y,pressure:e.pressure},this.smoothing>0&&(this.timeout=setTimeout((function(){t.interval=setInterval((function(){(e=JSON.parse(JSON.stringify(e))).x=s.BB.mix(i,t.lastMixedInput.x,t.smoothing),e.y=s.BB.mix(n,t.lastMixedInput.y,t.smoothing),e.pressure=s.BB.mix(r,t.lastMixedInput.pressure,t.smoothing),t.lastMixedInput={x:e.x,y:e.y,pressure:e.pressure},t.chainOut&&t.chainOut(e)}),35)}),80))}return e}},{key:"setChainOut",value:function(e){this.chainOut=e}},{key:"setSmoothing",value:function(e){this.smoothing=s.BB.clamp(e,0,1)}}]),e}()})),i.register("57YJz",(function(t,n){e(t.exports,"LineSanitizer",(function(){return o}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("7U0Ew"),o=function(){"use strict";function e(){(0,r.default)(this,e),(0,s.default)(this,"isDrawing",!1)}return(0,a.default)(e,[{key:"chainIn",value:function(e){return"down"===e.type&&(this.isDrawing?this.chainOut&&this.chainOut({type:"up",scale:e.scale,shiftIsPressed:e.shiftIsPressed,isCoalesced:!1}):this.isDrawing=!0),this.isDrawing||"move"!==e.type&&"up"!==e.type?("up"===e.type&&this.isDrawing&&(this.isDrawing=!1),e):null}},{key:"setChainOut",value:function(e){this.chainOut=e}},{key:"getIsDrawing",value:function(){return this.isDrawing}}]),e}()})),i.register("aId1u",(function(t,i){function n(e){return 1==e?.5:2==e?.84:3==e?.965:4==e?.9825:5==e?.99125:e}e(t.exports,"translateSmoothing",(function(){return n}))})),i.register("iG6pP",(function(t,n){e(t.exports,"ImportHandler",(function(){return c}));var r=i("gFgFC"),a=i("kiQ5H"),s=i("hrnUX"),o=i("1mH1z"),l=i("eWjiX"),h=i("gWfkn"),c=function(){"use strict";function e(t,i){(0,r.default)(this,e),this.klRootEl=t.klRootEl,this.klMaxCanvasSize=t.klMaxCanvasSize,this.layerManager=t.layerManager,this.setCurrentLayer=t.setCurrentLayer,this.klCanvas=t.klCanvas,this.klCanvasWorkspace=t.klCanvasWorkspace,this.handUi=t.handUi,this.onColor=i.onColor}return(0,a.default)(e,[{key:"importFinishedLoading",value:function(e,t,i){var n=this;if(!e||isNaN(e.width)||isNaN(e.height)||e.width<=0||e.height<=0)s.KL.popup({target:this.klRootEl,type:"error",message:(0,o.LANG)("import-broken-file"),buttons:["Ok"]});else{var r=function(e,t){var i=parseInt(""+e),r=parseInt(""+t);return i>n.klMaxCanvasSize&&(r=n.klMaxCanvasSize/i*r,i=n.klMaxCanvasSize),r>n.klMaxCanvasSize&&(i=n.klMaxCanvasSize/r*i,r=n.klMaxCanvasSize),{width:i=parseInt(""+i),height:r=parseInt(""+r)}},a=function(e){var i=r(e.width,e.height),a=l.BB.canvas(e.width,e.height);l.BB.ctx(a).drawImage(e,0,0),l.BB.resizeCanvas(a,i.width,i.height),n.klCanvas.reset({width:i.width,height:i.height,image:a,layerName:t}),n.layerManager.update(0),n.setCurrentLayer(n.klCanvas.getLayer(0)),n.klCanvasWorkspace.resetView(),n.handUi.update(n.klCanvasWorkspace.getScale(),n.klCanvasWorkspace.getAngleDeg())},c=function(e,t){var i=function(e,t,i){t.width=t.width,l.BB.ctx(t).drawImage(e,-i.x,-i.y),e.width=i.width,e.height=i.height,l.BB.ctx(e).drawImage(t,0,0)};if(t&&(t.width!==e.width||t.height!==e.height)){var a=l.BB.canvas(t.width,t.height);if(e.width=t.width,e.height=t.height,e.layers||i(e.canvas,a,t),e.layers)for(var s=0;s<e.layers.length;s++){i(e.layers[s].image,a,t)}}var o,h=r(e.width,e.height);if(e.width=h.width,e.height=h.height,e.layers||l.BB.resizeCanvas(e.canvas,e.width,e.height),e.layers)for(var c=0;c<e.layers.length;c++){var u=e.layers[c];l.BB.resizeCanvas(u.image,e.width,e.height)}o=e.layers?n.klCanvas.reset({width:e.width,height:e.height,layers:e.layers}):n.klCanvas.reset({width:e.width,height:e.height,image:e.canvas}),n.layerManager.update(o),n.setCurrentLayer(n.klCanvas.getLayer(o)),n.klCanvasWorkspace.resetView(),n.handUi.update(n.klCanvasWorkspace.getScale(),n.klCanvasWorkspace.getAngleDeg())},u=function(e){s.KL.showImportAsLayerDialog({target:n.klRootEl,klCanvas:n.klCanvas,importImage:e,callback:function(i,r){if(i){h.klHistory.pause(!0),n.klCanvas.addLayer();var a=n.klCanvas.getLayers().length-1;t&&n.klCanvas.renameLayer(a,t);var s=n.klCanvas.getLayerContext(a);l.BB.drawTransformedImageWithBounds(s,e,i,null,r),n.setCurrentLayer(n.klCanvas.getLayer(a)),n.layerManager.update(a),h.klHistory.pause(!1),h.klHistory.push({tool:["misc"],action:"importImage",params:[l.BB.copyCanvas(s.canvas),t]})}}})};"default"!==i&&i||s.KL.showImportImageDialog({image:e,target:this.klRootEl,maxSize:this.klMaxCanvasSize,callback:function(e){"as-image"===e.type?a(e.image):"as-image-psd"===e.type?c(e.image,e.cropObj):"as-layer"===e.type?u(e.image):e.type}}),"layer"===i&&u(e.canvas),"image"===i&&("psd"===e.type?c(e):a(e.canvas))}}},{key:"onPaste",value:function(e){var t=this;if(!(s.KL.dialogCounter.get()>0)){e.stopPropagation(),e.preventDefault(),e.clipboardData&&(e.clipboardData.files[0]?function(e,t){if(e)for(var i=0;i<e.length;i++)if(-1!=e[i].type.indexOf("image")){var n=e[i].getAsFile();n&&t(n)}}(e.clipboardData.items,(function(e){var i=new Image;i.onload=function(){URL.revokeObjectURL(i.src),t.importFinishedLoading({type:"image",width:i.width,height:i.height,canvas:i},void 0,"default")};var n=window.URL||window.webkitURL;i.src=n.createObjectURL(e)})):e.clipboardData.items[0]&&e.clipboardData.items[0].getAsString((function(e){if((e=e.trim()).match(/^https?/)){var i=new Image;i.onload=function(){t.importFinishedLoading({type:"image",width:i.width,height:i.height,canvas:i},void 0,"default")},i.onerror=function(e){console.log("error loading",e)},i.crossOrigin="Anonymous",i.src=e}else if(e.match(/^#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/)){var n=l.BB.ColorConverter.hexToRGB(e.replace("#",""));n&&t.onColor(n)}})))}}},{key:"handleFileSelect",value:function(e,t){for(var i,n=this,r=function(){s.KL.popup({target:n.klRootEl,type:"warning",message:(0,o.LANG)("import-psd-unsupported")+"<br /><br />",buttons:["Ok"]})},a=!1,h=0;i=e[h];h++){var c=i.name.split(".");"psd"===c[c.length-1].toLowerCase()?function(i){var a=4096;if(i.size>=1073741824)s.KL.popup({target:n.klRootEl,type:"error",message:"File too big. Unable to import.<br /><br />",buttons:["Ok"]});else{var l,h=1===e.length&&i.size>=26214400,c=!0;h&&s.KL.popup({target:n.klRootEl,message:(0,o.LANG)("import-opening"),callback:function(e){c=!1,l=null},closeFunc:function(e){l=e}});var u=new FileReader;u.onload=function(e){s.KL.loadAgPsd().then((function(u){if(!h||c)try{var p;if((p=u.readPsd(e.target.result,{skipLayerImageData:!0,skipThumbnail:!0,skipCompositeImageData:!0})).width>a||p.height>a)return l&&l(),void s.KL.popup({target:n.klRootEl,type:"error",message:(0,o.LANG)("import-psd-too-large").replace(/{x}/g,""+a)+"<br /><br />"+(0,o.LANG)("import-psd-size")+": "+p.width+" x "+p.height+" pixels<br /><br />",buttons:["Ok"]});p=null;try{p=u.readPsd(e.target.result)}catch(e){}if(p){var d=s.KL.PSD.readPsd(p);"image"===t&&d.error&&r(),l&&l(),n.importFinishedLoading(d,i.name,t)}else p=u.readPsd(e.target.result,{skipLayerImageData:!0,skipThumbnail:!0}),"image"===t&&r(),l&&l(),n.importFinishedLoading({type:"psd",width:p.width,height:p.height,canvas:p.canvas,error:!0},i.name,t)}catch(e){l&&l(),s.KL.popup({target:n.klRootEl,type:"error",message:"Failed to load PSD.<br /><br />",buttons:["Ok"]}),console.log(e),setTimeout((function(){throw new Error("psd load error")}))}})).catch((function(e){l&&l(),alert("Error: failed to load PSD library")}))},u.readAsArrayBuffer(i)}}(i):i.type.match("image.*")?function(e){window.URL=window.URL||window.webkitURL;var i=window.URL.createObjectURL(e),r=new Image;r.src=i,l.BB.loadImage(r,(function(){n.importFinishedLoading({type:"image",width:r.width,height:r.height,canvas:r},e.name,t)}))}(i):a=!0}a&&s.KL.popup({target:this.klRootEl,message:(0,o.LANG)("import-unsupported-file"),type:"error",buttons:["OK"]})}}]),e}()})),i.register("fX22P",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("kycpJ")})),i.register("i7SrA",(function(e,t){e.exports=i("f6OTe").getBundleURL("dafOa")+i("2evKT").resolve("TzbtI")})),i.register("qur3y",(function(t,n){e(t.exports,"createConsoleApi",(function(){return a}));var r=i("4Ea8f");function a(e){var t,i,n=["Draw via the console! Learn more: %cKL.help()","background: #000; color: #0f0;"];return"info"in console?(t=console).info.apply(t,(0,r.default)(n)):(i=console).log.apply(i,(0,r.default)(n)),Object.freeze({draw:function(t){e.onDraw(t)},help:function(){console.log("KL.draw({x: number; y: number}[]) // draw a line\nKL.help() // print help\n")}})}}))}();
//# sourceMappingURL=main-embed.6aa19314.js.map
